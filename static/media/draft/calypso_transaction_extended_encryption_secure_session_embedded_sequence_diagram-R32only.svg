<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="5996px" preserveAspectRatio="none" style="width:1821px;height:5996px;background:#FFFFFF;" version="1.1" viewBox="0 0 1821 5996" width="1821px" zoomAndPan="magnify"><defs/><g><rect fill="#FFD700" height="5815.1152" style="stroke:#181818;stroke-width:1.0;" width="10" x="94.5" y="91.4883"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="370.5" y="222.041"/><rect fill="#FFC0CB" height="59.9316" style="stroke:#181818;stroke-width:1.0;" width="10" x="370.5" y="557.457"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="370.5" y="793.5625"/><rect fill="#FFC0CB" height="702.6953" style="stroke:#181818;stroke-width:1.0;" width="10" x="370.5" y="836.873"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="370.5" y="1584.1895"/><rect fill="#FFC0CB" height="636.7637" style="stroke:#181818;stroke-width:1.0;" width="10" x="370.5" y="1627.5"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="370.5" y="2351.1953"/><rect fill="#FFC0CB" height="538.1426" style="stroke:#181818;stroke-width:1.0;" width="10" x="370.5" y="2394.5059"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="370.5" y="3019.5801"/><rect fill="#FFC0CB" height="553.4531" style="stroke:#181818;stroke-width:1.0;" width="10" x="370.5" y="3062.8906"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="370.5" y="3703.2754"/><rect fill="#FFC0CB" height="568.7637" style="stroke:#181818;stroke-width:1.0;" width="10" x="370.5" y="3746.5859"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="370.5" y="4432.9023"/><rect fill="#FFC0CB" height="1421.3906" style="stroke:#181818;stroke-width:1.0;" width="10" x="370.5" y="4476.2129"/><rect fill="#FFC0CB" height="262.7949" style="stroke:#181818;stroke-width:1.0;" width="10" x="628.5" y="265.3516"/><rect fill="#ADD8E6" height="173.5527" style="stroke:#181818;stroke-width:1.0;" width="10" x="828.5" y="325.2832"/><rect fill="#ADD8E6" height="303.416" style="stroke:#181818;stroke-width:1.0;" width="10" x="828.5" y="1087.9785"/><rect fill="#ADD8E6" height="185.8633" style="stroke:#181818;stroke-width:1.0;" width="10" x="828.5" y="1687.4316"/><rect fill="#ADD8E6" height="150.5527" style="stroke:#181818;stroke-width:1.0;" width="10" x="828.5" y="2454.4375"/><rect fill="#ADD8E6" height="150.5527" style="stroke:#181818;stroke-width:1.0;" width="10" x="828.5" y="3122.8223"/><rect fill="#ADD8E6" height="150.5527" style="stroke:#181818;stroke-width:1.0;" width="10" x="828.5" y="3806.5176"/><rect fill="#ADD8E6" height="119.2422" style="stroke:#181818;stroke-width:1.0;" width="10" x="828.5" y="4776.9395"/><rect fill="#ADD8E6" height="271.4844" style="stroke:#181818;stroke-width:1.0;" width="10" x="828.5" y="5311.1504"/><rect fill="#ADD8E6" height="5198.7305" style="stroke:#181818;stroke-width:1.0;" width="10" x="1228.5" y="354.5938"/><rect fill="#90EE90" height="131.2422" style="stroke:#181818;stroke-width:1.0;" width="10" x="1314" y="896.8047"/><rect fill="#90EE90" height="225.1738" style="stroke:#181818;stroke-width:1.0;" width="10" x="1314" y="1933.2266"/><rect fill="#90EE90" height="146.5527" style="stroke:#181818;stroke-width:1.0;" width="10" x="1314" y="2664.9219"/><rect fill="#90EE90" height="146.5527" style="stroke:#181818;stroke-width:1.0;" width="10" x="1314" y="3333.3066"/><rect fill="#90EE90" height="146.5527" style="stroke:#181818;stroke-width:1.0;" width="10" x="1314" y="4017.002"/><rect fill="#90EE90" height="87.9316" style="stroke:#181818;stroke-width:1.0;" width="10" x="1314" y="4629.0762"/><rect fill="#90EE90" height="295.1055" style="stroke:#181818;stroke-width:1.0;" width="10" x="1314" y="4956.1133"/><rect fill="#90EE90" height="87.9316" style="stroke:#181818;stroke-width:1.0;" width="10" x="1314" y="5642.5664"/><rect fill="#90EE90" height="5815.1152" style="stroke:#181818;stroke-width:1.0;" width="10" x="1748" y="91.4883"/><rect fill="none" height="141.8633" style="stroke:#000000;stroke-width:1.5;" width="662" x="606" y="1102.9785"/><rect fill="#F0F8FF" height="4150.2402" style="stroke:#000000;stroke-width:1.5;" width="1795" x="9" y="1258.8418"/><rect fill="none" height="142.5527" style="stroke:#000000;stroke-width:1.5;" width="584" x="694" y="1702.4316"/><rect fill="none" height="81.9316" style="stroke:#000000;stroke-width:1.5;" width="564" x="704" y="1726.7422"/><rect fill="none" height="107.2422" style="stroke:#000000;stroke-width:1.5;" width="517" x="761" y="2469.4375"/><rect fill="none" height="46.6211" style="stroke:#000000;stroke-width:1.5;" width="497" x="771" y="2493.748"/><rect fill="none" height="107.2422" style="stroke:#000000;stroke-width:1.5;" width="517" x="761" y="3137.8223"/><rect fill="none" height="46.6211" style="stroke:#000000;stroke-width:1.5;" width="497" x="771" y="3162.1328"/><rect fill="none" height="107.2422" style="stroke:#000000;stroke-width:1.5;" width="517" x="761" y="3821.5176"/><rect fill="none" height="46.6211" style="stroke:#000000;stroke-width:1.5;" width="497" x="771" y="3845.8281"/><rect fill="none" height="75.9316" style="stroke:#000000;stroke-width:1.5;" width="497" x="771" y="4791.9395"/><rect fill="none" height="75.9316" style="stroke:#000000;stroke-width:1.5;" width="536" x="1258" y="5088.3555"/><rect fill="none" height="75.9316" style="stroke:#000000;stroke-width:1.5;" width="497" x="771" y="5326.1504"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="99" x2="99" y1="81.4883" y2="5915.6035"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="375.5" x2="375.5" y1="81.4883" y2="5915.6035"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="633.5" x2="633.5" y1="81.4883" y2="5915.6035"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="833" x2="833" y1="81.4883" y2="5915.6035"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1233" x2="1233" y1="81.4883" y2="5915.6035"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1319" x2="1319" y1="81.4883" y2="5915.6035"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1753" x2="1753" y1="81.4883" y2="5915.6035"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="145" x="24" y="78.5352">Ticketing Application</text><ellipse cx="99.5" cy="13.5" fill="#FFD700" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M99.5,21.5 L99.5,48.5 M86.5,29.5 L112.5,29.5 M99.5,48.5 L86.5,63.5 M99.5,48.5 L112.5,63.5 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="145" x="24" y="5928.1387">Ticketing Application</text><ellipse cx="99.5" cy="5939.5918" fill="#FFD700" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M99.5,5947.5918 L99.5,5974.5918 M86.5,5955.5918 L112.5,5955.5918 M99.5,5974.5918 L86.5,5989.5918 M99.5,5974.5918 L112.5,5989.5918 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#FFC0CB" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="94" x="328.5" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="80" x="335.5" y="70.5352">Calypso API</text><rect fill="#FFC0CB" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="94" x="328.5" y="5914.6035"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="80" x="335.5" y="5935.1387">Calypso API</text><rect fill="#FFC0CB" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="88" x="589.5" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="74" x="596.5" y="70.5352">Reader API</text><rect fill="#FFC0CB" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="88" x="589.5" y="5914.6035"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="74" x="596.5" y="5935.1387">Reader API</text><rect fill="#ADD8E6" height="46.9766" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="105" x="781" y="33.5117"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="788" y="54.0469">Calypso Card</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48" x="809.5" y="70.5352">Reader</text><rect fill="#ADD8E6" height="46.9766" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="105" x="781" y="5914.6035"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="788" y="5935.1387">Calypso Card</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48" x="809.5" y="5951.627">Reader</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="33" x="1214" y="78.5352">Card</text><path d="M1213,37 L1213,61 M1213,49 L1230,49 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><ellipse cx="1242" cy="49" fill="#ADD8E6" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="33" x="1214" y="5928.1387">Card</text><path d="M1213,5935.0918 L1213,5959.0918 M1213,5947.0918 L1230,5947.0918 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><ellipse cx="1242" cy="5947.0918" fill="#ADD8E6" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#90EE90" height="46.9766" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="102" x="1268" y="33.5117"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="88" x="1275" y="54.0469">Calypso SAM</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48" x="1295" y="70.5352">Reader</text><rect fill="#90EE90" height="46.9766" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="102" x="1268" y="5914.6035"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="88" x="1275" y="5935.1387">Calypso SAM</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48" x="1295" y="5951.627">Reader</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="1722" y="62.0469">selected</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="31" x="1734.5" y="78.5352">SAM</text><path d="M1732.5,20.5117 L1732.5,44.5117 M1732.5,32.5117 L1749.5,32.5117 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><ellipse cx="1761.5" cy="32.5117" fill="#90EE90" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="1722" y="5928.1387">selected</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="31" x="1734.5" y="5944.627">SAM</text><path d="M1732.5,5951.5801 L1732.5,5975.5801 M1732.5,5963.5801 L1749.5,5963.5801 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><ellipse cx="1761.5" cy="5963.5801" fill="#90EE90" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#FFD700" height="5815.1152" style="stroke:#181818;stroke-width:1.0;" width="10" x="94.5" y="91.4883"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="370.5" y="222.041"/><rect fill="#FFC0CB" height="59.9316" style="stroke:#181818;stroke-width:1.0;" width="10" x="370.5" y="557.457"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="370.5" y="793.5625"/><rect fill="#FFC0CB" height="702.6953" style="stroke:#181818;stroke-width:1.0;" width="10" x="370.5" y="836.873"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="370.5" y="1584.1895"/><rect fill="#FFC0CB" height="636.7637" style="stroke:#181818;stroke-width:1.0;" width="10" x="370.5" y="1627.5"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="370.5" y="2351.1953"/><rect fill="#FFC0CB" height="538.1426" style="stroke:#181818;stroke-width:1.0;" width="10" x="370.5" y="2394.5059"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="370.5" y="3019.5801"/><rect fill="#FFC0CB" height="553.4531" style="stroke:#181818;stroke-width:1.0;" width="10" x="370.5" y="3062.8906"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="370.5" y="3703.2754"/><rect fill="#FFC0CB" height="568.7637" style="stroke:#181818;stroke-width:1.0;" width="10" x="370.5" y="3746.5859"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="370.5" y="4432.9023"/><rect fill="#FFC0CB" height="1421.3906" style="stroke:#181818;stroke-width:1.0;" width="10" x="370.5" y="4476.2129"/><rect fill="#FFC0CB" height="262.7949" style="stroke:#181818;stroke-width:1.0;" width="10" x="628.5" y="265.3516"/><rect fill="#ADD8E6" height="173.5527" style="stroke:#181818;stroke-width:1.0;" width="10" x="828.5" y="325.2832"/><rect fill="#ADD8E6" height="303.416" style="stroke:#181818;stroke-width:1.0;" width="10" x="828.5" y="1087.9785"/><rect fill="#ADD8E6" height="185.8633" style="stroke:#181818;stroke-width:1.0;" width="10" x="828.5" y="1687.4316"/><rect fill="#ADD8E6" height="150.5527" style="stroke:#181818;stroke-width:1.0;" width="10" x="828.5" y="2454.4375"/><rect fill="#ADD8E6" height="150.5527" style="stroke:#181818;stroke-width:1.0;" width="10" x="828.5" y="3122.8223"/><rect fill="#ADD8E6" height="150.5527" style="stroke:#181818;stroke-width:1.0;" width="10" x="828.5" y="3806.5176"/><rect fill="#ADD8E6" height="119.2422" style="stroke:#181818;stroke-width:1.0;" width="10" x="828.5" y="4776.9395"/><rect fill="#ADD8E6" height="271.4844" style="stroke:#181818;stroke-width:1.0;" width="10" x="828.5" y="5311.1504"/><rect fill="#ADD8E6" height="5198.7305" style="stroke:#181818;stroke-width:1.0;" width="10" x="1228.5" y="354.5938"/><rect fill="#90EE90" height="131.2422" style="stroke:#181818;stroke-width:1.0;" width="10" x="1314" y="896.8047"/><rect fill="#90EE90" height="225.1738" style="stroke:#181818;stroke-width:1.0;" width="10" x="1314" y="1933.2266"/><rect fill="#90EE90" height="146.5527" style="stroke:#181818;stroke-width:1.0;" width="10" x="1314" y="2664.9219"/><rect fill="#90EE90" height="146.5527" style="stroke:#181818;stroke-width:1.0;" width="10" x="1314" y="3333.3066"/><rect fill="#90EE90" height="146.5527" style="stroke:#181818;stroke-width:1.0;" width="10" x="1314" y="4017.002"/><rect fill="#90EE90" height="87.9316" style="stroke:#181818;stroke-width:1.0;" width="10" x="1314" y="4629.0762"/><rect fill="#90EE90" height="295.1055" style="stroke:#181818;stroke-width:1.0;" width="10" x="1314" y="4956.1133"/><rect fill="#90EE90" height="87.9316" style="stroke:#181818;stroke-width:1.0;" width="10" x="1314" y="5642.5664"/><rect fill="#90EE90" height="5815.1152" style="stroke:#181818;stroke-width:1.0;" width="10" x="1748" y="91.4883"/><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1814" x="0" y="112.1436"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1814" y1="112.1436" y2="112.1436"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1814" y1="115.1436" y2="115.1436"/><rect fill="#EEEEEE" height="23.3105" style="stroke:#000000;stroke-width:2.0;" width="221" x="796.5" y="101.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="203" x="802.5" y="118.0566">Card selection &amp; identification</text><path d="M255,139.7988 L255,164.7988 L496,164.7988 L496,149.7988 L486,139.7988 L255,139.7988 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M486,139.7988 L486,149.7988 L496,149.7988 L486,139.7988 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="261" y="157.3672">Only reads data inside the session.</text><polygon fill="#181818" points="358.5,218.041,368.5,222.041,358.5,226.041,362.5,222.041" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="104.5" x2="364.5" y1="222.041" y2="222.041"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="111.5" y="186.6777">prepare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="149" x="169.5" y="186.6777">card selection scenario:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="141" x="143.5" y="201.9883">- filter by specific AID</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="189" x="143.5" y="217.2988">- filter invalidated card status</text><polygon fill="#181818" points="115.5,232.041,105.5,236.041,115.5,240.041,111.5,236.041" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="109.5" x2="374.5" y1="236.041" y2="236.041"/><polygon fill="#181818" points="616.5,261.3516,626.5,265.3516,616.5,269.3516,620.5,265.3516" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="104.5" x2="622.5" y1="265.3516" y2="265.3516"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="111.5" y="260.6094">process</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="196" x="167.5" y="260.6094">explicit card selection scenario</text><polygon fill="#0000FF" points="816.5,321.2832,826.5,325.2832,816.5,329.2832,820.5,325.2832" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;" x1="638.5" x2="822.5" y1="325.2832" y2="325.2832"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="645.5" y="289.9199">Card #1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="165" x="645.5" y="305.2305">transmit selection request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="93" x="677.5" y="320.541">- card selector</text><polygon fill="#181818" points="1216.5,350.5938,1226.5,354.5938,1216.5,358.5938,1220.5,354.5938" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="838.5" x2="1222.5" y1="354.5938" y2="354.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="845.5" y="349.8516">open card channel</text><polygon fill="#181818" points="849.5,364.5938,839.5,368.5938,849.5,372.5938,845.5,368.5938" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="843.5" x2="1227.5" y1="368.5938" y2="368.5938"/><polygon fill="#181818" points="1216.5,393.9043,1226.5,397.9043,1216.5,401.9043,1220.5,397.9043" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="838.5" x2="1222.5" y1="397.9043" y2="397.9043"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="142" x="845.5" y="393.1621">select application (aid)</text><polygon fill="#181818" points="849.5,423.2148,839.5,427.2148,849.5,431.2148,845.5,427.2148" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="843.5" x2="1227.5" y1="427.2148" y2="427.2148"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="59" x="855.5" y="422.4727">[card FCI]</text><line style="stroke:#181818;stroke-width:1.0;" x1="838.5" x2="880.5" y1="456.5254" y2="456.5254"/><line style="stroke:#181818;stroke-width:1.0;" x1="880.5" x2="880.5" y1="456.5254" y2="469.5254"/><line style="stroke:#181818;stroke-width:1.0;" x1="839.5" x2="880.5" y1="469.5254" y2="469.5254"/><polygon fill="#181818" points="849.5,465.5254,839.5,469.5254,849.5,473.5254,845.5,469.5254" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="165" x="845.5" y="451.7832">checks invalidation status</text><polygon fill="#0000FF" points="649.5,494.8359,639.5,498.8359,649.5,502.8359,645.5,498.8359" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="643.5" x2="832.5" y1="498.8359" y2="498.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="166" x="655.5" y="494.0938">receive selection response</text><polygon fill="#181818" points="115.5,524.1465,105.5,528.1465,115.5,532.1465,111.5,528.1465" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="109.5" x2="632.5" y1="528.1465" y2="528.1465"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="204" x="121.5" y="523.4043">selected active SmartCard image</text><polygon fill="#181818" points="358.5,553.457,368.5,557.457,358.5,561.457,362.5,557.457" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="104.5" x2="364.5" y1="557.457" y2="557.457"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="27" x="111.5" y="552.7148">cast</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="81" x="142.5" y="552.7148">Calypso card</text><polygon fill="#181818" points="115.5,613.3887,105.5,617.3887,115.5,621.3887,111.5,617.3887" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="109.5" x2="374.5" y1="617.3887" y2="617.3887"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="121.5" y="582.0254">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127" x="153.5" y="597.3359">- identification data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="133" x="153.5" y="612.6465">- invalidation status]</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1814" x="0" y="646.0439"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1814" y1="646.0439" y2="646.0439"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1814" y1="649.0439" y2="649.0439"/><rect fill="#EEEEEE" height="23.3105" style="stroke:#000000;stroke-width:2.0;" width="179" x="817.5" y="635.3887"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="161" x="823.5" y="651.957">Card secure transaction</text><line style="stroke:#181818;stroke-width:1.0;" x1="104.5" x2="146.5" y1="720.6309" y2="720.6309"/><line style="stroke:#181818;stroke-width:1.0;" x1="146.5" x2="146.5" y1="720.6309" y2="733.6309"/><line style="stroke:#181818;stroke-width:1.0;" x1="105.5" x2="146.5" y1="733.6309" y2="733.6309"/><polygon fill="#181818" points="115.5,729.6309,105.5,733.6309,115.5,737.6309,111.5,733.6309" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="72" x="111.5" y="685.2676">instantiate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="187.5" y="685.2676">Calypso card transaction:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="143.5" y="700.5781">- Calypso card resource</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="143.5" y="715.8887">- Calypso SAM resource</text><polygon fill="#181818" points="358.5,789.5625,368.5,793.5625,358.5,797.5625,362.5,793.5625" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="104.5" x2="364.5" y1="793.5625" y2="793.5625"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="111.5" y="758.1992">prepare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="106" x="169.5" y="758.1992">card transaction:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="146" x="143.5" y="773.5098">- read environment file</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="206" x="143.5" y="788.8203">- manage session for encryption</text><polygon fill="#181818" points="115.5,803.5625,105.5,807.5625,115.5,811.5625,111.5,807.5625" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="109.5" x2="374.5" y1="807.5625" y2="807.5625"/><polygon fill="#181818" points="358.5,832.873,368.5,836.873,358.5,840.873,362.5,836.873" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="104.5" x2="364.5" y1="836.873" y2="836.873"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="111.5" y="832.1309">process</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="178" x="167.5" y="832.1309">opening (DEBIT access level)</text><polygon fill="#00FF00" points="1302,892.8047,1312,896.8047,1302,900.8047,1306,896.8047" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;" x1="380.5" x2="1308" y1="896.8047" y2="896.8047"/><text fill="#008000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="51" x="387.5" y="861.4414">SAM #1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="387.5" y="876.752">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="419.5" y="892.0625">- APDU list</text><polygon fill="#181818" points="1736,922.1152,1746,926.1152,1736,930.1152,1740,926.1152" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1324" x2="1742" y1="926.1152" y2="926.1152"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="181" x="1331" y="921.373">select diversifier (card serial)</text><polygon fill="#181818" points="1335,936.1152,1325,940.1152,1335,944.1152,1331,940.1152" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1329" x2="1747" y1="940.1152" y2="940.1152"/><polygon fill="#181818" points="1736,965.4258,1746,969.4258,1736,973.4258,1740,969.4258" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1324" x2="1742" y1="969.4258" y2="969.4258"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="84" x="1331" y="964.6836">get challenge</text><polygon fill="#181818" points="1335,994.7363,1325,998.7363,1335,1002.7363,1331,998.7363" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1329" x2="1747" y1="998.7363" y2="998.7363"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="99" x="1341" y="993.9941">[SAM challenge]</text><polygon fill="#00FF00" points="391.5,1024.0469,381.5,1028.0469,391.5,1032.0469,387.5,1028.0469" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="385.5" x2="1318" y1="1028.0469" y2="1028.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="99" x="397.5" y="1023.3047">[SAM challenge]</text><polygon fill="#0000FF" points="816.5,1083.9785,826.5,1087.9785,816.5,1091.9785,820.5,1087.9785" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;" x1="380.5" x2="822.5" y1="1087.9785" y2="1087.9785"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="387.5" y="1052.6152">Card #2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="387.5" y="1067.9258">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="419.5" y="1083.2363">- APDU list</text><path d="M606,1102.9785 L902,1102.9785 L902,1110.2891 L892,1120.2891 L606,1120.2891 L606,1102.9785 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="141.8633" style="stroke:#000000;stroke-width:1.5;" width="662" x="606" y="1102.9785"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="251" x="621" y="1116.5469">Card APDU commands inside session</text><path d="M616,1125.2891 L616,1150.2891 L1050,1150.2891 L1050,1135.2891 L1040,1125.2891 L616,1125.2891 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1040,1125.2891 L1040,1135.2891 L1050,1135.2891 L1040,1125.2891 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="413" x="622" y="1142.8574">Optimization: environment file read through the session opening.</text><polygon fill="#181818" points="1216.5,1203.5313,1226.5,1207.5313,1216.5,1211.5313,1220.5,1207.5313" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="838.5" x2="1222.5" y1="1207.5313" y2="1207.5313"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="229" x="845.5" y="1172.168">open secure session (card debit key,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="95" x="877.5" y="1187.4785">SAM challenge,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="153" x="877.5" y="1202.7891">SFI environment to read)</text><polygon fill="#181818" points="849.5,1232.8418,839.5,1236.8418,849.5,1240.8418,845.5,1236.8418" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="843.5" x2="1227.5" y1="1236.8418" y2="1236.8418"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="226" x="855.5" y="1232.0996">[card challenge &amp; environment data]</text><path d="M9,1258.8418 L162,1258.8418 L162,1266.1523 L152,1276.1523 L9,1276.1523 L9,1258.8418 " fill="#F0F8FF" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="4150.2402" style="stroke:#000000;stroke-width:1.5;" width="1795" x="9" y="1258.8418"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="108" x="24" y="1272.4102">Data Encryption</text><path d="M665,1281.1523 L665,1306.1523 L1001,1306.1523 L1001,1291.1523 L991,1281.1523 L665,1281.1523 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M991,1281.1523 L991,1291.1523 L1001,1291.1523 L991,1281.1523 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="315" x="671" y="1298.7207">command outside of the SMAC (no Digest Update)</text><polygon fill="#181818" points="1216.5,1328.7734,1226.5,1332.7734,1216.5,1336.7734,1220.5,1332.7734" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="838.5" x2="1222.5" y1="1332.7734" y2="1332.7734"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="366" x="845.5" y="1328.0313">manage secure session (authentication off, encryption on)</text><polygon fill="#181818" points="849.5,1358.084,839.5,1362.084,849.5,1366.084,845.5,1362.084" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="843.5" x2="1227.5" y1="1362.084" y2="1362.084"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="134" x="855.5" y="1357.3418">ack encryption active</text><polygon fill="#0000FF" points="391.5,1387.3945,381.5,1391.3945,391.5,1395.3945,387.5,1391.3945" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="385.5" x2="832.5" y1="1391.3945" y2="1391.3945"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="99" x="397.5" y="1386.6523">[card challenge]</text><line style="stroke:#181818;stroke-width:1.0;" x1="380.5" x2="422.5" y1="1420.7051" y2="1420.7051"/><line style="stroke:#181818;stroke-width:1.0;" x1="422.5" x2="422.5" y1="1420.7051" y2="1433.7051"/><line style="stroke:#181818;stroke-width:1.0;" x1="381.5" x2="422.5" y1="1433.7051" y2="1433.7051"/><polygon fill="#181818" points="391.5,1429.7051,381.5,1433.7051,391.5,1437.7051,387.5,1433.7051" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="387.5" y="1415.9629">checks ratification status</text><polygon fill="#181818" points="115.5,1535.5684,105.5,1539.5684,115.5,1543.5684,111.5,1539.5684" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="109.5" x2="374.5" y1="1539.5684" y2="1539.5684"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="121.5" y="1458.2734">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127" x="153.5" y="1473.584">- identification data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="153.5" y="1488.8945">- invalidation status</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="122" x="153.5" y="1504.2051">- environment data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="124" x="153.5" y="1519.5156">- ratification status</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="124" x="153.5" y="1534.8262">- encryption active]</text><polygon fill="#181818" points="358.5,1580.1895,368.5,1584.1895,358.5,1588.1895,362.5,1584.1895" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="104.5" x2="364.5" y1="1584.1895" y2="1584.1895"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="111.5" y="1564.1367">prepare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="106" x="169.5" y="1564.1367">card transaction:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="104" x="143.5" y="1579.4473">- read last event</text><polygon fill="#181818" points="115.5,1594.1895,105.5,1598.1895,115.5,1602.1895,111.5,1598.1895" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="109.5" x2="374.5" y1="1598.1895" y2="1598.1895"/><polygon fill="#181818" points="358.5,1623.5,368.5,1627.5,358.5,1631.5,362.5,1627.5" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="104.5" x2="364.5" y1="1627.5" y2="1627.5"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="111.5" y="1622.7578">process</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="69" x="167.5" y="1622.7578">commands</text><polygon fill="#0000FF" points="816.5,1683.4316,826.5,1687.4316,816.5,1691.4316,820.5,1687.4316" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;" x1="380.5" x2="822.5" y1="1687.4316" y2="1687.4316"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="387.5" y="1652.0684">Card #3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="387.5" y="1667.3789">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="419.5" y="1682.6895">- APDU list</text><path d="M694,1702.4316 L990,1702.4316 L990,1709.7422 L980,1719.7422 L694,1719.7422 L694,1702.4316 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="142.5527" style="stroke:#000000;stroke-width:1.5;" width="584" x="694" y="1702.4316"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="251" x="709" y="1716">Card APDU commands inside session</text><path d="M704,1726.7422 L966,1726.7422 L966,1734.0527 L956,1744.0527 L704,1744.0527 L704,1726.7422 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="81.9316" style="stroke:#000000;stroke-width:1.5;" width="564" x="704" y="1726.7422"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="76" x="719" y="1740.3105">anticipated</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="137" x="799" y="1740.3105">SAM APDU response</text><path d="M714,1749.0527 L714,1774.0527 L952,1774.0527 L952,1759.0527 L942,1749.0527 L714,1749.0527 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M942,1749.0527 L942,1759.0527 L952,1759.0527 L942,1749.0527 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="217" x="720" y="1766.6211">command without ciphered DataIn</text><polygon fill="#181818" points="1216.5,1796.6738,1226.5,1800.6738,1216.5,1804.6738,1220.5,1800.6738" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="838.5" x2="1222.5" y1="1800.6738" y2="1800.6738"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="144" x="845.5" y="1795.9316">read record (last event)</text><polygon fill="#181818" points="849.5,1832.9844,839.5,1836.9844,849.5,1840.9844,845.5,1836.9844" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="843.5" x2="1227.5" y1="1836.9844" y2="1836.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="855.5" y="1832.2422">[</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="859.5" y="1832.2422">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="92" x="863.5" y="1832.2422">last event data</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="58" x="955.5" y="1832.2422">}ciphered</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="1013.5" y="1832.2422">]</text><polygon fill="#0000FF" points="391.5,1869.2949,381.5,1873.2949,391.5,1877.2949,387.5,1873.2949" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="385.5" x2="832.5" y1="1873.2949" y2="1873.2949"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="397.5" y="1868.5527">[</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="401.5" y="1868.5527">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="92" x="405.5" y="1868.5527">last event data</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="58" x="497.5" y="1868.5527">}ciphered</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="555.5" y="1868.5527">]</text><polygon fill="#00FF00" points="1302,1929.2266,1312,1933.2266,1302,1937.2266,1306,1933.2266" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;" x1="380.5" x2="1308" y1="1933.2266" y2="1933.2266"/><text fill="#008000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="51" x="387.5" y="1897.8633">SAM #2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="387.5" y="1913.1738">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="419.5" y="1928.4844">- APDU list</text><polygon fill="#181818" points="1736,1958.5371,1746,1962.5371,1736,1966.5371,1740,1962.5371" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1324" x2="1742" y1="1962.5371" y2="1962.5371"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1331" y="1957.7949">digest init (opening data)</text><polygon fill="#181818" points="1335,1972.5371,1325,1976.5371,1335,1980.5371,1331,1976.5371" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1329" x2="1747" y1="1976.5371" y2="1976.5371"/><polygon fill="#181818" points="1736,2001.8477,1746,2005.8477,1736,2009.8477,1740,2005.8477" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1324" x2="1742" y1="2005.8477" y2="2005.8477"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="305" x="1331" y="2001.1055">digest update (request - read record (last event))</text><path d="M1164,2018.8477 L1164,2043.8477 L1474,2043.8477 L1474,2028.8477 L1464,2018.8477 L1164,2018.8477 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1464,2018.8477 L1464,2028.8477 L1474,2028.8477 L1464,2018.8477 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="289" x="1170" y="2036.416">useless, all bytes of the command are in plain</text><polygon fill="#181818" points="1335,2066.4688,1325,2070.4688,1335,2074.4688,1331,2070.4688" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1329" x2="1747" y1="2070.4688" y2="2070.4688"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="1341" y="2065.7266">[read record (last event)]</text><polygon fill="#181818" points="1736,2095.7793,1746,2099.7793,1736,2103.7793,1740,2099.7793" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1324" x2="1742" y1="2099.7793" y2="2099.7793"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="163" x="1331" y="2095.0371">digest update (response -</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="1498" y="2095.0371">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="92" x="1502" y="2095.0371">last event data</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="58" x="1594" y="2095.0371">}ciphered</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="1652" y="2095.0371">)</text><polygon fill="#181818" points="1335,2125.0898,1325,2129.0898,1335,2133.0898,1331,2129.0898" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1329" x2="1747" y1="2129.0898" y2="2129.0898"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="1341" y="2124.3477">[last event data]</text><polygon fill="#00FF00" points="391.5,2154.4004,381.5,2158.4004,391.5,2162.4004,387.5,2158.4004" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="385.5" x2="1318" y1="2158.4004" y2="2158.4004"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="252" x="397.5" y="2153.6582">[read record (last event), last event data]</text><polygon fill="#181818" points="115.5,2260.2637,105.5,2264.2637,115.5,2268.2637,111.5,2264.2637" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="109.5" x2="374.5" y1="2264.2637" y2="2264.2637"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="121.5" y="2182.9688">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127" x="153.5" y="2198.2793">- identification data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="153.5" y="2213.5898">- invalidation status</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="122" x="153.5" y="2228.9004">- environment data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="124" x="153.5" y="2244.2109">- ratification status</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="108" x="153.5" y="2259.5215">- last event data]</text><line style="stroke:#181818;stroke-width:1.0;" x1="104.5" x2="146.5" y1="2293.5742" y2="2293.5742"/><line style="stroke:#181818;stroke-width:1.0;" x1="146.5" x2="146.5" y1="2293.5742" y2="2306.5742"/><line style="stroke:#181818;stroke-width:1.0;" x1="105.5" x2="146.5" y1="2306.5742" y2="2306.5742"/><polygon fill="#181818" points="115.5,2302.5742,105.5,2306.5742,115.5,2310.5742,111.5,2306.5742" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="219" x="111.5" y="2288.832">checks transaction recovery status</text><polygon fill="#181818" points="358.5,2347.1953,368.5,2351.1953,358.5,2355.1953,362.5,2351.1953" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="104.5" x2="364.5" y1="2351.1953" y2="2351.1953"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="111.5" y="2331.1426">prepare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="106" x="169.5" y="2331.1426">card transaction:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="119" x="143.5" y="2346.4531">- read contract list</text><polygon fill="#181818" points="115.5,2361.1953,105.5,2365.1953,115.5,2369.1953,111.5,2365.1953" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="109.5" x2="374.5" y1="2365.1953" y2="2365.1953"/><polygon fill="#181818" points="358.5,2390.5059,368.5,2394.5059,358.5,2398.5059,362.5,2394.5059" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="104.5" x2="364.5" y1="2394.5059" y2="2394.5059"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="111.5" y="2389.7637">process</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="69" x="167.5" y="2389.7637">commands</text><polygon fill="#0000FF" points="816.5,2450.4375,826.5,2454.4375,816.5,2458.4375,820.5,2454.4375" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;" x1="380.5" x2="822.5" y1="2454.4375" y2="2454.4375"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="387.5" y="2419.0742">Card #4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="387.5" y="2434.3848">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="419.5" y="2449.6953">- APDU list</text><path d="M761,2469.4375 L1057,2469.4375 L1057,2476.748 L1047,2486.748 L761,2486.748 L761,2469.4375 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="107.2422" style="stroke:#000000;stroke-width:1.5;" width="517" x="761" y="2469.4375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="251" x="776" y="2483.0059">Card APDU commands inside session</text><path d="M771,2493.748 L1033,2493.748 L1033,2501.0586 L1023,2511.0586 L771,2511.0586 L771,2493.748 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="46.6211" style="stroke:#000000;stroke-width:1.5;" width="497" x="771" y="2493.748"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="76" x="786" y="2507.3164">anticipated</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="137" x="866" y="2507.3164">SAM APDU response</text><polygon fill="#181818" points="1216.5,2528.3691,1226.5,2532.3691,1216.5,2536.3691,1220.5,2532.3691" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="838.5" x2="1222.5" y1="2532.3691" y2="2532.3691"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="159" x="845.5" y="2527.627">read record (contract list)</text><polygon fill="#181818" points="849.5,2564.6797,839.5,2568.6797,849.5,2572.6797,845.5,2568.6797" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="843.5" x2="1227.5" y1="2568.6797" y2="2568.6797"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="855.5" y="2563.9375">[</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="859.5" y="2563.9375">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="107" x="863.5" y="2563.9375">contract list data</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="58" x="970.5" y="2563.9375">}ciphered</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="1028.5" y="2563.9375">]</text><polygon fill="#0000FF" points="391.5,2600.9902,381.5,2604.9902,391.5,2608.9902,387.5,2604.9902" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="385.5" x2="832.5" y1="2604.9902" y2="2604.9902"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="397.5" y="2600.248">[</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="401.5" y="2600.248">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="107" x="405.5" y="2600.248">contract list data</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="58" x="512.5" y="2600.248">}ciphered</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="570.5" y="2600.248">]</text><polygon fill="#00FF00" points="1302,2660.9219,1312,2664.9219,1302,2668.9219,1306,2664.9219" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;" x1="380.5" x2="1308" y1="2664.9219" y2="2664.9219"/><text fill="#008000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="51" x="387.5" y="2629.5586">SAM #3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="387.5" y="2644.8691">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="419.5" y="2660.1797">- APDU list</text><polygon fill="#181818" points="1736,2690.2324,1746,2694.2324,1736,2698.2324,1740,2694.2324" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1324" x2="1742" y1="2694.2324" y2="2694.2324"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="320" x="1331" y="2689.4902">digest update (request - read record (contract list))</text><polygon fill="#181818" points="1335,2719.543,1325,2723.543,1335,2727.543,1331,2723.543" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1329" x2="1747" y1="2723.543" y2="2723.543"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="167" x="1341" y="2718.8008">[read record (contract list)]</text><polygon fill="#181818" points="1736,2748.8535,1746,2752.8535,1736,2756.8535,1740,2752.8535" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1324" x2="1742" y1="2752.8535" y2="2752.8535"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="163" x="1331" y="2748.1113">digest update (response -</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="1498" y="2748.1113">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="107" x="1502" y="2748.1113">contract list data</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="58" x="1609" y="2748.1113">}ciphered</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="1667" y="2748.1113">)</text><polygon fill="#181818" points="1335,2778.1641,1325,2782.1641,1335,2786.1641,1331,2782.1641" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1329" x2="1747" y1="2782.1641" y2="2782.1641"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="1341" y="2777.4219">[contract list data]</text><polygon fill="#00FF00" points="391.5,2807.4746,381.5,2811.4746,391.5,2815.4746,387.5,2811.4746" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="385.5" x2="1318" y1="2811.4746" y2="2811.4746"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="282" x="397.5" y="2806.7324">[read record (contract list), contract list data]</text><polygon fill="#181818" points="115.5,2928.6484,105.5,2932.6484,115.5,2936.6484,111.5,2932.6484" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="109.5" x2="374.5" y1="2932.6484" y2="2932.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="121.5" y="2836.043">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127" x="153.5" y="2851.3535">- identification data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="153.5" y="2866.6641">- invalidation status</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="122" x="153.5" y="2881.9746">- environment data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="124" x="153.5" y="2897.2852">- ratification status</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="104" x="153.5" y="2912.5957">- last event data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="123" x="153.5" y="2927.9063">- contract list data]</text><line style="stroke:#181818;stroke-width:1.0;" x1="104.5" x2="146.5" y1="2961.959" y2="2961.959"/><line style="stroke:#181818;stroke-width:1.0;" x1="146.5" x2="146.5" y1="2961.959" y2="2974.959"/><line style="stroke:#181818;stroke-width:1.0;" x1="105.5" x2="146.5" y1="2974.959" y2="2974.959"/><polygon fill="#181818" points="115.5,2970.959,105.5,2974.959,115.5,2978.959,111.5,2974.959" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="111.5" y="2957.2168">identifies contract</text><polygon fill="#181818" points="358.5,3015.5801,368.5,3019.5801,358.5,3023.5801,362.5,3019.5801" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="104.5" x2="364.5" y1="3019.5801" y2="3019.5801"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="111.5" y="2999.5273">prepare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="106" x="169.5" y="2999.5273">card transaction:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="143.5" y="3014.8379">- read contract #x</text><polygon fill="#181818" points="115.5,3029.5801,105.5,3033.5801,115.5,3037.5801,111.5,3033.5801" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="109.5" x2="374.5" y1="3033.5801" y2="3033.5801"/><polygon fill="#181818" points="358.5,3058.8906,368.5,3062.8906,358.5,3066.8906,362.5,3062.8906" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="104.5" x2="364.5" y1="3062.8906" y2="3062.8906"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="111.5" y="3058.1484">process</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="69" x="167.5" y="3058.1484">commands</text><polygon fill="#0000FF" points="816.5,3118.8223,826.5,3122.8223,816.5,3126.8223,820.5,3122.8223" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;" x1="380.5" x2="822.5" y1="3122.8223" y2="3122.8223"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="387.5" y="3087.459">Card #5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="387.5" y="3102.7695">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="419.5" y="3118.0801">- APDU list</text><path d="M761,3137.8223 L1057,3137.8223 L1057,3145.1328 L1047,3155.1328 L761,3155.1328 L761,3137.8223 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="107.2422" style="stroke:#000000;stroke-width:1.5;" width="517" x="761" y="3137.8223"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="251" x="776" y="3151.3906">Card APDU commands inside session</text><path d="M771,3162.1328 L1033,3162.1328 L1033,3169.4434 L1023,3179.4434 L771,3179.4434 L771,3162.1328 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="46.6211" style="stroke:#000000;stroke-width:1.5;" width="497" x="771" y="3162.1328"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="76" x="786" y="3175.7012">anticipated</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="137" x="866" y="3175.7012">SAM APDU response</text><polygon fill="#181818" points="1216.5,3196.7539,1226.5,3200.7539,1216.5,3204.7539,1220.5,3200.7539" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="838.5" x2="1222.5" y1="3200.7539" y2="3200.7539"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="155" x="845.5" y="3196.0117">read record (contract #x)</text><polygon fill="#181818" points="849.5,3233.0645,839.5,3237.0645,849.5,3241.0645,845.5,3237.0645" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="843.5" x2="1227.5" y1="3237.0645" y2="3237.0645"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="855.5" y="3232.3223">[</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="859.5" y="3232.3223">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="103" x="863.5" y="3232.3223">contract #x data</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="58" x="966.5" y="3232.3223">}ciphered</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="1024.5" y="3232.3223">]</text><polygon fill="#0000FF" points="391.5,3269.375,381.5,3273.375,391.5,3277.375,387.5,3273.375" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="385.5" x2="832.5" y1="3273.375" y2="3273.375"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="397.5" y="3268.6328">[</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="401.5" y="3268.6328">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="103" x="405.5" y="3268.6328">contract #x data</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="58" x="508.5" y="3268.6328">}ciphered</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="566.5" y="3268.6328">]</text><polygon fill="#00FF00" points="1302,3329.3066,1312,3333.3066,1302,3337.3066,1306,3333.3066" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;" x1="380.5" x2="1308" y1="3333.3066" y2="3333.3066"/><text fill="#008000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="51" x="387.5" y="3297.9434">SAM #4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="387.5" y="3313.2539">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="419.5" y="3328.5645">- APDU list</text><polygon fill="#181818" points="1736,3358.6172,1746,3362.6172,1736,3366.6172,1740,3362.6172" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1324" x2="1742" y1="3362.6172" y2="3362.6172"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="316" x="1331" y="3357.875">digest update (request - read record (contract #x))</text><polygon fill="#181818" points="1335,3387.9277,1325,3391.9277,1335,3395.9277,1331,3391.9277" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1329" x2="1747" y1="3391.9277" y2="3391.9277"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="163" x="1341" y="3387.1855">[read record (contract #x)]</text><polygon fill="#181818" points="1736,3417.2383,1746,3421.2383,1736,3425.2383,1740,3421.2383" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1324" x2="1742" y1="3421.2383" y2="3421.2383"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="163" x="1331" y="3416.4961">digest update (response -</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="1498" y="3416.4961">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="103" x="1502" y="3416.4961">contract #x data</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="58" x="1605" y="3416.4961">}ciphered</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="1663" y="3416.4961">)</text><polygon fill="#181818" points="1335,3446.5488,1325,3450.5488,1335,3454.5488,1331,3450.5488" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1329" x2="1747" y1="3450.5488" y2="3450.5488"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="111" x="1341" y="3445.8066">[contract #x data]</text><polygon fill="#00FF00" points="391.5,3475.8594,381.5,3479.8594,391.5,3483.8594,387.5,3479.8594" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="385.5" x2="1318" y1="3479.8594" y2="3479.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="274" x="397.5" y="3475.1172">[read record (contract #x), contract #x data]</text><polygon fill="#181818" points="115.5,3612.3438,105.5,3616.3438,115.5,3620.3438,111.5,3616.3438" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="109.5" x2="374.5" y1="3616.3438" y2="3616.3438"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="121.5" y="3504.4277">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127" x="153.5" y="3519.7383">- identification data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="153.5" y="3535.0488">- invalidation status</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="122" x="153.5" y="3550.3594">- environment data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="124" x="153.5" y="3565.6699">- ratification status</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="104" x="153.5" y="3580.9805">- last event data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="119" x="153.5" y="3596.291">- contract list data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="119" x="153.5" y="3611.6016">- contract #x data]</text><line style="stroke:#181818;stroke-width:1.0;" x1="104.5" x2="146.5" y1="3645.6543" y2="3645.6543"/><line style="stroke:#181818;stroke-width:1.0;" x1="146.5" x2="146.5" y1="3645.6543" y2="3658.6543"/><line style="stroke:#181818;stroke-width:1.0;" x1="105.5" x2="146.5" y1="3658.6543" y2="3658.6543"/><polygon fill="#181818" points="115.5,3654.6543,105.5,3658.6543,115.5,3662.6543,111.5,3658.6543" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="182" x="111.5" y="3640.9121">identifies associated counter</text><polygon fill="#181818" points="358.5,3699.2754,368.5,3703.2754,358.5,3707.2754,362.5,3703.2754" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="104.5" x2="364.5" y1="3703.2754" y2="3703.2754"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="111.5" y="3683.2227">prepare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="106" x="169.5" y="3683.2227">card transaction:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="123" x="143.5" y="3698.5332">- reader counter #x</text><polygon fill="#181818" points="115.5,3713.2754,105.5,3717.2754,115.5,3721.2754,111.5,3717.2754" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="109.5" x2="374.5" y1="3717.2754" y2="3717.2754"/><polygon fill="#181818" points="358.5,3742.5859,368.5,3746.5859,358.5,3750.5859,362.5,3746.5859" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="104.5" x2="364.5" y1="3746.5859" y2="3746.5859"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="111.5" y="3741.8438">process</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="69" x="167.5" y="3741.8438">commands</text><polygon fill="#0000FF" points="816.5,3802.5176,826.5,3806.5176,816.5,3810.5176,820.5,3806.5176" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;" x1="380.5" x2="822.5" y1="3806.5176" y2="3806.5176"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="387.5" y="3771.1543">Card #6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="387.5" y="3786.4648">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="419.5" y="3801.7754">- APDU list</text><path d="M761,3821.5176 L1057,3821.5176 L1057,3828.8281 L1047,3838.8281 L761,3838.8281 L761,3821.5176 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="107.2422" style="stroke:#000000;stroke-width:1.5;" width="517" x="761" y="3821.5176"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="251" x="776" y="3835.0859">Card APDU commands inside session</text><path d="M771,3845.8281 L1033,3845.8281 L1033,3853.1387 L1023,3863.1387 L771,3863.1387 L771,3845.8281 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="46.6211" style="stroke:#000000;stroke-width:1.5;" width="497" x="771" y="3845.8281"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="76" x="786" y="3859.3965">anticipated</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="137" x="866" y="3859.3965">SAM APDU response</text><polygon fill="#181818" points="1216.5,3880.4492,1226.5,3884.4492,1216.5,3888.4492,1220.5,3884.4492" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="838.5" x2="1222.5" y1="3884.4492" y2="3884.4492"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="845.5" y="3879.707">read record (counter #x)</text><polygon fill="#181818" points="849.5,3916.7598,839.5,3920.7598,849.5,3924.7598,845.5,3920.7598" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="843.5" x2="1227.5" y1="3920.7598" y2="3920.7598"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="855.5" y="3916.0176">[</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="859.5" y="3916.0176">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="99" x="863.5" y="3916.0176">counter #x data</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="58" x="962.5" y="3916.0176">}ciphered</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="1020.5" y="3916.0176">]</text><polygon fill="#0000FF" points="391.5,3953.0703,381.5,3957.0703,391.5,3961.0703,387.5,3957.0703" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="385.5" x2="832.5" y1="3957.0703" y2="3957.0703"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="397.5" y="3952.3281">[</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="401.5" y="3952.3281">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="99" x="405.5" y="3952.3281">counter #x data</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="58" x="504.5" y="3952.3281">}ciphered</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="562.5" y="3952.3281">]</text><polygon fill="#00FF00" points="1302,4013.002,1312,4017.002,1302,4021.002,1306,4017.002" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;" x1="380.5" x2="1308" y1="4017.002" y2="4017.002"/><text fill="#008000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="51" x="387.5" y="3981.6387">SAM #5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="387.5" y="3996.9492">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="419.5" y="4012.2598">- APDU list</text><polygon fill="#181818" points="1736,4042.3125,1746,4046.3125,1736,4050.3125,1740,4046.3125" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1324" x2="1742" y1="4046.3125" y2="4046.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="312" x="1331" y="4041.5703">digest update (request - read record (counter #x))</text><polygon fill="#181818" points="1335,4071.623,1325,4075.623,1335,4079.623,1331,4075.623" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1329" x2="1747" y1="4075.623" y2="4075.623"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="159" x="1341" y="4070.8809">[read record (counter #x)]</text><polygon fill="#181818" points="1736,4100.9336,1746,4104.9336,1736,4108.9336,1740,4104.9336" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1324" x2="1742" y1="4104.9336" y2="4104.9336"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="163" x="1331" y="4100.1914">digest update (response -</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="1498" y="4100.1914">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="105" x="1502" y="4100.1914">counter #x value</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="58" x="1607" y="4100.1914">}ciphered</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="1665" y="4100.1914">)</text><polygon fill="#181818" points="1335,4130.2441,1325,4134.2441,1335,4138.2441,1331,4134.2441" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1329" x2="1747" y1="4134.2441" y2="4134.2441"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="113" x="1341" y="4129.502">[counter #x value]</text><polygon fill="#00FF00" points="391.5,4159.5547,381.5,4163.5547,391.5,4167.5547,387.5,4163.5547" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="385.5" x2="1318" y1="4163.5547" y2="4163.5547"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="272" x="397.5" y="4158.8125">[read record (counter #x), counter #x value]</text><polygon fill="#181818" points="115.5,4311.3496,105.5,4315.3496,115.5,4319.3496,111.5,4315.3496" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="109.5" x2="374.5" y1="4315.3496" y2="4315.3496"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="121.5" y="4188.123">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127" x="153.5" y="4203.4336">- identification data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="153.5" y="4218.7441">- invalidation status</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="122" x="153.5" y="4234.0547">- environment data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="124" x="153.5" y="4249.3652">- ratification status</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="104" x="153.5" y="4264.6758">- last event data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="119" x="153.5" y="4279.9863">- contract list data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="153.5" y="4295.2969">- contract #x data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="121" x="153.5" y="4310.6074">- counter #x value]</text><line style="stroke:#181818;stroke-width:1.0;" x1="104.5" x2="146.5" y1="4344.6602" y2="4344.6602"/><line style="stroke:#181818;stroke-width:1.0;" x1="146.5" x2="146.5" y1="4344.6602" y2="4357.6602"/><line style="stroke:#181818;stroke-width:1.0;" x1="105.5" x2="146.5" y1="4357.6602" y2="4357.6602"/><polygon fill="#181818" points="115.5,4353.6602,105.5,4357.6602,115.5,4361.6602,111.5,4357.6602" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="141" x="111.5" y="4339.918">defines data to update</text><polygon fill="#181818" points="358.5,4428.9023,368.5,4432.9023,358.5,4436.9023,362.5,4432.9023" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="104.5" x2="364.5" y1="4432.9023" y2="4432.9023"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="111.5" y="4382.2285">prepare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="165.5" y="4382.2285">:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="213" x="143.5" y="4397.5391">- decrease counter #x (new value)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="215" x="143.5" y="4412.8496">- append event record (new event)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="109" x="143.5" y="4428.1602">- release channel</text><polygon fill="#181818" points="115.5,4442.9023,105.5,4446.9023,115.5,4450.9023,111.5,4446.9023" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="109.5" x2="374.5" y1="4446.9023" y2="4446.9023"/><polygon fill="#181818" points="358.5,4472.2129,368.5,4476.2129,358.5,4480.2129,362.5,4476.2129" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="104.5" x2="364.5" y1="4476.2129" y2="4476.2129"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="111.5" y="4471.4707">process</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="128" x="167.5" y="4471.4707">closing (not ratified)</text><line style="stroke:#181818;stroke-width:1.0;" x1="380.5" x2="422.5" y1="4505.5234" y2="4505.5234"/><line style="stroke:#181818;stroke-width:1.0;" x1="422.5" x2="422.5" y1="4505.5234" y2="4518.5234"/><line style="stroke:#181818;stroke-width:1.0;" x1="381.5" x2="422.5" y1="4518.5234" y2="4518.5234"/><polygon fill="#181818" points="391.5,4514.5234,381.5,4518.5234,391.5,4522.5234,387.5,4518.5234" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="234" x="387.5" y="4500.7813">anticipates the future card responses</text><path d="M19,4531.5234 L19,4571.5234 L731,4571.5234 L731,4541.5234 L721,4531.5234 L19,4531.5234 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M721,4531.5234 L721,4541.5234 L731,4541.5234 L721,4531.5234 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="265" x="25" y="4549.0918">If the current value of the counter #x were</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="63" x="294" y="4549.0918">unknown</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="319" x="357" y="4549.0918">, then the transmission of an additional card APDU</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="691" x="25" y="4564.4023">message would be necessary to operate the decrease counter in a different message than the session closing.</text><polygon fill="#00FF00" points="1302,4625.0762,1312,4629.0762,1302,4633.0762,1306,4629.0762" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;" x1="380.5" x2="1308" y1="4629.0762" y2="4629.0762"/><text fill="#008000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="51" x="387.5" y="4593.7129">SAM #6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="387.5" y="4609.0234">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="419.5" y="4624.334">- APDU list</text><polygon fill="#181818" points="1736,4654.3867,1746,4658.3867,1736,4662.3867,1740,4658.3867" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1324" x2="1742" y1="4658.3867" y2="4658.3867"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="400" x="1331" y="4653.6445">digest update (request - decrease counter(counter #x, amount))</text><polygon fill="#181818" points="1335,4683.6973,1325,4687.6973,1335,4691.6973,1331,4687.6973" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1329" x2="1747" y1="4687.6973" y2="4687.6973"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="187" x="1341" y="4682.9551">[decrease counter(counter #x,</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="1532" y="4682.9551">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="48" x="1536" y="4682.9551">amount</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="58" x="1584" y="4682.9551">}ciphered</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="1642" y="4682.9551">]</text><polygon fill="#00FF00" points="391.5,4713.0078,381.5,4717.0078,391.5,4721.0078,387.5,4717.0078" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="385.5" x2="1318" y1="4717.0078" y2="4717.0078"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="397.5" y="4712.2656">[SAM certificate]</text><polygon fill="#0000FF" points="816.5,4772.9395,826.5,4776.9395,816.5,4780.9395,820.5,4776.9395" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;" x1="380.5" x2="822.5" y1="4776.9395" y2="4776.9395"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="387.5" y="4741.5762">Card #7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="387.5" y="4756.8867">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="419.5" y="4772.1973">- APDU list</text><path d="M771,4791.9395 L1067,4791.9395 L1067,4799.25 L1057,4809.25 L771,4809.25 L771,4791.9395 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="75.9316" style="stroke:#000000;stroke-width:1.5;" width="497" x="771" y="4791.9395"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="251" x="786" y="4805.5078">Card APDU commands inside session</text><polygon fill="#181818" points="1216.5,4826.5605,1226.5,4830.5605,1216.5,4834.5605,1220.5,4830.5605" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="838.5" x2="1222.5" y1="4830.5605" y2="4830.5605"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="183" x="845.5" y="4825.8184">decrease counter(counter #x,</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="1032.5" y="4825.8184">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="48" x="1036.5" y="4825.8184">amount</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="58" x="1084.5" y="4825.8184">}ciphered</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="1142.5" y="4825.8184">)</text><polygon fill="#181818" points="849.5,4855.8711,839.5,4859.8711,849.5,4863.8711,845.5,4859.8711" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="843.5" x2="1227.5" y1="4859.8711" y2="4859.8711"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="855.5" y="4855.1289">[</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="859.5" y="4855.1289">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="863.5" y="4855.1289">new counter value</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="58" x="977.5" y="4855.1289">}ciphered</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="1035.5" y="4855.1289">]</text><polygon fill="#0000FF" points="391.5,4892.1816,381.5,4896.1816,391.5,4900.1816,387.5,4896.1816" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="385.5" x2="832.5" y1="4896.1816" y2="4896.1816"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="397.5" y="4891.4395">[card certificate]</text><polygon fill="#00FF00" points="1302,4952.1133,1312,4956.1133,1302,4960.1133,1306,4956.1133" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;" x1="380.5" x2="1308" y1="4956.1133" y2="4956.1133"/><text fill="#008000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="51" x="387.5" y="4920.75">SAM #7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="387.5" y="4936.0605">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="419.5" y="4951.3711">- APDU list</text><polygon fill="#181818" points="1736,4981.4238,1746,4985.4238,1736,4989.4238,1740,4985.4238" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1324" x2="1742" y1="4985.4238" y2="4985.4238"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="163" x="1331" y="4980.6816">digest update (response -</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="1498" y="4980.6816">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="1502" y="4980.6816">new counter value</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="58" x="1616" y="4980.6816">}ciphered</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="1674" y="4980.6816">)</text><polygon fill="#181818" points="1335,5010.7344,1325,5014.7344,1335,5018.7344,1331,5014.7344" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1329" x2="1747" y1="5014.7344" y2="5014.7344"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="122" x="1341" y="5009.9922">[new counter value]</text><polygon fill="#181818" points="1736,5040.0449,1746,5044.0449,1736,5048.0449,1740,5044.0449" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1324" x2="1742" y1="5044.0449" y2="5044.0449"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="324" x="1331" y="5039.3027">digest update (request - append event record(data))</text><polygon fill="#181818" points="1335,5069.3555,1325,5073.3555,1335,5077.3555,1331,5073.3555" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1329" x2="1747" y1="5073.3555" y2="5073.3555"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="132" x="1341" y="5068.6133">append event record(</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="1473" y="5068.6133">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="56" x="1477" y="5068.6133">new data</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="58" x="1533" y="5068.6133">}ciphered</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="1591" y="5068.6133">)</text><path d="M1258,5088.3555 L1530,5088.3555 L1530,5095.666 L1520,5105.666 L1258,5105.666 L1258,5088.3555 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="75.9316" style="stroke:#000000;stroke-width:1.5;" width="536" x="1258" y="5088.3555"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="76" x="1273" y="5101.9238">anticipated</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="147" x="1353" y="5101.9238">Card APDU responses</text><polygon fill="#181818" points="1736,5122.9766,1746,5126.9766,1736,5130.9766,1740,5126.9766" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1324" x2="1742" y1="5126.9766" y2="5126.9766"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="193" x="1331" y="5122.2344">digest update (response - ack)</text><polygon fill="#181818" points="1335,5152.2871,1325,5156.2871,1335,5160.2871,1331,5156.2871" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1329" x2="1747" y1="5156.2871" y2="5156.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="22" x="1341" y="5151.5449">ack</text><polygon fill="#181818" points="1736,5188.5977,1746,5192.5977,1736,5196.5977,1740,5192.5977" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1324" x2="1742" y1="5192.5977" y2="5192.5977"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="76" x="1331" y="5187.8555">digest close</text><polygon fill="#181818" points="1335,5217.9082,1325,5221.9082,1335,5225.9082,1331,5221.9082" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1329" x2="1747" y1="5221.9082" y2="5221.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="1341" y="5217.166">[SAM certificate]</text><polygon fill="#00FF00" points="391.5,5247.2188,381.5,5251.2188,391.5,5255.2188,387.5,5251.2188" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="385.5" x2="1318" y1="5251.2188" y2="5251.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="397.5" y="5246.4766">[SAM certificate]</text><polygon fill="#0000FF" points="816.5,5307.1504,826.5,5311.1504,816.5,5315.1504,820.5,5311.1504" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;" x1="380.5" x2="822.5" y1="5311.1504" y2="5311.1504"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="387.5" y="5275.7871">Card #8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="387.5" y="5291.0977">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="419.5" y="5306.4082">- APDU list</text><path d="M771,5326.1504 L1067,5326.1504 L1067,5333.4609 L1057,5343.4609 L771,5343.4609 L771,5326.1504 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="75.9316" style="stroke:#000000;stroke-width:1.5;" width="497" x="771" y="5326.1504"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="251" x="786" y="5339.7188">Card APDU commands inside session</text><polygon fill="#181818" points="1216.5,5360.7715,1226.5,5364.7715,1216.5,5368.7715,1220.5,5364.7715" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="838.5" x2="1222.5" y1="5364.7715" y2="5364.7715"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="136" x="845.5" y="5360.0293">append record (event,</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="985.5" y="5360.0293">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="27" x="989.5" y="5360.0293">data</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="58" x="1016.5" y="5360.0293">}ciphered</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="1074.5" y="5360.0293">)</text><polygon fill="#181818" points="849.5,5390.082,839.5,5394.082,849.5,5398.082,845.5,5394.082" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="843.5" x2="1227.5" y1="5394.082" y2="5394.082"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="22" x="855.5" y="5389.3398">ack</text><polygon fill="#181818" points="1216.5,5433.3926,1226.5,5437.3926,1216.5,5441.3926,1220.5,5437.3926" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="838.5" x2="1222.5" y1="5437.3926" y2="5437.3926"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="335" x="845.5" y="5432.6504">close secure session (SAM certificate, as non ratified)</text><polygon fill="#181818" points="849.5,5462.7031,839.5,5466.7031,849.5,5470.7031,845.5,5466.7031" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="843.5" x2="1227.5" y1="5466.7031" y2="5466.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="855.5" y="5461.9609">[card certificate]</text><polygon fill="#181818" points="1216.5,5492.0137,1226.5,5496.0137,1216.5,5500.0137,1220.5,5496.0137" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="838.5" x2="1222.5" y1="5496.0137" y2="5496.0137"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="845.5" y="5491.2715">ratification command</text><polygon fill="#181818" points="849.5,5506.0137,839.5,5510.0137,849.5,5514.0137,845.5,5510.0137" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="843.5" x2="1227.5" y1="5510.0137" y2="5510.0137"/><polygon fill="#181818" points="1216.5,5535.3242,1226.5,5539.3242,1216.5,5543.3242,1220.5,5539.3242" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="838.5" x2="1222.5" y1="5539.3242" y2="5539.3242"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="845.5" y="5534.582">close card channel</text><polygon fill="#181818" points="849.5,5549.3242,839.5,5553.3242,849.5,5557.3242,845.5,5553.3242" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="843.5" x2="1232.5" y1="5553.3242" y2="5553.3242"/><polygon fill="#0000FF" points="391.5,5578.6348,381.5,5582.6348,391.5,5586.6348,387.5,5582.6348" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="385.5" x2="832.5" y1="5582.6348" y2="5582.6348"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="397.5" y="5577.8926">[card certificate]</text><polygon fill="#00FF00" points="1302,5638.5664,1312,5642.5664,1302,5646.5664,1306,5642.5664" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;" x1="380.5" x2="1308" y1="5642.5664" y2="5642.5664"/><text fill="#008000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="51" x="387.5" y="5607.2031">SAM #8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="387.5" y="5622.5137">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="419.5" y="5637.8242">- APDU list</text><polygon fill="#181818" points="1736,5667.877,1746,5671.877,1736,5675.877,1740,5671.877" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1324" x2="1742" y1="5671.877" y2="5671.877"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="227" x="1331" y="5667.1348">digest authenticate (card certificate)</text><polygon fill="#181818" points="1335,5697.1875,1325,5701.1875,1335,5705.1875,1331,5701.1875" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1329" x2="1747" y1="5701.1875" y2="5701.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="142" x="1341" y="5696.4453">[authentication status]</text><polygon fill="#00FF00" points="391.5,5726.498,381.5,5730.498,391.5,5734.498,387.5,5730.498" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="385.5" x2="1318" y1="5730.498" y2="5730.498"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="397.5" y="5725.7559">[authentification status]</text><polygon fill="#181818" points="115.5,5893.6035,105.5,5897.6035,115.5,5901.6035,111.5,5897.6035" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="109.5" x2="374.5" y1="5897.6035" y2="5897.6035"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="121.5" y="5755.0664">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127" x="153.5" y="5770.377">- identification data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="153.5" y="5785.6875">- invalidation status</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="122" x="153.5" y="5800.998">- environment data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="153.5" y="5816.3086">-</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" text-decoration="line-through" textLength="112" x="165.5" y="5816.3086">ratification status</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="167" x="153.5" y="5831.6191">- last event data (updated)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="119" x="153.5" y="5846.9297">- contract list data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="153.5" y="5862.2402">- contract #x data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="178" x="153.5" y="5877.5508">- counter #x data (updated)]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="143" x="121.5" y="5892.8613">authentification status</text><!--MD5=[c755f4ea3a8b58327ce7633d1cc8c68a]
@startuml

'skinparam ClassBorderColor #F1C40F
skinparam ClassBorderColor #D4AC0D
skinparam stereotypeABorderColor #A9DCDF
skinparam stereotypeIBorderColor #B4A7E5
skinparam stereotypeCBorderColor #ADD1B2
skinparam stereotypeEBorderColor #EB93DF
skinparam shadowing false

skinparam StateBorderColor #D4AC0D
skinparam ActivityBorderColor #D4AC0D

' Red
skinparam ClassBackgroundColor<<red>> #FDEDEC
skinparam ClassBorderColor<<red>> #E74C3C
hide <<red>> stereotype
' Purple
skinparam ClassBackgroundColor<<purple>> #F4ECF7
skinparam ClassBorderColor<<purple>> #8E44AD
hide <<purple>> stereotype
' blue
skinparam ClassBackgroundColor<<blue>> #EBF5FB
skinparam ClassBorderColor<<blue>> #3498DB
hide <<blue>> stereotype
' Green
skinparam ClassBackgroundColor<<green>> #EAFAF1
skinparam ClassBorderColor<<green>> #2ECC71
hide <<green>> stereotype

' Orange
skinparam ClassBackgroundColor<<orange>> #FDF2E9
skinparam ClassBorderColor<<orange>> #E67E22
hide <<orange>> stereotype

' Grey
skinparam ClassBackgroundColor<<grey>> #EAECEE
skinparam ClassBorderColor<<grey>> #2C3E50
hide <<grey>> stereotype

actor "Ticketing Application" as app #gold
participant "Calypso API" as capi #pink
participant "Reader API" as rapi #pink
participant "Calypso Card\nReader" as cardReader #lightBlue
boundary "**Card**" as card #lightBlue
participant "Calypso SAM\nReader" as samReader #lightGreen
boundary "selected\n**SAM**" as sam #lightGreen

activate app #gold
activate sam #lightGreen

== Card selection & identification ==

note over capi
    Only reads data inside the session.
end note

app->capi: <font color=red>**prepare**</font> card selection scenario:\n\t- filter by specific AID\n\t- filter invalidated card status
activate capi  #pink
capi- ->app
deactivate capi

app->rapi: <font color=red>**process**</font> explicit card selection scenario
activate rapi  #pink
rapi-[#0000FF]>cardReader: <font color=blue>**Card #1**</font>\ntransmit selection request\n\t- card selector
activate cardReader #lightBlue

cardReader->card: open card channel
activate card #lightBlue
card- ->cardReader
cardReader->card: select application (aid)
card- ->cardReader: [card FCI]
cardReader->cardReader: checks invalidation status

cardReader- -[#0000FF]>rapi: receive selection response
deactivate cardReader

rapi- ->app: selected active SmartCard image
deactivate rapi

app->capi: **cast** Calypso card
activate capi  #pink
capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status]

deactivate capi

== Card secure transaction ==

app->app: **instantiate** Calypso card transaction:\n\t- Calypso card resource\n\t- Calypso SAM resource

app->capi: <font color=red>**prepare**</font> card transaction:\n\t- read environment file\n\t- manage session for encryption
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> opening (DEBIT access level)
activate capi  #pink

capi-[#00FF00]>samReader: <font color=green>**SAM #1**<font color=red>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: select diversifier (card serial)
sam- ->samReader
samReader->sam: get challenge
sam- ->samReader: [SAM challenge]
samReader-[#00FF00]->capi: [SAM challenge]
deactivate samReader

capi-[#0000FF]>cardReader: <font color=blue>**Card #2**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
note over cardReader
    Optimization: environment file read through the session opening.
end note

    cardReader->card: open secure session (card debit key,\n\tSAM challenge,\n\tSFI environment to read)
    card- ->cardReader: [card challenge & environment data]
end

group#AliceBlue #AliceBlue Data Encryption

note over cardReader
    command outside of the SMAC (no Digest Update)
end note

    cardReader->card: manage secure session (authentication off, encryption on)
    card- ->cardReader: ack encryption active

cardReader- -[#0000FF]>capi: [card challenge]
deactivate cardReader
capi->capi: checks ratification status

capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status\n\t- environment data\n\t- ratification status\n\t- encryption active]
deactivate capi



app->capi: <font color=red>**prepare**</font> card transaction:\n\t- read last event
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> commands
activate capi  #pink

capi-[#0000FF]>cardReader: <font color=blue>**Card #3**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    group <font color=red>**anticipated**</font> SAM APDU response
        note over cardReader
            command without ciphered DataIn
        end note
        cardReader->card: read record (last event)
    end
    card- ->cardReader: [<font color=red>{</font>last event data<font color=red>}ciphered</font>]
end

cardReader- -[#0000FF]>capi: [<font color=red>{</font>last event data<font color=red>}ciphered</font>]
deactivate cardReader

capi-[#00FF00]>samReader: <font color=green>**SAM #2**<font color=red>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: digest init (opening data)
sam- ->samReader
samReader->sam: digest update (request - read record (last event))
    note over samReader
        useless, all bytes of the command are in plain
    end note

sam- ->samReader: [read record (last event)]

samReader->sam: digest update (response - <font color=red>{</font>last event data<font color=red>}ciphered</font>)
sam- ->samReader: [last event data]
samReader-[#00FF00]->capi: [read record (last event), last event data]
deactivate samReader


capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status\n\t- environment data\n\t- ratification status\n\t- last event data]
deactivate capi

app->app: checks transaction recovery status

app->capi: <font color=red>**prepare**</font> card transaction:\n\t- read contract list
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> commands
activate capi  #pink

capi-[#0000FF]>cardReader: <font color=blue>**Card #4**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    group <font color=red>**anticipated**</font> SAM APDU response
        cardReader->card: read record (contract list)
    end
    card- ->cardReader: [<font color=red>{</font>contract list data<font color=red>}ciphered</font>]
end

cardReader- -[#0000FF]>capi: [<font color=red>{</font>contract list data<font color=red>}ciphered</font>]
deactivate cardReader

capi-[#00FF00]>samReader: <font color=green>**SAM #3**<font color=red>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: digest update (request - read record (contract list))
sam- ->samReader: [read record (contract list)]

samReader->sam: digest update (response - <font color=red>{</font>contract list data<font color=red>}ciphered</font>)
sam- ->samReader: [contract list data]
samReader-[#00FF00]->capi: [read record (contract list), contract list data]
deactivate samReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status\n\t- environment data\n\t- ratification status\n\t- last event data\n\t- contract list data]
deactivate capi

app->app: identifies contract

app->capi: <font color=red>**prepare**</font> card transaction:\n\t- read contract #x
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> commands
activate capi  #pink

capi-[#0000FF]>cardReader: <font color=blue>**Card #5**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    group <font color=red>**anticipated**</font> SAM APDU response
        cardReader->card: read record (contract #x)
    end

    card- ->cardReader: [<font color=red>{</font>contract #x data<font color=red>}ciphered</font>]
end

cardReader- -[#0000FF]>capi: [<font color=red>{</font>contract #x data<font color=red>}ciphered</font>]
deactivate cardReader

capi-[#00FF00]>samReader: <font color=green>**SAM #4**<font color=red>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: digest update (request - read record (contract #x))
sam- ->samReader: [read record (contract #x)]

samReader->sam: digest update (response - <font color=red>{</font>contract #x data<font color=red>}ciphered</font>)
sam- ->samReader: [contract #x data]
samReader-[#00FF00]->capi: [read record (contract #x), contract #x data]
deactivate samReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status\n\t- environment data\n\t- ratification status\n\t- last event data\n\t- contract list data\n\t- contract #x data]
deactivate capi

app->app: identifies associated counter

app->capi: <font color=red>**prepare**</font> card transaction:\n\t- reader counter #x
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> commands
activate capi  #pink

capi-[#0000FF]>cardReader: <font color=blue>**Card #6**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    group <font color=red>**anticipated**</font> SAM APDU response
        cardReader->card: read record (counter #x)
    end

    card- ->cardReader: [<font color=red>{</font>counter #x data<font color=red>}ciphered</font>]
end

cardReader- -[#0000FF]>capi: [<font color=red>{</font>counter #x data<font color=red>}ciphered</font>]
deactivate cardReader

capi-[#00FF00]>samReader: <font color=green>**SAM #5**<font color=red>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: digest update (request - read record (counter #x))
sam- ->samReader: [read record (counter #x)]

samReader->sam: digest update (response - <font color=red>{</font>counter #x value<font color=red>}ciphered</font>)
sam- ->samReader: [counter #x value]
samReader-[#00FF00]->capi: [read record (counter #x), counter #x value]
deactivate samReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status\n\t- environment data\n\t- ratification status\n\t- last event data\n\t- contract list data\n\t- contract #x data\n\t- counter #x value]
deactivate capi

app->app: defines data to update

app->capi: <font color=red>**prepare**</font>:\n\t- decrease counter #x (new value)\n\t- append event record (new event)\n\t- release channel
'app->capi: <font color=red>**prepare**</font>:\n\t- append event record (new event)\n\t- decrease counter #x (new value)\n\t- release channel
activate capi  #pink

capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> closing (not ratified)
activate capi  #pink
capi->capi: anticipates the future card responses
note over capi
    If the current value of the counter #x were **unknown**, then the transmission of an additional card APDU
    message would be necessary to operate the decrease counter in a different message than the session closing.
end note

capi-[#00FF00]>samReader: <font color=green>**SAM #6**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen

samReader->sam: digest update (request - decrease counter(counter #x, amount))
sam- ->samReader: [decrease counter(counter #x, <font color=red>{</font>amount<font color=red>}ciphered</font>]

note over samReader
    'ciphered' decrease counter response can't be anticipated
end note

samReader-[#00FF00]->capi: [SAM certificate]
deactivate samReader

capi-[#0000FF]>cardReader: <font color=blue>**Card #7**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: decrease counter(counter #x, <font color=red>{</font>amount<font color=red>}ciphered</font>)
    card- ->cardReader: [<font color=red>{</font>new counter value<font color=red>}ciphered</font>]
end

cardReader-[#0000FF]->capi: [card certificate]
deactivate cardReader

capi-[#00FF00]>samReader: <font color=green>**SAM #7**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen

samReader->sam: digest update (response - <font color=red>{</font>new counter value<font color=red>}ciphered</font>)
sam- ->samReader: [new counter value]
samReader->sam: digest update (request - append event record(data))
sam- ->samReader: append event record(<font color=red>{</font>new data<font color=red>}ciphered</font>)
group <font color=red>**anticipated**</font> Card APDU responses
    samReader->sam: digest update (response - ack)
    sam- ->samReader: ack
end
samReader->sam: digest close
sam- ->samReader: [SAM certificate]

samReader-[#00FF00]->capi: [SAM certificate]
deactivate samReader

capi-[#0000FF]>cardReader: <font color=blue>**Card #8**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: append record (event, <font color=red>{</font>data<font color=red>}ciphered</font>)
    card- ->cardReader: ack
end

end

cardReader->card: close secure session (SAM certificate, as non ratified)
card- ->cardReader: [card certificate]
cardReader->card: ratification command
card- ->cardReader
cardReader->card: close card channel
card- ->cardReader
deactivate card

cardReader-[#0000FF]->capi: [card certificate]
deactivate cardReader

capi-[#00FF00]>samReader: <font color=green>**SAM #8**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: digest authenticate (card certificate)
sam- ->samReader: [authentication status]

samReader-[#00FF00]->capi: [authentification status]
deactivate samReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status\n\t- environment data\n\t- - -ratification status- -\n\t- last event data (updated)\n\t- contract list data\n\t- contract #x data\n\t- counter #x data (updated)]\nauthentification status
deactivate capi
@enduml

@startuml

skinparam ClassBorderColor #D4AC0D
skinparam stereotypeABorderColor #A9DCDF
skinparam stereotypeIBorderColor #B4A7E5
skinparam stereotypeCBorderColor #ADD1B2
skinparam stereotypeEBorderColor #EB93DF
skinparam shadowing false

skinparam StateBorderColor #D4AC0D
skinparam ActivityBorderColor #D4AC0D

skinparam ClassBackgroundColor<<red>> #FDEDEC
skinparam ClassBorderColor<<red>> #E74C3C
hide <<red>> stereotype
skinparam ClassBackgroundColor<<purple>> #F4ECF7
skinparam ClassBorderColor<<purple>> #8E44AD
hide <<purple>> stereotype
skinparam ClassBackgroundColor<<blue>> #EBF5FB
skinparam ClassBorderColor<<blue>> #3498DB
hide <<blue>> stereotype
skinparam ClassBackgroundColor<<green>> #EAFAF1
skinparam ClassBorderColor<<green>> #2ECC71
hide <<green>> stereotype

skinparam ClassBackgroundColor<<orange>> #FDF2E9
skinparam ClassBorderColor<<orange>> #E67E22
hide <<orange>> stereotype

skinparam ClassBackgroundColor<<grey>> #EAECEE
skinparam ClassBorderColor<<grey>> #2C3E50
hide <<grey>> stereotype

actor "Ticketing Application" as app #gold
participant "Calypso API" as capi #pink
participant "Reader API" as rapi #pink
participant "Calypso Card\nReader" as cardReader #lightBlue
boundary "**Card**" as card #lightBlue
participant "Calypso SAM\nReader" as samReader #lightGreen
boundary "selected\n**SAM**" as sam #lightGreen

activate app #gold
activate sam #lightGreen

== Card selection & identification ==

note over capi
    Only reads data inside the session.
end note

app->capi: <font color=red>**prepare**</font> card selection scenario:\n\t- filter by specific AID\n\t- filter invalidated card status
activate capi  #pink
capi- ->app
deactivate capi

app->rapi: <font color=red>**process**</font> explicit card selection scenario
activate rapi  #pink
rapi-[#0000FF]>cardReader: <font color=blue>**Card #1**</font>\ntransmit selection request\n\t- card selector
activate cardReader #lightBlue

cardReader->card: open card channel
activate card #lightBlue
card- ->cardReader
cardReader->card: select application (aid)
card- ->cardReader: [card FCI]
cardReader->cardReader: checks invalidation status

cardReader- -[#0000FF]>rapi: receive selection response
deactivate cardReader

rapi- ->app: selected active SmartCard image
deactivate rapi

app->capi: **cast** Calypso card
activate capi  #pink
capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status]

deactivate capi

== Card secure transaction ==

app->app: **instantiate** Calypso card transaction:\n\t- Calypso card resource\n\t- Calypso SAM resource

app->capi: <font color=red>**prepare**</font> card transaction:\n\t- read environment file\n\t- manage session for encryption
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> opening (DEBIT access level)
activate capi  #pink

capi-[#00FF00]>samReader: <font color=green>**SAM #1**<font color=red>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: select diversifier (card serial)
sam- ->samReader
samReader->sam: get challenge
sam- ->samReader: [SAM challenge]
samReader-[#00FF00]->capi: [SAM challenge]
deactivate samReader

capi-[#0000FF]>cardReader: <font color=blue>**Card #2**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
note over cardReader
    Optimization: environment file read through the session opening.
end note

    cardReader->card: open secure session (card debit key,\n\tSAM challenge,\n\tSFI environment to read)
    card- ->cardReader: [card challenge & environment data]
end

group#AliceBlue #AliceBlue Data Encryption

note over cardReader
    command outside of the SMAC (no Digest Update)
end note

    cardReader->card: manage secure session (authentication off, encryption on)
    card- ->cardReader: ack encryption active

cardReader- -[#0000FF]>capi: [card challenge]
deactivate cardReader
capi->capi: checks ratification status

capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status\n\t- environment data\n\t- ratification status\n\t- encryption active]
deactivate capi



app->capi: <font color=red>**prepare**</font> card transaction:\n\t- read last event
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> commands
activate capi  #pink

capi-[#0000FF]>cardReader: <font color=blue>**Card #3**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    group <font color=red>**anticipated**</font> SAM APDU response
        note over cardReader
            command without ciphered DataIn
        end note
        cardReader->card: read record (last event)
    end
    card- ->cardReader: [<font color=red>{</font>last event data<font color=red>}ciphered</font>]
end

cardReader- -[#0000FF]>capi: [<font color=red>{</font>last event data<font color=red>}ciphered</font>]
deactivate cardReader

capi-[#00FF00]>samReader: <font color=green>**SAM #2**<font color=red>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: digest init (opening data)
sam- ->samReader
samReader->sam: digest update (request - read record (last event))
    note over samReader
        useless, all bytes of the command are in plain
    end note

sam- ->samReader: [read record (last event)]

samReader->sam: digest update (response - <font color=red>{</font>last event data<font color=red>}ciphered</font>)
sam- ->samReader: [last event data]
samReader-[#00FF00]->capi: [read record (last event), last event data]
deactivate samReader


capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status\n\t- environment data\n\t- ratification status\n\t- last event data]
deactivate capi

app->app: checks transaction recovery status

app->capi: <font color=red>**prepare**</font> card transaction:\n\t- read contract list
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> commands
activate capi  #pink

capi-[#0000FF]>cardReader: <font color=blue>**Card #4**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    group <font color=red>**anticipated**</font> SAM APDU response
        cardReader->card: read record (contract list)
    end
    card- ->cardReader: [<font color=red>{</font>contract list data<font color=red>}ciphered</font>]
end

cardReader- -[#0000FF]>capi: [<font color=red>{</font>contract list data<font color=red>}ciphered</font>]
deactivate cardReader

capi-[#00FF00]>samReader: <font color=green>**SAM #3**<font color=red>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: digest update (request - read record (contract list))
sam- ->samReader: [read record (contract list)]

samReader->sam: digest update (response - <font color=red>{</font>contract list data<font color=red>}ciphered</font>)
sam- ->samReader: [contract list data]
samReader-[#00FF00]->capi: [read record (contract list), contract list data]
deactivate samReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status\n\t- environment data\n\t- ratification status\n\t- last event data\n\t- contract list data]
deactivate capi

app->app: identifies contract

app->capi: <font color=red>**prepare**</font> card transaction:\n\t- read contract #x
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> commands
activate capi  #pink

capi-[#0000FF]>cardReader: <font color=blue>**Card #5**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    group <font color=red>**anticipated**</font> SAM APDU response
        cardReader->card: read record (contract #x)
    end

    card- ->cardReader: [<font color=red>{</font>contract #x data<font color=red>}ciphered</font>]
end

cardReader- -[#0000FF]>capi: [<font color=red>{</font>contract #x data<font color=red>}ciphered</font>]
deactivate cardReader

capi-[#00FF00]>samReader: <font color=green>**SAM #4**<font color=red>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: digest update (request - read record (contract #x))
sam- ->samReader: [read record (contract #x)]

samReader->sam: digest update (response - <font color=red>{</font>contract #x data<font color=red>}ciphered</font>)
sam- ->samReader: [contract #x data]
samReader-[#00FF00]->capi: [read record (contract #x), contract #x data]
deactivate samReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status\n\t- environment data\n\t- ratification status\n\t- last event data\n\t- contract list data\n\t- contract #x data]
deactivate capi

app->app: identifies associated counter

app->capi: <font color=red>**prepare**</font> card transaction:\n\t- reader counter #x
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> commands
activate capi  #pink

capi-[#0000FF]>cardReader: <font color=blue>**Card #6**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    group <font color=red>**anticipated**</font> SAM APDU response
        cardReader->card: read record (counter #x)
    end

    card- ->cardReader: [<font color=red>{</font>counter #x data<font color=red>}ciphered</font>]
end

cardReader- -[#0000FF]>capi: [<font color=red>{</font>counter #x data<font color=red>}ciphered</font>]
deactivate cardReader

capi-[#00FF00]>samReader: <font color=green>**SAM #5**<font color=red>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: digest update (request - read record (counter #x))
sam- ->samReader: [read record (counter #x)]

samReader->sam: digest update (response - <font color=red>{</font>counter #x value<font color=red>}ciphered</font>)
sam- ->samReader: [counter #x value]
samReader-[#00FF00]->capi: [read record (counter #x), counter #x value]
deactivate samReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status\n\t- environment data\n\t- ratification status\n\t- last event data\n\t- contract list data\n\t- contract #x data\n\t- counter #x value]
deactivate capi

app->app: defines data to update

app->capi: <font color=red>**prepare**</font>:\n\t- decrease counter #x (new value)\n\t- append event record (new event)\n\t- release channel
activate capi  #pink

capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> closing (not ratified)
activate capi  #pink
capi->capi: anticipates the future card responses
note over capi
    If the current value of the counter #x were **unknown**, then the transmission of an additional card APDU
    message would be necessary to operate the decrease counter in a different message than the session closing.
end note

capi-[#00FF00]>samReader: <font color=green>**SAM #6**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen

samReader->sam: digest update (request - decrease counter(counter #x, amount))
sam- ->samReader: [decrease counter(counter #x, <font color=red>{</font>amount<font color=red>}ciphered</font>]

note over samReader
end note

samReader-[#00FF00]->capi: [SAM certificate]
deactivate samReader

capi-[#0000FF]>cardReader: <font color=blue>**Card #7**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: decrease counter(counter #x, <font color=red>{</font>amount<font color=red>}ciphered</font>)
    card- ->cardReader: [<font color=red>{</font>new counter value<font color=red>}ciphered</font>]
end

cardReader-[#0000FF]->capi: [card certificate]
deactivate cardReader

capi-[#00FF00]>samReader: <font color=green>**SAM #7**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen

samReader->sam: digest update (response - <font color=red>{</font>new counter value<font color=red>}ciphered</font>)
sam- ->samReader: [new counter value]
samReader->sam: digest update (request - append event record(data))
sam- ->samReader: append event record(<font color=red>{</font>new data<font color=red>}ciphered</font>)
group <font color=red>**anticipated**</font> Card APDU responses
    samReader->sam: digest update (response - ack)
    sam- ->samReader: ack
end
samReader->sam: digest close
sam- ->samReader: [SAM certificate]

samReader-[#00FF00]->capi: [SAM certificate]
deactivate samReader

capi-[#0000FF]>cardReader: <font color=blue>**Card #8**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: append record (event, <font color=red>{</font>data<font color=red>}ciphered</font>)
    card- ->cardReader: ack
end

end

cardReader->card: close secure session (SAM certificate, as non ratified)
card- ->cardReader: [card certificate]
cardReader->card: ratification command
card- ->cardReader
cardReader->card: close card channel
card- ->cardReader
deactivate card

cardReader-[#0000FF]->capi: [card certificate]
deactivate cardReader

capi-[#00FF00]>samReader: <font color=green>**SAM #8**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: digest authenticate (card certificate)
sam- ->samReader: [authentication status]

samReader-[#00FF00]->capi: [authentification status]
deactivate samReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status\n\t- environment data\n\t- - -ratification status- -\n\t- last event data (updated)\n\t- contract list data\n\t- contract #x data\n\t- counter #x data (updated)]\nauthentification status
deactivate capi
@enduml

PlantUML version 1.2022.7(Mon Aug 22 21:01:30 RET 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: fr
Country: FR
--></g></svg>