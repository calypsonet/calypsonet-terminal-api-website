<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="3142px" preserveAspectRatio="none" style="width:1493px;height:3142px;background:#FFFFFF;" version="1.1" viewBox="0 0 1493 3142" width="1493px" zoomAndPan="magnify"><defs/><g><rect fill="#FFD700" height="2961.4707" style="stroke:#181818;stroke-width:1.0;" width="10" x="92.5" y="91.4883"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="355.5" y="237.3516"/><rect fill="#FFC0CB" height="75.2422" style="stroke:#181818;stroke-width:1.0;" width="10" x="355.5" y="736.6309"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="355.5" y="1038.668"/><rect fill="#FFC0CB" height="659.3848" style="stroke:#181818;stroke-width:1.0;" width="10" x="355.5" y="1081.9785"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="355.5" y="1816.6055"/><rect fill="#FFC0CB" height="1184.043" style="stroke:#181818;stroke-width:1.0;" width="10" x="355.5" y="1859.916"/><rect fill="#FFC0CB" height="426.6582" style="stroke:#181818;stroke-width:1.0;" width="10" x="613.5" y="280.6621"/><rect fill="#ADD8E6" height="322.1055" style="stroke:#181818;stroke-width:1.0;" width="10" x="813.5" y="355.9043"/><rect fill="#ADD8E6" height="302.416" style="stroke:#181818;stroke-width:1.0;" width="10" x="813.5" y="1333.084"/><rect fill="#ADD8E6" height="307.7949" style="stroke:#181818;stroke-width:1.0;" width="10" x="813.5" y="2451.8164"/><rect fill="#ADD8E6" height="2345.0859" style="stroke:#181818;stroke-width:1.0;" width="10" x="1083.5" y="385.2148"/><rect fill="#90EE90" height="131.2422" style="stroke:#181818;stroke-width:1.0;" width="10" x="1169" y="1141.9102"/><rect fill="#90EE90" height="379.1055" style="stroke:#181818;stroke-width:1.0;" width="10" x="1169" y="2012.7793"/><rect fill="#90EE90" height="87.9316" style="stroke:#181818;stroke-width:1.0;" width="10" x="1169" y="2819.543"/><rect fill="#90EE90" height="2961.4707" style="stroke:#181818;stroke-width:1.0;" width="10" x="1430" y="91.4883"/><rect height="134.5527" style="stroke:#000000;stroke-width:1.5;fill:none;" width="367" x="756" y="515.1465"/><rect height="259.1055" style="stroke:#000000;stroke-width:1.5;fill:none;" width="532" x="591" y="1348.084"/><rect height="103.9316" style="stroke:#000000;stroke-width:1.5;fill:none;" width="363" x="1113" y="2201.0215"/><rect height="119.2422" style="stroke:#000000;stroke-width:1.5;fill:none;" width="367" x="756" y="2466.8164"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="97" x2="97" y1="81.4883" y2="3061.959"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="360.5" x2="360.5" y1="81.4883" y2="3061.959"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="618.5" x2="618.5" y1="81.4883" y2="3061.959"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="818" x2="818" y1="81.4883" y2="3061.959"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="1088" x2="1088" y1="81.4883" y2="3061.959"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="1174" x2="1174" y1="81.4883" y2="3061.959"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="1435" x2="1435" y1="81.4883" y2="3061.959"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="145" x="22" y="78.5352">Ticketing Application</text><ellipse cx="97.5" cy="13.5" fill="#FFD700" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M97.5,21.5 L97.5,48.5 M84.5,29.5 L110.5,29.5 M97.5,48.5 L84.5,63.5 M97.5,48.5 L110.5,63.5 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="145" x="22" y="3074.4941">Ticketing Application</text><ellipse cx="97.5" cy="3085.9473" fill="#FFD700" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M97.5,3093.9473 L97.5,3120.9473 M84.5,3101.9473 L110.5,3101.9473 M97.5,3120.9473 L84.5,3135.9473 M97.5,3120.9473 L110.5,3135.9473 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#FFC0CB" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="94" x="313.5" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="80" x="320.5" y="70.5352">Calypso API</text><rect fill="#FFC0CB" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="94" x="313.5" y="3060.959"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="80" x="320.5" y="3081.4941">Calypso API</text><rect fill="#FFC0CB" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="88" x="574.5" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="74" x="581.5" y="70.5352">Reader API</text><rect fill="#FFC0CB" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="88" x="574.5" y="3060.959"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="74" x="581.5" y="3081.4941">Reader API</text><rect fill="#ADD8E6" height="46.9766" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="105" x="766" y="33.5117"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="773" y="54.0469">Calypso Card</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48" x="794.5" y="70.5352">Reader</text><rect fill="#ADD8E6" height="46.9766" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="105" x="766" y="3060.959"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="773" y="3081.4941">Calypso Card</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48" x="794.5" y="3097.9824">Reader</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="33" x="1069" y="78.5352">Card</text><path d="M1068,37 L1068,61 M1068,49 L1085,49 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><ellipse cx="1097" cy="49" fill="#ADD8E6" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="33" x="1069" y="3074.4941">Card</text><path d="M1068,3081.4473 L1068,3105.4473 M1068,3093.4473 L1085,3093.4473 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><ellipse cx="1097" cy="3093.4473" fill="#ADD8E6" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#90EE90" height="46.9766" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="102" x="1123" y="33.5117"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="88" x="1130" y="54.0469">Calypso SAM</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48" x="1150" y="70.5352">Reader</text><rect fill="#90EE90" height="46.9766" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="102" x="1123" y="3060.959"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="88" x="1130" y="3081.4941">Calypso SAM</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48" x="1150" y="3097.9824">Reader</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="1404" y="62.0469">selected</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="31" x="1416.5" y="78.5352">SAM</text><path d="M1414.5,20.5117 L1414.5,44.5117 M1414.5,32.5117 L1431.5,32.5117 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><ellipse cx="1443.5" cy="32.5117" fill="#90EE90" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="1404" y="3074.4941">selected</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="31" x="1416.5" y="3090.9824">SAM</text><path d="M1414.5,3097.9355 L1414.5,3121.9355 M1414.5,3109.9355 L1431.5,3109.9355 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><ellipse cx="1443.5" cy="3109.9355" fill="#90EE90" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#FFD700" height="2961.4707" style="stroke:#181818;stroke-width:1.0;" width="10" x="92.5" y="91.4883"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="355.5" y="237.3516"/><rect fill="#FFC0CB" height="75.2422" style="stroke:#181818;stroke-width:1.0;" width="10" x="355.5" y="736.6309"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="355.5" y="1038.668"/><rect fill="#FFC0CB" height="659.3848" style="stroke:#181818;stroke-width:1.0;" width="10" x="355.5" y="1081.9785"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="355.5" y="1816.6055"/><rect fill="#FFC0CB" height="1184.043" style="stroke:#181818;stroke-width:1.0;" width="10" x="355.5" y="1859.916"/><rect fill="#FFC0CB" height="426.6582" style="stroke:#181818;stroke-width:1.0;" width="10" x="613.5" y="280.6621"/><rect fill="#ADD8E6" height="322.1055" style="stroke:#181818;stroke-width:1.0;" width="10" x="813.5" y="355.9043"/><rect fill="#ADD8E6" height="302.416" style="stroke:#181818;stroke-width:1.0;" width="10" x="813.5" y="1333.084"/><rect fill="#ADD8E6" height="307.7949" style="stroke:#181818;stroke-width:1.0;" width="10" x="813.5" y="2451.8164"/><rect fill="#ADD8E6" height="2345.0859" style="stroke:#181818;stroke-width:1.0;" width="10" x="1083.5" y="385.2148"/><rect fill="#90EE90" height="131.2422" style="stroke:#181818;stroke-width:1.0;" width="10" x="1169" y="1141.9102"/><rect fill="#90EE90" height="379.1055" style="stroke:#181818;stroke-width:1.0;" width="10" x="1169" y="2012.7793"/><rect fill="#90EE90" height="87.9316" style="stroke:#181818;stroke-width:1.0;" width="10" x="1169" y="2819.543"/><rect fill="#90EE90" height="2961.4707" style="stroke:#181818;stroke-width:1.0;" width="10" x="1430" y="91.4883"/><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1486" x="0" y="112.1436"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1486" y1="112.1436" y2="112.1436"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1486" y1="115.1436" y2="115.1436"/><rect fill="#EEEEEE" height="23.3105" style="stroke:#000000;stroke-width:2.0;" width="221" x="632.5" y="101.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="203" x="638.5" y="118.0566">Card selection &amp; identification</text><path d="M117,139.7988 L117,164.7988 L604,164.7988 L604,149.7988 L594,139.7988 L117,139.7988 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M594,139.7988 L594,149.7988 L604,149.7988 L594,139.7988 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="466" x="123" y="157.3672">Reads the environment data present in all the cards targeted for selection.</text><polygon fill="#181818" points="343.5,233.3516,353.5,237.3516,343.5,241.3516,347.5,237.3516" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="102.5" x2="349.5" y1="237.3516" y2="237.3516"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="109.5" y="186.6777">prepare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="149" x="167.5" y="186.6777">card selection scenario:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="141" x="141.5" y="201.9883">- filter by specific AID</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="146" x="141.5" y="217.2988">- read environment file</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="150" x="141.5" y="232.6094">- read contracts list file</text><polygon fill="#181818" points="113.5,247.3516,103.5,251.3516,113.5,255.3516,109.5,251.3516" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="107.5" x2="359.5" y1="251.3516" y2="251.3516"/><polygon fill="#181818" points="601.5,276.6621,611.5,280.6621,601.5,284.6621,605.5,280.6621" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="102.5" x2="607.5" y1="280.6621" y2="280.6621"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="109.5" y="275.9199">process</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="196" x="165.5" y="275.9199">explicit card selection scenario</text><polygon fill="#0000FF" points="801.5,351.9043,811.5,355.9043,801.5,359.9043,805.5,355.9043" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;" x1="623.5" x2="807.5" y1="355.9043" y2="355.9043"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="630.5" y="305.2305">Card #1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="165" x="630.5" y="320.541">transmit selection request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="93" x="662.5" y="335.8516">- card selector</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="662.5" y="351.1621">- APDU list</text><polygon fill="#181818" points="1071.5,381.2148,1081.5,385.2148,1071.5,389.2148,1075.5,385.2148" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="823.5" x2="1077.5" y1="385.2148" y2="385.2148"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="830.5" y="380.4727">open card channel</text><polygon fill="#181818" points="834.5,395.2148,824.5,399.2148,834.5,403.2148,830.5,399.2148" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="828.5" x2="1082.5" y1="399.2148" y2="399.2148"/><polygon fill="#181818" points="1071.5,424.5254,1081.5,428.5254,1071.5,432.5254,1075.5,428.5254" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="823.5" x2="1077.5" y1="428.5254" y2="428.5254"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="142" x="830.5" y="423.7832">select application (aid)</text><polygon fill="#181818" points="834.5,453.8359,824.5,457.8359,834.5,461.8359,830.5,457.8359" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="828.5" x2="1082.5" y1="457.8359" y2="457.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="59" x="840.5" y="453.0938">[card FCI]</text><line style="stroke:#181818;stroke-width:1.0;" x1="823.5" x2="865.5" y1="487.1465" y2="487.1465"/><line style="stroke:#181818;stroke-width:1.0;" x1="865.5" x2="865.5" y1="487.1465" y2="500.1465"/><line style="stroke:#181818;stroke-width:1.0;" x1="824.5" x2="865.5" y1="500.1465" y2="500.1465"/><polygon fill="#181818" points="834.5,496.1465,824.5,500.1465,834.5,504.1465,830.5,500.1465" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="165" x="830.5" y="482.4043">checks invalidation status</text><path d="M756,515.1465 L1110,515.1465 L1110,522.457 L1100,532.457 L756,532.457 L756,515.1465 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="134.5527" style="stroke:#000000;stroke-width:1.5;" width="367" x="756" y="515.1465"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="309" x="771" y="528.7148">Card APDU commands outside secure session</text><polygon fill="#181818" points="1071.5,549.7676,1081.5,553.7676,1071.5,557.7676,1075.5,553.7676" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="823.5" x2="1077.5" y1="553.7676" y2="553.7676"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="162" x="830.5" y="549.0254">read record (environment)</text><polygon fill="#181818" points="834.5,579.0781,824.5,583.0781,834.5,587.0781,830.5,583.0781" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="828.5" x2="1082.5" y1="583.0781" y2="583.0781"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="118" x="840.5" y="578.3359">[environment data]</text><polygon fill="#181818" points="1071.5,608.3887,1081.5,612.3887,1071.5,616.3887,1075.5,612.3887" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="823.5" x2="1077.5" y1="612.3887" y2="612.3887"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="159" x="830.5" y="607.6465">read record (contract list)</text><polygon fill="#181818" points="834.5,637.6992,824.5,641.6992,834.5,645.6992,830.5,641.6992" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="828.5" x2="1082.5" y1="641.6992" y2="641.6992"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="840.5" y="636.957">[contract list data]</text><polygon fill="#0000FF" points="634.5,674.0098,624.5,678.0098,634.5,682.0098,630.5,678.0098" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="628.5" x2="817.5" y1="678.0098" y2="678.0098"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="166" x="640.5" y="673.2676">receive selection response</text><polygon fill="#181818" points="113.5,703.3203,103.5,707.3203,113.5,711.3203,109.5,707.3203" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="107.5" x2="617.5" y1="707.3203" y2="707.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="204" x="119.5" y="702.5781">selected active SmartCard image</text><polygon fill="#181818" points="343.5,732.6309,353.5,736.6309,343.5,740.6309,347.5,736.6309" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="102.5" x2="349.5" y1="736.6309" y2="736.6309"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="27" x="109.5" y="731.8887">cast</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="81" x="140.5" y="731.8887">Calypso card</text><polygon fill="#181818" points="113.5,807.873,103.5,811.873,113.5,815.873,109.5,811.873" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="107.5" x2="359.5" y1="811.873" y2="811.873"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="119.5" y="761.1992">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127" x="151.5" y="776.5098">- identification data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="122" x="151.5" y="791.8203">- environment data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="123" x="151.5" y="807.1309">- contract list data]</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1486" x="0" y="840.5283"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1486" y1="840.5283" y2="840.5283"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1486" y1="843.5283" y2="843.5283"/><rect fill="#EEEEEE" height="23.3105" style="stroke:#000000;stroke-width:2.0;" width="179" x="653.5" y="829.873"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="161" x="659.5" y="846.4414">Card secure transaction</text><line style="stroke:#181818;stroke-width:1.0;" x1="102.5" x2="144.5" y1="915.1152" y2="915.1152"/><line style="stroke:#181818;stroke-width:1.0;" x1="144.5" x2="144.5" y1="915.1152" y2="928.1152"/><line style="stroke:#181818;stroke-width:1.0;" x1="103.5" x2="144.5" y1="928.1152" y2="928.1152"/><polygon fill="#181818" points="113.5,924.1152,103.5,928.1152,113.5,932.1152,109.5,928.1152" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="72" x="109.5" y="879.752">instantiate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="185.5" y="879.752">Calypso card transaction:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="141.5" y="895.0625">- Calypso card resource</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="141.5" y="910.373">- Calypso SAM resource</text><path d="M115,941.1152 L115,966.1152 L606,966.1152 L606,951.1152 L596,941.1152 L115,941.1152 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M596,941.1152 L596,951.1152 L606,951.1152 L596,941.1152 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="470" x="121" y="958.6836">Reads again the environment data inside the session to authenticate them.</text><polygon fill="#181818" points="343.5,1034.668,353.5,1038.668,343.5,1042.668,347.5,1038.668" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="102.5" x2="349.5" y1="1038.668" y2="1038.668"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="109.5" y="987.9941">prepare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="106" x="167.5" y="987.9941">card transaction:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="146" x="141.5" y="1003.3047">- read environment file</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="141.5" y="1018.6152">- read contract #1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="123" x="141.5" y="1033.9258">- reader counter #1</text><polygon fill="#181818" points="113.5,1048.668,103.5,1052.668,113.5,1056.668,109.5,1052.668" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="107.5" x2="359.5" y1="1052.668" y2="1052.668"/><polygon fill="#181818" points="343.5,1077.9785,353.5,1081.9785,343.5,1085.9785,347.5,1081.9785" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="102.5" x2="349.5" y1="1081.9785" y2="1081.9785"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="109.5" y="1077.2363">process</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="178" x="165.5" y="1077.2363">opening (DEBIT access level)</text><polygon fill="#00FF00" points="1157,1137.9102,1167,1141.9102,1157,1145.9102,1161,1141.9102" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;" x1="365.5" x2="1163" y1="1141.9102" y2="1141.9102"/><text fill="#008000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="51" x="372.5" y="1106.5469">SAM #1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="372.5" y="1121.8574">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="404.5" y="1137.168">- APDU list</text><polygon fill="#181818" points="1418,1167.2207,1428,1171.2207,1418,1175.2207,1422,1171.2207" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1179" x2="1424" y1="1171.2207" y2="1171.2207"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="181" x="1186" y="1166.4785">select diversifier (card serial)</text><polygon fill="#181818" points="1190,1181.2207,1180,1185.2207,1190,1189.2207,1186,1185.2207" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1184" x2="1429" y1="1185.2207" y2="1185.2207"/><polygon fill="#181818" points="1418,1210.5313,1428,1214.5313,1418,1218.5313,1422,1214.5313" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1179" x2="1424" y1="1214.5313" y2="1214.5313"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="84" x="1186" y="1209.7891">get challenge</text><polygon fill="#181818" points="1190,1239.8418,1180,1243.8418,1190,1247.8418,1186,1243.8418" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1184" x2="1429" y1="1243.8418" y2="1243.8418"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="99" x="1196" y="1239.0996">[SAM challenge]</text><polygon fill="#00FF00" points="376.5,1269.1523,366.5,1273.1523,376.5,1277.1523,372.5,1273.1523" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="370.5" x2="1173" y1="1273.1523" y2="1273.1523"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="99" x="382.5" y="1268.4102">[SAM challenge]</text><polygon fill="#0000FF" points="801.5,1329.084,811.5,1333.084,801.5,1337.084,805.5,1333.084" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;" x1="365.5" x2="807.5" y1="1333.084" y2="1333.084"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="372.5" y="1297.7207">Card #2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="372.5" y="1313.0313">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="404.5" y="1328.3418">- APDU list</text><path d="M591,1348.084 L887,1348.084 L887,1355.3945 L877,1365.3945 L591,1365.3945 L591,1348.084 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="259.1055" style="stroke:#000000;stroke-width:1.5;" width="532" x="591" y="1348.084"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="251" x="606" y="1361.6523">Card APDU commands inside session</text><path d="M601,1370.3945 L601,1395.3945 L1035,1395.3945 L1035,1380.3945 L1025,1370.3945 L601,1370.3945 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1025,1370.3945 L1025,1380.3945 L1035,1380.3945 L1025,1370.3945 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="413" x="607" y="1387.9629">Optimization: environment file read through the session opening.</text><polygon fill="#181818" points="1071.5,1448.6367,1081.5,1452.6367,1071.5,1456.6367,1075.5,1452.6367" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="823.5" x2="1077.5" y1="1452.6367" y2="1452.6367"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="229" x="830.5" y="1417.2734">open secure session (card debit key,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="95" x="862.5" y="1432.584">SAM challenge,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="153" x="862.5" y="1447.8945">SFI environment to read)</text><polygon fill="#181818" points="834.5,1477.9473,824.5,1481.9473,834.5,1485.9473,830.5,1481.9473" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="828.5" x2="1082.5" y1="1481.9473" y2="1481.9473"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="226" x="840.5" y="1477.2051">[card challenge &amp; environment data]</text><polygon fill="#181818" points="1071.5,1507.2578,1081.5,1511.2578,1071.5,1515.2578,1075.5,1511.2578" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="823.5" x2="1077.5" y1="1511.2578" y2="1511.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="155" x="830.5" y="1506.5156">read record (contract #1)</text><polygon fill="#181818" points="834.5,1536.5684,824.5,1540.5684,834.5,1544.5684,830.5,1540.5684" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="828.5" x2="1082.5" y1="1540.5684" y2="1540.5684"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="111" x="840.5" y="1535.8262">[contract #1 data]</text><polygon fill="#181818" points="1071.5,1565.8789,1081.5,1569.8789,1071.5,1573.8789,1075.5,1569.8789" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="823.5" x2="1077.5" y1="1569.8789" y2="1569.8789"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="830.5" y="1565.1367">read record (counter #1)</text><polygon fill="#181818" points="834.5,1595.1895,824.5,1599.1895,834.5,1603.1895,830.5,1599.1895" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="828.5" x2="1082.5" y1="1599.1895" y2="1599.1895"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="107" x="840.5" y="1594.4473">[counter #1 data]</text><polygon fill="#0000FF" points="376.5,1631.5,366.5,1635.5,376.5,1639.5,372.5,1635.5" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="370.5" x2="817.5" y1="1635.5" y2="1635.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="99" x="382.5" y="1630.7578">[card challenge]</text><polygon fill="#181818" points="113.5,1737.3633,103.5,1741.3633,113.5,1745.3633,109.5,1741.3633" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="107.5" x2="359.5" y1="1741.3633" y2="1741.3633"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="119.5" y="1660.0684">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127" x="151.5" y="1675.3789">- identification data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="185" x="151.5" y="1690.6895">- environment data (updated)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="119" x="151.5" y="1706">- contract list data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="151.5" y="1721.3105">- contract #1 data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="151.5" y="1736.6211">- counter #1 data]</text><polygon fill="#181818" points="343.5,1812.6055,353.5,1816.6055,343.5,1820.6055,347.5,1816.6055" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="102.5" x2="349.5" y1="1816.6055" y2="1816.6055"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="109.5" y="1765.9316">prepare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="163.5" y="1765.9316">:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="184" x="141.5" y="1781.2422">- decrease counter #1 (value)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="179" x="141.5" y="1796.5527">- append event record (data)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="109" x="141.5" y="1811.8633">- release channel</text><polygon fill="#181818" points="113.5,1826.6055,103.5,1830.6055,113.5,1834.6055,109.5,1830.6055" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="107.5" x2="359.5" y1="1830.6055" y2="1830.6055"/><polygon fill="#181818" points="343.5,1855.916,353.5,1859.916,343.5,1863.916,347.5,1859.916" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="102.5" x2="349.5" y1="1859.916" y2="1859.916"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="109.5" y="1855.1738">process</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="128" x="165.5" y="1855.1738">closing (not ratified)</text><line style="stroke:#181818;stroke-width:1.0;" x1="365.5" x2="407.5" y1="1889.2266" y2="1889.2266"/><line style="stroke:#181818;stroke-width:1.0;" x1="407.5" x2="407.5" y1="1889.2266" y2="1902.2266"/><line style="stroke:#181818;stroke-width:1.0;" x1="366.5" x2="407.5" y1="1902.2266" y2="1902.2266"/><polygon fill="#181818" points="376.5,1898.2266,366.5,1902.2266,376.5,1906.2266,372.5,1902.2266" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="234" x="372.5" y="1884.4844">anticipates the future card responses</text><path d="M5,1915.2266 L5,1955.2266 L717,1955.2266 L717,1925.2266 L707,1915.2266 L5,1915.2266 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M707,1915.2266 L707,1925.2266 L717,1925.2266 L707,1915.2266 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="265" x="11" y="1932.7949">If the current value of the counter #1 were</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="63" x="280" y="1932.7949">unknown</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="319" x="343" y="1932.7949">, then the transmission of an additional card APDU</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="691" x="11" y="1948.1055">message would be necessary to operate the decrease counter in a different message than the session closing.</text><polygon fill="#00FF00" points="1157,2008.7793,1167,2012.7793,1157,2016.7793,1161,2012.7793" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;" x1="365.5" x2="1163" y1="2012.7793" y2="2012.7793"/><text fill="#008000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="51" x="372.5" y="1977.416">SAM #2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="372.5" y="1992.7266">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="404.5" y="2008.0371">- APDU list</text><polygon fill="#181818" points="1418,2038.0898,1428,2042.0898,1418,2046.0898,1422,2042.0898" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1179" x2="1424" y1="2042.0898" y2="2042.0898"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1186" y="2037.3477">digest init (opening data)</text><polygon fill="#181818" points="1190,2052.0898,1180,2056.0898,1190,2060.0898,1186,2056.0898" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1184" x2="1429" y1="2056.0898" y2="2056.0898"/><polygon fill="#181818" points="1418,2081.4004,1428,2085.4004,1418,2089.4004,1422,2085.4004" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1179" x2="1424" y1="2085.4004" y2="2085.4004"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="208" x="1186" y="2080.6582">digest update (read environment)</text><polygon fill="#181818" points="1190,2095.4004,1180,2099.4004,1190,2103.4004,1186,2099.4004" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1184" x2="1429" y1="2099.4004" y2="2099.4004"/><polygon fill="#181818" points="1418,2124.7109,1428,2128.7109,1418,2132.7109,1422,2128.7109" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1179" x2="1424" y1="2128.7109" y2="2128.7109"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="181" x="1186" y="2123.9688">digest update (read contract)</text><polygon fill="#181818" points="1190,2138.7109,1180,2142.7109,1190,2146.7109,1186,2142.7109" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1184" x2="1429" y1="2142.7109" y2="2142.7109"/><polygon fill="#181818" points="1418,2168.0215,1428,2172.0215,1418,2176.0215,1422,2172.0215" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1179" x2="1424" y1="2172.0215" y2="2172.0215"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="177" x="1186" y="2167.2793">digest update (read counter)</text><polygon fill="#181818" points="1190,2182.0215,1180,2186.0215,1190,2190.0215,1186,2186.0215" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1184" x2="1429" y1="2186.0215" y2="2186.0215"/><path d="M1113,2201.0215 L1385,2201.0215 L1385,2208.332 L1375,2218.332 L1113,2218.332 L1113,2201.0215 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="103.9316" style="stroke:#000000;stroke-width:1.5;" width="363" x="1113" y="2201.0215"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="76" x="1128" y="2214.5898">anticipated</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="147" x="1208" y="2214.5898">Card APDU responses</text><polygon fill="#181818" points="1418,2235.6426,1428,2239.6426,1418,2243.6426,1422,2239.6426" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1179" x2="1424" y1="2239.6426" y2="2239.6426"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="205" x="1186" y="2234.9004">digest update (decrease counter)</text><polygon fill="#181818" points="1190,2249.6426,1180,2253.6426,1190,2257.6426,1186,2253.6426" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1184" x2="1429" y1="2253.6426" y2="2253.6426"/><polygon fill="#181818" points="1418,2278.9531,1428,2282.9531,1418,2286.9531,1422,2282.9531" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1179" x2="1424" y1="2282.9531" y2="2282.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="226" x="1186" y="2278.2109">digest update (append event record)</text><polygon fill="#181818" points="1190,2292.9531,1180,2296.9531,1190,2300.9531,1186,2296.9531" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1184" x2="1429" y1="2296.9531" y2="2296.9531"/><polygon fill="#181818" points="1418,2329.2637,1428,2333.2637,1418,2337.2637,1422,2333.2637" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1179" x2="1424" y1="2333.2637" y2="2333.2637"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="76" x="1186" y="2328.5215">digest close</text><polygon fill="#181818" points="1190,2358.5742,1180,2362.5742,1190,2366.5742,1186,2362.5742" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1184" x2="1429" y1="2362.5742" y2="2362.5742"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="1196" y="2357.832">[SAM certificate]</text><polygon fill="#00FF00" points="376.5,2387.8848,366.5,2391.8848,376.5,2395.8848,372.5,2391.8848" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="370.5" x2="1173" y1="2391.8848" y2="2391.8848"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="382.5" y="2387.1426">[SAM certificate]</text><polygon fill="#0000FF" points="801.5,2447.8164,811.5,2451.8164,801.5,2455.8164,805.5,2451.8164" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;" x1="365.5" x2="807.5" y1="2451.8164" y2="2451.8164"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="372.5" y="2416.4531">Card #3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="372.5" y="2431.7637">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="404.5" y="2447.0742">- APDU list</text><path d="M756,2466.8164 L1052,2466.8164 L1052,2474.127 L1042,2484.127 L756,2484.127 L756,2466.8164 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="119.2422" style="stroke:#000000;stroke-width:1.5;" width="367" x="756" y="2466.8164"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="251" x="771" y="2480.3848">Card APDU commands inside session</text><polygon fill="#181818" points="1071.5,2501.4375,1081.5,2505.4375,1071.5,2509.4375,1075.5,2505.4375" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="823.5" x2="1077.5" y1="2505.4375" y2="2505.4375"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="228" x="830.5" y="2500.6953">decrease counter (counter #1, value)</text><polygon fill="#181818" points="834.5,2530.748,824.5,2534.748,834.5,2538.748,830.5,2534.748" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="828.5" x2="1082.5" y1="2534.748" y2="2534.748"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="122" x="840.5" y="2530.0059">[new counter value]</text><polygon fill="#181818" points="1071.5,2560.0586,1081.5,2564.0586,1071.5,2568.0586,1075.5,2564.0586" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="823.5" x2="1077.5" y1="2564.0586" y2="2564.0586"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="171" x="830.5" y="2559.3164">append record (event, data)</text><polygon fill="#181818" points="834.5,2574.0586,824.5,2578.0586,834.5,2582.0586,830.5,2578.0586" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="828.5" x2="1082.5" y1="2578.0586" y2="2578.0586"/><polygon fill="#181818" points="1071.5,2610.3691,1081.5,2614.3691,1071.5,2618.3691,1075.5,2614.3691" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="823.5" x2="1077.5" y1="2614.3691" y2="2614.3691"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="236" x="830.5" y="2609.627">close secure session (SAM certificate)</text><polygon fill="#181818" points="834.5,2639.6797,824.5,2643.6797,834.5,2647.6797,830.5,2643.6797" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="828.5" x2="1082.5" y1="2643.6797" y2="2643.6797"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="840.5" y="2638.9375">[card certificate]</text><polygon fill="#181818" points="1071.5,2668.9902,1081.5,2672.9902,1071.5,2676.9902,1075.5,2672.9902" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="823.5" x2="1077.5" y1="2672.9902" y2="2672.9902"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="830.5" y="2668.248">ratification command</text><polygon fill="#181818" points="834.5,2682.9902,824.5,2686.9902,834.5,2690.9902,830.5,2686.9902" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="828.5" x2="1082.5" y1="2686.9902" y2="2686.9902"/><polygon fill="#181818" points="1071.5,2712.3008,1081.5,2716.3008,1071.5,2720.3008,1075.5,2716.3008" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="823.5" x2="1077.5" y1="2716.3008" y2="2716.3008"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="830.5" y="2711.5586">close card channel</text><polygon fill="#181818" points="834.5,2726.3008,824.5,2730.3008,834.5,2734.3008,830.5,2730.3008" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="828.5" x2="1087.5" y1="2730.3008" y2="2730.3008"/><polygon fill="#0000FF" points="376.5,2755.6113,366.5,2759.6113,376.5,2763.6113,372.5,2759.6113" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="370.5" x2="817.5" y1="2759.6113" y2="2759.6113"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="382.5" y="2754.8691">[card certificate]</text><polygon fill="#00FF00" points="1157,2815.543,1167,2819.543,1157,2823.543,1161,2819.543" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;" x1="365.5" x2="1163" y1="2819.543" y2="2819.543"/><text fill="#008000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="51" x="372.5" y="2784.1797">SAM #3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="372.5" y="2799.4902">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="404.5" y="2814.8008">- APDU list</text><polygon fill="#181818" points="1418,2844.8535,1428,2848.8535,1418,2852.8535,1422,2848.8535" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1179" x2="1424" y1="2848.8535" y2="2848.8535"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="227" x="1186" y="2844.1113">digest authenticate (card certificate)</text><polygon fill="#181818" points="1190,2874.1641,1180,2878.1641,1190,2882.1641,1186,2878.1641" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1184" x2="1429" y1="2878.1641" y2="2878.1641"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="142" x="1196" y="2873.4219">[authentication status]</text><polygon fill="#00FF00" points="376.5,2903.4746,366.5,2907.4746,376.5,2911.4746,372.5,2907.4746" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="370.5" x2="1173" y1="2907.4746" y2="2907.4746"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="382.5" y="2902.7324">[authentification status]</text><polygon fill="#181818" points="113.5,3039.959,103.5,3043.959,113.5,3047.959,109.5,3043.959" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="107.5" x2="359.5" y1="3043.959" y2="3043.959"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="119.5" y="2932.043">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127" x="151.5" y="2947.3535">- identification data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="122" x="151.5" y="2962.6641">- environment data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="119" x="151.5" y="2977.9746">- contract list data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="151.5" y="2993.2852">- contract #1 data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="174" x="151.5" y="3008.5957">- counter #1 data (updated)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="133" x="151.5" y="3023.9063">- event #1 (updated)]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="143" x="119.5" y="3039.2168">authentification status</text><!--MD5=[307297b4e702e8754aebc0ffd73ca201]
@startuml

'skinparam ClassBorderColor #F1C40F
skinparam ClassBorderColor #D4AC0D
skinparam stereotypeABorderColor #A9DCDF
skinparam stereotypeIBorderColor #B4A7E5
skinparam stereotypeCBorderColor #ADD1B2
skinparam stereotypeEBorderColor #EB93DF
skinparam shadowing false

skinparam StateBorderColor #D4AC0D
skinparam ActivityBorderColor #D4AC0D

' Red
skinparam ClassBackgroundColor<<red>> #FDEDEC
skinparam ClassBorderColor<<red>> #E74C3C
hide <<red>> stereotype
' Purple
skinparam ClassBackgroundColor<<purple>> #F4ECF7
skinparam ClassBorderColor<<purple>> #8E44AD
hide <<purple>> stereotype
' blue
skinparam ClassBackgroundColor<<blue>> #EBF5FB
skinparam ClassBorderColor<<blue>> #3498DB
hide <<blue>> stereotype
' Green
skinparam ClassBackgroundColor<<green>> #EAFAF1
skinparam ClassBorderColor<<green>> #2ECC71
hide <<green>> stereotype

' Orange
skinparam ClassBackgroundColor<<orange>> #FDF2E9
skinparam ClassBorderColor<<orange>> #E67E22
hide <<orange>> stereotype

' Grey
skinparam ClassBackgroundColor<<grey>> #EAECEE
skinparam ClassBorderColor<<grey>> #2C3E50
hide <<grey>> stereotype

actor "Ticketing Application" as app #gold
participant "Calypso API" as capi #pink
participant "Reader API" as rapi #pink
participant "Calypso Card\nReader" as cardReader #lightBlue
boundary "**Card**" as card #lightBlue
participant "Calypso SAM\nReader" as samReader #lightGreen
boundary "selected\n**SAM**" as sam #lightGreen

activate app #gold
activate sam #lightGreen

== Card selection & identification ==

note over capi
    Reads the environment data present in all the cards targeted for selection.
end note

app->capi: <font color=red>**prepare**</font> card selection scenario:\n\t- filter by specific AID\n\t- read environment file\n\t- read contracts list file
activate capi  #pink
capi- ->app
deactivate capi

app->rapi: <font color=red>**process**</font> explicit card selection scenario
activate rapi  #pink
rapi-[#0000FF]>cardReader: <font color=blue>**Card #1**</font>\ntransmit selection request\n\t- card selector\n\t- APDU list
activate cardReader #lightBlue

cardReader->card: open card channel
activate card #lightBlue
card- ->cardReader
cardReader->card: select application (aid)
card- ->cardReader: [card FCI]
cardReader->cardReader: checks invalidation status

group Card APDU commands outside secure session
    cardReader->card: read record (environment)
    card- ->cardReader: [environment data]
    cardReader->card: read record (contract list)
    card- ->cardReader: [contract list data]
end

cardReader- -[#0000FF]>rapi: receive selection response
deactivate cardReader

rapi- ->app: selected active SmartCard image
deactivate rapi

app->capi: **cast** Calypso card
activate capi  #pink
capi- ->app: [Calypso card image:\n\t- identification data\n\t- environment data\n\t- contract list data]

deactivate capi

== Card secure transaction ==

app->app: **instantiate** Calypso card transaction:\n\t- Calypso card resource\n\t- Calypso SAM resource

note over capi
    Reads again the environment data inside the session to authenticate them.
end note

app->capi: <font color=red>**prepare**</font> card transaction:\n\t- read environment file\n\t- read contract #1\n\t- reader counter #1
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> opening (DEBIT access level)
activate capi  #pink

capi-[#00FF00]>samReader: <font color=green>**SAM #1**<font color=red>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: select diversifier (card serial)
sam- ->samReader
samReader->sam: get challenge
sam- ->samReader: [SAM challenge]
samReader-[#00FF00]->capi: [SAM challenge]
deactivate samReader

capi-[#0000FF]>cardReader: <font color=blue>**Card #2**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
note over cardReader
    Optimization: environment file read through the session opening.
end note

    cardReader->card: open secure session (card debit key,\n\tSAM challenge,\n\tSFI environment to read)
    card- ->cardReader: [card challenge & environment data]
    cardReader->card: read record (contract #1)
    card- ->cardReader: [contract #1 data]
    cardReader->card: read record (counter #1)
    card- ->cardReader: [counter #1 data]
end

cardReader- -[#0000FF]>capi: [card challenge]
deactivate cardReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- environment data (updated)\n\t- contract list data\n\t- contract #1 data\n\t- counter #1 data]
deactivate capi

app->capi: <font color=red>**prepare**</font>:\n\t- decrease counter #1 (value)\n\t- append event record (data)\n\t- release channel
activate capi  #pink

capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> closing (not ratified)
activate capi  #pink
capi->capi: anticipates the future card responses
note over capi
    If the current value of the counter #1 were **unknown**, then the transmission of an additional card APDU
    message would be necessary to operate the decrease counter in a different message than the session closing.
end note

capi-[#00FF00]>samReader: <font color=green>**SAM #2**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen

samReader->sam: digest init (opening data)
sam- ->samReader
samReader->sam: digest update (read environment)
sam- ->samReader
samReader->sam: digest update (read contract)
sam- ->samReader
samReader->sam: digest update (read counter)
sam- ->samReader
group <font color=red>**anticipated**</font> Card APDU responses
    samReader->sam: digest update (decrease counter)
    sam- ->samReader
    samReader->sam: digest update (append event record)
    sam- ->samReader
end
samReader->sam: digest close
sam- ->samReader: [SAM certificate]

samReader-[#00FF00]->capi: [SAM certificate]
deactivate samReader

capi-[#0000FF]>cardReader: <font color=blue>**Card #3**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: decrease counter (counter #1, value)
    card- ->cardReader: [new counter value]
    cardReader->card: append record (event, data)
    card- ->cardReader
end

cardReader->card: close secure session (SAM certificate)
card- ->cardReader: [card certificate]
cardReader->card: ratification command
card- ->cardReader
cardReader->card: close card channel
card- ->cardReader
deactivate card

cardReader-[#0000FF]->capi: [card certificate]
deactivate cardReader

capi-[#00FF00]>samReader: <font color=green>**SAM #3**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: digest authenticate (card certificate)
sam- ->samReader: [authentication status]

samReader-[#00FF00]->capi: [authentification status]
deactivate samReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- environment data\n\t- contract list data\n\t- contract #1 data\n\t- counter #1 data (updated)\n\t- event #1 (updated)]\nauthentification status
deactivate capi
@enduml

@startuml

skinparam ClassBorderColor #D4AC0D
skinparam stereotypeABorderColor #A9DCDF
skinparam stereotypeIBorderColor #B4A7E5
skinparam stereotypeCBorderColor #ADD1B2
skinparam stereotypeEBorderColor #EB93DF
skinparam shadowing false

skinparam StateBorderColor #D4AC0D
skinparam ActivityBorderColor #D4AC0D

skinparam ClassBackgroundColor<<red>> #FDEDEC
skinparam ClassBorderColor<<red>> #E74C3C
hide <<red>> stereotype
skinparam ClassBackgroundColor<<purple>> #F4ECF7
skinparam ClassBorderColor<<purple>> #8E44AD
hide <<purple>> stereotype
skinparam ClassBackgroundColor<<blue>> #EBF5FB
skinparam ClassBorderColor<<blue>> #3498DB
hide <<blue>> stereotype
skinparam ClassBackgroundColor<<green>> #EAFAF1
skinparam ClassBorderColor<<green>> #2ECC71
hide <<green>> stereotype

skinparam ClassBackgroundColor<<orange>> #FDF2E9
skinparam ClassBorderColor<<orange>> #E67E22
hide <<orange>> stereotype

skinparam ClassBackgroundColor<<grey>> #EAECEE
skinparam ClassBorderColor<<grey>> #2C3E50
hide <<grey>> stereotype

actor "Ticketing Application" as app #gold
participant "Calypso API" as capi #pink
participant "Reader API" as rapi #pink
participant "Calypso Card\nReader" as cardReader #lightBlue
boundary "**Card**" as card #lightBlue
participant "Calypso SAM\nReader" as samReader #lightGreen
boundary "selected\n**SAM**" as sam #lightGreen

activate app #gold
activate sam #lightGreen

== Card selection & identification ==

note over capi
    Reads the environment data present in all the cards targeted for selection.
end note

app->capi: <font color=red>**prepare**</font> card selection scenario:\n\t- filter by specific AID\n\t- read environment file\n\t- read contracts list file
activate capi  #pink
capi- ->app
deactivate capi

app->rapi: <font color=red>**process**</font> explicit card selection scenario
activate rapi  #pink
rapi-[#0000FF]>cardReader: <font color=blue>**Card #1**</font>\ntransmit selection request\n\t- card selector\n\t- APDU list
activate cardReader #lightBlue

cardReader->card: open card channel
activate card #lightBlue
card- ->cardReader
cardReader->card: select application (aid)
card- ->cardReader: [card FCI]
cardReader->cardReader: checks invalidation status

group Card APDU commands outside secure session
    cardReader->card: read record (environment)
    card- ->cardReader: [environment data]
    cardReader->card: read record (contract list)
    card- ->cardReader: [contract list data]
end

cardReader- -[#0000FF]>rapi: receive selection response
deactivate cardReader

rapi- ->app: selected active SmartCard image
deactivate rapi

app->capi: **cast** Calypso card
activate capi  #pink
capi- ->app: [Calypso card image:\n\t- identification data\n\t- environment data\n\t- contract list data]

deactivate capi

== Card secure transaction ==

app->app: **instantiate** Calypso card transaction:\n\t- Calypso card resource\n\t- Calypso SAM resource

note over capi
    Reads again the environment data inside the session to authenticate them.
end note

app->capi: <font color=red>**prepare**</font> card transaction:\n\t- read environment file\n\t- read contract #1\n\t- reader counter #1
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> opening (DEBIT access level)
activate capi  #pink

capi-[#00FF00]>samReader: <font color=green>**SAM #1**<font color=red>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: select diversifier (card serial)
sam- ->samReader
samReader->sam: get challenge
sam- ->samReader: [SAM challenge]
samReader-[#00FF00]->capi: [SAM challenge]
deactivate samReader

capi-[#0000FF]>cardReader: <font color=blue>**Card #2**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
note over cardReader
    Optimization: environment file read through the session opening.
end note

    cardReader->card: open secure session (card debit key,\n\tSAM challenge,\n\tSFI environment to read)
    card- ->cardReader: [card challenge & environment data]
    cardReader->card: read record (contract #1)
    card- ->cardReader: [contract #1 data]
    cardReader->card: read record (counter #1)
    card- ->cardReader: [counter #1 data]
end

cardReader- -[#0000FF]>capi: [card challenge]
deactivate cardReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- environment data (updated)\n\t- contract list data\n\t- contract #1 data\n\t- counter #1 data]
deactivate capi

app->capi: <font color=red>**prepare**</font>:\n\t- decrease counter #1 (value)\n\t- append event record (data)\n\t- release channel
activate capi  #pink

capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> closing (not ratified)
activate capi  #pink
capi->capi: anticipates the future card responses
note over capi
    If the current value of the counter #1 were **unknown**, then the transmission of an additional card APDU
    message would be necessary to operate the decrease counter in a different message than the session closing.
end note

capi-[#00FF00]>samReader: <font color=green>**SAM #2**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen

samReader->sam: digest init (opening data)
sam- ->samReader
samReader->sam: digest update (read environment)
sam- ->samReader
samReader->sam: digest update (read contract)
sam- ->samReader
samReader->sam: digest update (read counter)
sam- ->samReader
group <font color=red>**anticipated**</font> Card APDU responses
    samReader->sam: digest update (decrease counter)
    sam- ->samReader
    samReader->sam: digest update (append event record)
    sam- ->samReader
end
samReader->sam: digest close
sam- ->samReader: [SAM certificate]

samReader-[#00FF00]->capi: [SAM certificate]
deactivate samReader

capi-[#0000FF]>cardReader: <font color=blue>**Card #3**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: decrease counter (counter #1, value)
    card- ->cardReader: [new counter value]
    cardReader->card: append record (event, data)
    card- ->cardReader
end

cardReader->card: close secure session (SAM certificate)
card- ->cardReader: [card certificate]
cardReader->card: ratification command
card- ->cardReader
cardReader->card: close card channel
card- ->cardReader
deactivate card

cardReader-[#0000FF]->capi: [card certificate]
deactivate cardReader

capi-[#00FF00]>samReader: <font color=green>**SAM #3**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: digest authenticate (card certificate)
sam- ->samReader: [authentication status]

samReader-[#00FF00]->capi: [authentification status]
deactivate samReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- environment data\n\t- contract list data\n\t- contract #1 data\n\t- counter #1 data (updated)\n\t- event #1 (updated)]\nauthentification status
deactivate capi
@enduml

PlantUML version 1.2022.4(Sat Apr 09 17:29:17 RET 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: fr
Country: FR
--></g></svg>