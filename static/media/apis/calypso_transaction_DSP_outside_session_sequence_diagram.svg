<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="936px" preserveAspectRatio="none" style="width:1189px;height:936px;background:#FFFFFF;" version="1.1" viewBox="0 0 1189 936" width="1189px" zoomAndPan="magnify"><defs/><g><rect fill="#FFD700" height="754.627" style="stroke:#181818;stroke-width:1.0;" width="10" x="75.5" y="91.4883"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="373.5" y="266.9727"/><rect fill="#FFC0CB" height="526.832" style="stroke:#181818;stroke-width:1.0;" width="10" x="373.5" y="310.2832"/><rect fill="#ADD8E6" height="177.8633" style="stroke:#181818;stroke-width:1.0;" width="10" x="537.5" y="553.3887"/><rect fill="#ADD8E6" height="754.627" style="stroke:#181818;stroke-width:1.0;" width="10" x="733.5" y="91.4883"/><rect fill="#90EE90" height="87.9316" style="stroke:#181818;stroke-width:1.0;" width="10" x="825.5" y="405.5254"/><rect fill="#90EE90" height="754.627" style="stroke:#181818;stroke-width:1.0;" width="10" x="1152.5" y="91.4883"/><rect height="134.5527" style="stroke:#000000;stroke-width:1.5;fill:none;" width="301" x="480" y="568.3887"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="80" x2="80" y1="81.4883" y2="855.1152"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="378.5" x2="378.5" y1="81.4883" y2="855.1152"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="542" x2="542" y1="81.4883" y2="855.1152"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="738.5" x2="738.5" y1="81.4883" y2="855.1152"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="830.5" x2="830.5" y1="81.4883" y2="855.1152"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="1157.5" x2="1157.5" y1="81.4883" y2="855.1152"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="145" x="5" y="78.5352">Ticketing Application</text><ellipse cx="80.5" cy="13.5" fill="#FFD700" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M80.5,21.5 L80.5,48.5 M67.5,29.5 L93.5,29.5 M80.5,48.5 L67.5,63.5 M80.5,48.5 L93.5,63.5 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="145" x="5" y="867.6504">Ticketing Application</text><ellipse cx="80.5" cy="879.1035" fill="#FFD700" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M80.5,887.1035 L80.5,914.1035 M67.5,895.1035 L93.5,895.1035 M80.5,914.1035 L67.5,929.1035 M80.5,914.1035 L93.5,929.1035 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#FFC0CB" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="94" x="331.5" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="80" x="338.5" y="70.5352">Calypso API</text><rect fill="#FFC0CB" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="94" x="331.5" y="854.1152"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="80" x="338.5" y="874.6504">Calypso API</text><rect fill="#ADD8E6" height="46.9766" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="105" x="490" y="33.5117"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="497" y="54.0469">Calypso Card</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48" x="518.5" y="70.5352">Reader</text><rect fill="#ADD8E6" height="46.9766" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="105" x="490" y="854.1152"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="497" y="874.6504">Calypso Card</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48" x="518.5" y="891.1387">Reader</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="707.5" y="62.0469">selected</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="33" x="719" y="78.5352">Card</text><path d="M718,20.5117 L718,44.5117 M718,32.5117 L735,32.5117 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><ellipse cx="747" cy="32.5117" fill="#ADD8E6" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="707.5" y="867.6504">selected</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="33" x="719" y="884.1387">Card</text><path d="M718,891.0918 L718,915.0918 M718,903.0918 L735,903.0918 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><ellipse cx="747" cy="903.0918" fill="#ADD8E6" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#90EE90" height="46.9766" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="102" x="779.5" y="33.5117"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="88" x="786.5" y="54.0469">Calypso SAM</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48" x="806.5" y="70.5352">Reader</text><rect fill="#90EE90" height="46.9766" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="102" x="779.5" y="854.1152"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="88" x="786.5" y="874.6504">Calypso SAM</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48" x="806.5" y="891.1387">Reader</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="1126.5" y="62.0469">selected</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="31" x="1139" y="78.5352">SAM</text><path d="M1137,20.5117 L1137,44.5117 M1137,32.5117 L1154,32.5117 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><ellipse cx="1166" cy="32.5117" fill="#90EE90" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="1126.5" y="867.6504">selected</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="31" x="1139" y="884.1387">SAM</text><path d="M1137,891.0918 L1137,915.0918 M1137,903.0918 L1154,903.0918 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><ellipse cx="1166" cy="903.0918" fill="#90EE90" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#FFD700" height="754.627" style="stroke:#181818;stroke-width:1.0;" width="10" x="75.5" y="91.4883"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="373.5" y="266.9727"/><rect fill="#FFC0CB" height="526.832" style="stroke:#181818;stroke-width:1.0;" width="10" x="373.5" y="310.2832"/><rect fill="#ADD8E6" height="177.8633" style="stroke:#181818;stroke-width:1.0;" width="10" x="537.5" y="553.3887"/><rect fill="#ADD8E6" height="754.627" style="stroke:#181818;stroke-width:1.0;" width="10" x="733.5" y="91.4883"/><rect fill="#90EE90" height="87.9316" style="stroke:#181818;stroke-width:1.0;" width="10" x="825.5" y="405.5254"/><rect fill="#90EE90" height="754.627" style="stroke:#181818;stroke-width:1.0;" width="10" x="1152.5" y="91.4883"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="127.5" y1="143.4199" y2="143.4199"/><line style="stroke:#181818;stroke-width:1.0;" x1="127.5" x2="127.5" y1="143.4199" y2="156.4199"/><line style="stroke:#181818;stroke-width:1.0;" x1="86.5" x2="127.5" y1="156.4199" y2="156.4199"/><polygon fill="#181818" points="96.5,152.4199,86.5,156.4199,96.5,160.4199,92.5,156.4199" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="72" x="92.5" y="108.0566">instantiate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="168.5" y="108.0566">Calypso card transaction:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="124.5" y="123.3672">- Calypso card resource</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="124.5" y="138.6777">- Calypso SAM resource</text><path d="M155,169.4199 L155,194.4199 L601,194.4199 L601,179.4199 L591,169.4199 L155,169.4199 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M591,169.4199 L591,179.4199 L601,179.4199 L591,169.4199 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="425" x="161" y="186.9883">Checks a signature of previously read data when selecting the card.</text><polygon fill="#181818" points="361.5,262.9727,371.5,266.9727,361.5,270.9727,365.5,266.9727" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="367.5" y1="266.9727" y2="266.9727"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="92.5" y="216.2988">prepare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="106" x="150.5" y="216.2988">card transaction:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="146" x="124.5" y="231.6094">- read environment file</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="124.5" y="246.9199">-</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="39" x="136.5" y="246.9199">verify</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="110" x="179.5" y="246.9199">environment data</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="65" x="293.5" y="246.9199">signature</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="124.5" y="262.2305">- read contract #1</text><polygon fill="#181818" points="96.5,276.9727,86.5,280.9727,96.5,284.9727,92.5,280.9727" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="377.5" y1="280.9727" y2="280.9727"/><polygon fill="#181818" points="361.5,306.2832,371.5,310.2832,361.5,314.2832,365.5,310.2832" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="367.5" y1="310.2832" y2="310.2832"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="92.5" y="305.541">process</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="69" x="148.5" y="305.541">commands</text><path d="M649,323.2832 L649,348.2832 L1011,348.2832 L1011,333.2832 L1001,323.2832 L649,323.2832 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1001,323.2832 L1001,333.2832 L1011,333.2832 L1001,323.2832 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="341" x="655" y="340.8516">Data secure processing with the SAM is operated first.</text><polygon fill="#00FF00" points="813.5,401.5254,823.5,405.5254,813.5,409.5254,817.5,405.5254" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;" x1="383.5" x2="819.5" y1="405.5254" y2="405.5254"/><text fill="#008000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="51" x="390.5" y="370.1621">SAM #1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="390.5" y="385.4727">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="422.5" y="400.7832">- APDU list</text><polygon fill="#181818" points="1140.5,430.8359,1150.5,434.8359,1140.5,438.8359,1144.5,434.8359" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="835.5" x2="1146.5" y1="434.8359" y2="434.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="108" x="842.5" y="430.0938">verify signature</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="181" x="954.5" y="430.0938">(environment data signature)</text><polygon fill="#181818" points="846.5,460.1465,836.5,464.1465,846.5,468.1465,842.5,464.1465" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="840.5" x2="1151.5" y1="464.1465" y2="464.1465"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="852.5" y="459.4043">signature status</text><polygon fill="#00FF00" points="394.5,489.457,384.5,493.457,394.5,497.457,390.5,493.457" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="388.5" x2="829.5" y1="493.457" y2="493.457"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="181" x="400.5" y="488.7148">[environment data signature]</text><polygon fill="#0000FF" points="525.5,549.3887,535.5,553.3887,525.5,557.3887,529.5,553.3887" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;" x1="383.5" x2="531.5" y1="553.3887" y2="553.3887"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="390.5" y="518.0254">Card #2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="390.5" y="533.3359">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="422.5" y="548.6465">- APDU list</text><path d="M480,568.3887 L776,568.3887 L776,575.6992 L766,585.6992 L480,585.6992 L480,568.3887 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="134.5527" style="stroke:#000000;stroke-width:1.5;" width="301" x="480" y="568.3887"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="251" x="495" y="581.957">Card APDU commands inside session</text><polygon fill="#181818" points="721.5,603.0098,731.5,607.0098,721.5,611.0098,725.5,607.0098" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="547.5" x2="727.5" y1="607.0098" y2="607.0098"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="162" x="554.5" y="602.2676">read record (environment)</text><polygon fill="#181818" points="558.5,632.3203,548.5,636.3203,558.5,640.3203,554.5,636.3203" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="552.5" x2="732.5" y1="636.3203" y2="636.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="118" x="564.5" y="631.5781">[environment data]</text><polygon fill="#181818" points="721.5,661.6309,731.5,665.6309,721.5,669.6309,725.5,665.6309" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="547.5" x2="727.5" y1="665.6309" y2="665.6309"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="155" x="554.5" y="660.8887">read record (contract #1)</text><polygon fill="#181818" points="558.5,690.9414,548.5,694.9414,558.5,698.9414,554.5,694.9414" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="552.5" x2="732.5" y1="694.9414" y2="694.9414"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="111" x="564.5" y="690.1992">[contract #1 data]</text><polygon fill="#0000FF" points="394.5,727.252,384.5,731.252,394.5,735.252,390.5,731.252" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="388.5" x2="541.5" y1="731.252" y2="731.252"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="99" x="400.5" y="726.5098">[card challenge]</text><polygon fill="#181818" points="96.5,833.1152,86.5,837.1152,96.5,841.1152,92.5,837.1152" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="377.5" y1="837.1152" y2="837.1152"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="102.5" y="755.8203">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="180" x="134.5" y="771.1309">- support identification data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="185" x="134.5" y="786.4414">- environment data (updated)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="119" x="134.5" y="801.752">- contract #1 data]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="155" x="102.5" y="817.0625">[Data secure processing:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="232" x="134.5" y="832.373">- environment data signature status]</text><!--MD5=[b8eaa348231aa900c60fbda366f3e79f]
@startuml

'skinparam ClassBorderColor #F1C40F
skinparam ClassBorderColor #D4AC0D
skinparam stereotypeABorderColor #A9DCDF
skinparam stereotypeIBorderColor #B4A7E5
skinparam stereotypeCBorderColor #ADD1B2
skinparam stereotypeEBorderColor #EB93DF
skinparam shadowing false

skinparam StateBorderColor #D4AC0D
skinparam ActivityBorderColor #D4AC0D

' Red
skinparam ClassBackgroundColor<<red>> #FDEDEC
skinparam ClassBorderColor<<red>> #E74C3C
hide <<red>> stereotype
' Purple
skinparam ClassBackgroundColor<<purple>> #F4ECF7
skinparam ClassBorderColor<<purple>> #8E44AD
hide <<purple>> stereotype
' blue
skinparam ClassBackgroundColor<<blue>> #EBF5FB
skinparam ClassBorderColor<<blue>> #3498DB
hide <<blue>> stereotype
' Green
skinparam ClassBackgroundColor<<green>> #EAFAF1
skinparam ClassBorderColor<<green>> #2ECC71
hide <<green>> stereotype

' Orange
skinparam ClassBackgroundColor<<orange>> #FDF2E9
skinparam ClassBorderColor<<orange>> #E67E22
hide <<orange>> stereotype

' Grey
skinparam ClassBackgroundColor<<grey>> #EAECEE
skinparam ClassBorderColor<<grey>> #2C3E50
hide <<grey>> stereotype

actor "Ticketing Application" as app #gold
participant "Calypso API" as capi #pink
participant "Calypso Card\nReader" as cardReader #lightBlue
boundary "selected\n**Card**" as card #lightBlue
participant "Calypso SAM\nReader" as samReader #lightGreen
boundary "selected\n**SAM**" as sam #lightGreen

activate app #gold
activate card #lightBlue
activate sam #lightGreen

app->app: **instantiate** Calypso card transaction:\n\t- Calypso card resource\n\t- Calypso SAM resource

note over capi
    Checks a signature of previously read data when selecting the card.
end note

app->capi: <font color=red>**prepare**</font> card transaction:\n\t- read environment file\n\t- **verify** environment data **signature**\n\t- read contract #1
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> commands
activate capi  #pink

note over samReader
    Data secure processing with the SAM is operated first.
end note

capi-[#00FF00]>samReader: <font color=green>**SAM #1**<font color=red>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: **verify signature** (environment data signature)
sam- ->samReader: signature status

samReader-[#00FF00]->capi: [environment data signature]
deactivate samReader

capi-[#0000FF]>cardReader: <font color=blue>**Card #2**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: read record (environment)
    card- ->cardReader: [environment data]
    cardReader->card: read record (contract #1)
    card- ->cardReader: [contract #1 data]
end

cardReader- -[#0000FF]>capi: [card challenge]
deactivate cardReader

capi- ->app: [Calypso card image:\n\t- support identification data\n\t- environment data (updated)\n\t- contract #1 data]\n[Data secure processing:\n\t- environment data signature status]
deactivate capi

deactivate samReader
deactivate capi
@enduml

@startuml

skinparam ClassBorderColor #D4AC0D
skinparam stereotypeABorderColor #A9DCDF
skinparam stereotypeIBorderColor #B4A7E5
skinparam stereotypeCBorderColor #ADD1B2
skinparam stereotypeEBorderColor #EB93DF
skinparam shadowing false

skinparam StateBorderColor #D4AC0D
skinparam ActivityBorderColor #D4AC0D

skinparam ClassBackgroundColor<<red>> #FDEDEC
skinparam ClassBorderColor<<red>> #E74C3C
hide <<red>> stereotype
skinparam ClassBackgroundColor<<purple>> #F4ECF7
skinparam ClassBorderColor<<purple>> #8E44AD
hide <<purple>> stereotype
skinparam ClassBackgroundColor<<blue>> #EBF5FB
skinparam ClassBorderColor<<blue>> #3498DB
hide <<blue>> stereotype
skinparam ClassBackgroundColor<<green>> #EAFAF1
skinparam ClassBorderColor<<green>> #2ECC71
hide <<green>> stereotype

skinparam ClassBackgroundColor<<orange>> #FDF2E9
skinparam ClassBorderColor<<orange>> #E67E22
hide <<orange>> stereotype

skinparam ClassBackgroundColor<<grey>> #EAECEE
skinparam ClassBorderColor<<grey>> #2C3E50
hide <<grey>> stereotype

actor "Ticketing Application" as app #gold
participant "Calypso API" as capi #pink
participant "Calypso Card\nReader" as cardReader #lightBlue
boundary "selected\n**Card**" as card #lightBlue
participant "Calypso SAM\nReader" as samReader #lightGreen
boundary "selected\n**SAM**" as sam #lightGreen

activate app #gold
activate card #lightBlue
activate sam #lightGreen

app->app: **instantiate** Calypso card transaction:\n\t- Calypso card resource\n\t- Calypso SAM resource

note over capi
    Checks a signature of previously read data when selecting the card.
end note

app->capi: <font color=red>**prepare**</font> card transaction:\n\t- read environment file\n\t- **verify** environment data **signature**\n\t- read contract #1
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> commands
activate capi  #pink

note over samReader
    Data secure processing with the SAM is operated first.
end note

capi-[#00FF00]>samReader: <font color=green>**SAM #1**<font color=red>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: **verify signature** (environment data signature)
sam- ->samReader: signature status

samReader-[#00FF00]->capi: [environment data signature]
deactivate samReader

capi-[#0000FF]>cardReader: <font color=blue>**Card #2**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: read record (environment)
    card- ->cardReader: [environment data]
    cardReader->card: read record (contract #1)
    card- ->cardReader: [contract #1 data]
end

cardReader- -[#0000FF]>capi: [card challenge]
deactivate cardReader

capi- ->app: [Calypso card image:\n\t- support identification data\n\t- environment data (updated)\n\t- contract #1 data]\n[Data secure processing:\n\t- environment data signature status]
deactivate capi

deactivate samReader
deactivate capi
@enduml

PlantUML version 1.2022.4(Sat Apr 09 17:29:17 RET 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: fr
Country: FR
--></g></svg>