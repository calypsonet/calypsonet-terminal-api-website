<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="3774px" preserveAspectRatio="none" style="width:1378px;height:3774px;background:#FFFFFF;" version="1.1" viewBox="0 0 1378 3774" width="1378px" zoomAndPan="magnify"><defs/><g><rect fill="#FFD700" height="3593.2344" style="stroke:#181818;stroke-width:1.0;" width="10" x="75.5" y="91.4883"/><rect fill="#FFC0CB" height="59.9316" style="stroke:#181818;stroke-width:1.0;" width="10" x="338.5" y="112.7988"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="338.5" y="506.6992"/><rect fill="#FFC0CB" height="2225.8438" style="stroke:#181818;stroke-width:1.0;" width="10" x="338.5" y="565.3203"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="338.5" y="2835.7852"/><rect fill="#FFC0CB" height="796.627" style="stroke:#181818;stroke-width:1.0;" width="10" x="338.5" y="2879.0957"/><rect fill="#ADD8E6" height="544.9004" style="stroke:#181818;stroke-width:1.0;" width="10" x="690" y="858.7363"/><rect fill="#ADD8E6" height="87.9316" style="stroke:#181818;stroke-width:1.0;" width="10" x="690" y="1949.916"/><rect fill="#ADD8E6" height="345.7266" style="stroke:#181818;stroke-width:1.0;" width="10" x="690" y="2339.5742"/><rect fill="#ADD8E6" height="131.2422" style="stroke:#181818;stroke-width:1.0;" width="10" x="690" y="3260.1328"/><rect fill="#ADD8E6" height="3270.5762" style="stroke:#181818;stroke-width:1.0;" width="10" x="972" y="91.4883"/><rect fill="#90EE90" height="131.2422" style="stroke:#181818;stroke-width:1.0;" width="10" x="1057.5" y="625.252"/><rect fill="#90EE90" height="426.416" style="stroke:#181818;stroke-width:1.0;" width="10" x="1057.5" y="1463.5684"/><rect fill="#90EE90" height="181.8633" style="stroke:#181818;stroke-width:1.0;" width="10" x="1057.5" y="2097.7793"/><rect fill="#90EE90" height="261.1738" style="stroke:#181818;stroke-width:1.0;" width="10" x="1057.5" y="2939.0273"/><rect fill="#90EE90" height="87.9316" style="stroke:#181818;stroke-width:1.0;" width="10" x="1057.5" y="3451.3066"/><rect fill="#90EE90" height="3593.2344" style="stroke:#181818;stroke-width:1.0;" width="10" x="1330.5" y="91.4883"/><rect height="501.5898" style="stroke:#000000;stroke-width:1.5;fill:none;" width="379" x="632.5" y="873.7363"/><rect height="267.1055" style="stroke:#000000;stroke-width:1.5;fill:none;" width="379" x="632.5" y="2389.8848"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="80" x2="80" y1="81.4883" y2="3693.7227"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="343.5" x2="343.5" y1="81.4883" y2="3693.7227"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="588.5" x2="588.5" y1="81.4883" y2="3693.7227"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="694.5" x2="694.5" y1="81.4883" y2="3693.7227"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="976.5" x2="976.5" y1="81.4883" y2="3693.7227"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="1062.5" x2="1062.5" y1="81.4883" y2="3693.7227"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="1335.5" x2="1335.5" y1="81.4883" y2="3693.7227"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="145" x="5" y="78.5352">Ticketing Application</text><ellipse cx="80.5" cy="13.5" fill="#FFD700" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M80.5,21.5 L80.5,48.5 M67.5,29.5 L93.5,29.5 M80.5,48.5 L67.5,63.5 M80.5,48.5 L93.5,63.5 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="145" x="5" y="3706.2578">Ticketing Application</text><ellipse cx="80.5" cy="3717.7109" fill="#FFD700" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M80.5,3725.7109 L80.5,3752.7109 M67.5,3733.7109 L93.5,3733.7109 M80.5,3752.7109 L67.5,3767.7109 M80.5,3752.7109 L93.5,3767.7109 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#FFC0CB" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="94" x="296.5" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="80" x="303.5" y="70.5352">Calypso API</text><rect fill="#FFC0CB" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="94" x="296.5" y="3692.7227"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="80" x="303.5" y="3713.2578">Calypso API</text><rect fill="#FFC0CB" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="88" x="544.5" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="74" x="551.5" y="70.5352">Reader API</text><rect fill="#FFC0CB" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="88" x="544.5" y="3692.7227"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="74" x="551.5" y="3713.2578">Reader API</text><rect fill="#ADD8E6" height="46.9766" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="105" x="642.5" y="33.5117"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="649.5" y="54.0469">Calypso Card</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48" x="671" y="70.5352">Reader</text><rect fill="#ADD8E6" height="46.9766" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="105" x="642.5" y="3692.7227"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="649.5" y="3713.2578">Calypso Card</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48" x="671" y="3729.7461">Reader</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="33" x="957.5" y="78.5352">Card</text><path d="M956.5,37 L956.5,61 M956.5,49 L973.5,49 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><ellipse cx="985.5" cy="49" fill="#ADD8E6" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="33" x="957.5" y="3706.2578">Card</text><path d="M956.5,3713.2109 L956.5,3737.2109 M956.5,3725.2109 L973.5,3725.2109 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><ellipse cx="985.5" cy="3725.2109" fill="#ADD8E6" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#90EE90" height="46.9766" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="102" x="1011.5" y="33.5117"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="88" x="1018.5" y="54.0469">Calypso SAM</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48" x="1038.5" y="70.5352">Reader</text><rect fill="#90EE90" height="46.9766" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="102" x="1011.5" y="3692.7227"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="88" x="1018.5" y="3713.2578">Calypso SAM</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48" x="1038.5" y="3729.7461">Reader</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="1304.5" y="62.0469">selected</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="31" x="1317" y="78.5352">SAM</text><path d="M1315,20.5117 L1315,44.5117 M1315,32.5117 L1332,32.5117 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><ellipse cx="1344" cy="32.5117" fill="#90EE90" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="1304.5" y="3706.2578">selected</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="31" x="1317" y="3722.7461">SAM</text><path d="M1315,3729.6992 L1315,3753.6992 M1315,3741.6992 L1332,3741.6992 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><ellipse cx="1344" cy="3741.6992" fill="#90EE90" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#FFD700" height="3593.2344" style="stroke:#181818;stroke-width:1.0;" width="10" x="75.5" y="91.4883"/><rect fill="#FFC0CB" height="59.9316" style="stroke:#181818;stroke-width:1.0;" width="10" x="338.5" y="112.7988"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="338.5" y="506.6992"/><rect fill="#FFC0CB" height="2225.8438" style="stroke:#181818;stroke-width:1.0;" width="10" x="338.5" y="565.3203"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="338.5" y="2835.7852"/><rect fill="#FFC0CB" height="796.627" style="stroke:#181818;stroke-width:1.0;" width="10" x="338.5" y="2879.0957"/><rect fill="#ADD8E6" height="544.9004" style="stroke:#181818;stroke-width:1.0;" width="10" x="690" y="858.7363"/><rect fill="#ADD8E6" height="87.9316" style="stroke:#181818;stroke-width:1.0;" width="10" x="690" y="1949.916"/><rect fill="#ADD8E6" height="345.7266" style="stroke:#181818;stroke-width:1.0;" width="10" x="690" y="2339.5742"/><rect fill="#ADD8E6" height="131.2422" style="stroke:#181818;stroke-width:1.0;" width="10" x="690" y="3260.1328"/><rect fill="#ADD8E6" height="3270.5762" style="stroke:#181818;stroke-width:1.0;" width="10" x="972" y="91.4883"/><rect fill="#90EE90" height="131.2422" style="stroke:#181818;stroke-width:1.0;" width="10" x="1057.5" y="625.252"/><rect fill="#90EE90" height="426.416" style="stroke:#181818;stroke-width:1.0;" width="10" x="1057.5" y="1463.5684"/><rect fill="#90EE90" height="181.8633" style="stroke:#181818;stroke-width:1.0;" width="10" x="1057.5" y="2097.7793"/><rect fill="#90EE90" height="261.1738" style="stroke:#181818;stroke-width:1.0;" width="10" x="1057.5" y="2939.0273"/><rect fill="#90EE90" height="87.9316" style="stroke:#181818;stroke-width:1.0;" width="10" x="1057.5" y="3451.3066"/><rect fill="#90EE90" height="3593.2344" style="stroke:#181818;stroke-width:1.0;" width="10" x="1330.5" y="91.4883"/><polygon fill="#181818" points="326.5,108.7988,336.5,112.7988,326.5,116.7988,330.5,112.7988" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="332.5" y1="112.7988" y2="112.7988"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="27" x="92.5" y="108.0566">cast</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="81" x="123.5" y="108.0566">Calypso card</text><polygon fill="#181818" points="96.5,168.7305,86.5,172.7305,96.5,176.7305,92.5,172.7305" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="342.5" y1="172.7305" y2="172.7305"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="102.5" y="137.3672">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127" x="134.5" y="152.6777">- identification data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="134.5" y="167.9883">- session buffer size]</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1371.5" x="0" y="201.3857"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1371.5" y1="201.3857" y2="201.3857"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1371.5" y1="204.3857" y2="204.3857"/><rect fill="#EEEEEE" height="23.3105" style="stroke:#000000;stroke-width:2.0;" width="179" x="596.25" y="190.7305"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="161" x="602.25" y="207.2988">Card secure transaction</text><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="127.5" y1="275.9727" y2="275.9727"/><line style="stroke:#181818;stroke-width:1.0;" x1="127.5" x2="127.5" y1="275.9727" y2="288.9727"/><line style="stroke:#181818;stroke-width:1.0;" x1="86.5" x2="127.5" y1="288.9727" y2="288.9727"/><polygon fill="#181818" points="96.5,284.9727,86.5,288.9727,96.5,292.9727,92.5,288.9727" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="72" x="92.5" y="240.6094">instantiate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="168.5" y="240.6094">Calypso card transaction:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="124.5" y="255.9199">- Calypso card resource</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="124.5" y="271.2305">- Calypso SAM resource</text><path d="M98,301.9727 L98,326.9727 L589,326.9727 L589,311.9727 L579,301.9727 L98,301.9727 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M579,301.9727 L579,311.9727 L589,311.9727 L579,301.9727 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="470" x="104" y="319.541">Reads again the environment data inside the session to authenticate them.</text><polygon fill="#181818" points="326.5,502.6992,336.5,506.6992,326.5,510.6992,330.5,506.6992" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="332.5" y1="506.6992" y2="506.6992"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="92.5" y="348.8516">prepare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="106" x="150.5" y="348.8516">card transaction:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="162" x="124.5" y="364.1621">- update environment file</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="124.5" y="379.4727">- update contract list</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="124.5" y="394.7832">- update contract #1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="124.5" y="410.0938">- update contract #2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="124.5" y="425.4043">- update contract #3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="124.5" y="440.7148">- update contract #4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="133" x="124.5" y="456.0254">- update all counters</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="137" x="124.5" y="471.3359">- update event log #1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="137" x="124.5" y="486.6465">- update event log #2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="137" x="124.5" y="501.957">- update event log #3</text><polygon fill="#181818" points="96.5,516.6992,86.5,520.6992,96.5,524.6992,92.5,520.6992" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="342.5" y1="520.6992" y2="520.6992"/><polygon fill="#181818" points="326.5,561.3203,336.5,565.3203,326.5,569.3203,330.5,565.3203" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="332.5" y1="565.3203" y2="565.3203"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="92.5" y="545.2676">process</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="178" x="148.5" y="545.2676">opening (LOAD access level,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="103" x="188.5" y="560.5781">MULTIPLE mode)</text><polygon fill="#00FF00" points="1045.5,621.252,1055.5,625.252,1045.5,629.252,1049.5,625.252" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;" x1="348.5" x2="1051.5" y1="625.252" y2="625.252"/><text fill="#008000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="51" x="355.5" y="589.8887">SAM #1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="355.5" y="605.1992">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="387.5" y="620.5098">- APDU list</text><polygon fill="#181818" points="1318.5,650.5625,1328.5,654.5625,1318.5,658.5625,1322.5,654.5625" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1067.5" x2="1324.5" y1="654.5625" y2="654.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="181" x="1074.5" y="649.8203">select diversifier (card serial)</text><polygon fill="#181818" points="1078.5,664.5625,1068.5,668.5625,1078.5,672.5625,1074.5,668.5625" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1072.5" x2="1329.5" y1="668.5625" y2="668.5625"/><polygon fill="#181818" points="1318.5,693.873,1328.5,697.873,1318.5,701.873,1322.5,697.873" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1067.5" x2="1324.5" y1="697.873" y2="697.873"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="84" x="1074.5" y="693.1309">get challenge</text><polygon fill="#181818" points="1078.5,723.1836,1068.5,727.1836,1078.5,731.1836,1074.5,727.1836" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1072.5" x2="1329.5" y1="727.1836" y2="727.1836"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="111" x="1084.5" y="722.4414">[SAM challenge 1]</text><polygon fill="#00FF00" points="359.5,752.4941,349.5,756.4941,359.5,760.4941,355.5,756.4941" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="353.5" x2="1061.5" y1="756.4941" y2="756.4941"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="111" x="365.5" y="751.752">[SAM challenge 1]</text><line style="stroke:#181818;stroke-width:1.0;" x1="348.5" x2="390.5" y1="785.8047" y2="785.8047"/><line style="stroke:#181818;stroke-width:1.0;" x1="390.5" x2="390.5" y1="785.8047" y2="798.8047"/><line style="stroke:#181818;stroke-width:1.0;" x1="349.5" x2="390.5" y1="798.8047" y2="798.8047"/><polygon fill="#181818" points="359.5,794.8047,349.5,798.8047,359.5,802.8047,355.5,798.8047" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="221" x="355.5" y="781.0625">anticipates session buffer overflow</text><polygon fill="#0000FF" points="678,854.7363,688,858.7363,678,862.7363,682,858.7363" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;" x1="348.5" x2="684" y1="858.7363" y2="858.7363"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="355.5" y="823.373">Card #2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="355.5" y="838.6836">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="387.5" y="853.9941">- APDU list</text><path d="M632.5,873.7363 L941.5,873.7363 L941.5,881.0469 L931.5,891.0469 L632.5,891.0469 L632.5,873.7363 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="501.5898" style="stroke:#000000;stroke-width:1.5;" width="379" x="632.5" y="873.7363"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="251" x="647.5" y="887.3047">Card APDU commands inside session</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="902.5" y="887.3047">1</text><polygon fill="#181818" points="960,923.668,970,927.668,960,931.668,964,927.668" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="700" x2="966" y1="927.668" y2="927.668"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="229" x="707" y="907.6152">open secure session (card debit key,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="107" x="739" y="922.9258">SAM challenge 1)</text><polygon fill="#181818" points="711,952.9785,701,956.9785,711,960.9785,707,956.9785" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="705" x2="971" y1="956.9785" y2="956.9785"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="111" x="717" y="952.2363">[card challenge 1]</text><polygon fill="#181818" points="960,982.2891,970,986.2891,960,990.2891,964,986.2891" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="700" x2="966" y1="986.2891" y2="986.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="178" x="707" y="981.5469">update record (environment)</text><polygon fill="#181818" points="711,1011.5996,701,1015.5996,711,1019.5996,707,1015.5996" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="705" x2="971" y1="1015.5996" y2="1015.5996"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="22" x="717" y="1010.8574">ack</text><polygon fill="#181818" points="960,1040.9102,970,1044.9102,960,1048.9102,964,1044.9102" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="700" x2="966" y1="1044.9102" y2="1044.9102"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="175" x="707" y="1040.168">update record (contract list)</text><polygon fill="#181818" points="711,1070.2207,701,1074.2207,711,1078.2207,707,1074.2207" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="705" x2="971" y1="1074.2207" y2="1074.2207"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="22" x="717" y="1069.4785">ack</text><polygon fill="#181818" points="960,1099.5313,970,1103.5313,960,1107.5313,964,1103.5313" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="700" x2="966" y1="1103.5313" y2="1103.5313"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="171" x="707" y="1098.7891">update record (contract #1)</text><polygon fill="#181818" points="711,1128.8418,701,1132.8418,711,1136.8418,707,1132.8418" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="705" x2="971" y1="1132.8418" y2="1132.8418"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="22" x="717" y="1128.0996">ack</text><polygon fill="#181818" points="960,1158.1523,970,1162.1523,960,1166.1523,964,1162.1523" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="700" x2="966" y1="1162.1523" y2="1162.1523"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="171" x="707" y="1157.4102">update record (contract #2)</text><polygon fill="#181818" points="711,1187.4629,701,1191.4629,711,1195.4629,707,1191.4629" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="705" x2="971" y1="1191.4629" y2="1191.4629"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="22" x="717" y="1186.7207">ack</text><polygon fill="#181818" points="960,1216.7734,970,1220.7734,960,1224.7734,964,1220.7734" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="700" x2="966" y1="1220.7734" y2="1220.7734"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="171" x="707" y="1216.0313">update record (contract #3)</text><polygon fill="#181818" points="711,1246.084,701,1250.084,711,1254.084,707,1250.084" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="705" x2="971" y1="1250.084" y2="1250.084"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="22" x="717" y="1245.3418">ack</text><polygon fill="#181818" points="960,1275.3945,970,1279.3945,960,1283.3945,964,1279.3945" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="700" x2="966" y1="1279.3945" y2="1279.3945"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="171" x="707" y="1274.6523">update record (contract #4)</text><polygon fill="#181818" points="711,1304.7051,701,1308.7051,711,1312.7051,707,1308.7051" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="705" x2="971" y1="1308.7051" y2="1308.7051"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="22" x="717" y="1303.9629">ack</text><polygon fill="#181818" points="960,1334.0156,970,1338.0156,960,1342.0156,964,1338.0156" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="700" x2="966" y1="1338.0156" y2="1338.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="173" x="707" y="1333.2734">update record (all counters)</text><polygon fill="#181818" points="711,1363.3262,701,1367.3262,711,1371.3262,707,1367.3262" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="705" x2="971" y1="1367.3262" y2="1367.3262"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="22" x="717" y="1362.584">ack</text><polygon fill="#0000FF" points="359.5,1399.6367,349.5,1403.6367,359.5,1407.6367,355.5,1403.6367" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="353.5" x2="694" y1="1403.6367" y2="1403.6367"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="99" x="365.5" y="1398.8945">[card challenge]</text><polygon fill="#00FF00" points="1045.5,1459.5684,1055.5,1463.5684,1045.5,1467.5684,1049.5,1463.5684" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;" x1="348.5" x2="1051.5" y1="1463.5684" y2="1463.5684"/><text fill="#008000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="51" x="355.5" y="1428.2051">SAM #2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="355.5" y="1443.5156">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="387.5" y="1458.8262">- APDU list</text><polygon fill="#181818" points="1318.5,1488.8789,1328.5,1492.8789,1318.5,1496.8789,1322.5,1492.8789" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1067.5" x2="1324.5" y1="1492.8789" y2="1492.8789"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1074.5" y="1488.1367">digest init (opening data)</text><polygon fill="#181818" points="1078.5,1502.8789,1068.5,1506.8789,1078.5,1510.8789,1074.5,1506.8789" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1072.5" x2="1329.5" y1="1506.8789" y2="1506.8789"/><polygon fill="#181818" points="1318.5,1532.1895,1328.5,1536.1895,1318.5,1540.1895,1322.5,1536.1895" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1067.5" x2="1324.5" y1="1536.1895" y2="1536.1895"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="224" x="1074.5" y="1531.4473">digest update (update environment)</text><polygon fill="#181818" points="1078.5,1546.1895,1068.5,1550.1895,1078.5,1554.1895,1074.5,1550.1895" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1072.5" x2="1329.5" y1="1550.1895" y2="1550.1895"/><polygon fill="#181818" points="1318.5,1575.5,1328.5,1579.5,1318.5,1583.5,1322.5,1579.5" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1067.5" x2="1324.5" y1="1579.5" y2="1579.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="221" x="1074.5" y="1574.7578">digest update (update contract list)</text><polygon fill="#181818" points="1078.5,1589.5,1068.5,1593.5,1078.5,1597.5,1074.5,1593.5" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1072.5" x2="1329.5" y1="1593.5" y2="1593.5"/><polygon fill="#181818" points="1318.5,1618.8105,1328.5,1622.8105,1318.5,1626.8105,1322.5,1622.8105" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1067.5" x2="1324.5" y1="1622.8105" y2="1622.8105"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="217" x="1074.5" y="1618.0684">digest update (update contract #1)</text><polygon fill="#181818" points="1078.5,1632.8105,1068.5,1636.8105,1078.5,1640.8105,1074.5,1636.8105" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1072.5" x2="1329.5" y1="1636.8105" y2="1636.8105"/><polygon fill="#181818" points="1318.5,1662.1211,1328.5,1666.1211,1318.5,1670.1211,1322.5,1666.1211" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1067.5" x2="1324.5" y1="1666.1211" y2="1666.1211"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="217" x="1074.5" y="1661.3789">digest update (update contract #2)</text><polygon fill="#181818" points="1078.5,1676.1211,1068.5,1680.1211,1078.5,1684.1211,1074.5,1680.1211" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1072.5" x2="1329.5" y1="1680.1211" y2="1680.1211"/><polygon fill="#181818" points="1318.5,1705.4316,1328.5,1709.4316,1318.5,1713.4316,1322.5,1709.4316" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1067.5" x2="1324.5" y1="1709.4316" y2="1709.4316"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="217" x="1074.5" y="1704.6895">digest update (update contract #3)</text><polygon fill="#181818" points="1078.5,1719.4316,1068.5,1723.4316,1078.5,1727.4316,1074.5,1723.4316" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1072.5" x2="1329.5" y1="1723.4316" y2="1723.4316"/><polygon fill="#181818" points="1318.5,1748.7422,1328.5,1752.7422,1318.5,1756.7422,1322.5,1752.7422" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1067.5" x2="1324.5" y1="1752.7422" y2="1752.7422"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="217" x="1074.5" y="1748">digest update (update contract #4)</text><polygon fill="#181818" points="1078.5,1762.7422,1068.5,1766.7422,1078.5,1770.7422,1074.5,1766.7422" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1072.5" x2="1329.5" y1="1766.7422" y2="1766.7422"/><path d="M893,1779.7422 L893,1804.7422 L1232,1804.7422 L1232,1789.7422 L1222,1779.7422 L893,1779.7422 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1222,1779.7422 L1222,1789.7422 L1232,1789.7422 L1222,1779.7422 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="318" x="899" y="1797.3105">Close card session before session buffer overflow.</text><polygon fill="#181818" points="1318.5,1827.3633,1328.5,1831.3633,1318.5,1835.3633,1322.5,1831.3633" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1067.5" x2="1324.5" y1="1831.3633" y2="1831.3633"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="76" x="1074.5" y="1826.6211">digest close</text><polygon fill="#181818" points="1078.5,1856.6738,1068.5,1860.6738,1078.5,1864.6738,1074.5,1860.6738" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1072.5" x2="1329.5" y1="1860.6738" y2="1860.6738"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="1084.5" y="1855.9316">[SAM certificate 1]</text><polygon fill="#00FF00" points="359.5,1885.9844,349.5,1889.9844,359.5,1893.9844,355.5,1889.9844" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="353.5" x2="1061.5" y1="1889.9844" y2="1889.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="111" x="365.5" y="1885.2422">[SAM challenge 1]</text><polygon fill="#0000FF" points="678,1945.916,688,1949.916,678,1953.916,682,1949.916" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;" x1="348.5" x2="684" y1="1949.916" y2="1949.916"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="355.5" y="1914.5527">Card #3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="355.5" y="1929.8633">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="387.5" y="1945.1738">- APDU list</text><polygon fill="#181818" points="960,1975.2266,970,1979.2266,960,1983.2266,964,1979.2266" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="700" x2="966" y1="1979.2266" y2="1979.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="248" x="707" y="1974.4844">close secure session (SAM certificate 1)</text><polygon fill="#181818" points="711,2004.5371,701,2008.5371,711,2012.5371,707,2008.5371" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="705" x2="971" y1="2008.5371" y2="2008.5371"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="717" y="2003.7949">[card certificate 1]</text><polygon fill="#0000FF" points="359.5,2033.8477,349.5,2037.8477,359.5,2041.8477,355.5,2037.8477" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="353.5" x2="694" y1="2037.8477" y2="2037.8477"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="365.5" y="2033.1055">[card certificate 1]</text><polygon fill="#00FF00" points="1045.5,2093.7793,1055.5,2097.7793,1045.5,2101.7793,1049.5,2097.7793" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;" x1="348.5" x2="1051.5" y1="2097.7793" y2="2097.7793"/><text fill="#008000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="51" x="355.5" y="2062.416">SAM #3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="355.5" y="2077.7266">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="387.5" y="2093.0371">- APDU list</text><polygon fill="#181818" points="1318.5,2123.0898,1328.5,2127.0898,1318.5,2131.0898,1322.5,2127.0898" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1067.5" x2="1324.5" y1="2127.0898" y2="2127.0898"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="239" x="1074.5" y="2122.3477">digest authenticate (card certificate 1)</text><polygon fill="#181818" points="1078.5,2152.4004,1068.5,2156.4004,1078.5,2160.4004,1074.5,2156.4004" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1072.5" x2="1329.5" y1="2156.4004" y2="2156.4004"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="1084.5" y="2151.6582">[authentication status 1]</text><path d="M888,2169.4004 L888,2194.4004 L1237,2194.4004 L1237,2179.4004 L1227,2169.4004 L888,2169.4004 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1227,2169.4004 L1227,2179.4004 L1237,2179.4004 L1227,2169.4004 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="328" x="894" y="2186.9688">Anticipate second session with the same diversifier.</text><polygon fill="#181818" points="1318.5,2217.0215,1328.5,2221.0215,1318.5,2225.0215,1322.5,2221.0215" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1067.5" x2="1324.5" y1="2221.0215" y2="2221.0215"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="84" x="1074.5" y="2216.2793">get challenge</text><polygon fill="#181818" points="1078.5,2246.332,1068.5,2250.332,1078.5,2254.332,1074.5,2250.332" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1072.5" x2="1329.5" y1="2250.332" y2="2250.332"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="111" x="1084.5" y="2245.5898">[SAM challenge 2]</text><polygon fill="#00FF00" points="359.5,2275.6426,349.5,2279.6426,359.5,2283.6426,355.5,2279.6426" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="353.5" x2="1061.5" y1="2279.6426" y2="2279.6426"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="265" x="365.5" y="2274.9004">[authentication status 1, SAM challenge 2]</text><polygon fill="#0000FF" points="678,2335.5742,688,2339.5742,678,2343.5742,682,2339.5742" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;" x1="348.5" x2="684" y1="2339.5742" y2="2339.5742"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="355.5" y="2304.2109">Card #4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="355.5" y="2319.5215">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="387.5" y="2334.832">- APDU list</text><path d="M409,2352.5742 L409,2377.5742 L981,2377.5742 L981,2362.5742 L971,2352.5742 L409,2352.5742 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M971,2352.5742 L971,2362.5742 L981,2362.5742 L971,2352.5742 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="551" x="415" y="2370.1426">The card modifications aren't managed in an atomic way (split between sessions 1 &amp; 2).</text><path d="M632.5,2389.8848 L941.5,2389.8848 L941.5,2397.1953 L931.5,2407.1953 L632.5,2407.1953 L632.5,2389.8848 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="267.1055" style="stroke:#000000;stroke-width:1.5;" width="379" x="632.5" y="2389.8848"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="251" x="647.5" y="2403.4531">Card APDU commands inside session</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="902.5" y="2403.4531">2</text><polygon fill="#181818" points="960,2439.8164,970,2443.8164,960,2447.8164,964,2443.8164" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="700" x2="966" y1="2443.8164" y2="2443.8164"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="229" x="707" y="2423.7637">open secure session (card debit key,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="107" x="739" y="2439.0742">SAM challenge 2)</text><polygon fill="#181818" points="711,2469.127,701,2473.127,711,2477.127,707,2473.127" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="705" x2="971" y1="2473.127" y2="2473.127"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="111" x="717" y="2468.3848">[card challenge 2]</text><polygon fill="#181818" points="960,2498.4375,970,2502.4375,960,2506.4375,964,2502.4375" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="700" x2="966" y1="2502.4375" y2="2502.4375"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="177" x="707" y="2497.6953">update record (event log #1)</text><polygon fill="#181818" points="711,2527.748,701,2531.748,711,2535.748,707,2531.748" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="705" x2="971" y1="2531.748" y2="2531.748"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="22" x="717" y="2527.0059">ack</text><polygon fill="#181818" points="960,2557.0586,970,2561.0586,960,2565.0586,964,2561.0586" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="700" x2="966" y1="2561.0586" y2="2561.0586"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="177" x="707" y="2556.3164">update record (event log #2)</text><polygon fill="#181818" points="711,2586.3691,701,2590.3691,711,2594.3691,707,2590.3691" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="705" x2="971" y1="2590.3691" y2="2590.3691"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="22" x="717" y="2585.627">ack</text><polygon fill="#181818" points="960,2615.6797,970,2619.6797,960,2623.6797,964,2619.6797" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="700" x2="966" y1="2619.6797" y2="2619.6797"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="177" x="707" y="2614.9375">update record (event log #3)</text><polygon fill="#181818" points="711,2644.9902,701,2648.9902,711,2652.9902,707,2648.9902" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="705" x2="971" y1="2648.9902" y2="2648.9902"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="22" x="717" y="2644.248">ack</text><polygon fill="#0000FF" points="359.5,2681.3008,349.5,2685.3008,359.5,2689.3008,355.5,2685.3008" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="353.5" x2="694" y1="2685.3008" y2="2685.3008"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="365.5" y="2680.5586">[card certificate 1]</text><polygon fill="#181818" points="96.5,2787.1641,86.5,2791.1641,96.5,2795.1641,92.5,2791.1641" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="342.5" y1="2791.1641" y2="2791.1641"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="102.5" y="2709.8691">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127" x="134.5" y="2725.1797">- identification data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="185" x="134.5" y="2740.4902">- environment data (updated)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="119" x="134.5" y="2755.8008">- contract list data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="134.5" y="2771.1113">- contract #1 data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="134.5" y="2786.4219">- counter #1 data]</text><polygon fill="#181818" points="326.5,2831.7852,336.5,2835.7852,326.5,2839.7852,330.5,2835.7852" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="332.5" y1="2835.7852" y2="2835.7852"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="92.5" y="2815.7324">prepare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="146.5" y="2815.7324">:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="109" x="124.5" y="2831.043">- release channel</text><polygon fill="#181818" points="96.5,2845.7852,86.5,2849.7852,96.5,2853.7852,92.5,2849.7852" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="342.5" y1="2849.7852" y2="2849.7852"/><polygon fill="#181818" points="326.5,2875.0957,336.5,2879.0957,326.5,2883.0957,330.5,2879.0957" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="332.5" y1="2879.0957" y2="2879.0957"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="92.5" y="2874.3535">process</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="121" x="148.5" y="2874.3535">closing (as ratified)</text><polygon fill="#00FF00" points="1045.5,2935.0273,1055.5,2939.0273,1045.5,2943.0273,1049.5,2939.0273" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;" x1="348.5" x2="1051.5" y1="2939.0273" y2="2939.0273"/><text fill="#008000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="51" x="355.5" y="2903.6641">SAM #4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="355.5" y="2918.9746">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="387.5" y="2934.2852">- APDU list</text><polygon fill="#181818" points="1318.5,2964.3379,1328.5,2968.3379,1318.5,2972.3379,1322.5,2968.3379" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1067.5" x2="1324.5" y1="2968.3379" y2="2968.3379"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1074.5" y="2963.5957">digest init (opening data)</text><polygon fill="#181818" points="1078.5,2978.3379,1068.5,2982.3379,1078.5,2986.3379,1074.5,2982.3379" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1072.5" x2="1329.5" y1="2982.3379" y2="2982.3379"/><polygon fill="#181818" points="1318.5,3007.6484,1328.5,3011.6484,1318.5,3015.6484,1322.5,3011.6484" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1067.5" x2="1324.5" y1="3011.6484" y2="3011.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="1074.5" y="3006.9063">digest update (update event log #1)</text><polygon fill="#181818" points="1078.5,3021.6484,1068.5,3025.6484,1078.5,3029.6484,1074.5,3025.6484" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1072.5" x2="1329.5" y1="3025.6484" y2="3025.6484"/><polygon fill="#181818" points="1318.5,3050.959,1328.5,3054.959,1318.5,3058.959,1322.5,3054.959" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1067.5" x2="1324.5" y1="3054.959" y2="3054.959"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="1074.5" y="3050.2168">digest update (update event log #2)</text><polygon fill="#181818" points="1078.5,3064.959,1068.5,3068.959,1078.5,3072.959,1074.5,3068.959" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1072.5" x2="1329.5" y1="3068.959" y2="3068.959"/><polygon fill="#181818" points="1318.5,3094.2695,1328.5,3098.2695,1318.5,3102.2695,1322.5,3098.2695" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1067.5" x2="1324.5" y1="3098.2695" y2="3098.2695"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="1074.5" y="3093.5273">digest update (update event log #3)</text><polygon fill="#181818" points="1078.5,3108.2695,1068.5,3112.2695,1078.5,3116.2695,1074.5,3112.2695" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1072.5" x2="1329.5" y1="3112.2695" y2="3112.2695"/><polygon fill="#181818" points="1318.5,3137.5801,1328.5,3141.5801,1318.5,3145.5801,1322.5,3141.5801" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1067.5" x2="1324.5" y1="3141.5801" y2="3141.5801"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="76" x="1074.5" y="3136.8379">digest close</text><polygon fill="#181818" points="1078.5,3166.8906,1068.5,3170.8906,1078.5,3174.8906,1074.5,3170.8906" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1072.5" x2="1329.5" y1="3170.8906" y2="3170.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="1084.5" y="3166.1484">[SAM certificate 2]</text><polygon fill="#00FF00" points="359.5,3196.2012,349.5,3200.2012,359.5,3204.2012,355.5,3200.2012" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="353.5" x2="1061.5" y1="3200.2012" y2="3200.2012"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="365.5" y="3195.459">[SAM certificate 2]</text><polygon fill="#0000FF" points="678,3256.1328,688,3260.1328,678,3264.1328,682,3260.1328" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;" x1="348.5" x2="684" y1="3260.1328" y2="3260.1328"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="355.5" y="3224.7695">Card #5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="355.5" y="3240.0801">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="387.5" y="3255.3906">- APDU list</text><polygon fill="#181818" points="960,3285.4434,970,3289.4434,960,3293.4434,964,3289.4434" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="700" x2="966" y1="3289.4434" y2="3289.4434"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="248" x="707" y="3284.7012">close secure session (SAM certificate 2)</text><polygon fill="#181818" points="711,3314.7539,701,3318.7539,711,3322.7539,707,3318.7539" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="705" x2="971" y1="3318.7539" y2="3318.7539"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="717" y="3314.0117">[card certificate 2]</text><polygon fill="#181818" points="960,3344.0645,970,3348.0645,960,3352.0645,964,3348.0645" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="700" x2="966" y1="3348.0645" y2="3348.0645"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="707" y="3343.3223">close card channel</text><polygon fill="#181818" points="711,3358.0645,701,3362.0645,711,3366.0645,707,3362.0645" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="705" x2="976" y1="3362.0645" y2="3362.0645"/><polygon fill="#0000FF" points="359.5,3387.375,349.5,3391.375,359.5,3395.375,355.5,3391.375" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="353.5" x2="694" y1="3391.375" y2="3391.375"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="365.5" y="3386.6328">[card certificate]</text><polygon fill="#00FF00" points="1045.5,3447.3066,1055.5,3451.3066,1045.5,3455.3066,1049.5,3451.3066" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;" x1="348.5" x2="1051.5" y1="3451.3066" y2="3451.3066"/><text fill="#008000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="51" x="355.5" y="3415.9434">SAM #5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="355.5" y="3431.2539">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="387.5" y="3446.5645">- APDU list</text><polygon fill="#181818" points="1318.5,3476.6172,1328.5,3480.6172,1318.5,3484.6172,1322.5,3480.6172" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1067.5" x2="1324.5" y1="3480.6172" y2="3480.6172"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="239" x="1074.5" y="3475.875">digest authenticate (card certificate 2)</text><polygon fill="#181818" points="1078.5,3505.9277,1068.5,3509.9277,1078.5,3513.9277,1074.5,3509.9277" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1072.5" x2="1329.5" y1="3509.9277" y2="3509.9277"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="142" x="1084.5" y="3505.1855">[authentication status]</text><polygon fill="#00FF00" points="359.5,3535.2383,349.5,3539.2383,359.5,3543.2383,355.5,3539.2383" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="353.5" x2="1061.5" y1="3539.2383" y2="3539.2383"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="365.5" y="3534.4961">[authentification status]</text><polygon fill="#181818" points="96.5,3671.7227,86.5,3675.7227,96.5,3679.7227,92.5,3675.7227" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="342.5" y1="3675.7227" y2="3675.7227"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="102.5" y="3563.8066">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127" x="134.5" y="3579.1172">- identification data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="122" x="134.5" y="3594.4277">- environment data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="119" x="134.5" y="3609.7383">- contract list data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="134.5" y="3625.0488">- contract #1 data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="174" x="134.5" y="3640.3594">- counter #1 data (updated)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="133" x="134.5" y="3655.6699">- event #1 (updated)]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="143" x="102.5" y="3670.9805">authentification status</text><!--MD5=[aea46f043ea9b490ec007ec55809d316]
@startuml

'skinparam ClassBorderColor #F1C40F
skinparam ClassBorderColor #D4AC0D
skinparam stereotypeABorderColor #A9DCDF
skinparam stereotypeIBorderColor #B4A7E5
skinparam stereotypeCBorderColor #ADD1B2
skinparam stereotypeEBorderColor #EB93DF
skinparam shadowing false

skinparam StateBorderColor #D4AC0D
skinparam ActivityBorderColor #D4AC0D

' Red
skinparam ClassBackgroundColor<<red>> #FDEDEC
skinparam ClassBorderColor<<red>> #E74C3C
hide <<red>> stereotype
' Purple
skinparam ClassBackgroundColor<<purple>> #F4ECF7
skinparam ClassBorderColor<<purple>> #8E44AD
hide <<purple>> stereotype
' blue
skinparam ClassBackgroundColor<<blue>> #EBF5FB
skinparam ClassBorderColor<<blue>> #3498DB
hide <<blue>> stereotype
' Green
skinparam ClassBackgroundColor<<green>> #EAFAF1
skinparam ClassBorderColor<<green>> #2ECC71
hide <<green>> stereotype

' Orange
skinparam ClassBackgroundColor<<orange>> #FDF2E9
skinparam ClassBorderColor<<orange>> #E67E22
hide <<orange>> stereotype

' Grey
skinparam ClassBackgroundColor<<grey>> #EAECEE
skinparam ClassBorderColor<<grey>> #2C3E50
hide <<grey>> stereotype

actor "Ticketing Application" as app #gold
participant "Calypso API" as capi #pink
participant "Reader API" as rapi #pink
participant "Calypso Card\nReader" as cardReader #lightBlue
boundary "**Card**" as card #lightBlue
participant "Calypso SAM\nReader" as samReader #lightGreen
boundary "selected\n**SAM**" as sam #lightGreen

activate app #gold
activate sam #lightGreen

activate card #lightBlue

app->capi: **cast** Calypso card
activate capi  #pink
capi- ->app: [Calypso card image:\n\t- identification data\n\t- session buffer size]

deactivate capi

== Card secure transaction ==

app->app: **instantiate** Calypso card transaction:\n\t- Calypso card resource\n\t- Calypso SAM resource

note over capi
    Reads again the environment data inside the session to authenticate them.
end note

app->capi: <font color=red>**prepare**</font> card transaction:\n\t- update environment file\n\t- update contract list\n\t- update contract #1\n\t- update contract #2\n\t- update contract #3\n\t- update contract #4\n\t- update all counters\n\t- update event log #1\n\t- update event log #2\n\t- update event log #3
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> opening (LOAD access level,\n\t\t\tMULTIPLE mode)
activate capi  #pink

capi-[#00FF00]>samReader: <font color=green>**SAM #1**<font color=red>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: select diversifier (card serial)
sam- ->samReader
samReader->sam: get challenge
sam- ->samReader: [SAM challenge 1]
samReader-[#00FF00]->capi: [SAM challenge 1]
deactivate samReader

capi->capi: anticipates session buffer overflow

capi-[#0000FF]>cardReader: <font color=blue>**Card #2**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session <font color=red>**1**</font>
    cardReader->card: open secure session (card debit key,\n\tSAM challenge 1)
    card- ->cardReader: [card challenge 1]

    cardReader->card: update record (environment)
    card- ->cardReader: ack
    cardReader->card: update record (contract list)
    card- ->cardReader: ack
    cardReader->card: update record (contract #1)
    card- ->cardReader: ack
    cardReader->card: update record (contract #2)
    card- ->cardReader: ack
    cardReader->card: update record (contract #3)
    card- ->cardReader: ack
    cardReader->card: update record (contract #4)
    card- ->cardReader: ack
    cardReader->card: update record (all counters)
    card- ->cardReader: ack
end

cardReader- -[#0000FF]>capi: [card challenge]
deactivate cardReader

capi-[#00FF00]>samReader: <font color=green>**SAM #2**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen

samReader->sam: digest init (opening data)
sam- ->samReader
samReader->sam: digest update (update environment)
sam- ->samReader
samReader->sam: digest update (update contract list)
sam- ->samReader
samReader->sam: digest update (update contract #1)
sam- ->samReader
samReader->sam: digest update (update contract #2)
sam- ->samReader
samReader->sam: digest update (update contract #3)
sam- ->samReader
samReader->sam: digest update (update contract #4)
sam- ->samReader

note over samReader
    Close card session before session buffer overflow.
end note

samReader->sam: digest close
sam- ->samReader: [SAM certificate 1]
samReader-[#00FF00]->capi: [SAM challenge 1]
deactivate samReader


capi-[#0000FF]>cardReader: <font color=blue>**Card #3**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

cardReader->card: close secure session (SAM certificate 1)
card- ->cardReader: [card certificate 1]

cardReader- -[#0000FF]>capi: [card certificate 1]
deactivate cardReader


capi-[#00FF00]>samReader: <font color=green>**SAM #3**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen

samReader->sam: digest authenticate (card certificate 1)
sam- ->samReader: [authentication status 1]
'samReader-[#00FF00]->capi: [authentication status]
'deactivate samReader
'capi-[#00FF00]>samReader: <font color=green>**SAM #4**</font>\ntransmit card request\n\t- APDU list
'activate samReader #lightGreen

note over samReader
    Anticipate second session with the same diversifier.
end note

samReader->sam: get challenge
sam- ->samReader: [SAM challenge 2]
samReader-[#00FF00]->capi: [authentication status 1, SAM challenge 2]
deactivate samReader


capi-[#0000FF]>cardReader: <font color=blue>**Card #4**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

note over cardReader
    The card modifications aren't managed in an atomic way (split between sessions 1 & 2).
end note

group Card APDU commands inside session <font color=red>**2**</font>
    cardReader->card: open secure session (card debit key,\n\tSAM challenge 2)
    card- ->cardReader: [card challenge 2]
    cardReader->card: update record (event log #1)
    card- ->cardReader: ack
    cardReader->card: update record (event log #2)
    card- ->cardReader: ack
    cardReader->card: update record (event log #3)
    card- ->cardReader: ack
end

cardReader- -[#0000FF]>capi: [card certificate 1]
deactivate cardReader


capi- ->app: [Calypso card image:\n\t- identification data\n\t- environment data (updated)\n\t- contract list data\n\t- contract #1 data\n\t- counter #1 data]
deactivate capi

app->capi: <font color=red>**prepare**</font>:\n\t- release channel
activate capi  #pink

capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> closing (as ratified)
activate capi  #pink

capi-[#00FF00]>samReader: <font color=green>**SAM #4**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen

samReader->sam: digest init (opening data)
sam- ->samReader
samReader->sam: digest update (update event log #1)
sam- ->samReader
samReader->sam: digest update (update event log #2)
sam- ->samReader
samReader->sam: digest update (update event log #3)
sam- ->samReader
samReader->sam: digest close
sam- ->samReader: [SAM certificate 2]

samReader-[#00FF00]->capi: [SAM certificate 2]
deactivate samReader

capi-[#0000FF]>cardReader: <font color=blue>**Card #5**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

cardReader->card: close secure session (SAM certificate 2)
card- ->cardReader: [card certificate 2]
cardReader->card: close card channel
card- ->cardReader
deactivate card

cardReader-[#0000FF]->capi: [card certificate]
deactivate cardReader

capi-[#00FF00]>samReader: <font color=green>**SAM #5**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: digest authenticate (card certificate 2)
sam- ->samReader: [authentication status]

samReader-[#00FF00]->capi: [authentification status]
deactivate samReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- environment data\n\t- contract list data\n\t- contract #1 data\n\t- counter #1 data (updated)\n\t- event #1 (updated)]\nauthentification status
deactivate capi
@enduml

@startuml

skinparam ClassBorderColor #D4AC0D
skinparam stereotypeABorderColor #A9DCDF
skinparam stereotypeIBorderColor #B4A7E5
skinparam stereotypeCBorderColor #ADD1B2
skinparam stereotypeEBorderColor #EB93DF
skinparam shadowing false

skinparam StateBorderColor #D4AC0D
skinparam ActivityBorderColor #D4AC0D

skinparam ClassBackgroundColor<<red>> #FDEDEC
skinparam ClassBorderColor<<red>> #E74C3C
hide <<red>> stereotype
skinparam ClassBackgroundColor<<purple>> #F4ECF7
skinparam ClassBorderColor<<purple>> #8E44AD
hide <<purple>> stereotype
skinparam ClassBackgroundColor<<blue>> #EBF5FB
skinparam ClassBorderColor<<blue>> #3498DB
hide <<blue>> stereotype
skinparam ClassBackgroundColor<<green>> #EAFAF1
skinparam ClassBorderColor<<green>> #2ECC71
hide <<green>> stereotype

skinparam ClassBackgroundColor<<orange>> #FDF2E9
skinparam ClassBorderColor<<orange>> #E67E22
hide <<orange>> stereotype

skinparam ClassBackgroundColor<<grey>> #EAECEE
skinparam ClassBorderColor<<grey>> #2C3E50
hide <<grey>> stereotype

actor "Ticketing Application" as app #gold
participant "Calypso API" as capi #pink
participant "Reader API" as rapi #pink
participant "Calypso Card\nReader" as cardReader #lightBlue
boundary "**Card**" as card #lightBlue
participant "Calypso SAM\nReader" as samReader #lightGreen
boundary "selected\n**SAM**" as sam #lightGreen

activate app #gold
activate sam #lightGreen

activate card #lightBlue

app->capi: **cast** Calypso card
activate capi  #pink
capi- ->app: [Calypso card image:\n\t- identification data\n\t- session buffer size]

deactivate capi

== Card secure transaction ==

app->app: **instantiate** Calypso card transaction:\n\t- Calypso card resource\n\t- Calypso SAM resource

note over capi
    Reads again the environment data inside the session to authenticate them.
end note

app->capi: <font color=red>**prepare**</font> card transaction:\n\t- update environment file\n\t- update contract list\n\t- update contract #1\n\t- update contract #2\n\t- update contract #3\n\t- update contract #4\n\t- update all counters\n\t- update event log #1\n\t- update event log #2\n\t- update event log #3
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> opening (LOAD access level,\n\t\t\tMULTIPLE mode)
activate capi  #pink

capi-[#00FF00]>samReader: <font color=green>**SAM #1**<font color=red>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: select diversifier (card serial)
sam- ->samReader
samReader->sam: get challenge
sam- ->samReader: [SAM challenge 1]
samReader-[#00FF00]->capi: [SAM challenge 1]
deactivate samReader

capi->capi: anticipates session buffer overflow

capi-[#0000FF]>cardReader: <font color=blue>**Card #2**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session <font color=red>**1**</font>
    cardReader->card: open secure session (card debit key,\n\tSAM challenge 1)
    card- ->cardReader: [card challenge 1]

    cardReader->card: update record (environment)
    card- ->cardReader: ack
    cardReader->card: update record (contract list)
    card- ->cardReader: ack
    cardReader->card: update record (contract #1)
    card- ->cardReader: ack
    cardReader->card: update record (contract #2)
    card- ->cardReader: ack
    cardReader->card: update record (contract #3)
    card- ->cardReader: ack
    cardReader->card: update record (contract #4)
    card- ->cardReader: ack
    cardReader->card: update record (all counters)
    card- ->cardReader: ack
end

cardReader- -[#0000FF]>capi: [card challenge]
deactivate cardReader

capi-[#00FF00]>samReader: <font color=green>**SAM #2**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen

samReader->sam: digest init (opening data)
sam- ->samReader
samReader->sam: digest update (update environment)
sam- ->samReader
samReader->sam: digest update (update contract list)
sam- ->samReader
samReader->sam: digest update (update contract #1)
sam- ->samReader
samReader->sam: digest update (update contract #2)
sam- ->samReader
samReader->sam: digest update (update contract #3)
sam- ->samReader
samReader->sam: digest update (update contract #4)
sam- ->samReader

note over samReader
    Close card session before session buffer overflow.
end note

samReader->sam: digest close
sam- ->samReader: [SAM certificate 1]
samReader-[#00FF00]->capi: [SAM challenge 1]
deactivate samReader


capi-[#0000FF]>cardReader: <font color=blue>**Card #3**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

cardReader->card: close secure session (SAM certificate 1)
card- ->cardReader: [card certificate 1]

cardReader- -[#0000FF]>capi: [card certificate 1]
deactivate cardReader


capi-[#00FF00]>samReader: <font color=green>**SAM #3**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen

samReader->sam: digest authenticate (card certificate 1)
sam- ->samReader: [authentication status 1]

note over samReader
    Anticipate second session with the same diversifier.
end note

samReader->sam: get challenge
sam- ->samReader: [SAM challenge 2]
samReader-[#00FF00]->capi: [authentication status 1, SAM challenge 2]
deactivate samReader


capi-[#0000FF]>cardReader: <font color=blue>**Card #4**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

note over cardReader
    The card modifications aren't managed in an atomic way (split between sessions 1 & 2).
end note

group Card APDU commands inside session <font color=red>**2**</font>
    cardReader->card: open secure session (card debit key,\n\tSAM challenge 2)
    card- ->cardReader: [card challenge 2]
    cardReader->card: update record (event log #1)
    card- ->cardReader: ack
    cardReader->card: update record (event log #2)
    card- ->cardReader: ack
    cardReader->card: update record (event log #3)
    card- ->cardReader: ack
end

cardReader- -[#0000FF]>capi: [card certificate 1]
deactivate cardReader


capi- ->app: [Calypso card image:\n\t- identification data\n\t- environment data (updated)\n\t- contract list data\n\t- contract #1 data\n\t- counter #1 data]
deactivate capi

app->capi: <font color=red>**prepare**</font>:\n\t- release channel
activate capi  #pink

capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> closing (as ratified)
activate capi  #pink

capi-[#00FF00]>samReader: <font color=green>**SAM #4**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen

samReader->sam: digest init (opening data)
sam- ->samReader
samReader->sam: digest update (update event log #1)
sam- ->samReader
samReader->sam: digest update (update event log #2)
sam- ->samReader
samReader->sam: digest update (update event log #3)
sam- ->samReader
samReader->sam: digest close
sam- ->samReader: [SAM certificate 2]

samReader-[#00FF00]->capi: [SAM certificate 2]
deactivate samReader

capi-[#0000FF]>cardReader: <font color=blue>**Card #5**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

cardReader->card: close secure session (SAM certificate 2)
card- ->cardReader: [card certificate 2]
cardReader->card: close card channel
card- ->cardReader
deactivate card

cardReader-[#0000FF]->capi: [card certificate]
deactivate cardReader

capi-[#00FF00]>samReader: <font color=green>**SAM #5**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: digest authenticate (card certificate 2)
sam- ->samReader: [authentication status]

samReader-[#00FF00]->capi: [authentification status]
deactivate samReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- environment data\n\t- contract list data\n\t- contract #1 data\n\t- counter #1 data (updated)\n\t- event #1 (updated)]\nauthentification status
deactivate capi
@enduml

PlantUML version 1.2022.4(Sat Apr 09 17:29:17 RET 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: fr
Country: FR
--></g></svg>