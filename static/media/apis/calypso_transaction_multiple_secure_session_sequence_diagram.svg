<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="3828px" preserveAspectRatio="none" style="width:1378px;height:3828px;background:#FFFFFF;" version="1.1" viewBox="0 0 1378 3828" width="1378px" zoomAndPan="magnify"><defs/><g><rect fill="#FFD700" height="3647.166" style="stroke:#181818;stroke-width:1.0;" width="10" x="75.5" y="91.4883"/><rect fill="#FFC0CB" height="59.9316" style="stroke:#181818;stroke-width:1.0;" width="10" x="338.5" y="112.7988"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="338.5" y="506.6992"/><rect fill="#FFC0CB" height="2453.0176" style="stroke:#181818;stroke-width:1.0;" width="10" x="338.5" y="565.3203"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="338.5" y="3062.959"/><rect fill="#FFC0CB" height="623.3848" style="stroke:#181818;stroke-width:1.0;" width="10" x="338.5" y="3106.2695"/><rect fill="#ADD8E6" height="544.9004" style="stroke:#181818;stroke-width:1.0;" width="10" x="690" y="858.7363"/><rect fill="#ADD8E6" height="87.9316" style="stroke:#181818;stroke-width:1.0;" width="10" x="690" y="1949.916"/><rect fill="#ADD8E6" height="310.416" style="stroke:#181818;stroke-width:1.0;" width="10" x="690" y="2339.5742"/><rect fill="#ADD8E6" height="131.2422" style="stroke:#181818;stroke-width:1.0;" width="10" x="690" y="3314.0645"/><rect fill="#ADD8E6" height="3324.5078" style="stroke:#181818;stroke-width:1.0;" width="10" x="972" y="91.4883"/><rect fill="#90EE90" height="131.2422" style="stroke:#181818;stroke-width:1.0;" width="10" x="1057.5" y="625.252"/><rect fill="#90EE90" height="426.416" style="stroke:#181818;stroke-width:1.0;" width="10" x="1057.5" y="1463.5684"/><rect fill="#90EE90" height="181.8633" style="stroke:#181818;stroke-width:1.0;" width="10" x="1057.5" y="2097.7793"/><rect fill="#90EE90" height="202.5527" style="stroke:#181818;stroke-width:1.0;" width="10" x="1057.5" y="2709.9219"/><rect fill="#90EE90" height="87.9316" style="stroke:#181818;stroke-width:1.0;" width="10" x="1057.5" y="3166.2012"/><rect fill="#90EE90" height="87.9316" style="stroke:#181818;stroke-width:1.0;" width="10" x="1057.5" y="3505.2383"/><rect fill="#90EE90" height="3647.166" style="stroke:#181818;stroke-width:1.0;" width="10" x="1330.5" y="91.4883"/><rect height="501.5898" style="stroke:#000000;stroke-width:1.5;fill:none;" width="379" x="632.5" y="873.7363"/><rect height="267.1055" style="stroke:#000000;stroke-width:1.5;fill:none;" width="379" x="632.5" y="2354.5742"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="80" x2="80" y1="81.4883" y2="3747.6543"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="343.5" x2="343.5" y1="81.4883" y2="3747.6543"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="588.5" x2="588.5" y1="81.4883" y2="3747.6543"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="694.5" x2="694.5" y1="81.4883" y2="3747.6543"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="976.5" x2="976.5" y1="81.4883" y2="3747.6543"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="1062.5" x2="1062.5" y1="81.4883" y2="3747.6543"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="1335.5" x2="1335.5" y1="81.4883" y2="3747.6543"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="145" x="5" y="78.5352">Ticketing Application</text><ellipse cx="80.5" cy="13.5" fill="#FFD700" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M80.5,21.5 L80.5,48.5 M67.5,29.5 L93.5,29.5 M80.5,48.5 L67.5,63.5 M80.5,48.5 L93.5,63.5 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="145" x="5" y="3760.1895">Ticketing Application</text><ellipse cx="80.5" cy="3771.6426" fill="#FFD700" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M80.5,3779.6426 L80.5,3806.6426 M67.5,3787.6426 L93.5,3787.6426 M80.5,3806.6426 L67.5,3821.6426 M80.5,3806.6426 L93.5,3821.6426 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#FFC0CB" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="94" x="296.5" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="80" x="303.5" y="70.5352">Calypso API</text><rect fill="#FFC0CB" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="94" x="296.5" y="3746.6543"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="80" x="303.5" y="3767.1895">Calypso API</text><rect fill="#FFC0CB" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="88" x="544.5" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="74" x="551.5" y="70.5352">Reader API</text><rect fill="#FFC0CB" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="88" x="544.5" y="3746.6543"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="74" x="551.5" y="3767.1895">Reader API</text><rect fill="#ADD8E6" height="46.9766" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="105" x="642.5" y="33.5117"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="649.5" y="54.0469">Calypso Card</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48" x="671" y="70.5352">Reader</text><rect fill="#ADD8E6" height="46.9766" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="105" x="642.5" y="3746.6543"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="649.5" y="3767.1895">Calypso Card</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48" x="671" y="3783.6777">Reader</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="33" x="957.5" y="78.5352">Card</text><path d="M956.5,37 L956.5,61 M956.5,49 L973.5,49 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><ellipse cx="985.5" cy="49" fill="#ADD8E6" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="33" x="957.5" y="3760.1895">Card</text><path d="M956.5,3767.1426 L956.5,3791.1426 M956.5,3779.1426 L973.5,3779.1426 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><ellipse cx="985.5" cy="3779.1426" fill="#ADD8E6" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#90EE90" height="46.9766" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="102" x="1011.5" y="33.5117"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="88" x="1018.5" y="54.0469">Calypso SAM</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48" x="1038.5" y="70.5352">Reader</text><rect fill="#90EE90" height="46.9766" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="102" x="1011.5" y="3746.6543"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="88" x="1018.5" y="3767.1895">Calypso SAM</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48" x="1038.5" y="3783.6777">Reader</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="1304.5" y="62.0469">selected</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="31" x="1317" y="78.5352">SAM</text><path d="M1315,20.5117 L1315,44.5117 M1315,32.5117 L1332,32.5117 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><ellipse cx="1344" cy="32.5117" fill="#90EE90" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="1304.5" y="3760.1895">selected</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="31" x="1317" y="3776.6777">SAM</text><path d="M1315,3783.6309 L1315,3807.6309 M1315,3795.6309 L1332,3795.6309 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><ellipse cx="1344" cy="3795.6309" fill="#90EE90" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#FFD700" height="3647.166" style="stroke:#181818;stroke-width:1.0;" width="10" x="75.5" y="91.4883"/><rect fill="#FFC0CB" height="59.9316" style="stroke:#181818;stroke-width:1.0;" width="10" x="338.5" y="112.7988"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="338.5" y="506.6992"/><rect fill="#FFC0CB" height="2453.0176" style="stroke:#181818;stroke-width:1.0;" width="10" x="338.5" y="565.3203"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="338.5" y="3062.959"/><rect fill="#FFC0CB" height="623.3848" style="stroke:#181818;stroke-width:1.0;" width="10" x="338.5" y="3106.2695"/><rect fill="#ADD8E6" height="544.9004" style="stroke:#181818;stroke-width:1.0;" width="10" x="690" y="858.7363"/><rect fill="#ADD8E6" height="87.9316" style="stroke:#181818;stroke-width:1.0;" width="10" x="690" y="1949.916"/><rect fill="#ADD8E6" height="310.416" style="stroke:#181818;stroke-width:1.0;" width="10" x="690" y="2339.5742"/><rect fill="#ADD8E6" height="131.2422" style="stroke:#181818;stroke-width:1.0;" width="10" x="690" y="3314.0645"/><rect fill="#ADD8E6" height="3324.5078" style="stroke:#181818;stroke-width:1.0;" width="10" x="972" y="91.4883"/><rect fill="#90EE90" height="131.2422" style="stroke:#181818;stroke-width:1.0;" width="10" x="1057.5" y="625.252"/><rect fill="#90EE90" height="426.416" style="stroke:#181818;stroke-width:1.0;" width="10" x="1057.5" y="1463.5684"/><rect fill="#90EE90" height="181.8633" style="stroke:#181818;stroke-width:1.0;" width="10" x="1057.5" y="2097.7793"/><rect fill="#90EE90" height="202.5527" style="stroke:#181818;stroke-width:1.0;" width="10" x="1057.5" y="2709.9219"/><rect fill="#90EE90" height="87.9316" style="stroke:#181818;stroke-width:1.0;" width="10" x="1057.5" y="3166.2012"/><rect fill="#90EE90" height="87.9316" style="stroke:#181818;stroke-width:1.0;" width="10" x="1057.5" y="3505.2383"/><rect fill="#90EE90" height="3647.166" style="stroke:#181818;stroke-width:1.0;" width="10" x="1330.5" y="91.4883"/><polygon fill="#181818" points="326.5,108.7988,336.5,112.7988,326.5,116.7988,330.5,112.7988" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="332.5" y1="112.7988" y2="112.7988"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="27" x="92.5" y="108.0566">cast</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="81" x="123.5" y="108.0566">Calypso card</text><polygon fill="#181818" points="96.5,168.7305,86.5,172.7305,96.5,176.7305,92.5,172.7305" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="342.5" y1="172.7305" y2="172.7305"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="102.5" y="137.3672">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127" x="134.5" y="152.6777">- identification data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="134.5" y="167.9883">- session buffer size]</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1371.5" x="0" y="201.3857"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1371.5" y1="201.3857" y2="201.3857"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1371.5" y1="204.3857" y2="204.3857"/><rect fill="#EEEEEE" height="23.3105" style="stroke:#000000;stroke-width:2.0;" width="179" x="596.25" y="190.7305"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="161" x="602.25" y="207.2988">Card secure transaction</text><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="127.5" y1="275.9727" y2="275.9727"/><line style="stroke:#181818;stroke-width:1.0;" x1="127.5" x2="127.5" y1="275.9727" y2="288.9727"/><line style="stroke:#181818;stroke-width:1.0;" x1="86.5" x2="127.5" y1="288.9727" y2="288.9727"/><polygon fill="#181818" points="96.5,284.9727,86.5,288.9727,96.5,292.9727,92.5,288.9727" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="72" x="92.5" y="240.6094">instantiate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="168.5" y="240.6094">Calypso card transaction:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="124.5" y="255.9199">- Calypso card resource</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="124.5" y="271.2305">- Calypso SAM resource</text><path d="M98,301.9727 L98,326.9727 L589,326.9727 L589,311.9727 L579,301.9727 L98,301.9727 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M579,301.9727 L579,311.9727 L589,311.9727 L579,301.9727 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="470" x="104" y="319.541">Reads again the environment data inside the session to authenticate them.</text><polygon fill="#181818" points="326.5,502.6992,336.5,506.6992,326.5,510.6992,330.5,506.6992" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="332.5" y1="506.6992" y2="506.6992"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="92.5" y="348.8516">prepare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="106" x="150.5" y="348.8516">card transaction:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="162" x="124.5" y="364.1621">- update environment file</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="124.5" y="379.4727">- update contract list</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="124.5" y="394.7832">- update contract #1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="124.5" y="410.0938">- update contract #2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="124.5" y="425.4043">- update contract #3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="124.5" y="440.7148">- update contract #4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="133" x="124.5" y="456.0254">- update all counters</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="137" x="124.5" y="471.3359">- update event log #1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="137" x="124.5" y="486.6465">- update event log #2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="137" x="124.5" y="501.957">- update event log #3</text><polygon fill="#181818" points="96.5,516.6992,86.5,520.6992,96.5,524.6992,92.5,520.6992" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="342.5" y1="520.6992" y2="520.6992"/><polygon fill="#181818" points="326.5,561.3203,336.5,565.3203,326.5,569.3203,330.5,565.3203" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="332.5" y1="565.3203" y2="565.3203"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="92.5" y="545.2676">process</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="178" x="148.5" y="545.2676">opening (LOAD access level,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="103" x="188.5" y="560.5781">MULTIPLE mode)</text><polygon fill="#00FF00" points="1045.5,621.252,1055.5,625.252,1045.5,629.252,1049.5,625.252" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;" x1="348.5" x2="1051.5" y1="625.252" y2="625.252"/><text fill="#008000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="51" x="355.5" y="589.8887">SAM #1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="355.5" y="605.1992">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="387.5" y="620.5098">- APDU list</text><polygon fill="#181818" points="1318.5,650.5625,1328.5,654.5625,1318.5,658.5625,1322.5,654.5625" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1067.5" x2="1324.5" y1="654.5625" y2="654.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="181" x="1074.5" y="649.8203">select diversifier (card serial)</text><polygon fill="#181818" points="1078.5,664.5625,1068.5,668.5625,1078.5,672.5625,1074.5,668.5625" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1072.5" x2="1329.5" y1="668.5625" y2="668.5625"/><polygon fill="#181818" points="1318.5,693.873,1328.5,697.873,1318.5,701.873,1322.5,697.873" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1067.5" x2="1324.5" y1="697.873" y2="697.873"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="84" x="1074.5" y="693.1309">get challenge</text><polygon fill="#181818" points="1078.5,723.1836,1068.5,727.1836,1078.5,731.1836,1074.5,727.1836" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1072.5" x2="1329.5" y1="727.1836" y2="727.1836"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="111" x="1084.5" y="722.4414">[SAM challenge 1]</text><polygon fill="#00FF00" points="359.5,752.4941,349.5,756.4941,359.5,760.4941,355.5,756.4941" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="353.5" x2="1061.5" y1="756.4941" y2="756.4941"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="111" x="365.5" y="751.752">[SAM challenge 1]</text><line style="stroke:#181818;stroke-width:1.0;" x1="348.5" x2="390.5" y1="785.8047" y2="785.8047"/><line style="stroke:#181818;stroke-width:1.0;" x1="390.5" x2="390.5" y1="785.8047" y2="798.8047"/><line style="stroke:#181818;stroke-width:1.0;" x1="349.5" x2="390.5" y1="798.8047" y2="798.8047"/><polygon fill="#181818" points="359.5,794.8047,349.5,798.8047,359.5,802.8047,355.5,798.8047" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="221" x="355.5" y="781.0625">anticipates session buffer overflow</text><polygon fill="#0000FF" points="678,854.7363,688,858.7363,678,862.7363,682,858.7363" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;" x1="348.5" x2="684" y1="858.7363" y2="858.7363"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="355.5" y="823.373">Card #2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="355.5" y="838.6836">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="387.5" y="853.9941">- APDU list</text><path d="M632.5,873.7363 L941.5,873.7363 L941.5,881.0469 L931.5,891.0469 L632.5,891.0469 L632.5,873.7363 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="501.5898" style="stroke:#000000;stroke-width:1.5;" width="379" x="632.5" y="873.7363"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="251" x="647.5" y="887.3047">Card APDU commands inside session</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="902.5" y="887.3047">1</text><polygon fill="#181818" points="960,923.668,970,927.668,960,931.668,964,927.668" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="700" x2="966" y1="927.668" y2="927.668"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="229" x="707" y="907.6152">open secure session (card debit key,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="107" x="739" y="922.9258">SAM challenge 1)</text><polygon fill="#181818" points="711,952.9785,701,956.9785,711,960.9785,707,956.9785" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="705" x2="971" y1="956.9785" y2="956.9785"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="111" x="717" y="952.2363">[card challenge 1]</text><polygon fill="#181818" points="960,982.2891,970,986.2891,960,990.2891,964,986.2891" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="700" x2="966" y1="986.2891" y2="986.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="178" x="707" y="981.5469">update record (environment)</text><polygon fill="#181818" points="711,1011.5996,701,1015.5996,711,1019.5996,707,1015.5996" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="705" x2="971" y1="1015.5996" y2="1015.5996"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="22" x="717" y="1010.8574">ack</text><polygon fill="#181818" points="960,1040.9102,970,1044.9102,960,1048.9102,964,1044.9102" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="700" x2="966" y1="1044.9102" y2="1044.9102"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="175" x="707" y="1040.168">update record (contract list)</text><polygon fill="#181818" points="711,1070.2207,701,1074.2207,711,1078.2207,707,1074.2207" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="705" x2="971" y1="1074.2207" y2="1074.2207"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="22" x="717" y="1069.4785">ack</text><polygon fill="#181818" points="960,1099.5313,970,1103.5313,960,1107.5313,964,1103.5313" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="700" x2="966" y1="1103.5313" y2="1103.5313"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="171" x="707" y="1098.7891">update record (contract #1)</text><polygon fill="#181818" points="711,1128.8418,701,1132.8418,711,1136.8418,707,1132.8418" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="705" x2="971" y1="1132.8418" y2="1132.8418"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="22" x="717" y="1128.0996">ack</text><polygon fill="#181818" points="960,1158.1523,970,1162.1523,960,1166.1523,964,1162.1523" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="700" x2="966" y1="1162.1523" y2="1162.1523"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="171" x="707" y="1157.4102">update record (contract #2)</text><polygon fill="#181818" points="711,1187.4629,701,1191.4629,711,1195.4629,707,1191.4629" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="705" x2="971" y1="1191.4629" y2="1191.4629"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="22" x="717" y="1186.7207">ack</text><polygon fill="#181818" points="960,1216.7734,970,1220.7734,960,1224.7734,964,1220.7734" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="700" x2="966" y1="1220.7734" y2="1220.7734"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="171" x="707" y="1216.0313">update record (contract #3)</text><polygon fill="#181818" points="711,1246.084,701,1250.084,711,1254.084,707,1250.084" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="705" x2="971" y1="1250.084" y2="1250.084"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="22" x="717" y="1245.3418">ack</text><polygon fill="#181818" points="960,1275.3945,970,1279.3945,960,1283.3945,964,1279.3945" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="700" x2="966" y1="1279.3945" y2="1279.3945"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="171" x="707" y="1274.6523">update record (contract #4)</text><polygon fill="#181818" points="711,1304.7051,701,1308.7051,711,1312.7051,707,1308.7051" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="705" x2="971" y1="1308.7051" y2="1308.7051"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="22" x="717" y="1303.9629">ack</text><polygon fill="#181818" points="960,1334.0156,970,1338.0156,960,1342.0156,964,1338.0156" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="700" x2="966" y1="1338.0156" y2="1338.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="173" x="707" y="1333.2734">update record (all counters)</text><polygon fill="#181818" points="711,1363.3262,701,1367.3262,711,1371.3262,707,1367.3262" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="705" x2="971" y1="1367.3262" y2="1367.3262"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="22" x="717" y="1362.584">ack</text><polygon fill="#0000FF" points="359.5,1399.6367,349.5,1403.6367,359.5,1407.6367,355.5,1403.6367" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="353.5" x2="694" y1="1403.6367" y2="1403.6367"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="99" x="365.5" y="1398.8945">[card challenge]</text><polygon fill="#00FF00" points="1045.5,1459.5684,1055.5,1463.5684,1045.5,1467.5684,1049.5,1463.5684" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;" x1="348.5" x2="1051.5" y1="1463.5684" y2="1463.5684"/><text fill="#008000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="51" x="355.5" y="1428.2051">SAM #2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="355.5" y="1443.5156">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="387.5" y="1458.8262">- APDU list</text><polygon fill="#181818" points="1318.5,1488.8789,1328.5,1492.8789,1318.5,1496.8789,1322.5,1492.8789" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1067.5" x2="1324.5" y1="1492.8789" y2="1492.8789"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1074.5" y="1488.1367">digest init (opening data)</text><polygon fill="#181818" points="1078.5,1502.8789,1068.5,1506.8789,1078.5,1510.8789,1074.5,1506.8789" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1072.5" x2="1329.5" y1="1506.8789" y2="1506.8789"/><polygon fill="#181818" points="1318.5,1532.1895,1328.5,1536.1895,1318.5,1540.1895,1322.5,1536.1895" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1067.5" x2="1324.5" y1="1536.1895" y2="1536.1895"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="224" x="1074.5" y="1531.4473">digest update (update environment)</text><polygon fill="#181818" points="1078.5,1546.1895,1068.5,1550.1895,1078.5,1554.1895,1074.5,1550.1895" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1072.5" x2="1329.5" y1="1550.1895" y2="1550.1895"/><polygon fill="#181818" points="1318.5,1575.5,1328.5,1579.5,1318.5,1583.5,1322.5,1579.5" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1067.5" x2="1324.5" y1="1579.5" y2="1579.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="221" x="1074.5" y="1574.7578">digest update (update contract list)</text><polygon fill="#181818" points="1078.5,1589.5,1068.5,1593.5,1078.5,1597.5,1074.5,1593.5" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1072.5" x2="1329.5" y1="1593.5" y2="1593.5"/><polygon fill="#181818" points="1318.5,1618.8105,1328.5,1622.8105,1318.5,1626.8105,1322.5,1622.8105" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1067.5" x2="1324.5" y1="1622.8105" y2="1622.8105"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="217" x="1074.5" y="1618.0684">digest update (update contract #1)</text><polygon fill="#181818" points="1078.5,1632.8105,1068.5,1636.8105,1078.5,1640.8105,1074.5,1636.8105" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1072.5" x2="1329.5" y1="1636.8105" y2="1636.8105"/><polygon fill="#181818" points="1318.5,1662.1211,1328.5,1666.1211,1318.5,1670.1211,1322.5,1666.1211" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1067.5" x2="1324.5" y1="1666.1211" y2="1666.1211"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="217" x="1074.5" y="1661.3789">digest update (update contract #2)</text><polygon fill="#181818" points="1078.5,1676.1211,1068.5,1680.1211,1078.5,1684.1211,1074.5,1680.1211" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1072.5" x2="1329.5" y1="1680.1211" y2="1680.1211"/><polygon fill="#181818" points="1318.5,1705.4316,1328.5,1709.4316,1318.5,1713.4316,1322.5,1709.4316" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1067.5" x2="1324.5" y1="1709.4316" y2="1709.4316"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="217" x="1074.5" y="1704.6895">digest update (update contract #3)</text><polygon fill="#181818" points="1078.5,1719.4316,1068.5,1723.4316,1078.5,1727.4316,1074.5,1723.4316" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1072.5" x2="1329.5" y1="1723.4316" y2="1723.4316"/><polygon fill="#181818" points="1318.5,1748.7422,1328.5,1752.7422,1318.5,1756.7422,1322.5,1752.7422" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1067.5" x2="1324.5" y1="1752.7422" y2="1752.7422"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="217" x="1074.5" y="1748">digest update (update contract #4)</text><polygon fill="#181818" points="1078.5,1762.7422,1068.5,1766.7422,1078.5,1770.7422,1074.5,1766.7422" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1072.5" x2="1329.5" y1="1766.7422" y2="1766.7422"/><path d="M893,1779.7422 L893,1804.7422 L1232,1804.7422 L1232,1789.7422 L1222,1779.7422 L893,1779.7422 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1222,1779.7422 L1222,1789.7422 L1232,1789.7422 L1222,1779.7422 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="318" x="899" y="1797.3105">Close card session before session buffer overflow.</text><polygon fill="#181818" points="1318.5,1827.3633,1328.5,1831.3633,1318.5,1835.3633,1322.5,1831.3633" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1067.5" x2="1324.5" y1="1831.3633" y2="1831.3633"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="76" x="1074.5" y="1826.6211">digest close</text><polygon fill="#181818" points="1078.5,1856.6738,1068.5,1860.6738,1078.5,1864.6738,1074.5,1860.6738" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1072.5" x2="1329.5" y1="1860.6738" y2="1860.6738"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="1084.5" y="1855.9316">[SAM certificate 1]</text><polygon fill="#00FF00" points="359.5,1885.9844,349.5,1889.9844,359.5,1893.9844,355.5,1889.9844" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="353.5" x2="1061.5" y1="1889.9844" y2="1889.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="111" x="365.5" y="1885.2422">[SAM challenge 1]</text><polygon fill="#0000FF" points="678,1945.916,688,1949.916,678,1953.916,682,1949.916" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;" x1="348.5" x2="684" y1="1949.916" y2="1949.916"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="355.5" y="1914.5527">Card #3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="355.5" y="1929.8633">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="387.5" y="1945.1738">- APDU list</text><polygon fill="#181818" points="960,1975.2266,970,1979.2266,960,1983.2266,964,1979.2266" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="700" x2="966" y1="1979.2266" y2="1979.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="248" x="707" y="1974.4844">close secure session (SAM certificate 1)</text><polygon fill="#181818" points="711,2004.5371,701,2008.5371,711,2012.5371,707,2008.5371" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="705" x2="971" y1="2008.5371" y2="2008.5371"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="717" y="2003.7949">[card certificate 1]</text><polygon fill="#0000FF" points="359.5,2033.8477,349.5,2037.8477,359.5,2041.8477,355.5,2037.8477" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="353.5" x2="694" y1="2037.8477" y2="2037.8477"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="365.5" y="2033.1055">[card certificate 1]</text><polygon fill="#00FF00" points="1045.5,2093.7793,1055.5,2097.7793,1045.5,2101.7793,1049.5,2097.7793" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;" x1="348.5" x2="1051.5" y1="2097.7793" y2="2097.7793"/><text fill="#008000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="51" x="355.5" y="2062.416">SAM #3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="355.5" y="2077.7266">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="387.5" y="2093.0371">- APDU list</text><polygon fill="#181818" points="1318.5,2123.0898,1328.5,2127.0898,1318.5,2131.0898,1322.5,2127.0898" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1067.5" x2="1324.5" y1="2127.0898" y2="2127.0898"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="239" x="1074.5" y="2122.3477">digest authenticate (card certificate 1)</text><polygon fill="#181818" points="1078.5,2152.4004,1068.5,2156.4004,1078.5,2160.4004,1074.5,2156.4004" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1072.5" x2="1329.5" y1="2156.4004" y2="2156.4004"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="1084.5" y="2151.6582">[authentication status 1]</text><path d="M888,2169.4004 L888,2194.4004 L1237,2194.4004 L1237,2179.4004 L1227,2169.4004 L888,2169.4004 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1227,2169.4004 L1227,2179.4004 L1237,2179.4004 L1227,2169.4004 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="328" x="894" y="2186.9688">Anticipate second session with the same diversifier.</text><polygon fill="#181818" points="1318.5,2217.0215,1328.5,2221.0215,1318.5,2225.0215,1322.5,2221.0215" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1067.5" x2="1324.5" y1="2221.0215" y2="2221.0215"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="84" x="1074.5" y="2216.2793">get challenge</text><polygon fill="#181818" points="1078.5,2246.332,1068.5,2250.332,1078.5,2254.332,1074.5,2250.332" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1072.5" x2="1329.5" y1="2250.332" y2="2250.332"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="111" x="1084.5" y="2245.5898">[SAM challenge 2]</text><polygon fill="#00FF00" points="359.5,2275.6426,349.5,2279.6426,359.5,2283.6426,355.5,2279.6426" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="353.5" x2="1061.5" y1="2279.6426" y2="2279.6426"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="265" x="365.5" y="2274.9004">[authentication status 1, SAM challenge 2]</text><polygon fill="#0000FF" points="678,2335.5742,688,2339.5742,678,2343.5742,682,2339.5742" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;" x1="348.5" x2="684" y1="2339.5742" y2="2339.5742"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="355.5" y="2304.2109">Card #4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="355.5" y="2319.5215">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="387.5" y="2334.832">- APDU list</text><path d="M632.5,2354.5742 L941.5,2354.5742 L941.5,2361.8848 L931.5,2371.8848 L632.5,2371.8848 L632.5,2354.5742 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="267.1055" style="stroke:#000000;stroke-width:1.5;" width="379" x="632.5" y="2354.5742"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="251" x="647.5" y="2368.1426">Card APDU commands inside session</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="902.5" y="2368.1426">2</text><polygon fill="#181818" points="960,2404.5059,970,2408.5059,960,2412.5059,964,2408.5059" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="700" x2="966" y1="2408.5059" y2="2408.5059"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="229" x="707" y="2388.4531">open secure session (card debit key,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="107" x="739" y="2403.7637">SAM challenge 2)</text><polygon fill="#181818" points="711,2433.8164,701,2437.8164,711,2441.8164,707,2437.8164" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="705" x2="971" y1="2437.8164" y2="2437.8164"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="111" x="717" y="2433.0742">[card challenge 2]</text><polygon fill="#181818" points="960,2463.127,970,2467.127,960,2471.127,964,2467.127" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="700" x2="966" y1="2467.127" y2="2467.127"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="177" x="707" y="2462.3848">update record (event log #1)</text><polygon fill="#181818" points="711,2492.4375,701,2496.4375,711,2500.4375,707,2496.4375" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="705" x2="971" y1="2496.4375" y2="2496.4375"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="22" x="717" y="2491.6953">ack</text><polygon fill="#181818" points="960,2521.748,970,2525.748,960,2529.748,964,2525.748" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="700" x2="966" y1="2525.748" y2="2525.748"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="177" x="707" y="2521.0059">update record (event log #2)</text><polygon fill="#181818" points="711,2551.0586,701,2555.0586,711,2559.0586,707,2555.0586" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="705" x2="971" y1="2555.0586" y2="2555.0586"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="22" x="717" y="2550.3164">ack</text><polygon fill="#181818" points="960,2580.3691,970,2584.3691,960,2588.3691,964,2584.3691" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="700" x2="966" y1="2584.3691" y2="2584.3691"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="177" x="707" y="2579.627">update record (event log #3)</text><polygon fill="#181818" points="711,2609.6797,701,2613.6797,711,2617.6797,707,2613.6797" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="705" x2="971" y1="2613.6797" y2="2613.6797"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="22" x="717" y="2608.9375">ack</text><polygon fill="#0000FF" points="359.5,2645.9902,349.5,2649.9902,359.5,2653.9902,355.5,2649.9902" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="353.5" x2="694" y1="2649.9902" y2="2649.9902"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="365.5" y="2645.248">[card certificate 1]</text><polygon fill="#00FF00" points="1045.5,2705.9219,1055.5,2709.9219,1045.5,2713.9219,1049.5,2709.9219" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;" x1="348.5" x2="1051.5" y1="2709.9219" y2="2709.9219"/><text fill="#008000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="51" x="355.5" y="2674.5586">SAM #3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="355.5" y="2689.8691">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="387.5" y="2705.1797">- APDU list</text><polygon fill="#181818" points="1318.5,2735.2324,1328.5,2739.2324,1318.5,2743.2324,1322.5,2739.2324" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1067.5" x2="1324.5" y1="2739.2324" y2="2739.2324"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1074.5" y="2734.4902">digest init (opening data)</text><polygon fill="#181818" points="1078.5,2749.2324,1068.5,2753.2324,1078.5,2757.2324,1074.5,2753.2324" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1072.5" x2="1329.5" y1="2753.2324" y2="2753.2324"/><polygon fill="#181818" points="1318.5,2778.543,1328.5,2782.543,1318.5,2786.543,1322.5,2782.543" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1067.5" x2="1324.5" y1="2782.543" y2="2782.543"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="1074.5" y="2777.8008">digest update (update event log #1)</text><polygon fill="#181818" points="1078.5,2792.543,1068.5,2796.543,1078.5,2800.543,1074.5,2796.543" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1072.5" x2="1329.5" y1="2796.543" y2="2796.543"/><polygon fill="#181818" points="1318.5,2821.8535,1328.5,2825.8535,1318.5,2829.8535,1322.5,2825.8535" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1067.5" x2="1324.5" y1="2825.8535" y2="2825.8535"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="1074.5" y="2821.1113">digest update (update event log #2)</text><polygon fill="#181818" points="1078.5,2835.8535,1068.5,2839.8535,1078.5,2843.8535,1074.5,2839.8535" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1072.5" x2="1329.5" y1="2839.8535" y2="2839.8535"/><polygon fill="#181818" points="1318.5,2865.1641,1328.5,2869.1641,1318.5,2873.1641,1322.5,2869.1641" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1067.5" x2="1324.5" y1="2869.1641" y2="2869.1641"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="1074.5" y="2864.4219">digest update (update event log #3)</text><polygon fill="#181818" points="1078.5,2879.1641,1068.5,2883.1641,1078.5,2887.1641,1074.5,2883.1641" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1072.5" x2="1329.5" y1="2883.1641" y2="2883.1641"/><polygon fill="#00FF00" points="359.5,2908.4746,349.5,2912.4746,359.5,2916.4746,355.5,2912.4746" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="353.5" x2="1061.5" y1="2912.4746" y2="2912.4746"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="22" x="365.5" y="2907.7324">ack</text><polygon fill="#181818" points="96.5,3014.3379,86.5,3018.3379,96.5,3022.3379,92.5,3018.3379" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="342.5" y1="3018.3379" y2="3018.3379"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="102.5" y="2937.043">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127" x="134.5" y="2952.3535">- identification data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="185" x="134.5" y="2967.6641">- environment data (updated)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="119" x="134.5" y="2982.9746">- contract list data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="134.5" y="2998.2852">- contract #1 data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="134.5" y="3013.5957">- counter #1 data]</text><polygon fill="#181818" points="326.5,3058.959,336.5,3062.959,326.5,3066.959,330.5,3062.959" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="332.5" y1="3062.959" y2="3062.959"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="92.5" y="3042.9063">prepare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="146.5" y="3042.9063">:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="109" x="124.5" y="3058.2168">- release channel</text><polygon fill="#181818" points="96.5,3072.959,86.5,3076.959,96.5,3080.959,92.5,3076.959" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="342.5" y1="3076.959" y2="3076.959"/><polygon fill="#181818" points="326.5,3102.2695,336.5,3106.2695,326.5,3110.2695,330.5,3106.2695" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="332.5" y1="3106.2695" y2="3106.2695"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="92.5" y="3101.5273">process</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="121" x="148.5" y="3101.5273">closing (as ratified)</text><polygon fill="#00FF00" points="1045.5,3162.2012,1055.5,3166.2012,1045.5,3170.2012,1049.5,3166.2012" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;" x1="348.5" x2="1051.5" y1="3166.2012" y2="3166.2012"/><text fill="#008000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="51" x="355.5" y="3130.8379">SAM #4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="355.5" y="3146.1484">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="387.5" y="3161.459">- APDU list</text><polygon fill="#181818" points="1318.5,3191.5117,1328.5,3195.5117,1318.5,3199.5117,1322.5,3195.5117" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1067.5" x2="1324.5" y1="3195.5117" y2="3195.5117"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="76" x="1074.5" y="3190.7695">digest close</text><polygon fill="#181818" points="1078.5,3220.8223,1068.5,3224.8223,1078.5,3228.8223,1074.5,3224.8223" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1072.5" x2="1329.5" y1="3224.8223" y2="3224.8223"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="1084.5" y="3220.0801">[SAM certificate 2]</text><polygon fill="#00FF00" points="359.5,3250.1328,349.5,3254.1328,359.5,3258.1328,355.5,3254.1328" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="353.5" x2="1061.5" y1="3254.1328" y2="3254.1328"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="365.5" y="3249.3906">[SAM certificate 2]</text><polygon fill="#0000FF" points="678,3310.0645,688,3314.0645,678,3318.0645,682,3314.0645" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;" x1="348.5" x2="684" y1="3314.0645" y2="3314.0645"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="355.5" y="3278.7012">Card #3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="355.5" y="3294.0117">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="387.5" y="3309.3223">- APDU list</text><polygon fill="#181818" points="960,3339.375,970,3343.375,960,3347.375,964,3343.375" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="700" x2="966" y1="3343.375" y2="3343.375"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="248" x="707" y="3338.6328">close secure session (SAM certificate 2)</text><polygon fill="#181818" points="711,3368.6855,701,3372.6855,711,3376.6855,707,3372.6855" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="705" x2="971" y1="3372.6855" y2="3372.6855"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="717" y="3367.9434">[card certificate 2]</text><polygon fill="#181818" points="960,3397.9961,970,3401.9961,960,3405.9961,964,3401.9961" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="700" x2="966" y1="3401.9961" y2="3401.9961"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="707" y="3397.2539">close card channel</text><polygon fill="#181818" points="711,3411.9961,701,3415.9961,711,3419.9961,707,3415.9961" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="705" x2="976" y1="3415.9961" y2="3415.9961"/><polygon fill="#0000FF" points="359.5,3441.3066,349.5,3445.3066,359.5,3449.3066,355.5,3445.3066" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="353.5" x2="694" y1="3445.3066" y2="3445.3066"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="365.5" y="3440.5645">[card certificate]</text><polygon fill="#00FF00" points="1045.5,3501.2383,1055.5,3505.2383,1045.5,3509.2383,1049.5,3505.2383" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;" x1="348.5" x2="1051.5" y1="3505.2383" y2="3505.2383"/><text fill="#008000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="51" x="355.5" y="3469.875">SAM #3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="355.5" y="3485.1855">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="387.5" y="3500.4961">- APDU list</text><polygon fill="#181818" points="1318.5,3530.5488,1328.5,3534.5488,1318.5,3538.5488,1322.5,3534.5488" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1067.5" x2="1324.5" y1="3534.5488" y2="3534.5488"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="239" x="1074.5" y="3529.8066">digest authenticate (card certificate 2)</text><polygon fill="#181818" points="1078.5,3559.8594,1068.5,3563.8594,1078.5,3567.8594,1074.5,3563.8594" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1072.5" x2="1329.5" y1="3563.8594" y2="3563.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="142" x="1084.5" y="3559.1172">[authentication status]</text><polygon fill="#00FF00" points="359.5,3589.1699,349.5,3593.1699,359.5,3597.1699,355.5,3593.1699" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="353.5" x2="1061.5" y1="3593.1699" y2="3593.1699"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="365.5" y="3588.4277">[authentification status]</text><polygon fill="#181818" points="96.5,3725.6543,86.5,3729.6543,96.5,3733.6543,92.5,3729.6543" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="342.5" y1="3729.6543" y2="3729.6543"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="102.5" y="3617.7383">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127" x="134.5" y="3633.0488">- identification data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="122" x="134.5" y="3648.3594">- environment data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="119" x="134.5" y="3663.6699">- contract list data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="134.5" y="3678.9805">- contract #1 data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="174" x="134.5" y="3694.291">- counter #1 data (updated)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="133" x="134.5" y="3709.6016">- event #1 (updated)]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="143" x="102.5" y="3724.9121">authentification status</text><!--MD5=[d16dd8f4dac9efd9db3e22a754ae8eba]
@startuml

'skinparam ClassBorderColor #F1C40F
skinparam ClassBorderColor #D4AC0D
skinparam stereotypeABorderColor #A9DCDF
skinparam stereotypeIBorderColor #B4A7E5
skinparam stereotypeCBorderColor #ADD1B2
skinparam stereotypeEBorderColor #EB93DF
skinparam shadowing false

skinparam StateBorderColor #D4AC0D
skinparam ActivityBorderColor #D4AC0D

' Red
skinparam ClassBackgroundColor<<red>> #FDEDEC
skinparam ClassBorderColor<<red>> #E74C3C
hide <<red>> stereotype
' Purple
skinparam ClassBackgroundColor<<purple>> #F4ECF7
skinparam ClassBorderColor<<purple>> #8E44AD
hide <<purple>> stereotype
' blue
skinparam ClassBackgroundColor<<blue>> #EBF5FB
skinparam ClassBorderColor<<blue>> #3498DB
hide <<blue>> stereotype
' Green
skinparam ClassBackgroundColor<<green>> #EAFAF1
skinparam ClassBorderColor<<green>> #2ECC71
hide <<green>> stereotype

' Orange
skinparam ClassBackgroundColor<<orange>> #FDF2E9
skinparam ClassBorderColor<<orange>> #E67E22
hide <<orange>> stereotype

' Grey
skinparam ClassBackgroundColor<<grey>> #EAECEE
skinparam ClassBorderColor<<grey>> #2C3E50
hide <<grey>> stereotype

actor "Ticketing Application" as app #gold
participant "Calypso API" as capi #pink
participant "Reader API" as rapi #pink
participant "Calypso Card\nReader" as cardReader #lightBlue
boundary "**Card**" as card #lightBlue
participant "Calypso SAM\nReader" as samReader #lightGreen
boundary "selected\n**SAM**" as sam #lightGreen

activate app #gold
activate sam #lightGreen

activate card #lightBlue

app->capi: **cast** Calypso card
activate capi  #pink
capi- ->app: [Calypso card image:\n\t- identification data\n\t- session buffer size]

deactivate capi

== Card secure transaction ==

app->app: **instantiate** Calypso card transaction:\n\t- Calypso card resource\n\t- Calypso SAM resource

note over capi
    Reads again the environment data inside the session to authenticate them.
end note

app->capi: <font color=red>**prepare**</font> card transaction:\n\t- update environment file\n\t- update contract list\n\t- update contract #1\n\t- update contract #2\n\t- update contract #3\n\t- update contract #4\n\t- update all counters\n\t- update event log #1\n\t- update event log #2\n\t- update event log #3
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> opening (LOAD access level,\n\t\t\tMULTIPLE mode)
activate capi  #pink

capi-[#00FF00]>samReader: <font color=green>**SAM #1**<font color=red>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: select diversifier (card serial)
sam- ->samReader
samReader->sam: get challenge
sam- ->samReader: [SAM challenge 1]
samReader-[#00FF00]->capi: [SAM challenge 1]
deactivate samReader

capi->capi: anticipates session buffer overflow

capi-[#0000FF]>cardReader: <font color=blue>**Card #2**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session <font color=red>**1**</font>
    cardReader->card: open secure session (card debit key,\n\tSAM challenge 1)
    card- ->cardReader: [card challenge 1]

    cardReader->card: update record (environment)
    card- ->cardReader: ack
    cardReader->card: update record (contract list)
    card- ->cardReader: ack
    cardReader->card: update record (contract #1)
    card- ->cardReader: ack
    cardReader->card: update record (contract #2)
    card- ->cardReader: ack
    cardReader->card: update record (contract #3)
    card- ->cardReader: ack
    cardReader->card: update record (contract #4)
    card- ->cardReader: ack
    cardReader->card: update record (all counters)
    card- ->cardReader: ack
end

cardReader- -[#0000FF]>capi: [card challenge]
deactivate cardReader

capi-[#00FF00]>samReader: <font color=green>**SAM #2**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen

samReader->sam: digest init (opening data)
sam- ->samReader
samReader->sam: digest update (update environment)
sam- ->samReader
samReader->sam: digest update (update contract list)
sam- ->samReader
samReader->sam: digest update (update contract #1)
sam- ->samReader
samReader->sam: digest update (update contract #2)
sam- ->samReader
samReader->sam: digest update (update contract #3)
sam- ->samReader
samReader->sam: digest update (update contract #4)
sam- ->samReader

note over samReader
    Close card session before session buffer overflow.
end note

samReader->sam: digest close
sam- ->samReader: [SAM certificate 1]
samReader-[#00FF00]->capi: [SAM challenge 1]
deactivate samReader


capi-[#0000FF]>cardReader: <font color=blue>**Card #3**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

cardReader->card: close secure session (SAM certificate 1)
card- ->cardReader: [card certificate 1]

cardReader- -[#0000FF]>capi: [card certificate 1]
deactivate cardReader


capi-[#00FF00]>samReader: <font color=green>**SAM #3**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen

samReader->sam: digest authenticate (card certificate 1)
sam- ->samReader: [authentication status 1]
'samReader-[#00FF00]->capi: [authentication status]
'deactivate samReader
'capi-[#00FF00]>samReader: <font color=green>**SAM #4**</font>\ntransmit card request\n\t- APDU list
'activate samReader #lightGreen

note over samReader
    Anticipate second session with the same diversifier.
end note

samReader->sam: get challenge
sam- ->samReader: [SAM challenge 2]
samReader-[#00FF00]->capi: [authentication status 1, SAM challenge 2]
deactivate samReader


capi-[#0000FF]>cardReader: <font color=blue>**Card #4**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session <font color=red>**2**</font>
    cardReader->card: open secure session (card debit key,\n\tSAM challenge 2)
    card- ->cardReader: [card challenge 2]
    cardReader->card: update record (event log #1)
    card- ->cardReader: ack
    cardReader->card: update record (event log #2)
    card- ->cardReader: ack
    cardReader->card: update record (event log #3)
    card- ->cardReader: ack
end

cardReader- -[#0000FF]>capi: [card certificate 1]
deactivate cardReader










capi-[#00FF00]>samReader: <font color=green>**SAM #3**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen

samReader->sam: digest init (opening data)
sam- ->samReader
samReader->sam: digest update (update event log #1)
sam- ->samReader
samReader->sam: digest update (update event log #2)
sam- ->samReader
samReader->sam: digest update (update event log #3)
sam- ->samReader

samReader-[#00FF00]->capi: ack
deactivate samReader








capi- ->app: [Calypso card image:\n\t- identification data\n\t- environment data (updated)\n\t- contract list data\n\t- contract #1 data\n\t- counter #1 data]
deactivate capi

app->capi: <font color=red>**prepare**</font>:\n\t- release channel
activate capi  #pink

capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> closing (as ratified)
activate capi  #pink

capi-[#00FF00]>samReader: <font color=green>**SAM #4**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen

samReader->sam: digest close
sam- ->samReader: [SAM certificate 2]

samReader-[#00FF00]->capi: [SAM certificate 2]
deactivate samReader

capi-[#0000FF]>cardReader: <font color=blue>**Card #3**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

cardReader->card: close secure session (SAM certificate 2)
card- ->cardReader: [card certificate 2]
cardReader->card: close card channel
card- ->cardReader
deactivate card

cardReader-[#0000FF]->capi: [card certificate]
deactivate cardReader

capi-[#00FF00]>samReader: <font color=green>**SAM #3**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: digest authenticate (card certificate 2)
sam- ->samReader: [authentication status]

samReader-[#00FF00]->capi: [authentification status]
deactivate samReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- environment data\n\t- contract list data\n\t- contract #1 data\n\t- counter #1 data (updated)\n\t- event #1 (updated)]\nauthentification status
deactivate capi
@enduml

@startuml

skinparam ClassBorderColor #D4AC0D
skinparam stereotypeABorderColor #A9DCDF
skinparam stereotypeIBorderColor #B4A7E5
skinparam stereotypeCBorderColor #ADD1B2
skinparam stereotypeEBorderColor #EB93DF
skinparam shadowing false

skinparam StateBorderColor #D4AC0D
skinparam ActivityBorderColor #D4AC0D

skinparam ClassBackgroundColor<<red>> #FDEDEC
skinparam ClassBorderColor<<red>> #E74C3C
hide <<red>> stereotype
skinparam ClassBackgroundColor<<purple>> #F4ECF7
skinparam ClassBorderColor<<purple>> #8E44AD
hide <<purple>> stereotype
skinparam ClassBackgroundColor<<blue>> #EBF5FB
skinparam ClassBorderColor<<blue>> #3498DB
hide <<blue>> stereotype
skinparam ClassBackgroundColor<<green>> #EAFAF1
skinparam ClassBorderColor<<green>> #2ECC71
hide <<green>> stereotype

skinparam ClassBackgroundColor<<orange>> #FDF2E9
skinparam ClassBorderColor<<orange>> #E67E22
hide <<orange>> stereotype

skinparam ClassBackgroundColor<<grey>> #EAECEE
skinparam ClassBorderColor<<grey>> #2C3E50
hide <<grey>> stereotype

actor "Ticketing Application" as app #gold
participant "Calypso API" as capi #pink
participant "Reader API" as rapi #pink
participant "Calypso Card\nReader" as cardReader #lightBlue
boundary "**Card**" as card #lightBlue
participant "Calypso SAM\nReader" as samReader #lightGreen
boundary "selected\n**SAM**" as sam #lightGreen

activate app #gold
activate sam #lightGreen

activate card #lightBlue

app->capi: **cast** Calypso card
activate capi  #pink
capi- ->app: [Calypso card image:\n\t- identification data\n\t- session buffer size]

deactivate capi

== Card secure transaction ==

app->app: **instantiate** Calypso card transaction:\n\t- Calypso card resource\n\t- Calypso SAM resource

note over capi
    Reads again the environment data inside the session to authenticate them.
end note

app->capi: <font color=red>**prepare**</font> card transaction:\n\t- update environment file\n\t- update contract list\n\t- update contract #1\n\t- update contract #2\n\t- update contract #3\n\t- update contract #4\n\t- update all counters\n\t- update event log #1\n\t- update event log #2\n\t- update event log #3
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> opening (LOAD access level,\n\t\t\tMULTIPLE mode)
activate capi  #pink

capi-[#00FF00]>samReader: <font color=green>**SAM #1**<font color=red>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: select diversifier (card serial)
sam- ->samReader
samReader->sam: get challenge
sam- ->samReader: [SAM challenge 1]
samReader-[#00FF00]->capi: [SAM challenge 1]
deactivate samReader

capi->capi: anticipates session buffer overflow

capi-[#0000FF]>cardReader: <font color=blue>**Card #2**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session <font color=red>**1**</font>
    cardReader->card: open secure session (card debit key,\n\tSAM challenge 1)
    card- ->cardReader: [card challenge 1]

    cardReader->card: update record (environment)
    card- ->cardReader: ack
    cardReader->card: update record (contract list)
    card- ->cardReader: ack
    cardReader->card: update record (contract #1)
    card- ->cardReader: ack
    cardReader->card: update record (contract #2)
    card- ->cardReader: ack
    cardReader->card: update record (contract #3)
    card- ->cardReader: ack
    cardReader->card: update record (contract #4)
    card- ->cardReader: ack
    cardReader->card: update record (all counters)
    card- ->cardReader: ack
end

cardReader- -[#0000FF]>capi: [card challenge]
deactivate cardReader

capi-[#00FF00]>samReader: <font color=green>**SAM #2**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen

samReader->sam: digest init (opening data)
sam- ->samReader
samReader->sam: digest update (update environment)
sam- ->samReader
samReader->sam: digest update (update contract list)
sam- ->samReader
samReader->sam: digest update (update contract #1)
sam- ->samReader
samReader->sam: digest update (update contract #2)
sam- ->samReader
samReader->sam: digest update (update contract #3)
sam- ->samReader
samReader->sam: digest update (update contract #4)
sam- ->samReader

note over samReader
    Close card session before session buffer overflow.
end note

samReader->sam: digest close
sam- ->samReader: [SAM certificate 1]
samReader-[#00FF00]->capi: [SAM challenge 1]
deactivate samReader


capi-[#0000FF]>cardReader: <font color=blue>**Card #3**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

cardReader->card: close secure session (SAM certificate 1)
card- ->cardReader: [card certificate 1]

cardReader- -[#0000FF]>capi: [card certificate 1]
deactivate cardReader


capi-[#00FF00]>samReader: <font color=green>**SAM #3**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen

samReader->sam: digest authenticate (card certificate 1)
sam- ->samReader: [authentication status 1]

note over samReader
    Anticipate second session with the same diversifier.
end note

samReader->sam: get challenge
sam- ->samReader: [SAM challenge 2]
samReader-[#00FF00]->capi: [authentication status 1, SAM challenge 2]
deactivate samReader


capi-[#0000FF]>cardReader: <font color=blue>**Card #4**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session <font color=red>**2**</font>
    cardReader->card: open secure session (card debit key,\n\tSAM challenge 2)
    card- ->cardReader: [card challenge 2]
    cardReader->card: update record (event log #1)
    card- ->cardReader: ack
    cardReader->card: update record (event log #2)
    card- ->cardReader: ack
    cardReader->card: update record (event log #3)
    card- ->cardReader: ack
end

cardReader- -[#0000FF]>capi: [card certificate 1]
deactivate cardReader










capi-[#00FF00]>samReader: <font color=green>**SAM #3**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen

samReader->sam: digest init (opening data)
sam- ->samReader
samReader->sam: digest update (update event log #1)
sam- ->samReader
samReader->sam: digest update (update event log #2)
sam- ->samReader
samReader->sam: digest update (update event log #3)
sam- ->samReader

samReader-[#00FF00]->capi: ack
deactivate samReader








capi- ->app: [Calypso card image:\n\t- identification data\n\t- environment data (updated)\n\t- contract list data\n\t- contract #1 data\n\t- counter #1 data]
deactivate capi

app->capi: <font color=red>**prepare**</font>:\n\t- release channel
activate capi  #pink

capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> closing (as ratified)
activate capi  #pink

capi-[#00FF00]>samReader: <font color=green>**SAM #4**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen

samReader->sam: digest close
sam- ->samReader: [SAM certificate 2]

samReader-[#00FF00]->capi: [SAM certificate 2]
deactivate samReader

capi-[#0000FF]>cardReader: <font color=blue>**Card #3**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

cardReader->card: close secure session (SAM certificate 2)
card- ->cardReader: [card certificate 2]
cardReader->card: close card channel
card- ->cardReader
deactivate card

cardReader-[#0000FF]->capi: [card certificate]
deactivate cardReader

capi-[#00FF00]>samReader: <font color=green>**SAM #3**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: digest authenticate (card certificate 2)
sam- ->samReader: [authentication status]

samReader-[#00FF00]->capi: [authentification status]
deactivate samReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- environment data\n\t- contract list data\n\t- contract #1 data\n\t- counter #1 data (updated)\n\t- event #1 (updated)]\nauthentification status
deactivate capi
@enduml

PlantUML version 1.2022.4(Sat Apr 09 17:29:17 RET 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: fr
Country: FR
--></g></svg>