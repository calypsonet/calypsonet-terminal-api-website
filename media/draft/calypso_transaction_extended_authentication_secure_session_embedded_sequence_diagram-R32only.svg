<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="5218px" preserveAspectRatio="none" style="width:1655px;height:5218px;background:#FFFFFF;" version="1.1" viewBox="0 0 1655 5218" width="1655px" zoomAndPan="magnify"><defs/><g><rect fill="#FFD700" height="5037.1777" style="stroke:#181818;stroke-width:1.0;" width="10" x="75.5" y="91.4883"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="366.5" y="222.041"/><rect fill="#FFC0CB" height="59.9316" style="stroke:#181818;stroke-width:1.0;" width="10" x="366.5" y="557.457"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="366.5" y="793.5625"/><rect fill="#FFC0CB" height="1153.2852" style="stroke:#181818;stroke-width:1.0;" width="10" x="366.5" y="836.873"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="366.5" y="2034.7793"/><rect fill="#FFC0CB" height="285.0371" style="stroke:#181818;stroke-width:1.0;" width="10" x="366.5" y="2078.0898"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="366.5" y="2450.0586"/><rect fill="#FFC0CB" height="300.3477" style="stroke:#181818;stroke-width:1.0;" width="10" x="366.5" y="2493.3691"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="366.5" y="2880.6484"/><rect fill="#FFC0CB" height="315.6582" style="stroke:#181818;stroke-width:1.0;" width="10" x="366.5" y="2923.959"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="366.5" y="3326.5488"/><rect fill="#FFC0CB" height="330.9688" style="stroke:#181818;stroke-width:1.0;" width="10" x="366.5" y="3369.8594"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="366.5" y="3818.3809"/><rect fill="#FFC0CB" height="1257.9746" style="stroke:#181818;stroke-width:1.0;" width="10" x="366.5" y="3861.6914"/><rect fill="#FFC0CB" height="262.7949" style="stroke:#181818;stroke-width:1.0;" width="10" x="624.5" y="265.3516"/><rect fill="#ADD8E6" height="173.5527" style="stroke:#181818;stroke-width:1.0;" width="10" x="824.5" y="325.2832"/><rect fill="#ADD8E6" height="185.1738" style="stroke:#181818;stroke-width:1.0;" width="10" x="824.5" y="1087.9785"/><rect fill="#ADD8E6" height="138.5527" style="stroke:#181818;stroke-width:1.0;" width="10" x="824.5" y="1590.8789"/><rect fill="#ADD8E6" height="119.2422" style="stroke:#181818;stroke-width:1.0;" width="10" x="824.5" y="2138.0215"/><rect fill="#ADD8E6" height="119.2422" style="stroke:#181818;stroke-width:1.0;" width="10" x="824.5" y="2553.3008"/><rect fill="#ADD8E6" height="119.2422" style="stroke:#181818;stroke-width:1.0;" width="10" x="824.5" y="2983.8906"/><rect fill="#ADD8E6" height="119.2422" style="stroke:#181818;stroke-width:1.0;" width="10" x="824.5" y="3429.791"/><rect fill="#ADD8E6" height="307.7949" style="stroke:#181818;stroke-width:1.0;" width="10" x="824.5" y="4496.9023"/><rect fill="#ADD8E6" height="4420.793" style="stroke:#181818;stroke-width:1.0;" width="10" x="1224.5" y="354.5938"/><rect fill="#90EE90" height="131.2422" style="stroke:#181818;stroke-width:1.0;" width="10" x="1310" y="896.8047"/><rect fill="#90EE90" height="155.5527" style="stroke:#181818;stroke-width:1.0;" width="10" x="1310" y="1375.3945"/><rect fill="#90EE90" height="87.9316" style="stroke:#181818;stroke-width:1.0;" width="10" x="1310" y="1789.3633"/><rect fill="#90EE90" height="422.416" style="stroke:#181818;stroke-width:1.0;" width="10" x="1310" y="4014.5547"/><rect fill="#90EE90" height="87.9316" style="stroke:#181818;stroke-width:1.0;" width="10" x="1310" y="4864.6289"/><rect fill="#90EE90" height="5037.1777" style="stroke:#181818;stroke-width:1.0;" width="10" x="1592" y="91.4883"/><rect fill="none" height="141.8633" style="stroke:#000000;stroke-width:1.5;" width="662" x="602" y="1102.9785"/><rect fill="#F0F8FF" height="451.5898" style="stroke:#000000;stroke-width:1.5;" width="1323.5" x="314.5" y="1433.7051"/><rect fill="none" height="75.9316" style="stroke:#000000;stroke-width:1.5;" width="497" x="767" y="2153.0215"/><rect fill="none" height="75.9316" style="stroke:#000000;stroke-width:1.5;" width="497" x="767" y="2568.3008"/><rect fill="none" height="75.9316" style="stroke:#000000;stroke-width:1.5;" width="497" x="767" y="2998.8906"/><rect fill="none" height="75.9316" style="stroke:#000000;stroke-width:1.5;" width="497" x="767" y="3444.791"/><rect fill="none" height="103.9316" style="stroke:#000000;stroke-width:1.5;" width="384" x="1254" y="4246.1074"/><rect fill="none" height="119.2422" style="stroke:#000000;stroke-width:1.5;" width="497" x="767" y="4511.9023"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="80" x2="80" y1="81.4883" y2="5137.666"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="371.5" x2="371.5" y1="81.4883" y2="5137.666"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="629.5" x2="629.5" y1="81.4883" y2="5137.666"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="829" x2="829" y1="81.4883" y2="5137.666"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1229" x2="1229" y1="81.4883" y2="5137.666"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1315" x2="1315" y1="81.4883" y2="5137.666"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1597" x2="1597" y1="81.4883" y2="5137.666"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="145" x="5" y="78.5352">Ticketing Application</text><ellipse cx="80.5" cy="13.5" fill="#FFD700" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M80.5,21.5 L80.5,48.5 M67.5,29.5 L93.5,29.5 M80.5,48.5 L67.5,63.5 M80.5,48.5 L93.5,63.5 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="145" x="5" y="5150.2012">Ticketing Application</text><ellipse cx="80.5" cy="5161.6543" fill="#FFD700" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M80.5,5169.6543 L80.5,5196.6543 M67.5,5177.6543 L93.5,5177.6543 M80.5,5196.6543 L67.5,5211.6543 M80.5,5196.6543 L93.5,5211.6543 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#FFC0CB" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="94" x="324.5" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="80" x="331.5" y="70.5352">Calypso API</text><rect fill="#FFC0CB" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="94" x="324.5" y="5136.666"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="80" x="331.5" y="5157.2012">Calypso API</text><rect fill="#FFC0CB" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="88" x="585.5" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="74" x="592.5" y="70.5352">Reader API</text><rect fill="#FFC0CB" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="88" x="585.5" y="5136.666"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="74" x="592.5" y="5157.2012">Reader API</text><rect fill="#ADD8E6" height="46.9766" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="105" x="777" y="33.5117"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="784" y="54.0469">Calypso Card</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48" x="805.5" y="70.5352">Reader</text><rect fill="#ADD8E6" height="46.9766" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="105" x="777" y="5136.666"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="784" y="5157.2012">Calypso Card</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48" x="805.5" y="5173.6895">Reader</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="33" x="1210" y="78.5352">Card</text><path d="M1209,37 L1209,61 M1209,49 L1226,49 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><ellipse cx="1238" cy="49" fill="#ADD8E6" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="33" x="1210" y="5150.2012">Card</text><path d="M1209,5157.1543 L1209,5181.1543 M1209,5169.1543 L1226,5169.1543 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><ellipse cx="1238" cy="5169.1543" fill="#ADD8E6" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#90EE90" height="46.9766" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="102" x="1264" y="33.5117"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="88" x="1271" y="54.0469">Calypso SAM</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48" x="1291" y="70.5352">Reader</text><rect fill="#90EE90" height="46.9766" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="102" x="1264" y="5136.666"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="88" x="1271" y="5157.2012">Calypso SAM</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48" x="1291" y="5173.6895">Reader</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="1566" y="62.0469">selected</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="31" x="1578.5" y="78.5352">SAM</text><path d="M1576.5,20.5117 L1576.5,44.5117 M1576.5,32.5117 L1593.5,32.5117 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><ellipse cx="1605.5" cy="32.5117" fill="#90EE90" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="1566" y="5150.2012">selected</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="31" x="1578.5" y="5166.6895">SAM</text><path d="M1576.5,5173.6426 L1576.5,5197.6426 M1576.5,5185.6426 L1593.5,5185.6426 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><ellipse cx="1605.5" cy="5185.6426" fill="#90EE90" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#FFD700" height="5037.1777" style="stroke:#181818;stroke-width:1.0;" width="10" x="75.5" y="91.4883"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="366.5" y="222.041"/><rect fill="#FFC0CB" height="59.9316" style="stroke:#181818;stroke-width:1.0;" width="10" x="366.5" y="557.457"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="366.5" y="793.5625"/><rect fill="#FFC0CB" height="1153.2852" style="stroke:#181818;stroke-width:1.0;" width="10" x="366.5" y="836.873"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="366.5" y="2034.7793"/><rect fill="#FFC0CB" height="285.0371" style="stroke:#181818;stroke-width:1.0;" width="10" x="366.5" y="2078.0898"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="366.5" y="2450.0586"/><rect fill="#FFC0CB" height="300.3477" style="stroke:#181818;stroke-width:1.0;" width="10" x="366.5" y="2493.3691"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="366.5" y="2880.6484"/><rect fill="#FFC0CB" height="315.6582" style="stroke:#181818;stroke-width:1.0;" width="10" x="366.5" y="2923.959"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="366.5" y="3326.5488"/><rect fill="#FFC0CB" height="330.9688" style="stroke:#181818;stroke-width:1.0;" width="10" x="366.5" y="3369.8594"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="366.5" y="3818.3809"/><rect fill="#FFC0CB" height="1257.9746" style="stroke:#181818;stroke-width:1.0;" width="10" x="366.5" y="3861.6914"/><rect fill="#FFC0CB" height="262.7949" style="stroke:#181818;stroke-width:1.0;" width="10" x="624.5" y="265.3516"/><rect fill="#ADD8E6" height="173.5527" style="stroke:#181818;stroke-width:1.0;" width="10" x="824.5" y="325.2832"/><rect fill="#ADD8E6" height="185.1738" style="stroke:#181818;stroke-width:1.0;" width="10" x="824.5" y="1087.9785"/><rect fill="#ADD8E6" height="138.5527" style="stroke:#181818;stroke-width:1.0;" width="10" x="824.5" y="1590.8789"/><rect fill="#ADD8E6" height="119.2422" style="stroke:#181818;stroke-width:1.0;" width="10" x="824.5" y="2138.0215"/><rect fill="#ADD8E6" height="119.2422" style="stroke:#181818;stroke-width:1.0;" width="10" x="824.5" y="2553.3008"/><rect fill="#ADD8E6" height="119.2422" style="stroke:#181818;stroke-width:1.0;" width="10" x="824.5" y="2983.8906"/><rect fill="#ADD8E6" height="119.2422" style="stroke:#181818;stroke-width:1.0;" width="10" x="824.5" y="3429.791"/><rect fill="#ADD8E6" height="307.7949" style="stroke:#181818;stroke-width:1.0;" width="10" x="824.5" y="4496.9023"/><rect fill="#ADD8E6" height="4420.793" style="stroke:#181818;stroke-width:1.0;" width="10" x="1224.5" y="354.5938"/><rect fill="#90EE90" height="131.2422" style="stroke:#181818;stroke-width:1.0;" width="10" x="1310" y="896.8047"/><rect fill="#90EE90" height="155.5527" style="stroke:#181818;stroke-width:1.0;" width="10" x="1310" y="1375.3945"/><rect fill="#90EE90" height="87.9316" style="stroke:#181818;stroke-width:1.0;" width="10" x="1310" y="1789.3633"/><rect fill="#90EE90" height="422.416" style="stroke:#181818;stroke-width:1.0;" width="10" x="1310" y="4014.5547"/><rect fill="#90EE90" height="87.9316" style="stroke:#181818;stroke-width:1.0;" width="10" x="1310" y="4864.6289"/><rect fill="#90EE90" height="5037.1777" style="stroke:#181818;stroke-width:1.0;" width="10" x="1592" y="91.4883"/><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1648" x="0" y="112.1436"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1648" y1="112.1436" y2="112.1436"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1648" y1="115.1436" y2="115.1436"/><rect fill="#EEEEEE" height="23.3105" style="stroke:#000000;stroke-width:2.0;" width="221" x="713.5" y="101.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="203" x="719.5" y="118.0566">Card selection &amp; identification</text><path d="M251,139.7988 L251,164.7988 L492,164.7988 L492,149.7988 L482,139.7988 L251,139.7988 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M482,139.7988 L482,149.7988 L492,149.7988 L482,139.7988 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="257" y="157.3672">Only reads data inside the session.</text><polygon fill="#181818" points="354.5,218.041,364.5,222.041,354.5,226.041,358.5,222.041" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="360.5" y1="222.041" y2="222.041"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="92.5" y="186.6777">prepare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="149" x="150.5" y="186.6777">card selection scenario:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="141" x="124.5" y="201.9883">- filter by specific AID</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="189" x="124.5" y="217.2988">- filter invalidated card status</text><polygon fill="#181818" points="96.5,232.041,86.5,236.041,96.5,240.041,92.5,236.041" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="370.5" y1="236.041" y2="236.041"/><polygon fill="#181818" points="612.5,261.3516,622.5,265.3516,612.5,269.3516,616.5,265.3516" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="618.5" y1="265.3516" y2="265.3516"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="92.5" y="260.6094">process</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="196" x="148.5" y="260.6094">explicit card selection scenario</text><polygon fill="#0000FF" points="812.5,321.2832,822.5,325.2832,812.5,329.2832,816.5,325.2832" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;" x1="634.5" x2="818.5" y1="325.2832" y2="325.2832"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="641.5" y="289.9199">Card #1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="165" x="641.5" y="305.2305">transmit selection request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="93" x="673.5" y="320.541">- card selector</text><polygon fill="#181818" points="1212.5,350.5938,1222.5,354.5938,1212.5,358.5938,1216.5,354.5938" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="834.5" x2="1218.5" y1="354.5938" y2="354.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="841.5" y="349.8516">open card channel</text><polygon fill="#181818" points="845.5,364.5938,835.5,368.5938,845.5,372.5938,841.5,368.5938" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="839.5" x2="1223.5" y1="368.5938" y2="368.5938"/><polygon fill="#181818" points="1212.5,393.9043,1222.5,397.9043,1212.5,401.9043,1216.5,397.9043" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="834.5" x2="1218.5" y1="397.9043" y2="397.9043"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="142" x="841.5" y="393.1621">select application (aid)</text><polygon fill="#181818" points="845.5,423.2148,835.5,427.2148,845.5,431.2148,841.5,427.2148" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="839.5" x2="1223.5" y1="427.2148" y2="427.2148"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="59" x="851.5" y="422.4727">[card FCI]</text><line style="stroke:#181818;stroke-width:1.0;" x1="834.5" x2="876.5" y1="456.5254" y2="456.5254"/><line style="stroke:#181818;stroke-width:1.0;" x1="876.5" x2="876.5" y1="456.5254" y2="469.5254"/><line style="stroke:#181818;stroke-width:1.0;" x1="835.5" x2="876.5" y1="469.5254" y2="469.5254"/><polygon fill="#181818" points="845.5,465.5254,835.5,469.5254,845.5,473.5254,841.5,469.5254" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="165" x="841.5" y="451.7832">checks invalidation status</text><polygon fill="#0000FF" points="645.5,494.8359,635.5,498.8359,645.5,502.8359,641.5,498.8359" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="639.5" x2="828.5" y1="498.8359" y2="498.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="166" x="651.5" y="494.0938">receive selection response</text><polygon fill="#181818" points="96.5,524.1465,86.5,528.1465,96.5,532.1465,92.5,528.1465" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="628.5" y1="528.1465" y2="528.1465"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="204" x="102.5" y="523.4043">selected active SmartCard image</text><polygon fill="#181818" points="354.5,553.457,364.5,557.457,354.5,561.457,358.5,557.457" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="360.5" y1="557.457" y2="557.457"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="27" x="92.5" y="552.7148">cast</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="81" x="123.5" y="552.7148">Calypso card</text><polygon fill="#181818" points="96.5,613.3887,86.5,617.3887,96.5,621.3887,92.5,617.3887" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="370.5" y1="617.3887" y2="617.3887"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="102.5" y="582.0254">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127" x="134.5" y="597.3359">- identification data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="133" x="134.5" y="612.6465">- invalidation status]</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1648" x="0" y="646.0439"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1648" y1="646.0439" y2="646.0439"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1648" y1="649.0439" y2="649.0439"/><rect fill="#EEEEEE" height="23.3105" style="stroke:#000000;stroke-width:2.0;" width="179" x="734.5" y="635.3887"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="161" x="740.5" y="651.957">Card secure transaction</text><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="127.5" y1="720.6309" y2="720.6309"/><line style="stroke:#181818;stroke-width:1.0;" x1="127.5" x2="127.5" y1="720.6309" y2="733.6309"/><line style="stroke:#181818;stroke-width:1.0;" x1="86.5" x2="127.5" y1="733.6309" y2="733.6309"/><polygon fill="#181818" points="96.5,729.6309,86.5,733.6309,96.5,737.6309,92.5,733.6309" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="72" x="92.5" y="685.2676">instantiate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="168.5" y="685.2676">Calypso card transaction:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="124.5" y="700.5781">- Calypso card resource</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="124.5" y="715.8887">- Calypso SAM resource</text><polygon fill="#181818" points="354.5,789.5625,364.5,793.5625,354.5,797.5625,358.5,793.5625" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="360.5" y1="793.5625" y2="793.5625"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="92.5" y="758.1992">prepare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="106" x="150.5" y="758.1992">card transaction:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="146" x="124.5" y="773.5098">- read environment file</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="230" x="124.5" y="788.8203">- manage session for authentication</text><polygon fill="#181818" points="96.5,803.5625,86.5,807.5625,96.5,811.5625,92.5,807.5625" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="370.5" y1="807.5625" y2="807.5625"/><polygon fill="#181818" points="354.5,832.873,364.5,836.873,354.5,840.873,358.5,836.873" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="360.5" y1="836.873" y2="836.873"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="92.5" y="832.1309">process</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="178" x="148.5" y="832.1309">opening (DEBIT access level)</text><polygon fill="#00FF00" points="1298,892.8047,1308,896.8047,1298,900.8047,1302,896.8047" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;" x1="376.5" x2="1304" y1="896.8047" y2="896.8047"/><text fill="#008000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="51" x="383.5" y="861.4414">SAM #1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="383.5" y="876.752">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="415.5" y="892.0625">- APDU list</text><polygon fill="#181818" points="1580,922.1152,1590,926.1152,1580,930.1152,1584,926.1152" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1320" x2="1586" y1="926.1152" y2="926.1152"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="181" x="1327" y="921.373">select diversifier (card serial)</text><polygon fill="#181818" points="1331,936.1152,1321,940.1152,1331,944.1152,1327,940.1152" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1325" x2="1591" y1="940.1152" y2="940.1152"/><polygon fill="#181818" points="1580,965.4258,1590,969.4258,1580,973.4258,1584,969.4258" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1320" x2="1586" y1="969.4258" y2="969.4258"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="84" x="1327" y="964.6836">get challenge</text><polygon fill="#181818" points="1331,994.7363,1321,998.7363,1331,1002.7363,1327,998.7363" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1325" x2="1591" y1="998.7363" y2="998.7363"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="99" x="1337" y="993.9941">[SAM challenge]</text><polygon fill="#00FF00" points="387.5,1024.0469,377.5,1028.0469,387.5,1032.0469,383.5,1028.0469" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="381.5" x2="1314" y1="1028.0469" y2="1028.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="99" x="393.5" y="1023.3047">[SAM challenge]</text><polygon fill="#0000FF" points="812.5,1083.9785,822.5,1087.9785,812.5,1091.9785,816.5,1087.9785" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;" x1="376.5" x2="818.5" y1="1087.9785" y2="1087.9785"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="383.5" y="1052.6152">Card #2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="383.5" y="1067.9258">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="415.5" y="1083.2363">- APDU list</text><path d="M602,1102.9785 L898,1102.9785 L898,1110.2891 L888,1120.2891 L602,1120.2891 L602,1102.9785 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="141.8633" style="stroke:#000000;stroke-width:1.5;" width="662" x="602" y="1102.9785"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="251" x="617" y="1116.5469">Card APDU commands inside session</text><path d="M612,1125.2891 L612,1150.2891 L1046,1150.2891 L1046,1135.2891 L1036,1125.2891 L612,1125.2891 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1036,1125.2891 L1036,1135.2891 L1046,1135.2891 L1036,1125.2891 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="413" x="618" y="1142.8574">Optimization: environment file read through the session opening.</text><polygon fill="#181818" points="1212.5,1203.5313,1222.5,1207.5313,1212.5,1211.5313,1216.5,1207.5313" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="834.5" x2="1218.5" y1="1207.5313" y2="1207.5313"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="229" x="841.5" y="1172.168">open secure session (card debit key,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="95" x="873.5" y="1187.4785">SAM challenge,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="153" x="873.5" y="1202.7891">SFI environment to read)</text><polygon fill="#181818" points="845.5,1232.8418,835.5,1236.8418,845.5,1240.8418,841.5,1236.8418" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="839.5" x2="1223.5" y1="1236.8418" y2="1236.8418"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="226" x="851.5" y="1232.0996">[card challenge &amp; environment data]</text><polygon fill="#0000FF" points="387.5,1269.1523,377.5,1273.1523,387.5,1277.1523,383.5,1273.1523" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="381.5" x2="828.5" y1="1273.1523" y2="1273.1523"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="99" x="393.5" y="1268.4102">[card challenge]</text><line style="stroke:#181818;stroke-width:1.0;" x1="376.5" x2="418.5" y1="1302.4629" y2="1302.4629"/><line style="stroke:#181818;stroke-width:1.0;" x1="418.5" x2="418.5" y1="1302.4629" y2="1315.4629"/><line style="stroke:#181818;stroke-width:1.0;" x1="377.5" x2="418.5" y1="1315.4629" y2="1315.4629"/><polygon fill="#181818" points="387.5,1311.4629,377.5,1315.4629,387.5,1319.4629,383.5,1315.4629" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="383.5" y="1297.7207">checks ratification status</text><polygon fill="#00FF00" points="1298,1371.3945,1308,1375.3945,1298,1379.3945,1302,1375.3945" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;" x1="376.5" x2="1304" y1="1375.3945" y2="1375.3945"/><text fill="#008000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="51" x="383.5" y="1340.0313">SAM #2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="383.5" y="1355.3418">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="415.5" y="1370.6523">- APDU list</text><polygon fill="#181818" points="1580,1400.7051,1590,1404.7051,1580,1408.7051,1584,1404.7051" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1320" x2="1586" y1="1404.7051" y2="1404.7051"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1327" y="1399.9629">digest init (opening data)</text><polygon fill="#181818" points="1331,1414.7051,1321,1418.7051,1331,1422.7051,1327,1418.7051" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1325" x2="1591" y1="1418.7051" y2="1418.7051"/><path d="M314.5,1433.7051 L501.5,1433.7051 L501.5,1441.0156 L491.5,1451.0156 L314.5,1451.0156 L314.5,1433.7051 " fill="#F0F8FF" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="451.5898" style="stroke:#000000;stroke-width:1.5;" width="1323.5" x="314.5" y="1433.7051"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="142" x="329.5" y="1447.2734">Initial Authentication</text><polygon fill="#181818" points="1580,1468.3262,1590,1472.3262,1580,1476.3262,1584,1472.3262" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1320" x2="1586" y1="1472.3262" y2="1472.3262"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="173" x="1327" y="1467.584">digest internal authenticate</text><polygon fill="#181818" points="1331,1497.6367,1321,1501.6367,1331,1505.6367,1327,1501.6367" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1325" x2="1591" y1="1501.6367" y2="1501.6367"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="1337" y="1496.8945">[SAM certificate]</text><polygon fill="#00FF00" points="387.5,1526.9473,377.5,1530.9473,387.5,1534.9473,383.5,1530.9473" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="381.5" x2="1314" y1="1530.9473" y2="1530.9473"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="393.5" y="1526.2051">[SAM certificate]</text><polygon fill="#0000FF" points="812.5,1586.8789,822.5,1590.8789,812.5,1594.8789,816.5,1590.8789" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;" x1="376.5" x2="818.5" y1="1590.8789" y2="1590.8789"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="383.5" y="1555.5156">Card #3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="383.5" y="1570.8262">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="415.5" y="1586.1367">- APDU list</text><path d="M661,1603.8789 L661,1628.8789 L997,1628.8789 L997,1613.8789 L987,1603.8789 L661,1603.8789 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M987,1603.8789 L987,1613.8789 L997,1613.8789 L987,1603.8789 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="315" x="667" y="1621.4473">command outside of the SMAC (no Digest Update)</text><polygon fill="#181818" points="1212.5,1666.8105,1222.5,1670.8105,1212.5,1674.8105,1216.5,1670.8105" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="834.5" x2="1218.5" y1="1670.8105" y2="1670.8105"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="366" x="841.5" y="1650.7578">manage secure session (authentication on, encryption off,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="98" x="873.5" y="1666.0684">SAM certificate)</text><polygon fill="#181818" points="845.5,1696.1211,835.5,1700.1211,845.5,1704.1211,841.5,1700.1211" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="839.5" x2="1223.5" y1="1700.1211" y2="1700.1211"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="851.5" y="1695.3789">[card certificate]</text><polygon fill="#0000FF" points="387.5,1725.4316,377.5,1729.4316,387.5,1733.4316,383.5,1729.4316" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="381.5" x2="828.5" y1="1729.4316" y2="1729.4316"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="99" x="393.5" y="1724.6895">[card challenge]</text><polygon fill="#00FF00" points="1298,1785.3633,1308,1789.3633,1298,1793.3633,1302,1789.3633" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;" x1="376.5" x2="1304" y1="1789.3633" y2="1789.3633"/><text fill="#008000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="51" x="383.5" y="1754">SAM #3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="383.5" y="1769.3105">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="415.5" y="1784.6211">- APDU list</text><polygon fill="#181818" points="1580,1814.6738,1590,1818.6738,1580,1822.6738,1584,1818.6738" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1320" x2="1586" y1="1818.6738" y2="1818.6738"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="227" x="1327" y="1813.9316">digest authenticate (card certificate)</text><polygon fill="#181818" points="1331,1843.9844,1321,1847.9844,1331,1851.9844,1327,1847.9844" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1325" x2="1591" y1="1847.9844" y2="1847.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="142" x="1337" y="1843.2422">[authentication status]</text><polygon fill="#00FF00" points="387.5,1873.2949,377.5,1877.2949,387.5,1881.2949,383.5,1877.2949" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="381.5" x2="1314" y1="1877.2949" y2="1877.2949"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="142" x="393.5" y="1872.5527">[authentication status]</text><polygon fill="#181818" points="96.5,1986.1582,86.5,1990.1582,96.5,1994.1582,92.5,1990.1582" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="370.5" y1="1990.1582" y2="1990.1582"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="102.5" y="1908.8633">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127" x="134.5" y="1924.1738">- identification data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="134.5" y="1939.4844">- invalidation status</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="122" x="134.5" y="1954.7949">- environment data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="124" x="134.5" y="1970.1055">- ratification status</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="150" x="134.5" y="1985.416">- authentication status]</text><polygon fill="#181818" points="354.5,2030.7793,364.5,2034.7793,354.5,2038.7793,358.5,2034.7793" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="360.5" y1="2034.7793" y2="2034.7793"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="92.5" y="2014.7266">prepare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="106" x="150.5" y="2014.7266">card transaction:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="104" x="124.5" y="2030.0371">- read last event</text><polygon fill="#181818" points="96.5,2044.7793,86.5,2048.7793,96.5,2052.7793,92.5,2048.7793" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="370.5" y1="2048.7793" y2="2048.7793"/><polygon fill="#181818" points="354.5,2074.0898,364.5,2078.0898,354.5,2082.0898,358.5,2078.0898" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="360.5" y1="2078.0898" y2="2078.0898"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="92.5" y="2073.3477">process</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="69" x="148.5" y="2073.3477">commands</text><polygon fill="#0000FF" points="812.5,2134.0215,822.5,2138.0215,812.5,2142.0215,816.5,2138.0215" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;" x1="376.5" x2="818.5" y1="2138.0215" y2="2138.0215"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="383.5" y="2102.6582">Card #4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="383.5" y="2117.9688">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="415.5" y="2133.2793">- APDU list</text><path d="M767,2153.0215 L1063,2153.0215 L1063,2160.332 L1053,2170.332 L767,2170.332 L767,2153.0215 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="75.9316" style="stroke:#000000;stroke-width:1.5;" width="497" x="767" y="2153.0215"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="251" x="782" y="2166.5898">Card APDU commands inside session</text><polygon fill="#181818" points="1212.5,2187.6426,1222.5,2191.6426,1212.5,2195.6426,1216.5,2191.6426" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="834.5" x2="1218.5" y1="2191.6426" y2="2191.6426"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="144" x="841.5" y="2186.9004">read record (last event)</text><polygon fill="#181818" points="845.5,2216.9531,835.5,2220.9531,845.5,2224.9531,841.5,2220.9531" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="839.5" x2="1223.5" y1="2220.9531" y2="2220.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="851.5" y="2216.2109">[last event data]</text><polygon fill="#0000FF" points="387.5,2253.2637,377.5,2257.2637,387.5,2261.2637,383.5,2257.2637" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="381.5" x2="828.5" y1="2257.2637" y2="2257.2637"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="393.5" y="2252.5215">[last event data]</text><polygon fill="#181818" points="96.5,2359.127,86.5,2363.127,96.5,2367.127,92.5,2363.127" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="370.5" y1="2363.127" y2="2363.127"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="102.5" y="2281.832">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127" x="134.5" y="2297.1426">- identification data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="134.5" y="2312.4531">- invalidation status</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="122" x="134.5" y="2327.7637">- environment data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="124" x="134.5" y="2343.0742">- ratification status</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="108" x="134.5" y="2358.3848">- last event data]</text><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="127.5" y1="2392.4375" y2="2392.4375"/><line style="stroke:#181818;stroke-width:1.0;" x1="127.5" x2="127.5" y1="2392.4375" y2="2405.4375"/><line style="stroke:#181818;stroke-width:1.0;" x1="86.5" x2="127.5" y1="2405.4375" y2="2405.4375"/><polygon fill="#181818" points="96.5,2401.4375,86.5,2405.4375,96.5,2409.4375,92.5,2405.4375" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="219" x="92.5" y="2387.6953">checks transaction recovery status</text><polygon fill="#181818" points="354.5,2446.0586,364.5,2450.0586,354.5,2454.0586,358.5,2450.0586" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="360.5" y1="2450.0586" y2="2450.0586"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="92.5" y="2430.0059">prepare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="106" x="150.5" y="2430.0059">card transaction:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="119" x="124.5" y="2445.3164">- read contract list</text><polygon fill="#181818" points="96.5,2460.0586,86.5,2464.0586,96.5,2468.0586,92.5,2464.0586" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="370.5" y1="2464.0586" y2="2464.0586"/><polygon fill="#181818" points="354.5,2489.3691,364.5,2493.3691,354.5,2497.3691,358.5,2493.3691" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="360.5" y1="2493.3691" y2="2493.3691"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="92.5" y="2488.627">process</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="69" x="148.5" y="2488.627">commands</text><polygon fill="#0000FF" points="812.5,2549.3008,822.5,2553.3008,812.5,2557.3008,816.5,2553.3008" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;" x1="376.5" x2="818.5" y1="2553.3008" y2="2553.3008"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="383.5" y="2517.9375">Card #5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="383.5" y="2533.248">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="415.5" y="2548.5586">- APDU list</text><path d="M767,2568.3008 L1063,2568.3008 L1063,2575.6113 L1053,2585.6113 L767,2585.6113 L767,2568.3008 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="75.9316" style="stroke:#000000;stroke-width:1.5;" width="497" x="767" y="2568.3008"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="251" x="782" y="2581.8691">Card APDU commands inside session</text><polygon fill="#181818" points="1212.5,2602.9219,1222.5,2606.9219,1212.5,2610.9219,1216.5,2606.9219" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="834.5" x2="1218.5" y1="2606.9219" y2="2606.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="159" x="841.5" y="2602.1797">read record (contract list)</text><polygon fill="#181818" points="845.5,2632.2324,835.5,2636.2324,845.5,2640.2324,841.5,2636.2324" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="839.5" x2="1223.5" y1="2636.2324" y2="2636.2324"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="851.5" y="2631.4902">[contract list data]</text><polygon fill="#0000FF" points="387.5,2668.543,377.5,2672.543,387.5,2676.543,383.5,2672.543" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="381.5" x2="828.5" y1="2672.543" y2="2672.543"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="393.5" y="2667.8008">[contract list data]</text><polygon fill="#181818" points="96.5,2789.7168,86.5,2793.7168,96.5,2797.7168,92.5,2793.7168" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="370.5" y1="2793.7168" y2="2793.7168"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="102.5" y="2697.1113">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127" x="134.5" y="2712.4219">- identification data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="134.5" y="2727.7324">- invalidation status</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="122" x="134.5" y="2743.043">- environment data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="124" x="134.5" y="2758.3535">- ratification status</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="104" x="134.5" y="2773.6641">- last event data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="123" x="134.5" y="2788.9746">- contract list data]</text><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="127.5" y1="2823.0273" y2="2823.0273"/><line style="stroke:#181818;stroke-width:1.0;" x1="127.5" x2="127.5" y1="2823.0273" y2="2836.0273"/><line style="stroke:#181818;stroke-width:1.0;" x1="86.5" x2="127.5" y1="2836.0273" y2="2836.0273"/><polygon fill="#181818" points="96.5,2832.0273,86.5,2836.0273,96.5,2840.0273,92.5,2836.0273" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="92.5" y="2818.2852">identifies contract</text><polygon fill="#181818" points="354.5,2876.6484,364.5,2880.6484,354.5,2884.6484,358.5,2880.6484" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="360.5" y1="2880.6484" y2="2880.6484"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="92.5" y="2860.5957">prepare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="106" x="150.5" y="2860.5957">card transaction:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="124.5" y="2875.9063">- read contract #x</text><polygon fill="#181818" points="96.5,2890.6484,86.5,2894.6484,96.5,2898.6484,92.5,2894.6484" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="370.5" y1="2894.6484" y2="2894.6484"/><polygon fill="#181818" points="354.5,2919.959,364.5,2923.959,354.5,2927.959,358.5,2923.959" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="360.5" y1="2923.959" y2="2923.959"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="92.5" y="2919.2168">process</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="69" x="148.5" y="2919.2168">commands</text><polygon fill="#0000FF" points="812.5,2979.8906,822.5,2983.8906,812.5,2987.8906,816.5,2983.8906" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;" x1="376.5" x2="818.5" y1="2983.8906" y2="2983.8906"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="383.5" y="2948.5273">Card #6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="383.5" y="2963.8379">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="415.5" y="2979.1484">- APDU list</text><path d="M767,2998.8906 L1063,2998.8906 L1063,3006.2012 L1053,3016.2012 L767,3016.2012 L767,2998.8906 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="75.9316" style="stroke:#000000;stroke-width:1.5;" width="497" x="767" y="2998.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="251" x="782" y="3012.459">Card APDU commands inside session</text><polygon fill="#181818" points="1212.5,3033.5117,1222.5,3037.5117,1212.5,3041.5117,1216.5,3037.5117" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="834.5" x2="1218.5" y1="3037.5117" y2="3037.5117"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="155" x="841.5" y="3032.7695">read record (contract #x)</text><polygon fill="#181818" points="845.5,3062.8223,835.5,3066.8223,845.5,3070.8223,841.5,3066.8223" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="839.5" x2="1223.5" y1="3066.8223" y2="3066.8223"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="111" x="851.5" y="3062.0801">[contract #x data]</text><polygon fill="#0000FF" points="387.5,3099.1328,377.5,3103.1328,387.5,3107.1328,383.5,3103.1328" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="381.5" x2="828.5" y1="3103.1328" y2="3103.1328"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="111" x="393.5" y="3098.3906">[contract #x data]</text><polygon fill="#181818" points="96.5,3235.6172,86.5,3239.6172,96.5,3243.6172,92.5,3239.6172" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="370.5" y1="3239.6172" y2="3239.6172"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="102.5" y="3127.7012">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127" x="134.5" y="3143.0117">- identification data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="134.5" y="3158.3223">- invalidation status</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="122" x="134.5" y="3173.6328">- environment data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="124" x="134.5" y="3188.9434">- ratification status</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="104" x="134.5" y="3204.2539">- last event data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="119" x="134.5" y="3219.5645">- contract list data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="119" x="134.5" y="3234.875">- contract #x data]</text><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="127.5" y1="3268.9277" y2="3268.9277"/><line style="stroke:#181818;stroke-width:1.0;" x1="127.5" x2="127.5" y1="3268.9277" y2="3281.9277"/><line style="stroke:#181818;stroke-width:1.0;" x1="86.5" x2="127.5" y1="3281.9277" y2="3281.9277"/><polygon fill="#181818" points="96.5,3277.9277,86.5,3281.9277,96.5,3285.9277,92.5,3281.9277" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="182" x="92.5" y="3264.1855">identifies associated counter</text><polygon fill="#181818" points="354.5,3322.5488,364.5,3326.5488,354.5,3330.5488,358.5,3326.5488" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="360.5" y1="3326.5488" y2="3326.5488"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="92.5" y="3306.4961">prepare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="106" x="150.5" y="3306.4961">card transaction:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="123" x="124.5" y="3321.8066">- reader counter #x</text><polygon fill="#181818" points="96.5,3336.5488,86.5,3340.5488,96.5,3344.5488,92.5,3340.5488" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="370.5" y1="3340.5488" y2="3340.5488"/><polygon fill="#181818" points="354.5,3365.8594,364.5,3369.8594,354.5,3373.8594,358.5,3369.8594" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="360.5" y1="3369.8594" y2="3369.8594"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="92.5" y="3365.1172">process</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="69" x="148.5" y="3365.1172">commands</text><polygon fill="#0000FF" points="812.5,3425.791,822.5,3429.791,812.5,3433.791,816.5,3429.791" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;" x1="376.5" x2="818.5" y1="3429.791" y2="3429.791"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="383.5" y="3394.4277">Card #7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="383.5" y="3409.7383">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="415.5" y="3425.0488">- APDU list</text><path d="M767,3444.791 L1063,3444.791 L1063,3452.1016 L1053,3462.1016 L767,3462.1016 L767,3444.791 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="75.9316" style="stroke:#000000;stroke-width:1.5;" width="497" x="767" y="3444.791"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="251" x="782" y="3458.3594">Card APDU commands inside session</text><polygon fill="#181818" points="1212.5,3479.4121,1222.5,3483.4121,1212.5,3487.4121,1216.5,3483.4121" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="834.5" x2="1218.5" y1="3483.4121" y2="3483.4121"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="841.5" y="3478.6699">read record (counter #x)</text><polygon fill="#181818" points="845.5,3508.7227,835.5,3512.7227,845.5,3516.7227,841.5,3512.7227" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="839.5" x2="1223.5" y1="3512.7227" y2="3512.7227"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="107" x="851.5" y="3507.9805">[counter #x data]</text><polygon fill="#0000FF" points="387.5,3545.0332,377.5,3549.0332,387.5,3553.0332,383.5,3549.0332" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="381.5" x2="828.5" y1="3549.0332" y2="3549.0332"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="107" x="393.5" y="3544.291">[counter #x data]</text><polygon fill="#181818" points="96.5,3696.8281,86.5,3700.8281,96.5,3704.8281,92.5,3700.8281" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="370.5" y1="3700.8281" y2="3700.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="102.5" y="3573.6016">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127" x="134.5" y="3588.9121">- identification data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="134.5" y="3604.2227">- invalidation status</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="122" x="134.5" y="3619.5332">- environment data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="124" x="134.5" y="3634.8438">- ratification status</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="104" x="134.5" y="3650.1543">- last event data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="119" x="134.5" y="3665.4648">- contract list data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="134.5" y="3680.7754">- contract #x data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="134.5" y="3696.0859">- counter #x data]</text><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="127.5" y1="3730.1387" y2="3730.1387"/><line style="stroke:#181818;stroke-width:1.0;" x1="127.5" x2="127.5" y1="3730.1387" y2="3743.1387"/><line style="stroke:#181818;stroke-width:1.0;" x1="86.5" x2="127.5" y1="3743.1387" y2="3743.1387"/><polygon fill="#181818" points="96.5,3739.1387,86.5,3743.1387,96.5,3747.1387,92.5,3743.1387" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="141" x="92.5" y="3725.3965">defines data to update</text><polygon fill="#181818" points="354.5,3814.3809,364.5,3818.3809,354.5,3822.3809,358.5,3818.3809" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="360.5" y1="3818.3809" y2="3818.3809"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="92.5" y="3767.707">prepare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="146.5" y="3767.707">:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="213" x="124.5" y="3783.0176">- decrease counter #x (new value)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="215" x="124.5" y="3798.3281">- append event record (new event)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="109" x="124.5" y="3813.6387">- release channel</text><polygon fill="#181818" points="96.5,3828.3809,86.5,3832.3809,96.5,3836.3809,92.5,3832.3809" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="370.5" y1="3832.3809" y2="3832.3809"/><polygon fill="#181818" points="354.5,3857.6914,364.5,3861.6914,354.5,3865.6914,358.5,3861.6914" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="360.5" y1="3861.6914" y2="3861.6914"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="92.5" y="3856.9492">process</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="128" x="148.5" y="3856.9492">closing (not ratified)</text><line style="stroke:#181818;stroke-width:1.0;" x1="376.5" x2="418.5" y1="3891.002" y2="3891.002"/><line style="stroke:#181818;stroke-width:1.0;" x1="418.5" x2="418.5" y1="3891.002" y2="3904.002"/><line style="stroke:#181818;stroke-width:1.0;" x1="377.5" x2="418.5" y1="3904.002" y2="3904.002"/><polygon fill="#181818" points="387.5,3900.002,377.5,3904.002,387.5,3908.002,383.5,3904.002" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="234" x="383.5" y="3886.2598">anticipates the future card responses</text><path d="M15,3917.002 L15,3957.002 L727,3957.002 L727,3927.002 L717,3917.002 L15,3917.002 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M717,3917.002 L717,3927.002 L727,3927.002 L717,3917.002 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="265" x="21" y="3934.5703">If the current value of the counter #x were</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="63" x="290" y="3934.5703">unknown</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="319" x="353" y="3934.5703">, then the transmission of an additional card APDU</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="691" x="21" y="3949.8809">message would be necessary to operate the decrease counter in a different message than the session closing.</text><polygon fill="#00FF00" points="1298,4010.5547,1308,4014.5547,1298,4018.5547,1302,4014.5547" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;" x1="376.5" x2="1304" y1="4014.5547" y2="4014.5547"/><text fill="#008000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="51" x="383.5" y="3979.1914">SAM #4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="383.5" y="3994.502">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="415.5" y="4009.8125">- APDU list</text><polygon fill="#181818" points="1580,4039.8652,1590,4043.8652,1580,4047.8652,1584,4043.8652" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1320" x2="1586" y1="4043.8652" y2="4043.8652"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="230" x="1327" y="4039.123">digest update (read environment) * 2</text><polygon fill="#181818" points="1331,4053.8652,1321,4057.8652,1331,4061.8652,1327,4057.8652" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1325" x2="1591" y1="4057.8652" y2="4057.8652"/><polygon fill="#181818" points="1580,4083.1758,1590,4087.1758,1580,4091.1758,1584,4087.1758" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1320" x2="1586" y1="4087.1758" y2="4087.1758"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="181" x="1327" y="4082.4336">digest update (last event) * 2</text><polygon fill="#181818" points="1331,4097.1758,1321,4101.1758,1331,4105.1758,1327,4101.1758" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1325" x2="1591" y1="4101.1758" y2="4101.1758"/><polygon fill="#181818" points="1580,4126.4863,1590,4130.4863,1580,4134.4863,1584,4130.4863" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1320" x2="1586" y1="4130.4863" y2="4130.4863"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="227" x="1327" y="4125.7441">digest update (read contract list) * 2</text><polygon fill="#181818" points="1331,4140.4863,1321,4144.4863,1331,4148.4863,1327,4144.4863" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1325" x2="1591" y1="4144.4863" y2="4144.4863"/><polygon fill="#181818" points="1580,4169.7969,1590,4173.7969,1580,4177.7969,1584,4173.7969" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1320" x2="1586" y1="4173.7969" y2="4173.7969"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="1327" y="4169.0547">digest update (read contract #x) * 2</text><polygon fill="#181818" points="1331,4183.7969,1321,4187.7969,1331,4191.7969,1327,4187.7969" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1325" x2="1591" y1="4187.7969" y2="4187.7969"/><polygon fill="#181818" points="1580,4213.1074,1590,4217.1074,1580,4221.1074,1584,4217.1074" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1320" x2="1586" y1="4217.1074" y2="4217.1074"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="206" x="1327" y="4212.3652">digest update (read counters) * 2</text><polygon fill="#181818" points="1331,4227.1074,1321,4231.1074,1331,4235.1074,1327,4231.1074" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1325" x2="1591" y1="4231.1074" y2="4231.1074"/><path d="M1254,4246.1074 L1526,4246.1074 L1526,4253.418 L1516,4263.418 L1254,4263.418 L1254,4246.1074 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="103.9316" style="stroke:#000000;stroke-width:1.5;" width="384" x="1254" y="4246.1074"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="76" x="1269" y="4259.6758">anticipated</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="147" x="1349" y="4259.6758">Card APDU responses</text><polygon fill="#181818" points="1580,4280.7285,1590,4284.7285,1580,4288.7285,1584,4284.7285" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1320" x2="1586" y1="4284.7285" y2="4284.7285"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="227" x="1327" y="4279.9863">digest update (decrease counter) * 2</text><polygon fill="#181818" points="1331,4294.7285,1321,4298.7285,1331,4302.7285,1327,4298.7285" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1325" x2="1591" y1="4298.7285" y2="4298.7285"/><polygon fill="#181818" points="1580,4324.0391,1590,4328.0391,1580,4332.0391,1584,4328.0391" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1320" x2="1586" y1="4328.0391" y2="4328.0391"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="248" x="1327" y="4323.2969">digest update (append event record) * 2</text><polygon fill="#181818" points="1331,4338.0391,1321,4342.0391,1331,4346.0391,1327,4342.0391" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1325" x2="1591" y1="4342.0391" y2="4342.0391"/><polygon fill="#181818" points="1580,4374.3496,1590,4378.3496,1580,4382.3496,1584,4378.3496" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1320" x2="1586" y1="4378.3496" y2="4378.3496"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="76" x="1327" y="4373.6074">digest close</text><polygon fill="#181818" points="1331,4403.6602,1321,4407.6602,1331,4411.6602,1327,4407.6602" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1325" x2="1591" y1="4407.6602" y2="4407.6602"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="1337" y="4402.918">[SAM certificate]</text><polygon fill="#00FF00" points="387.5,4432.9707,377.5,4436.9707,387.5,4440.9707,383.5,4436.9707" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="381.5" x2="1314" y1="4436.9707" y2="4436.9707"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="393.5" y="4432.2285">[SAM certificate]</text><polygon fill="#0000FF" points="812.5,4492.9023,822.5,4496.9023,812.5,4500.9023,816.5,4496.9023" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;" x1="376.5" x2="818.5" y1="4496.9023" y2="4496.9023"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="383.5" y="4461.5391">Card #8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="383.5" y="4476.8496">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="415.5" y="4492.1602">- APDU list</text><path d="M767,4511.9023 L1063,4511.9023 L1063,4519.2129 L1053,4529.2129 L767,4529.2129 L767,4511.9023 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="119.2422" style="stroke:#000000;stroke-width:1.5;" width="497" x="767" y="4511.9023"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="251" x="782" y="4525.4707">Card APDU commands inside session</text><polygon fill="#181818" points="1212.5,4546.5234,1222.5,4550.5234,1212.5,4554.5234,1216.5,4550.5234" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="834.5" x2="1218.5" y1="4550.5234" y2="4550.5234"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="228" x="841.5" y="4545.7813">decrease counter (counter #1, value)</text><polygon fill="#181818" points="845.5,4575.834,835.5,4579.834,845.5,4583.834,841.5,4579.834" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="839.5" x2="1223.5" y1="4579.834" y2="4579.834"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="122" x="851.5" y="4575.0918">[new counter value]</text><polygon fill="#181818" points="1212.5,4605.1445,1222.5,4609.1445,1212.5,4613.1445,1216.5,4609.1445" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="834.5" x2="1218.5" y1="4609.1445" y2="4609.1445"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="171" x="841.5" y="4604.4023">append record (event, data)</text><polygon fill="#181818" points="845.5,4619.1445,835.5,4623.1445,845.5,4627.1445,841.5,4623.1445" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="839.5" x2="1223.5" y1="4623.1445" y2="4623.1445"/><polygon fill="#181818" points="1212.5,4655.4551,1222.5,4659.4551,1212.5,4663.4551,1216.5,4659.4551" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="834.5" x2="1218.5" y1="4659.4551" y2="4659.4551"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="335" x="841.5" y="4654.7129">close secure session (SAM certificate, as non ratified)</text><polygon fill="#181818" points="845.5,4684.7656,835.5,4688.7656,845.5,4692.7656,841.5,4688.7656" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="839.5" x2="1223.5" y1="4688.7656" y2="4688.7656"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="851.5" y="4684.0234">[card certificate]</text><polygon fill="#181818" points="1212.5,4714.0762,1222.5,4718.0762,1212.5,4722.0762,1216.5,4718.0762" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="834.5" x2="1218.5" y1="4718.0762" y2="4718.0762"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="841.5" y="4713.334">ratification command</text><polygon fill="#181818" points="845.5,4728.0762,835.5,4732.0762,845.5,4736.0762,841.5,4732.0762" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="839.5" x2="1223.5" y1="4732.0762" y2="4732.0762"/><polygon fill="#181818" points="1212.5,4757.3867,1222.5,4761.3867,1212.5,4765.3867,1216.5,4761.3867" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="834.5" x2="1218.5" y1="4761.3867" y2="4761.3867"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="841.5" y="4756.6445">close card channel</text><polygon fill="#181818" points="845.5,4771.3867,835.5,4775.3867,845.5,4779.3867,841.5,4775.3867" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="839.5" x2="1228.5" y1="4775.3867" y2="4775.3867"/><polygon fill="#0000FF" points="387.5,4800.6973,377.5,4804.6973,387.5,4808.6973,383.5,4804.6973" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="381.5" x2="828.5" y1="4804.6973" y2="4804.6973"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="393.5" y="4799.9551">[card certificate]</text><polygon fill="#00FF00" points="1298,4860.6289,1308,4864.6289,1298,4868.6289,1302,4864.6289" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;" x1="376.5" x2="1304" y1="4864.6289" y2="4864.6289"/><text fill="#008000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="51" x="383.5" y="4829.2656">SAM #5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="383.5" y="4844.5762">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="415.5" y="4859.8867">- APDU list</text><polygon fill="#181818" points="1580,4889.9395,1590,4893.9395,1580,4897.9395,1584,4893.9395" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1320" x2="1586" y1="4893.9395" y2="4893.9395"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="227" x="1327" y="4889.1973">digest authenticate (card certificate)</text><polygon fill="#181818" points="1331,4919.25,1321,4923.25,1331,4927.25,1327,4923.25" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1325" x2="1591" y1="4923.25" y2="4923.25"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="142" x="1337" y="4918.5078">[authentication status]</text><polygon fill="#00FF00" points="387.5,4948.5605,377.5,4952.5605,387.5,4956.5605,383.5,4952.5605" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="381.5" x2="1314" y1="4952.5605" y2="4952.5605"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="393.5" y="4947.8184">[authentification status]</text><polygon fill="#181818" points="96.5,5115.666,86.5,5119.666,96.5,5123.666,92.5,5119.666" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="370.5" y1="5119.666" y2="5119.666"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="102.5" y="4977.1289">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127" x="134.5" y="4992.4395">- identification data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="134.5" y="5007.75">- invalidation status</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="122" x="134.5" y="5023.0605">- environment data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="134.5" y="5038.3711">-</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" text-decoration="line-through" textLength="112" x="146.5" y="5038.3711">ratification status</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="167" x="134.5" y="5053.6816">- last event data (updated)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="119" x="134.5" y="5068.9922">- contract list data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="134.5" y="5084.3027">- contract #x data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="178" x="134.5" y="5099.6133">- counter #x data (updated)]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="143" x="102.5" y="5114.9238">authentification status</text><!--MD5=[7a31a8b6f98030b20dd52aa3aaaded78]
@startuml

'skinparam ClassBorderColor #F1C40F
skinparam ClassBorderColor #D4AC0D
skinparam stereotypeABorderColor #A9DCDF
skinparam stereotypeIBorderColor #B4A7E5
skinparam stereotypeCBorderColor #ADD1B2
skinparam stereotypeEBorderColor #EB93DF
skinparam shadowing false

skinparam StateBorderColor #D4AC0D
skinparam ActivityBorderColor #D4AC0D

' Red
skinparam ClassBackgroundColor<<red>> #FDEDEC
skinparam ClassBorderColor<<red>> #E74C3C
hide <<red>> stereotype
' Purple
skinparam ClassBackgroundColor<<purple>> #F4ECF7
skinparam ClassBorderColor<<purple>> #8E44AD
hide <<purple>> stereotype
' blue
skinparam ClassBackgroundColor<<blue>> #EBF5FB
skinparam ClassBorderColor<<blue>> #3498DB
hide <<blue>> stereotype
' Green
skinparam ClassBackgroundColor<<green>> #EAFAF1
skinparam ClassBorderColor<<green>> #2ECC71
hide <<green>> stereotype

' Orange
skinparam ClassBackgroundColor<<orange>> #FDF2E9
skinparam ClassBorderColor<<orange>> #E67E22
hide <<orange>> stereotype

' Grey
skinparam ClassBackgroundColor<<grey>> #EAECEE
skinparam ClassBorderColor<<grey>> #2C3E50
hide <<grey>> stereotype

actor "Ticketing Application" as app #gold
participant "Calypso API" as capi #pink
participant "Reader API" as rapi #pink
participant "Calypso Card\nReader" as cardReader #lightBlue
boundary "**Card**" as card #lightBlue
participant "Calypso SAM\nReader" as samReader #lightGreen
boundary "selected\n**SAM**" as sam #lightGreen

activate app #gold
activate sam #lightGreen

== Card selection & identification ==

note over capi
    Only reads data inside the session.
end note

app->capi: <font color=red>**prepare**</font> card selection scenario:\n\t- filter by specific AID\n\t- filter invalidated card status
activate capi  #pink
capi- ->app
deactivate capi

app->rapi: <font color=red>**process**</font> explicit card selection scenario
activate rapi  #pink
rapi-[#0000FF]>cardReader: <font color=blue>**Card #1**</font>\ntransmit selection request\n\t- card selector
activate cardReader #lightBlue

cardReader->card: open card channel
activate card #lightBlue
card- ->cardReader
cardReader->card: select application (aid)
card- ->cardReader: [card FCI]
cardReader->cardReader: checks invalidation status

cardReader- -[#0000FF]>rapi: receive selection response
deactivate cardReader

rapi- ->app: selected active SmartCard image
deactivate rapi

app->capi: **cast** Calypso card
activate capi  #pink
capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status]

deactivate capi

== Card secure transaction ==

app->app: **instantiate** Calypso card transaction:\n\t- Calypso card resource\n\t- Calypso SAM resource

app->capi: <font color=red>**prepare**</font> card transaction:\n\t- read environment file\n\t- manage session for authentication
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> opening (DEBIT access level)
activate capi  #pink

capi-[#00FF00]>samReader: <font color=green>**SAM #1**<font color=red>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: select diversifier (card serial)
sam- ->samReader
samReader->sam: get challenge
sam- ->samReader: [SAM challenge]
samReader-[#00FF00]->capi: [SAM challenge]
deactivate samReader

capi-[#0000FF]>cardReader: <font color=blue>**Card #2**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
note over cardReader
    Optimization: environment file read through the session opening.
end note

    cardReader->card: open secure session (card debit key,\n\tSAM challenge,\n\tSFI environment to read)
    card- ->cardReader: [card challenge & environment data]
end

cardReader- -[#0000FF]>capi: [card challenge]
deactivate cardReader
capi->capi: checks ratification status

capi-[#00FF00]>samReader: <font color=green>**SAM #2**<font color=red>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: digest init (opening data)
sam- ->samReader

group#AliceBlue #AliceBlue Initial Authentication

samReader->sam: digest internal authenticate
sam- ->samReader: [SAM certificate]
samReader-[#00FF00]->capi: [SAM certificate]
deactivate samReader

capi-[#0000FF]>cardReader: <font color=blue>**Card #3**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

note over cardReader
    command outside of the SMAC (no Digest Update)
end note

    cardReader->card: manage secure session (authentication on, encryption off,\n\tSAM certificate)
    card- ->cardReader: [card certificate]

cardReader- -[#0000FF]>capi: [card challenge]
deactivate cardReader

capi-[#00FF00]>samReader: <font color=green>**SAM #3**<font color=red>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: digest authenticate (card certificate)
sam- ->samReader: [authentication status]
samReader-[#00FF00]->capi: [authentication status]
deactivate samReader

end

capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status\n\t- environment data\n\t- ratification status\n\t- authentication status]
deactivate capi



app->capi: <font color=red>**prepare**</font> card transaction:\n\t- read last event
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> commands
activate capi  #pink

capi-[#0000FF]>cardReader: <font color=blue>**Card #4**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: read record (last event)
    card- ->cardReader: [last event data]
end

cardReader- -[#0000FF]>capi: [last event data]
deactivate cardReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status\n\t- environment data\n\t- ratification status\n\t- last event data]
deactivate capi

app->app: checks transaction recovery status

app->capi: <font color=red>**prepare**</font> card transaction:\n\t- read contract list
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> commands
activate capi  #pink

capi-[#0000FF]>cardReader: <font color=blue>**Card #5**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: read record (contract list)
    card- ->cardReader: [contract list data]
end

cardReader- -[#0000FF]>capi: [contract list data]
deactivate cardReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status\n\t- environment data\n\t- ratification status\n\t- last event data\n\t- contract list data]
deactivate capi

app->app: identifies contract

app->capi: <font color=red>**prepare**</font> card transaction:\n\t- read contract #x
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> commands
activate capi  #pink

capi-[#0000FF]>cardReader: <font color=blue>**Card #6**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: read record (contract #x)
    card- ->cardReader: [contract #x data]
end

cardReader- -[#0000FF]>capi: [contract #x data]
deactivate cardReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status\n\t- environment data\n\t- ratification status\n\t- last event data\n\t- contract list data\n\t- contract #x data]
deactivate capi

app->app: identifies associated counter

app->capi: <font color=red>**prepare**</font> card transaction:\n\t- reader counter #x
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> commands
activate capi  #pink

capi-[#0000FF]>cardReader: <font color=blue>**Card #7**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: read record (counter #x)
    card- ->cardReader: [counter #x data]
end

cardReader- -[#0000FF]>capi: [counter #x data]
deactivate cardReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status\n\t- environment data\n\t- ratification status\n\t- last event data\n\t- contract list data\n\t- contract #x data\n\t- counter #x data]
deactivate capi

app->app: defines data to update

app->capi: <font color=red>**prepare**</font>:\n\t- decrease counter #x (new value)\n\t- append event record (new event)\n\t- release channel
activate capi  #pink

capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> closing (not ratified)
activate capi  #pink
capi->capi: anticipates the future card responses
note over capi
    If the current value of the counter #x were **unknown**, then the transmission of an additional card APDU
    message would be necessary to operate the decrease counter in a different message than the session closing.
end note

capi-[#00FF00]>samReader: <font color=green>**SAM #4**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen

samReader->sam: digest update (read environment) * 2
sam- ->samReader
samReader->sam: digest update (last event) * 2
sam- ->samReader
samReader->sam: digest update (read contract list) * 2
sam- ->samReader
samReader->sam: digest update (read contract #x) * 2
sam- ->samReader
samReader->sam: digest update (read counters) * 2
sam- ->samReader
group <font color=red>**anticipated**</font> Card APDU responses
    samReader->sam: digest update (decrease counter) * 2
    sam- ->samReader
    samReader->sam: digest update (append event record) * 2
    sam- ->samReader
end
samReader->sam: digest close
sam- ->samReader: [SAM certificate]

samReader-[#00FF00]->capi: [SAM certificate]
deactivate samReader

capi-[#0000FF]>cardReader: <font color=blue>**Card #8**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: decrease counter (counter #1, value)
    card- ->cardReader: [new counter value]
    cardReader->card: append record (event, data)
    card- ->cardReader
end

cardReader->card: close secure session (SAM certificate, as non ratified)
card- ->cardReader: [card certificate]
cardReader->card: ratification command
card- ->cardReader
cardReader->card: close card channel
card- ->cardReader
deactivate card

cardReader-[#0000FF]->capi: [card certificate]
deactivate cardReader

capi-[#00FF00]>samReader: <font color=green>**SAM #5**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: digest authenticate (card certificate)
sam- ->samReader: [authentication status]

samReader-[#00FF00]->capi: [authentification status]
deactivate samReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status\n\t- environment data\n\t- - -ratification status- -\n\t- last event data (updated)\n\t- contract list data\n\t- contract #x data\n\t- counter #x data (updated)]\nauthentification status
deactivate capi
@enduml

@startuml

skinparam ClassBorderColor #D4AC0D
skinparam stereotypeABorderColor #A9DCDF
skinparam stereotypeIBorderColor #B4A7E5
skinparam stereotypeCBorderColor #ADD1B2
skinparam stereotypeEBorderColor #EB93DF
skinparam shadowing false

skinparam StateBorderColor #D4AC0D
skinparam ActivityBorderColor #D4AC0D

skinparam ClassBackgroundColor<<red>> #FDEDEC
skinparam ClassBorderColor<<red>> #E74C3C
hide <<red>> stereotype
skinparam ClassBackgroundColor<<purple>> #F4ECF7
skinparam ClassBorderColor<<purple>> #8E44AD
hide <<purple>> stereotype
skinparam ClassBackgroundColor<<blue>> #EBF5FB
skinparam ClassBorderColor<<blue>> #3498DB
hide <<blue>> stereotype
skinparam ClassBackgroundColor<<green>> #EAFAF1
skinparam ClassBorderColor<<green>> #2ECC71
hide <<green>> stereotype

skinparam ClassBackgroundColor<<orange>> #FDF2E9
skinparam ClassBorderColor<<orange>> #E67E22
hide <<orange>> stereotype

skinparam ClassBackgroundColor<<grey>> #EAECEE
skinparam ClassBorderColor<<grey>> #2C3E50
hide <<grey>> stereotype

actor "Ticketing Application" as app #gold
participant "Calypso API" as capi #pink
participant "Reader API" as rapi #pink
participant "Calypso Card\nReader" as cardReader #lightBlue
boundary "**Card**" as card #lightBlue
participant "Calypso SAM\nReader" as samReader #lightGreen
boundary "selected\n**SAM**" as sam #lightGreen

activate app #gold
activate sam #lightGreen

== Card selection & identification ==

note over capi
    Only reads data inside the session.
end note

app->capi: <font color=red>**prepare**</font> card selection scenario:\n\t- filter by specific AID\n\t- filter invalidated card status
activate capi  #pink
capi- ->app
deactivate capi

app->rapi: <font color=red>**process**</font> explicit card selection scenario
activate rapi  #pink
rapi-[#0000FF]>cardReader: <font color=blue>**Card #1**</font>\ntransmit selection request\n\t- card selector
activate cardReader #lightBlue

cardReader->card: open card channel
activate card #lightBlue
card- ->cardReader
cardReader->card: select application (aid)
card- ->cardReader: [card FCI]
cardReader->cardReader: checks invalidation status

cardReader- -[#0000FF]>rapi: receive selection response
deactivate cardReader

rapi- ->app: selected active SmartCard image
deactivate rapi

app->capi: **cast** Calypso card
activate capi  #pink
capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status]

deactivate capi

== Card secure transaction ==

app->app: **instantiate** Calypso card transaction:\n\t- Calypso card resource\n\t- Calypso SAM resource

app->capi: <font color=red>**prepare**</font> card transaction:\n\t- read environment file\n\t- manage session for authentication
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> opening (DEBIT access level)
activate capi  #pink

capi-[#00FF00]>samReader: <font color=green>**SAM #1**<font color=red>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: select diversifier (card serial)
sam- ->samReader
samReader->sam: get challenge
sam- ->samReader: [SAM challenge]
samReader-[#00FF00]->capi: [SAM challenge]
deactivate samReader

capi-[#0000FF]>cardReader: <font color=blue>**Card #2**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
note over cardReader
    Optimization: environment file read through the session opening.
end note

    cardReader->card: open secure session (card debit key,\n\tSAM challenge,\n\tSFI environment to read)
    card- ->cardReader: [card challenge & environment data]
end

cardReader- -[#0000FF]>capi: [card challenge]
deactivate cardReader
capi->capi: checks ratification status

capi-[#00FF00]>samReader: <font color=green>**SAM #2**<font color=red>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: digest init (opening data)
sam- ->samReader

group#AliceBlue #AliceBlue Initial Authentication

samReader->sam: digest internal authenticate
sam- ->samReader: [SAM certificate]
samReader-[#00FF00]->capi: [SAM certificate]
deactivate samReader

capi-[#0000FF]>cardReader: <font color=blue>**Card #3**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

note over cardReader
    command outside of the SMAC (no Digest Update)
end note

    cardReader->card: manage secure session (authentication on, encryption off,\n\tSAM certificate)
    card- ->cardReader: [card certificate]

cardReader- -[#0000FF]>capi: [card challenge]
deactivate cardReader

capi-[#00FF00]>samReader: <font color=green>**SAM #3**<font color=red>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: digest authenticate (card certificate)
sam- ->samReader: [authentication status]
samReader-[#00FF00]->capi: [authentication status]
deactivate samReader

end

capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status\n\t- environment data\n\t- ratification status\n\t- authentication status]
deactivate capi



app->capi: <font color=red>**prepare**</font> card transaction:\n\t- read last event
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> commands
activate capi  #pink

capi-[#0000FF]>cardReader: <font color=blue>**Card #4**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: read record (last event)
    card- ->cardReader: [last event data]
end

cardReader- -[#0000FF]>capi: [last event data]
deactivate cardReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status\n\t- environment data\n\t- ratification status\n\t- last event data]
deactivate capi

app->app: checks transaction recovery status

app->capi: <font color=red>**prepare**</font> card transaction:\n\t- read contract list
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> commands
activate capi  #pink

capi-[#0000FF]>cardReader: <font color=blue>**Card #5**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: read record (contract list)
    card- ->cardReader: [contract list data]
end

cardReader- -[#0000FF]>capi: [contract list data]
deactivate cardReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status\n\t- environment data\n\t- ratification status\n\t- last event data\n\t- contract list data]
deactivate capi

app->app: identifies contract

app->capi: <font color=red>**prepare**</font> card transaction:\n\t- read contract #x
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> commands
activate capi  #pink

capi-[#0000FF]>cardReader: <font color=blue>**Card #6**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: read record (contract #x)
    card- ->cardReader: [contract #x data]
end

cardReader- -[#0000FF]>capi: [contract #x data]
deactivate cardReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status\n\t- environment data\n\t- ratification status\n\t- last event data\n\t- contract list data\n\t- contract #x data]
deactivate capi

app->app: identifies associated counter

app->capi: <font color=red>**prepare**</font> card transaction:\n\t- reader counter #x
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> commands
activate capi  #pink

capi-[#0000FF]>cardReader: <font color=blue>**Card #7**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: read record (counter #x)
    card- ->cardReader: [counter #x data]
end

cardReader- -[#0000FF]>capi: [counter #x data]
deactivate cardReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status\n\t- environment data\n\t- ratification status\n\t- last event data\n\t- contract list data\n\t- contract #x data\n\t- counter #x data]
deactivate capi

app->app: defines data to update

app->capi: <font color=red>**prepare**</font>:\n\t- decrease counter #x (new value)\n\t- append event record (new event)\n\t- release channel
activate capi  #pink

capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> closing (not ratified)
activate capi  #pink
capi->capi: anticipates the future card responses
note over capi
    If the current value of the counter #x were **unknown**, then the transmission of an additional card APDU
    message would be necessary to operate the decrease counter in a different message than the session closing.
end note

capi-[#00FF00]>samReader: <font color=green>**SAM #4**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen

samReader->sam: digest update (read environment) * 2
sam- ->samReader
samReader->sam: digest update (last event) * 2
sam- ->samReader
samReader->sam: digest update (read contract list) * 2
sam- ->samReader
samReader->sam: digest update (read contract #x) * 2
sam- ->samReader
samReader->sam: digest update (read counters) * 2
sam- ->samReader
group <font color=red>**anticipated**</font> Card APDU responses
    samReader->sam: digest update (decrease counter) * 2
    sam- ->samReader
    samReader->sam: digest update (append event record) * 2
    sam- ->samReader
end
samReader->sam: digest close
sam- ->samReader: [SAM certificate]

samReader-[#00FF00]->capi: [SAM certificate]
deactivate samReader

capi-[#0000FF]>cardReader: <font color=blue>**Card #8**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: decrease counter (counter #1, value)
    card- ->cardReader: [new counter value]
    cardReader->card: append record (event, data)
    card- ->cardReader
end

cardReader->card: close secure session (SAM certificate, as non ratified)
card- ->cardReader: [card certificate]
cardReader->card: ratification command
card- ->cardReader
cardReader->card: close card channel
card- ->cardReader
deactivate card

cardReader-[#0000FF]->capi: [card certificate]
deactivate cardReader

capi-[#00FF00]>samReader: <font color=green>**SAM #5**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: digest authenticate (card certificate)
sam- ->samReader: [authentication status]

samReader-[#00FF00]->capi: [authentification status]
deactivate samReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status\n\t- environment data\n\t- - -ratification status- -\n\t- last event data (updated)\n\t- contract list data\n\t- contract #x data\n\t- counter #x data (updated)]\nauthentification status
deactivate capi
@enduml

PlantUML version 1.2022.7(Mon Aug 22 21:01:30 RET 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: fr
Country: FR
--></g></svg>