<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="5594.4px" preserveAspectRatio="none" style="width:1910px;height:5594px;background:#FFFFFF;" version="1.1" viewBox="0 0 1910 5594" width="1910.4px" zoomAndPan="magnify"><defs/><g><rect fill="#FFD700" height="5377.2422" style="stroke:#181818;stroke-width:1.2;" width="12" x="95.4" y="109.7859"/><rect fill="#FFC0CB" height="16.8" style="stroke:#181818;stroke-width:1.2;" width="12" x="426.6" y="266.4492"/><rect fill="#FFC0CB" height="71.918" style="stroke:#181818;stroke-width:1.2;" width="12" x="426.6" y="668.9484"/><rect fill="#FFC0CB" height="16.8" style="stroke:#181818;stroke-width:1.2;" width="12" x="426.6" y="933.9023"/><rect fill="#FFC0CB" height="682.9711" style="stroke:#181818;stroke-width:1.2;" width="12" x="426.6" y="985.875"/><rect fill="#FFC0CB" height="16.8" style="stroke:#181818;stroke-width:1.2;" width="12" x="426.6" y="1722.3914"/><rect fill="#FFC0CB" height="342.0445" style="stroke:#181818;stroke-width:1.2;" width="12" x="426.6" y="1774.3641"/><rect fill="#FFC0CB" height="16.8" style="stroke:#181818;stroke-width:1.2;" width="12" x="426.6" y="2220.7266"/><rect fill="#FFC0CB" height="360.4172" style="stroke:#181818;stroke-width:1.2;" width="12" x="426.6" y="2272.6992"/><rect fill="#FFC0CB" height="16.8" style="stroke:#181818;stroke-width:1.2;" width="12" x="426.6" y="2737.4344"/><rect fill="#FFC0CB" height="378.7898" style="stroke:#181818;stroke-width:1.2;" width="12" x="426.6" y="2789.407"/><rect fill="#FFC0CB" height="16.8" style="stroke:#181818;stroke-width:1.2;" width="12" x="426.6" y="3272.5148"/><rect fill="#FFC0CB" height="397.1625" style="stroke:#181818;stroke-width:1.2;" width="12" x="426.6" y="3324.4875"/><rect fill="#FFC0CB" height="16.8" style="stroke:#181818;stroke-width:1.2;" width="12" x="426.6" y="3862.7133"/><rect fill="#FFC0CB" height="1561.5422" style="stroke:#181818;stroke-width:1.2;" width="12" x="426.6" y="3914.6859"/><rect fill="#FFC0CB" height="315.3539" style="stroke:#181818;stroke-width:1.2;" width="12" x="736.2" y="318.4219"/><rect fill="#ADD8E6" height="208.2633" style="stroke:#181818;stroke-width:1.2;" width="12" x="976.2" y="390.3398"/><rect fill="#ADD8E6" height="222.2086" style="stroke:#181818;stroke-width:1.2;" width="12" x="976.2" y="1287.2016"/><rect fill="#ADD8E6" height="143.0906" style="stroke:#181818;stroke-width:1.2;" width="12" x="976.2" y="1846.282"/><rect fill="#ADD8E6" height="143.0906" style="stroke:#181818;stroke-width:1.2;" width="12" x="976.2" y="2344.6172"/><rect fill="#ADD8E6" height="143.0906" style="stroke:#181818;stroke-width:1.2;" width="12" x="976.2" y="2861.325"/><rect fill="#ADD8E6" height="143.0906" style="stroke:#181818;stroke-width:1.2;" width="12" x="976.2" y="3396.4055"/><rect fill="#ADD8E6" height="369.3539" style="stroke:#181818;stroke-width:1.2;" width="12" x="976.2" y="4728.9117"/><rect fill="#ADD8E6" height="4637.5805" style="stroke:#181818;stroke-width:1.2;" width="12" x="1419" y="425.5125"/><rect fill="#90EE90" height="157.4906" style="stroke:#181818;stroke-width:1.2;" width="12" x="1521.6" y="1057.793"/><rect fill="#90EE90" height="558.8719" style="stroke:#181818;stroke-width:1.2;" width="12" x="1521.6" y="4098.1219"/><rect fill="#90EE90" height="105.518" style="stroke:#181818;stroke-width:1.2;" width="12" x="1521.6" y="5170.1836"/><rect fill="#90EE90" height="5377.2422" style="stroke:#181818;stroke-width:1.2;" width="12" x="1834.8" y="109.7859"/><rect height="170.2359" style="stroke:#000000;stroke-width:1.7999999999999998;fill:none;" width="757.2" x="709.2" y="1305.2016"/><rect height="91.118" style="stroke:#000000;stroke-width:1.7999999999999998;fill:none;" width="559.2" x="907.2" y="1864.282"/><rect height="91.118" style="stroke:#000000;stroke-width:1.7999999999999998;fill:none;" width="559.2" x="907.2" y="2362.6172"/><rect height="91.118" style="stroke:#000000;stroke-width:1.7999999999999998;fill:none;" width="559.2" x="907.2" y="2879.325"/><rect height="91.118" style="stroke:#000000;stroke-width:1.7999999999999998;fill:none;" width="559.2" x="907.2" y="3414.4055"/><rect height="124.718" style="stroke:#000000;stroke-width:1.7999999999999998;fill:none;" width="435.6" x="1454.4" y="4427.9578"/><rect height="143.0906" style="stroke:#000000;stroke-width:1.7999999999999998;fill:none;" width="559.2" x="907.2" y="4746.9117"/><line style="stroke:#181818;stroke-width:0.6;fill:none;stroke-dasharray:5.0,5.0;" x1="100.8" x2="100.8" y1="97.7859" y2="5497.8281"/><line style="stroke:#181818;stroke-width:0.6;fill:none;stroke-dasharray:5.0,5.0;" x1="432.6" x2="432.6" y1="97.7859" y2="5497.8281"/><line style="stroke:#181818;stroke-width:0.6;fill:none;stroke-dasharray:5.0,5.0;" x1="742.2" x2="742.2" y1="97.7859" y2="5497.8281"/><line style="stroke:#181818;stroke-width:0.6;fill:none;stroke-dasharray:5.0,5.0;" x1="981.6" x2="981.6" y1="97.7859" y2="5497.8281"/><line style="stroke:#181818;stroke-width:0.6;fill:none;stroke-dasharray:5.0,5.0;" x1="1424.4" x2="1424.4" y1="97.7859" y2="5497.8281"/><line style="stroke:#181818;stroke-width:0.6;fill:none;stroke-dasharray:5.0,5.0;" x1="1527.6" x2="1527.6" y1="97.7859" y2="5497.8281"/><line style="stroke:#181818;stroke-width:0.6;fill:none;stroke-dasharray:5.0,5.0;" x1="1840.8" x2="1840.8" y1="97.7859" y2="5497.8281"/><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="174" x="10.8" y="94.2422">Ticketing Application</text><ellipse cx="101.4" cy="16.2" fill="#FFD700" rx="9.6" ry="9.6" style="stroke:#181818;stroke-width:0.6;"/><path d="M101.4,25.8 L101.4,58.2 M85.8,35.4 L117,35.4 M101.4,58.2 L85.8,76.2 M101.4,58.2 L117,76.2 " fill="none" style="stroke:#181818;stroke-width:0.6;"/><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="174" x="10.8" y="5512.8703">Ticketing Application</text><ellipse cx="101.4" cy="5526.6141" fill="#FFD700" rx="9.6" ry="9.6" style="stroke:#181818;stroke-width:0.6;"/><path d="M101.4,5536.2141 L101.4,5568.6141 M85.8,5545.8141 L117,5545.8141 M101.4,5568.6141 L85.8,5586.6141 M101.4,5568.6141 L117,5586.6141 " fill="none" style="stroke:#181818;stroke-width:0.6;"/><rect fill="#FFC0CB" height="36.5859" rx="3" ry="3" style="stroke:#181818;stroke-width:0.6;" width="112.8" x="376.2" y="60"/><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="96" x="384.6" y="84.6422">Calypso API</text><rect fill="#FFC0CB" height="36.5859" rx="3" ry="3" style="stroke:#181818;stroke-width:0.6;" width="112.8" x="376.2" y="5496.6281"/><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="96" x="384.6" y="5521.2703">Calypso API</text><rect fill="#FFC0CB" height="36.5859" rx="3" ry="3" style="stroke:#181818;stroke-width:0.6;" width="105.6" x="689.4" y="60"/><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="88.8" x="697.8" y="84.6422">Reader API</text><rect fill="#FFC0CB" height="36.5859" rx="3" ry="3" style="stroke:#181818;stroke-width:0.6;" width="105.6" x="689.4" y="5496.6281"/><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="88.8" x="697.8" y="5521.2703">Reader API</text><rect fill="#ADD8E6" height="56.3719" rx="3" ry="3" style="stroke:#181818;stroke-width:0.6;" width="126" x="919.2" y="40.2141"/><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="109.2" x="927.6" y="64.8563">Calypso Card</text><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="57.6" x="953.4" y="84.6422">Reader</text><rect fill="#ADD8E6" height="56.3719" rx="3" ry="3" style="stroke:#181818;stroke-width:0.6;" width="126" x="919.2" y="5496.6281"/><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="109.2" x="927.6" y="5521.2703">Calypso Card</text><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="57.6" x="953.4" y="5541.0563">Reader</text><text fill="#000000" font-family="sans-serif" font-size="16.8" font-weight="bold" lengthAdjust="spacing" textLength="39.6" x="1401.6" y="94.2422">Card</text><path d="M1400.4,44.4 L1400.4,73.2 M1400.4,58.8 L1420.8,58.8 " fill="none" style="stroke:#181818;stroke-width:0.6;"/><ellipse cx="1435.2" cy="58.8" fill="#ADD8E6" rx="14.4" ry="14.4" style="stroke:#181818;stroke-width:0.6;"/><text fill="#000000" font-family="sans-serif" font-size="16.8" font-weight="bold" lengthAdjust="spacing" textLength="39.6" x="1401.6" y="5512.8703">Card</text><path d="M1400.4,5521.2141 L1400.4,5550.0141 M1400.4,5535.6141 L1420.8,5535.6141 " fill="none" style="stroke:#181818;stroke-width:0.6;"/><ellipse cx="1435.2" cy="5535.6141" fill="#ADD8E6" rx="14.4" ry="14.4" style="stroke:#181818;stroke-width:0.6;"/><rect fill="#90EE90" height="56.3719" rx="3" ry="3" style="stroke:#181818;stroke-width:0.6;" width="122.4" x="1466.4" y="40.2141"/><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="105.6" x="1474.8" y="64.8563">Calypso SAM</text><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="57.6" x="1498.8" y="84.6422">Reader</text><rect fill="#90EE90" height="56.3719" rx="3" ry="3" style="stroke:#181818;stroke-width:0.6;" width="122.4" x="1466.4" y="5496.6281"/><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="105.6" x="1474.8" y="5521.2703">Calypso SAM</text><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="57.6" x="1498.8" y="5541.0563">Reader</text><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="67.2" x="1803.6" y="74.4563">selected</text><text fill="#000000" font-family="sans-serif" font-size="16.8" font-weight="bold" lengthAdjust="spacing" textLength="37.2" x="1818.6" y="94.2422">SAM</text><path d="M1816.2,24.6141 L1816.2,53.4141 M1816.2,39.0141 L1836.6,39.0141 " fill="none" style="stroke:#181818;stroke-width:0.6;"/><ellipse cx="1851" cy="39.0141" fill="#90EE90" rx="14.4" ry="14.4" style="stroke:#181818;stroke-width:0.6;"/><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="67.2" x="1803.6" y="5512.8703">selected</text><text fill="#000000" font-family="sans-serif" font-size="16.8" font-weight="bold" lengthAdjust="spacing" textLength="37.2" x="1818.6" y="5532.6563">SAM</text><path d="M1816.2,5541 L1816.2,5569.8 M1816.2,5555.4 L1836.6,5555.4 " fill="none" style="stroke:#181818;stroke-width:0.6;"/><ellipse cx="1851" cy="5555.4" fill="#90EE90" rx="14.4" ry="14.4" style="stroke:#181818;stroke-width:0.6;"/><rect fill="#FFD700" height="5377.2422" style="stroke:#181818;stroke-width:1.2;" width="12" x="95.4" y="109.7859"/><rect fill="#FFC0CB" height="16.8" style="stroke:#181818;stroke-width:1.2;" width="12" x="426.6" y="266.4492"/><rect fill="#FFC0CB" height="71.918" style="stroke:#181818;stroke-width:1.2;" width="12" x="426.6" y="668.9484"/><rect fill="#FFC0CB" height="16.8" style="stroke:#181818;stroke-width:1.2;" width="12" x="426.6" y="933.9023"/><rect fill="#FFC0CB" height="682.9711" style="stroke:#181818;stroke-width:1.2;" width="12" x="426.6" y="985.875"/><rect fill="#FFC0CB" height="16.8" style="stroke:#181818;stroke-width:1.2;" width="12" x="426.6" y="1722.3914"/><rect fill="#FFC0CB" height="342.0445" style="stroke:#181818;stroke-width:1.2;" width="12" x="426.6" y="1774.3641"/><rect fill="#FFC0CB" height="16.8" style="stroke:#181818;stroke-width:1.2;" width="12" x="426.6" y="2220.7266"/><rect fill="#FFC0CB" height="360.4172" style="stroke:#181818;stroke-width:1.2;" width="12" x="426.6" y="2272.6992"/><rect fill="#FFC0CB" height="16.8" style="stroke:#181818;stroke-width:1.2;" width="12" x="426.6" y="2737.4344"/><rect fill="#FFC0CB" height="378.7898" style="stroke:#181818;stroke-width:1.2;" width="12" x="426.6" y="2789.407"/><rect fill="#FFC0CB" height="16.8" style="stroke:#181818;stroke-width:1.2;" width="12" x="426.6" y="3272.5148"/><rect fill="#FFC0CB" height="397.1625" style="stroke:#181818;stroke-width:1.2;" width="12" x="426.6" y="3324.4875"/><rect fill="#FFC0CB" height="16.8" style="stroke:#181818;stroke-width:1.2;" width="12" x="426.6" y="3862.7133"/><rect fill="#FFC0CB" height="1561.5422" style="stroke:#181818;stroke-width:1.2;" width="12" x="426.6" y="3914.6859"/><rect fill="#FFC0CB" height="315.3539" style="stroke:#181818;stroke-width:1.2;" width="12" x="736.2" y="318.4219"/><rect fill="#ADD8E6" height="208.2633" style="stroke:#181818;stroke-width:1.2;" width="12" x="976.2" y="390.3398"/><rect fill="#ADD8E6" height="222.2086" style="stroke:#181818;stroke-width:1.2;" width="12" x="976.2" y="1287.2016"/><rect fill="#ADD8E6" height="143.0906" style="stroke:#181818;stroke-width:1.2;" width="12" x="976.2" y="1846.282"/><rect fill="#ADD8E6" height="143.0906" style="stroke:#181818;stroke-width:1.2;" width="12" x="976.2" y="2344.6172"/><rect fill="#ADD8E6" height="143.0906" style="stroke:#181818;stroke-width:1.2;" width="12" x="976.2" y="2861.325"/><rect fill="#ADD8E6" height="143.0906" style="stroke:#181818;stroke-width:1.2;" width="12" x="976.2" y="3396.4055"/><rect fill="#ADD8E6" height="369.3539" style="stroke:#181818;stroke-width:1.2;" width="12" x="976.2" y="4728.9117"/><rect fill="#ADD8E6" height="4637.5805" style="stroke:#181818;stroke-width:1.2;" width="12" x="1419" y="425.5125"/><rect fill="#90EE90" height="157.4906" style="stroke:#181818;stroke-width:1.2;" width="12" x="1521.6" y="1057.793"/><rect fill="#90EE90" height="558.8719" style="stroke:#181818;stroke-width:1.2;" width="12" x="1521.6" y="4098.1219"/><rect fill="#90EE90" height="105.518" style="stroke:#181818;stroke-width:1.2;" width="12" x="1521.6" y="5170.1836"/><rect fill="#90EE90" height="5377.2422" style="stroke:#181818;stroke-width:1.2;" width="12" x="1834.8" y="109.7859"/><rect fill="#EEEEEE" height="3.6" style="stroke:#EEEEEE;stroke-width:1.2;" width="1902" x="0" y="134.5723"/><line style="stroke:#000000;stroke-width:1.2;" x1="0" x2="1902" y1="134.5723" y2="134.5723"/><line style="stroke:#000000;stroke-width:1.2;" x1="0" x2="1902" y1="138.1723" y2="138.1723"/><rect fill="#EEEEEE" height="27.9727" style="stroke:#000000;stroke-width:2.4;" width="265.2" x="818.4" y="121.7859"/><text fill="#000000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="243.6" x="825.6" y="141.668">Card selection &amp; identification</text><path d="M288,167.7586 L288,197.7586 L577.2,197.7586 L577.2,179.7586 L565.2,167.7586 L288,167.7586 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.6;"/><path d="M565.2,167.7586 L565.2,179.7586 L577.2,179.7586 L565.2,167.7586 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.6;"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="264" x="295.2" y="188.8406">Only reads data inside the session.</text><polygon fill="#181818" points="412.2,261.6492,424.2,266.4492,412.2,271.2492,417,266.4492" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="107.4" x2="419.4" y1="266.4492" y2="266.4492"/><text fill="#FF0000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="64.8" x="115.8" y="224.0133">prepare</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="178.8" x="185.4" y="224.0133">card selection scenario:</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="169.2" x="154.2" y="242.3859">- filter by specific AID</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="226.8" x="154.2" y="260.7586">- filter invalidated card status</text><polygon fill="#181818" points="120.6,278.4492,108.6,283.2492,120.6,288.0492,115.8,283.2492" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="113.4" x2="431.4" y1="283.2492" y2="283.2492"/><polygon fill="#181818" points="721.8,313.6219,733.8,318.4219,721.8,323.2219,726.6,318.4219" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="107.4" x2="729" y1="318.4219" y2="318.4219"/><text fill="#FF0000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="62.4" x="115.8" y="312.7313">process</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="235.2" x="183" y="312.7313">explicit card selection scenario</text><polygon fill="#0000FF" points="961.8,385.5398,973.8,390.3398,961.8,395.1398,966.6,390.3398" style="stroke:#0000FF;stroke-width:1.2;"/><line style="stroke:#0000FF;stroke-width:1.2;" x1="748.2" x2="969" y1="390.3398" y2="390.3398"/><text fill="#0000FF" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="64.8" x="756.6" y="347.9039">Card #1</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="198" x="756.6" y="366.2766">transmit selection request</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="111.6" x="795" y="384.6492">- card selector</text><polygon fill="#181818" points="1404.6,420.7125,1416.6,425.5125,1404.6,430.3125,1409.4,425.5125" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="988.2" x2="1411.8" y1="425.5125" y2="425.5125"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="138" x="996.6" y="419.8219">open card channel</text><polygon fill="#181818" points="1001.4,437.5125,989.4,442.3125,1001.4,447.1125,996.6,442.3125" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="994.2" x2="1417.8" y1="442.3125" y2="442.3125"/><polygon fill="#181818" points="1404.6,472.6852,1416.6,477.4852,1404.6,482.2852,1409.4,477.4852" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="988.2" x2="1411.8" y1="477.4852" y2="477.4852"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="170.4" x="996.6" y="471.7945">select application (aid)</text><polygon fill="#181818" points="1001.4,507.8578,989.4,512.6578,1001.4,517.4578,996.6,512.6578" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="994.2" x2="1417.8" y1="512.6578" y2="512.6578"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="70.8" x="1008.6" y="506.9672">[card FCI]</text><line style="stroke:#181818;stroke-width:1.2;" x1="988.2" x2="1038.6" y1="547.8305" y2="547.8305"/><line style="stroke:#181818;stroke-width:1.2;" x1="1038.6" x2="1038.6" y1="547.8305" y2="563.4305"/><line style="stroke:#181818;stroke-width:1.2;" x1="989.4" x2="1038.6" y1="563.4305" y2="563.4305"/><polygon fill="#181818" points="1001.4,558.6305,989.4,563.4305,1001.4,568.2305,996.6,563.4305" style="stroke:#181818;stroke-width:1.2;"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="198" x="996.6" y="542.1398">checks invalidation status</text><polygon fill="#0000FF" points="761.4,593.8031,749.4,598.6031,761.4,603.4031,756.6,598.6031" style="stroke:#0000FF;stroke-width:1.2;"/><line style="stroke:#0000FF;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="754.2" x2="981" y1="598.6031" y2="598.6031"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="199.2" x="768.6" y="592.9125">receive selection response</text><polygon fill="#181818" points="120.6,628.9758,108.6,633.7758,120.6,638.5758,115.8,633.7758" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="113.4" x2="741" y1="633.7758" y2="633.7758"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="244.8" x="127.8" y="628.0852">selected active SmartCard image</text><polygon fill="#181818" points="412.2,664.1484,424.2,668.9484,412.2,673.7484,417,668.9484" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="107.4" x2="419.4" y1="668.9484" y2="668.9484"/><text fill="#000000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="32.4" x="115.8" y="663.2578">cast</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="97.2" x="153" y="663.2578">Calypso card</text><polygon fill="#181818" points="120.6,736.0664,108.6,740.8664,120.6,745.6664,115.8,740.8664" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="113.4" x2="431.4" y1="740.8664" y2="740.8664"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="157.2" x="127.8" y="698.4305">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="152.4" x="166.2" y="716.8031">- identification data</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="159.6" x="166.2" y="735.1758">- invalidation status]</text><rect fill="#EEEEEE" height="3.6" style="stroke:#EEEEEE;stroke-width:1.2;" width="1902" x="0" y="775.2527"/><line style="stroke:#000000;stroke-width:1.2;" x1="0" x2="1902" y1="775.2527" y2="775.2527"/><line style="stroke:#000000;stroke-width:1.2;" x1="0" x2="1902" y1="778.8527" y2="778.8527"/><rect fill="#EEEEEE" height="27.9727" style="stroke:#000000;stroke-width:2.4;" width="214.8" x="843.6" y="762.4664"/><text fill="#000000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="193.2" x="850.8" y="782.3484">Card secure transaction</text><line style="stroke:#181818;stroke-width:1.2;" x1="107.4" x2="157.8" y1="864.757" y2="864.757"/><line style="stroke:#181818;stroke-width:1.2;" x1="157.8" x2="157.8" y1="864.757" y2="880.357"/><line style="stroke:#181818;stroke-width:1.2;" x1="108.6" x2="157.8" y1="880.357" y2="880.357"/><polygon fill="#181818" points="120.6,875.557,108.6,880.357,120.6,885.157,115.8,880.357" style="stroke:#181818;stroke-width:1.2;"/><text fill="#000000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="86.4" x="115.8" y="822.3211">instantiate</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="192" x="207" y="822.3211">Calypso card transaction:</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="181.2" x="154.2" y="840.6938">- Calypso card resource</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="181.2" x="154.2" y="859.0664">- Calypso SAM resource</text><polygon fill="#181818" points="412.2,929.1023,424.2,933.9023,412.2,938.7023,417,933.9023" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="107.4" x2="419.4" y1="933.9023" y2="933.9023"/><text fill="#FF0000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="64.8" x="115.8" y="909.8391">prepare</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="127.2" x="185.4" y="909.8391">card transaction:</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="175.2" x="154.2" y="928.2117">- read environment file</text><polygon fill="#181818" points="120.6,945.9023,108.6,950.7023,120.6,955.5023,115.8,950.7023" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="113.4" x2="431.4" y1="950.7023" y2="950.7023"/><polygon fill="#181818" points="412.2,981.075,424.2,985.875,412.2,990.675,417,985.875" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="107.4" x2="419.4" y1="985.875" y2="985.875"/><text fill="#FF0000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="62.4" x="115.8" y="980.1844">process</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="213.6" x="183" y="980.1844">opening (DEBIT access level)</text><polygon fill="#00FF00" points="1507.2,1052.993,1519.2,1057.793,1507.2,1062.593,1512,1057.793" style="stroke:#00FF00;stroke-width:1.2;"/><line style="stroke:#00FF00;stroke-width:1.2;" x1="438.6" x2="1514.4" y1="1057.793" y2="1057.793"/><text fill="#008000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="61.2" x="447" y="1015.357">SAM #1</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="162" x="447" y="1033.7297">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="85.2" x="485.4" y="1052.1023">- APDU list</text><polygon fill="#181818" points="1820.4,1088.1656,1832.4,1092.9656,1820.4,1097.7656,1825.2,1092.9656" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="1533.6" x2="1827.6" y1="1092.9656" y2="1092.9656"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="217.2" x="1542" y="1087.275">select diversifier (card serial)</text><polygon fill="#181818" points="1546.8,1104.9656,1534.8,1109.7656,1546.8,1114.5656,1542,1109.7656" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="1539.6" x2="1833.6" y1="1109.7656" y2="1109.7656"/><polygon fill="#181818" points="1820.4,1140.1383,1832.4,1144.9383,1820.4,1149.7383,1825.2,1144.9383" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="1533.6" x2="1827.6" y1="1144.9383" y2="1144.9383"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="100.8" x="1542" y="1139.2477">get challenge</text><polygon fill="#181818" points="1546.8,1175.3109,1534.8,1180.1109,1546.8,1184.9109,1542,1180.1109" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="1539.6" x2="1833.6" y1="1180.1109" y2="1180.1109"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="118.8" x="1554" y="1174.4203">[SAM challenge]</text><polygon fill="#00FF00" points="451.8,1210.4836,439.8,1215.2836,451.8,1220.0836,447,1215.2836" style="stroke:#00FF00;stroke-width:1.2;"/><line style="stroke:#00FF00;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="444.6" x2="1526.4" y1="1215.2836" y2="1215.2836"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="118.8" x="459" y="1209.593">[SAM challenge]</text><polygon fill="#0000FF" points="961.8,1282.4016,973.8,1287.2016,961.8,1292.0016,966.6,1287.2016" style="stroke:#0000FF;stroke-width:1.2;"/><line style="stroke:#0000FF;stroke-width:1.2;" x1="438.6" x2="969" y1="1287.2016" y2="1287.2016"/><text fill="#0000FF" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="64.8" x="447" y="1244.7656">Card #2</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="162" x="447" y="1263.1383">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="85.2" x="485.4" y="1281.5109">- APDU list</text><path d="M709.2,1305.2016 L1064.4,1305.2016 L1064.4,1313.9742 L1052.4,1325.9742 L709.2,1325.9742 L709.2,1305.2016 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.7999999999999998;"/><rect fill="none" height="170.2359" style="stroke:#000000;stroke-width:1.7999999999999998;" width="757.2" x="709.2" y="1305.2016"/><text fill="#000000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="301.2" x="727.2" y="1321.4836">Card APDU commands inside session</text><path d="M721.2,1331.9742 L721.2,1361.9742 L1242,1361.9742 L1242,1343.9742 L1230,1331.9742 L721.2,1331.9742 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.6;"/><path d="M1230,1331.9742 L1230,1343.9742 L1242,1343.9742 L1230,1331.9742 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.6;"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="495.6" x="728.4" y="1353.0562">Optimization: environment file read through the session opening.</text><polygon fill="#181818" points="1404.6,1425.8648,1416.6,1430.6648,1404.6,1435.4648,1409.4,1430.6648" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="988.2" x2="1411.8" y1="1430.6648" y2="1430.6648"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="274.8" x="996.6" y="1388.2289">open secure session (card debit key,</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="114" x="1035" y="1406.6016">SAM challenge,</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="183.6" x="1035" y="1424.9742">SFI environment to read)</text><polygon fill="#181818" points="1001.4,1461.0375,989.4,1465.8375,1001.4,1470.6375,996.6,1465.8375" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="994.2" x2="1417.8" y1="1465.8375" y2="1465.8375"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="271.2" x="1008.6" y="1460.1469">[card challenge &amp; environment data]</text><polygon fill="#0000FF" points="451.8,1504.6102,439.8,1509.4102,451.8,1514.2102,447,1509.4102" style="stroke:#0000FF;stroke-width:1.2;"/><line style="stroke:#0000FF;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="444.6" x2="981" y1="1509.4102" y2="1509.4102"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="118.8" x="459" y="1503.7195">[card challenge]</text><line style="stroke:#181818;stroke-width:1.2;" x1="438.6" x2="489" y1="1544.5828" y2="1544.5828"/><line style="stroke:#181818;stroke-width:1.2;" x1="489" x2="489" y1="1544.5828" y2="1560.1828"/><line style="stroke:#181818;stroke-width:1.2;" x1="439.8" x2="489" y1="1560.1828" y2="1560.1828"/><polygon fill="#181818" points="451.8,1555.3828,439.8,1560.1828,451.8,1564.9828,447,1560.1828" style="stroke:#181818;stroke-width:1.2;"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="192" x="447" y="1538.8922">checks ratification status</text><polygon fill="#181818" points="120.6,1664.0461,108.6,1668.8461,120.6,1673.6461,115.8,1668.8461" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="113.4" x2="431.4" y1="1668.8461" y2="1668.8461"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="157.2" x="127.8" y="1589.6648">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="152.4" x="166.2" y="1608.0375">- identification data</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="154.8" x="166.2" y="1626.4102">- invalidation status</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="146.4" x="166.2" y="1644.7828">- environment data</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="153.6" x="166.2" y="1663.1555">- ratification status]</text><polygon fill="#181818" points="412.2,1717.5914,424.2,1722.3914,412.2,1727.1914,417,1722.3914" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="107.4" x2="419.4" y1="1722.3914" y2="1722.3914"/><text fill="#FF0000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="64.8" x="115.8" y="1698.3281">prepare</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="127.2" x="185.4" y="1698.3281">card transaction:</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="124.8" x="154.2" y="1716.7008">- read last event</text><polygon fill="#181818" points="120.6,1734.3914,108.6,1739.1914,120.6,1743.9914,115.8,1739.1914" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="113.4" x2="431.4" y1="1739.1914" y2="1739.1914"/><polygon fill="#181818" points="412.2,1769.5641,424.2,1774.3641,412.2,1779.1641,417,1774.3641" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="107.4" x2="419.4" y1="1774.3641" y2="1774.3641"/><text fill="#FF0000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="62.4" x="115.8" y="1768.6734">process</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="82.8" x="183" y="1768.6734">commands</text><polygon fill="#0000FF" points="961.8,1841.482,973.8,1846.282,961.8,1851.082,966.6,1846.282" style="stroke:#0000FF;stroke-width:1.2;"/><line style="stroke:#0000FF;stroke-width:1.2;" x1="438.6" x2="969" y1="1846.282" y2="1846.282"/><text fill="#0000FF" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="64.8" x="447" y="1803.8461">Card #3</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="162" x="447" y="1822.2188">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="85.2" x="485.4" y="1840.5914">- APDU list</text><path d="M907.2,1864.282 L1262.4,1864.282 L1262.4,1873.0547 L1250.4,1885.0547 L907.2,1885.0547 L907.2,1864.282 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.7999999999999998;"/><rect fill="none" height="91.118" style="stroke:#000000;stroke-width:1.7999999999999998;" width="559.2" x="907.2" y="1864.282"/><text fill="#000000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="301.2" x="925.2" y="1880.5641">Card APDU commands inside session</text><polygon fill="#181818" points="1404.6,1905.8273,1416.6,1910.6273,1404.6,1915.4273,1409.4,1910.6273" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="988.2" x2="1411.8" y1="1910.6273" y2="1910.6273"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="172.8" x="996.6" y="1904.9367">read record (last event)</text><polygon fill="#181818" points="1001.4,1941,989.4,1945.8,1001.4,1950.6,996.6,1945.8" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="994.2" x2="1417.8" y1="1945.8" y2="1945.8"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="120" x="1008.6" y="1940.1094">[last event data]</text><polygon fill="#0000FF" points="451.8,1984.5727,439.8,1989.3727,451.8,1994.1727,447,1989.3727" style="stroke:#0000FF;stroke-width:1.2;"/><line style="stroke:#0000FF;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="444.6" x2="981" y1="1989.3727" y2="1989.3727"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="120" x="459" y="1983.682">[last event data]</text><polygon fill="#181818" points="120.6,2111.6086,108.6,2116.4086,120.6,2121.2086,115.8,2116.4086" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="113.4" x2="431.4" y1="2116.4086" y2="2116.4086"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="157.2" x="127.8" y="2018.8547">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="152.4" x="166.2" y="2037.2273">- identification data</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="154.8" x="166.2" y="2055.6">- invalidation status</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="146.4" x="166.2" y="2073.9727">- environment data</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="148.8" x="166.2" y="2092.3453">- ratification status</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="129.6" x="166.2" y="2110.718">- last event data]</text><line style="stroke:#181818;stroke-width:1.2;" x1="107.4" x2="157.8" y1="2151.5812" y2="2151.5812"/><line style="stroke:#181818;stroke-width:1.2;" x1="157.8" x2="157.8" y1="2151.5812" y2="2167.1813"/><line style="stroke:#181818;stroke-width:1.2;" x1="108.6" x2="157.8" y1="2167.1813" y2="2167.1813"/><polygon fill="#181818" points="120.6,2162.3813,108.6,2167.1813,120.6,2171.9813,115.8,2167.1813" style="stroke:#181818;stroke-width:1.2;"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="262.8" x="115.8" y="2145.8906">checks transaction recovery status</text><polygon fill="#181818" points="412.2,2215.9266,424.2,2220.7266,412.2,2225.5266,417,2220.7266" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="107.4" x2="419.4" y1="2220.7266" y2="2220.7266"/><text fill="#FF0000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="64.8" x="115.8" y="2196.6633">prepare</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="127.2" x="185.4" y="2196.6633">card transaction:</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="142.8" x="154.2" y="2215.0359">- read contract list</text><polygon fill="#181818" points="120.6,2232.7266,108.6,2237.5266,120.6,2242.3266,115.8,2237.5266" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="113.4" x2="431.4" y1="2237.5266" y2="2237.5266"/><polygon fill="#181818" points="412.2,2267.8992,424.2,2272.6992,412.2,2277.4992,417,2272.6992" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="107.4" x2="419.4" y1="2272.6992" y2="2272.6992"/><text fill="#FF0000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="62.4" x="115.8" y="2267.0086">process</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="82.8" x="183" y="2267.0086">commands</text><polygon fill="#0000FF" points="961.8,2339.8172,973.8,2344.6172,961.8,2349.4172,966.6,2344.6172" style="stroke:#0000FF;stroke-width:1.2;"/><line style="stroke:#0000FF;stroke-width:1.2;" x1="438.6" x2="969" y1="2344.6172" y2="2344.6172"/><text fill="#0000FF" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="64.8" x="447" y="2302.1813">Card #4</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="162" x="447" y="2320.5539">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="85.2" x="485.4" y="2338.9266">- APDU list</text><path d="M907.2,2362.6172 L1262.4,2362.6172 L1262.4,2371.3898 L1250.4,2383.3898 L907.2,2383.3898 L907.2,2362.6172 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.7999999999999998;"/><rect fill="none" height="91.118" style="stroke:#000000;stroke-width:1.7999999999999998;" width="559.2" x="907.2" y="2362.6172"/><text fill="#000000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="301.2" x="925.2" y="2378.8992">Card APDU commands inside session</text><polygon fill="#181818" points="1404.6,2404.1625,1416.6,2408.9625,1404.6,2413.7625,1409.4,2408.9625" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="988.2" x2="1411.8" y1="2408.9625" y2="2408.9625"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="190.8" x="996.6" y="2403.2719">read record (contract list)</text><polygon fill="#181818" points="1001.4,2439.3352,989.4,2444.1352,1001.4,2448.9352,996.6,2444.1352" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="994.2" x2="1417.8" y1="2444.1352" y2="2444.1352"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="138" x="1008.6" y="2438.4445">[contract list data]</text><polygon fill="#0000FF" points="451.8,2482.9078,439.8,2487.7078,451.8,2492.5078,447,2487.7078" style="stroke:#0000FF;stroke-width:1.2;"/><line style="stroke:#0000FF;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="444.6" x2="981" y1="2487.7078" y2="2487.7078"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="138" x="459" y="2482.0172">[contract list data]</text><polygon fill="#181818" points="120.6,2628.3164,108.6,2633.1164,120.6,2637.9164,115.8,2633.1164" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="113.4" x2="431.4" y1="2633.1164" y2="2633.1164"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="157.2" x="127.8" y="2517.1898">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="152.4" x="166.2" y="2535.5625">- identification data</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="154.8" x="166.2" y="2553.9352">- invalidation status</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="146.4" x="166.2" y="2572.3078">- environment data</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="148.8" x="166.2" y="2590.6805">- ratification status</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="124.8" x="166.2" y="2609.0531">- last event data</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="147.6" x="166.2" y="2627.4258">- contract list data]</text><line style="stroke:#181818;stroke-width:1.2;" x1="107.4" x2="157.8" y1="2668.2891" y2="2668.2891"/><line style="stroke:#181818;stroke-width:1.2;" x1="157.8" x2="157.8" y1="2668.2891" y2="2683.8891"/><line style="stroke:#181818;stroke-width:1.2;" x1="108.6" x2="157.8" y1="2683.8891" y2="2683.8891"/><polygon fill="#181818" points="120.6,2679.0891,108.6,2683.8891,120.6,2688.6891,115.8,2683.8891" style="stroke:#181818;stroke-width:1.2;"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="138" x="115.8" y="2662.5984">identifies contract</text><polygon fill="#181818" points="412.2,2732.6344,424.2,2737.4344,412.2,2742.2344,417,2737.4344" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="107.4" x2="419.4" y1="2737.4344" y2="2737.4344"/><text fill="#FF0000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="64.8" x="115.8" y="2713.3711">prepare</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="127.2" x="185.4" y="2713.3711">card transaction:</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="138" x="154.2" y="2731.7438">- read contract #x</text><polygon fill="#181818" points="120.6,2749.4344,108.6,2754.2344,120.6,2759.0344,115.8,2754.2344" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="113.4" x2="431.4" y1="2754.2344" y2="2754.2344"/><polygon fill="#181818" points="412.2,2784.607,424.2,2789.407,412.2,2794.207,417,2789.407" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="107.4" x2="419.4" y1="2789.407" y2="2789.407"/><text fill="#FF0000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="62.4" x="115.8" y="2783.7164">process</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="82.8" x="183" y="2783.7164">commands</text><polygon fill="#0000FF" points="961.8,2856.525,973.8,2861.325,961.8,2866.125,966.6,2861.325" style="stroke:#0000FF;stroke-width:1.2;"/><line style="stroke:#0000FF;stroke-width:1.2;" x1="438.6" x2="969" y1="2861.325" y2="2861.325"/><text fill="#0000FF" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="64.8" x="447" y="2818.8891">Card #5</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="162" x="447" y="2837.2617">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="85.2" x="485.4" y="2855.6344">- APDU list</text><path d="M907.2,2879.325 L1262.4,2879.325 L1262.4,2888.0977 L1250.4,2900.0977 L907.2,2900.0977 L907.2,2879.325 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.7999999999999998;"/><rect fill="none" height="91.118" style="stroke:#000000;stroke-width:1.7999999999999998;" width="559.2" x="907.2" y="2879.325"/><text fill="#000000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="301.2" x="925.2" y="2895.607">Card APDU commands inside session</text><polygon fill="#181818" points="1404.6,2920.8703,1416.6,2925.6703,1404.6,2930.4703,1409.4,2925.6703" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="988.2" x2="1411.8" y1="2925.6703" y2="2925.6703"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="186" x="996.6" y="2919.9797">read record (contract #x)</text><polygon fill="#181818" points="1001.4,2956.043,989.4,2960.843,1001.4,2965.643,996.6,2960.843" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="994.2" x2="1417.8" y1="2960.843" y2="2960.843"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="133.2" x="1008.6" y="2955.1523">[contract #x data]</text><polygon fill="#0000FF" points="451.8,2999.6156,439.8,3004.4156,451.8,3009.2156,447,3004.4156" style="stroke:#0000FF;stroke-width:1.2;"/><line style="stroke:#0000FF;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="444.6" x2="981" y1="3004.4156" y2="3004.4156"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="133.2" x="459" y="2998.725">[contract #x data]</text><polygon fill="#181818" points="120.6,3163.3969,108.6,3168.1969,120.6,3172.9969,115.8,3168.1969" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="113.4" x2="431.4" y1="3168.1969" y2="3168.1969"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="157.2" x="127.8" y="3033.8977">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="152.4" x="166.2" y="3052.2703">- identification data</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="154.8" x="166.2" y="3070.643">- invalidation status</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="146.4" x="166.2" y="3089.0156">- environment data</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="148.8" x="166.2" y="3107.3883">- ratification status</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="124.8" x="166.2" y="3125.7609">- last event data</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="142.8" x="166.2" y="3144.1336">- contract list data</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="142.8" x="166.2" y="3162.5063">- contract #x data]</text><line style="stroke:#181818;stroke-width:1.2;" x1="107.4" x2="157.8" y1="3203.3695" y2="3203.3695"/><line style="stroke:#181818;stroke-width:1.2;" x1="157.8" x2="157.8" y1="3203.3695" y2="3218.9695"/><line style="stroke:#181818;stroke-width:1.2;" x1="108.6" x2="157.8" y1="3218.9695" y2="3218.9695"/><polygon fill="#181818" points="120.6,3214.1695,108.6,3218.9695,120.6,3223.7695,115.8,3218.9695" style="stroke:#181818;stroke-width:1.2;"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="218.4" x="115.8" y="3197.6789">identifies associated counter</text><polygon fill="#181818" points="412.2,3267.7148,424.2,3272.5148,412.2,3277.3148,417,3272.5148" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="107.4" x2="419.4" y1="3272.5148" y2="3272.5148"/><text fill="#FF0000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="64.8" x="115.8" y="3248.4516">prepare</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="127.2" x="185.4" y="3248.4516">card transaction:</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="147.6" x="154.2" y="3266.8242">- reader counter #x</text><polygon fill="#181818" points="120.6,3284.5148,108.6,3289.3148,120.6,3294.1148,115.8,3289.3148" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="113.4" x2="431.4" y1="3289.3148" y2="3289.3148"/><polygon fill="#181818" points="412.2,3319.6875,424.2,3324.4875,412.2,3329.2875,417,3324.4875" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="107.4" x2="419.4" y1="3324.4875" y2="3324.4875"/><text fill="#FF0000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="62.4" x="115.8" y="3318.7969">process</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="82.8" x="183" y="3318.7969">commands</text><polygon fill="#0000FF" points="961.8,3391.6055,973.8,3396.4055,961.8,3401.2055,966.6,3396.4055" style="stroke:#0000FF;stroke-width:1.2;"/><line style="stroke:#0000FF;stroke-width:1.2;" x1="438.6" x2="969" y1="3396.4055" y2="3396.4055"/><text fill="#0000FF" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="64.8" x="447" y="3353.9695">Card #6</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="162" x="447" y="3372.3422">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="85.2" x="485.4" y="3390.7148">- APDU list</text><path d="M907.2,3414.4055 L1262.4,3414.4055 L1262.4,3423.1781 L1250.4,3435.1781 L907.2,3435.1781 L907.2,3414.4055 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.7999999999999998;"/><rect fill="none" height="91.118" style="stroke:#000000;stroke-width:1.7999999999999998;" width="559.2" x="907.2" y="3414.4055"/><text fill="#000000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="301.2" x="925.2" y="3430.6875">Card APDU commands inside session</text><polygon fill="#181818" points="1404.6,3455.9508,1416.6,3460.7508,1404.6,3465.5508,1409.4,3460.7508" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="988.2" x2="1411.8" y1="3460.7508" y2="3460.7508"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="181.2" x="996.6" y="3455.0602">read record (counter #x)</text><polygon fill="#181818" points="1001.4,3491.1234,989.4,3495.9234,1001.4,3500.7234,996.6,3495.9234" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="994.2" x2="1417.8" y1="3495.9234" y2="3495.9234"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="128.4" x="1008.6" y="3490.2328">[counter #1 data]</text><polygon fill="#0000FF" points="451.8,3534.6961,439.8,3539.4961,451.8,3544.2961,447,3539.4961" style="stroke:#0000FF;stroke-width:1.2;"/><line style="stroke:#0000FF;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="444.6" x2="981" y1="3539.4961" y2="3539.4961"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="118.8" x="459" y="3533.8055">[card challenge]</text><polygon fill="#181818" points="120.6,3716.85,108.6,3721.65,120.6,3726.45,115.8,3721.65" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="113.4" x2="431.4" y1="3721.65" y2="3721.65"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="157.2" x="127.8" y="3568.9781">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="152.4" x="166.2" y="3587.3508">- identification data</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="154.8" x="166.2" y="3605.7234">- invalidation status</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="146.4" x="166.2" y="3624.0961">- environment data</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="148.8" x="166.2" y="3642.4688">- ratification status</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="124.8" x="166.2" y="3660.8414">- last event data</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="142.8" x="166.2" y="3679.2141">- contract list data</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="138" x="166.2" y="3697.5867">- contract #x data</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="138" x="166.2" y="3715.9594">- counter #x data]</text><line style="stroke:#181818;stroke-width:1.2;" x1="107.4" x2="157.8" y1="3756.8227" y2="3756.8227"/><line style="stroke:#181818;stroke-width:1.2;" x1="157.8" x2="157.8" y1="3756.8227" y2="3772.4227"/><line style="stroke:#181818;stroke-width:1.2;" x1="108.6" x2="157.8" y1="3772.4227" y2="3772.4227"/><polygon fill="#181818" points="120.6,3767.6227,108.6,3772.4227,120.6,3777.2227,115.8,3772.4227" style="stroke:#181818;stroke-width:1.2;"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="169.2" x="115.8" y="3751.132">defines data to update</text><polygon fill="#181818" points="412.2,3857.9133,424.2,3862.7133,412.2,3867.5133,417,3862.7133" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="107.4" x2="419.4" y1="3862.7133" y2="3862.7133"/><text fill="#FF0000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="64.8" x="115.8" y="3801.9047">prepare</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="4.8" x="180.6" y="3801.9047">:</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="255.6" x="154.2" y="3820.2773">- decrease counter #x (new value)</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="258" x="154.2" y="3838.65">- append event record (new event)</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="130.8" x="154.2" y="3857.0227">- release channel</text><polygon fill="#181818" points="120.6,3874.7133,108.6,3879.5133,120.6,3884.3133,115.8,3879.5133" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="113.4" x2="431.4" y1="3879.5133" y2="3879.5133"/><polygon fill="#181818" points="412.2,3909.8859,424.2,3914.6859,412.2,3919.4859,417,3914.6859" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="107.4" x2="419.4" y1="3914.6859" y2="3914.6859"/><text fill="#FF0000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="62.4" x="115.8" y="3908.9953">process</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="153.6" x="183" y="3908.9953">closing (not ratified)</text><line style="stroke:#181818;stroke-width:1.2;" x1="438.6" x2="489" y1="3949.8586" y2="3949.8586"/><line style="stroke:#181818;stroke-width:1.2;" x1="489" x2="489" y1="3949.8586" y2="3965.4586"/><line style="stroke:#181818;stroke-width:1.2;" x1="439.8" x2="489" y1="3965.4586" y2="3965.4586"/><polygon fill="#181818" points="451.8,3960.6586,439.8,3965.4586,451.8,3970.2586,447,3965.4586" style="stroke:#181818;stroke-width:1.2;"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="280.8" x="447" y="3944.168">anticipates the future card responses</text><path d="M6,3981.0586 L6,4029.0586 L860.4,4029.0586 L860.4,3993.0586 L848.4,3981.0586 L6,3981.0586 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.6;"/><path d="M848.4,3981.0586 L848.4,3993.0586 L860.4,3993.0586 L848.4,3981.0586 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.6;"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="318" x="13.2" y="4002.1406">If the current value of the counter #x were</text><text fill="#000000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="75.6" x="336" y="4002.1406">unknown</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="382.8" x="411.6" y="4002.1406">, then the transmission of an additional card APDU</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="829.2" x="13.2" y="4020.5133">message would be necessary to operate the decrease counter in a different message than the session closing.</text><polygon fill="#00FF00" points="1507.2,4093.3219,1519.2,4098.1219,1507.2,4102.9219,1512,4098.1219" style="stroke:#00FF00;stroke-width:1.2;"/><line style="stroke:#00FF00;stroke-width:1.2;" x1="438.6" x2="1514.4" y1="4098.1219" y2="4098.1219"/><text fill="#008000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="61.2" x="447" y="4055.6859">SAM #2</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="162" x="447" y="4074.0586">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="85.2" x="485.4" y="4092.4312">- APDU list</text><polygon fill="#181818" points="1820.4,4128.4945,1832.4,4133.2945,1820.4,4138.0945,1825.2,4133.2945" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="1533.6" x2="1827.6" y1="4133.2945" y2="4133.2945"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="189.6" x="1542" y="4127.6039">digest init (opening data)</text><polygon fill="#181818" points="1546.8,4145.2945,1534.8,4150.0945,1546.8,4154.8945,1542,4150.0945" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="1539.6" x2="1833.6" y1="4150.0945" y2="4150.0945"/><polygon fill="#181818" points="1820.4,4180.4672,1832.4,4185.2672,1820.4,4190.0672,1825.2,4185.2672" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="1533.6" x2="1827.6" y1="4185.2672" y2="4185.2672"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="249.6" x="1542" y="4179.5766">digest update (read environment)</text><polygon fill="#181818" points="1546.8,4197.2672,1534.8,4202.0672,1546.8,4206.8672,1542,4202.0672" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="1539.6" x2="1833.6" y1="4202.0672" y2="4202.0672"/><polygon fill="#181818" points="1820.4,4232.4398,1832.4,4237.2398,1820.4,4242.0398,1825.2,4237.2398" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="1533.6" x2="1827.6" y1="4237.2398" y2="4237.2398"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="190.8" x="1542" y="4231.5492">digest update (last event)</text><polygon fill="#181818" points="1546.8,4249.2398,1534.8,4254.0398,1546.8,4258.8398,1542,4254.0398" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="1539.6" x2="1833.6" y1="4254.0398" y2="4254.0398"/><polygon fill="#181818" points="1820.4,4284.4125,1832.4,4289.2125,1820.4,4294.0125,1825.2,4289.2125" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="1533.6" x2="1827.6" y1="4289.2125" y2="4289.2125"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="246" x="1542" y="4283.5219">digest update (read contract list)</text><polygon fill="#181818" points="1546.8,4301.2125,1534.8,4306.0125,1546.8,4310.8125,1542,4306.0125" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="1539.6" x2="1833.6" y1="4306.0125" y2="4306.0125"/><polygon fill="#181818" points="1820.4,4336.3852,1832.4,4341.1852,1820.4,4345.9852,1825.2,4341.1852" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="1533.6" x2="1827.6" y1="4341.1852" y2="4341.1852"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="241.2" x="1542" y="4335.4945">digest update (read contract #x)</text><polygon fill="#181818" points="1546.8,4353.1852,1534.8,4357.9852,1546.8,4362.7852,1542,4357.9852" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="1539.6" x2="1833.6" y1="4357.9852" y2="4357.9852"/><polygon fill="#181818" points="1820.4,4388.3578,1832.4,4393.1578,1820.4,4397.9578,1825.2,4393.1578" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="1533.6" x2="1827.6" y1="4393.1578" y2="4393.1578"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="220.8" x="1542" y="4387.4672">digest update (read counters)</text><polygon fill="#181818" points="1546.8,4405.1578,1534.8,4409.9578,1546.8,4414.7578,1542,4409.9578" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="1539.6" x2="1833.6" y1="4409.9578" y2="4409.9578"/><path d="M1454.4,4427.9578 L1780.8,4427.9578 L1780.8,4436.7305 L1768.8,4448.7305 L1454.4,4448.7305 L1454.4,4427.9578 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.7999999999999998;"/><rect fill="none" height="124.718" style="stroke:#000000;stroke-width:1.7999999999999998;" width="435.6" x="1454.4" y="4427.9578"/><text fill="#FF0000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="91.2" x="1472.4" y="4444.2398">anticipated</text><text fill="#000000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="176.4" x="1568.4" y="4444.2398">Card APDU responses</text><polygon fill="#181818" points="1820.4,4469.5031,1832.4,4474.3031,1820.4,4479.1031,1825.2,4474.3031" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="1533.6" x2="1827.6" y1="4474.3031" y2="4474.3031"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="246" x="1542" y="4468.6125">digest update (decrease counter)</text><polygon fill="#181818" points="1546.8,4486.3031,1534.8,4491.1031,1546.8,4495.9031,1542,4491.1031" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="1539.6" x2="1833.6" y1="4491.1031" y2="4491.1031"/><polygon fill="#181818" points="1820.4,4521.4758,1832.4,4526.2758,1820.4,4531.0758,1825.2,4526.2758" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="1533.6" x2="1827.6" y1="4526.2758" y2="4526.2758"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="271.2" x="1542" y="4520.5852">digest update (append event record)</text><polygon fill="#181818" points="1546.8,4538.2758,1534.8,4543.0758,1546.8,4547.8758,1542,4543.0758" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="1539.6" x2="1833.6" y1="4543.0758" y2="4543.0758"/><polygon fill="#181818" points="1820.4,4581.8484,1832.4,4586.6484,1820.4,4591.4484,1825.2,4586.6484" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="1533.6" x2="1827.6" y1="4586.6484" y2="4586.6484"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="91.2" x="1542" y="4580.9578">digest close</text><polygon fill="#181818" points="1546.8,4617.0211,1534.8,4621.8211,1546.8,4626.6211,1542,4621.8211" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="1539.6" x2="1833.6" y1="4621.8211" y2="4621.8211"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="122.4" x="1554" y="4616.1305">[SAM certificate]</text><polygon fill="#00FF00" points="451.8,4652.1937,439.8,4656.9938,451.8,4661.7938,447,4656.9938" style="stroke:#00FF00;stroke-width:1.2;"/><line style="stroke:#00FF00;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="444.6" x2="1526.4" y1="4656.9938" y2="4656.9938"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="122.4" x="459" y="4651.3031">[SAM certificate]</text><polygon fill="#0000FF" points="961.8,4724.1117,973.8,4728.9117,961.8,4733.7117,966.6,4728.9117" style="stroke:#0000FF;stroke-width:1.2;"/><line style="stroke:#0000FF;stroke-width:1.2;" x1="438.6" x2="969" y1="4728.9117" y2="4728.9117"/><text fill="#0000FF" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="64.8" x="447" y="4686.4758">Card #7</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="162" x="447" y="4704.8484">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="85.2" x="485.4" y="4723.2211">- APDU list</text><path d="M907.2,4746.9117 L1262.4,4746.9117 L1262.4,4755.6844 L1250.4,4767.6844 L907.2,4767.6844 L907.2,4746.9117 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.7999999999999998;"/><rect fill="none" height="143.0906" style="stroke:#000000;stroke-width:1.7999999999999998;" width="559.2" x="907.2" y="4746.9117"/><text fill="#000000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="301.2" x="925.2" y="4763.1937">Card APDU commands inside session</text><polygon fill="#181818" points="1404.6,4788.457,1416.6,4793.257,1404.6,4798.057,1409.4,4793.257" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="988.2" x2="1411.8" y1="4793.257" y2="4793.257"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="273.6" x="996.6" y="4787.5664">decrease counter (counter #1, value)</text><polygon fill="#181818" points="1001.4,4823.6297,989.4,4828.4297,1001.4,4833.2297,996.6,4828.4297" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="994.2" x2="1417.8" y1="4828.4297" y2="4828.4297"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="146.4" x="1008.6" y="4822.7391">[new counter value]</text><polygon fill="#181818" points="1404.6,4858.8023,1416.6,4863.6023,1404.6,4868.4023,1409.4,4863.6023" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="988.2" x2="1411.8" y1="4863.6023" y2="4863.6023"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="205.2" x="996.6" y="4857.9117">append record (event, data)</text><polygon fill="#181818" points="1001.4,4875.6023,989.4,4880.4023,1001.4,4885.2023,996.6,4880.4023" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="994.2" x2="1417.8" y1="4880.4023" y2="4880.4023"/><polygon fill="#181818" points="1404.6,4919.175,1416.6,4923.975,1404.6,4928.775,1409.4,4923.975" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="988.2" x2="1411.8" y1="4923.975" y2="4923.975"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="402" x="996.6" y="4918.2844">close secure session (SAM certificate, as non ratified)</text><polygon fill="#181818" points="1001.4,4954.3477,989.4,4959.1477,1001.4,4963.9477,996.6,4959.1477" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="994.2" x2="1417.8" y1="4959.1477" y2="4959.1477"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="122.4" x="1008.6" y="4953.457">[card certificate]</text><polygon fill="#181818" points="1404.6,4989.5203,1416.6,4994.3203,1404.6,4999.1203,1409.4,4994.3203" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="988.2" x2="1411.8" y1="4994.3203" y2="4994.3203"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="162" x="996.6" y="4988.6297">ratification command</text><polygon fill="#181818" points="1001.4,5006.3203,989.4,5011.1203,1001.4,5015.9203,996.6,5011.1203" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="994.2" x2="1417.8" y1="5011.1203" y2="5011.1203"/><polygon fill="#181818" points="1404.6,5041.493,1416.6,5046.293,1404.6,5051.093,1409.4,5046.293" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="988.2" x2="1411.8" y1="5046.293" y2="5046.293"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="140.4" x="996.6" y="5040.6023">close card channel</text><polygon fill="#181818" points="1001.4,5058.293,989.4,5063.093,1001.4,5067.893,996.6,5063.093" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="994.2" x2="1423.8" y1="5063.093" y2="5063.093"/><polygon fill="#0000FF" points="451.8,5093.4656,439.8,5098.2656,451.8,5103.0656,447,5098.2656" style="stroke:#0000FF;stroke-width:1.2;"/><line style="stroke:#0000FF;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="444.6" x2="981" y1="5098.2656" y2="5098.2656"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="122.4" x="459" y="5092.575">[card certificate]</text><polygon fill="#00FF00" points="1507.2,5165.3836,1519.2,5170.1836,1507.2,5174.9836,1512,5170.1836" style="stroke:#00FF00;stroke-width:1.2;"/><line style="stroke:#00FF00;stroke-width:1.2;" x1="438.6" x2="1514.4" y1="5170.1836" y2="5170.1836"/><text fill="#008000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="61.2" x="447" y="5127.7477">SAM #3</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="162" x="447" y="5146.1203">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="85.2" x="485.4" y="5164.493">- APDU list</text><polygon fill="#181818" points="1820.4,5200.5563,1832.4,5205.3563,1820.4,5210.1563,1825.2,5205.3563" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="1533.6" x2="1827.6" y1="5205.3563" y2="5205.3563"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="272.4" x="1542" y="5199.6656">digest authenticate (card certificate)</text><polygon fill="#181818" points="1546.8,5235.7289,1534.8,5240.5289,1546.8,5245.3289,1542,5240.5289" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="1539.6" x2="1833.6" y1="5240.5289" y2="5240.5289"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="170.4" x="1554" y="5234.8383">[authentication status]</text><polygon fill="#00FF00" points="451.8,5270.9016,439.8,5275.7016,451.8,5280.5016,447,5275.7016" style="stroke:#00FF00;stroke-width:1.2;"/><line style="stroke:#00FF00;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="444.6" x2="1526.4" y1="5275.7016" y2="5275.7016"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="181.2" x="459" y="5270.0109">[authentification status]</text><polygon fill="#181818" points="120.6,5471.4281,108.6,5476.2281,120.6,5481.0281,115.8,5476.2281" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="113.4" x2="431.4" y1="5476.2281" y2="5476.2281"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="157.2" x="127.8" y="5305.1836">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="152.4" x="166.2" y="5323.5563">- identification data</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="154.8" x="166.2" y="5341.9289">- invalidation status</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="146.4" x="166.2" y="5360.3016">- environment data</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="9.6" x="166.2" y="5378.6742">-</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" text-decoration="line-through" textLength="134.4" x="180.6" y="5378.6742">ratification status</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="200.4" x="166.2" y="5397.0469">- last event data (updated)</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="142.8" x="166.2" y="5415.4195">- contract list data</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="138" x="166.2" y="5433.7922">- contract #x data</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="213.6" x="166.2" y="5452.1648">- counter #x data (updated)]</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="171.6" x="127.8" y="5470.5375">authentification status</text><!--MD5=[49ee1a29952aa264198d4c31f747155a]
@startuml

'skinparam ClassBorderColor #F1C40F
skinparam ClassBorderColor #D4AC0D
skinparam stereotypeABorderColor #A9DCDF
skinparam stereotypeIBorderColor #B4A7E5
skinparam stereotypeCBorderColor #ADD1B2
skinparam stereotypeEBorderColor #EB93DF
skinparam shadowing false

skinparam StateBorderColor #D4AC0D
skinparam ActivityBorderColor #D4AC0D

' Red
skinparam ClassBackgroundColor<<red>> #FDEDEC
skinparam ClassBorderColor<<red>> #E74C3C
hide <<red>> stereotype
' Purple
skinparam ClassBackgroundColor<<purple>> #F4ECF7
skinparam ClassBorderColor<<purple>> #8E44AD
hide <<purple>> stereotype
' blue
skinparam ClassBackgroundColor<<blue>> #EBF5FB
skinparam ClassBorderColor<<blue>> #3498DB
hide <<blue>> stereotype
' Green
skinparam ClassBackgroundColor<<green>> #EAFAF1
skinparam ClassBorderColor<<green>> #2ECC71
hide <<green>> stereotype

' Orange
skinparam ClassBackgroundColor<<orange>> #FDF2E9
skinparam ClassBorderColor<<orange>> #E67E22
hide <<orange>> stereotype

' Grey
skinparam ClassBackgroundColor<<grey>> #EAECEE
skinparam ClassBorderColor<<grey>> #2C3E50
hide <<grey>> stereotype

actor "Ticketing Application" as app #gold
participant "Calypso API" as capi #pink
participant "Reader API" as rapi #pink
participant "Calypso Card\nReader" as cardReader #lightBlue
boundary "**Card**" as card #lightBlue
participant "Calypso SAM\nReader" as samReader #lightGreen
boundary "selected\n**SAM**" as sam #lightGreen

activate app #gold
activate sam #lightGreen

== Card selection & identification ==

note over capi
    Only reads data inside the session.
end note

app->capi: <font color=red>**prepare**</font> card selection scenario:\n\t- filter by specific AID\n\t- filter invalidated card status
activate capi  #pink
capi- ->app
deactivate capi

app->rapi: <font color=red>**process**</font> explicit card selection scenario
activate rapi  #pink
rapi-[#0000FF]>cardReader: <font color=blue>**Card #1**</font>\ntransmit selection request\n\t- card selector
activate cardReader #lightBlue

cardReader->card: open card channel
activate card #lightBlue
card- ->cardReader
cardReader->card: select application (aid)
card- ->cardReader: [card FCI]
cardReader->cardReader: checks invalidation status

cardReader- -[#0000FF]>rapi: receive selection response
deactivate cardReader

rapi- ->app: selected active SmartCard image
deactivate rapi

app->capi: **cast** Calypso card
activate capi  #pink
capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status]

deactivate capi

== Card secure transaction ==

app->app: **instantiate** Calypso card transaction:\n\t- Calypso card resource\n\t- Calypso SAM resource

app->capi: <font color=red>**prepare**</font> card transaction:\n\t- read environment file
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> opening (DEBIT access level)
activate capi  #pink

capi-[#00FF00]>samReader: <font color=green>**SAM #1**<font color=red>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: select diversifier (card serial)
sam- ->samReader
samReader->sam: get challenge
sam- ->samReader: [SAM challenge]
samReader-[#00FF00]->capi: [SAM challenge]
deactivate samReader

capi-[#0000FF]>cardReader: <font color=blue>**Card #2**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
note over cardReader
    Optimization: environment file read through the session opening.
end note

    cardReader->card: open secure session (card debit key,\n\tSAM challenge,\n\tSFI environment to read)
    card- ->cardReader: [card challenge & environment data]
end

cardReader- -[#0000FF]>capi: [card challenge]
deactivate cardReader
capi->capi: checks ratification status

capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status\n\t- environment data\n\t- ratification status]
deactivate capi

app->capi: <font color=red>**prepare**</font> card transaction:\n\t- read last event
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> commands
activate capi  #pink

capi-[#0000FF]>cardReader: <font color=blue>**Card #3**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: read record (last event)
    card- ->cardReader: [last event data]
end

cardReader- -[#0000FF]>capi: [last event data]
deactivate cardReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status\n\t- environment data\n\t- ratification status\n\t- last event data]
deactivate capi

app->app: checks transaction recovery status

app->capi: <font color=red>**prepare**</font> card transaction:\n\t- read contract list
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> commands
activate capi  #pink

capi-[#0000FF]>cardReader: <font color=blue>**Card #4**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: read record (contract list)
    card- ->cardReader: [contract list data]
end

cardReader- -[#0000FF]>capi: [contract list data]
deactivate cardReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status\n\t- environment data\n\t- ratification status\n\t- last event data\n\t- contract list data]
deactivate capi

app->app: identifies contract

app->capi: <font color=red>**prepare**</font> card transaction:\n\t- read contract #x
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> commands
activate capi  #pink

capi-[#0000FF]>cardReader: <font color=blue>**Card #5**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: read record (contract #x)
    card- ->cardReader: [contract #x data]
end

cardReader- -[#0000FF]>capi: [contract #x data]
deactivate cardReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status\n\t- environment data\n\t- ratification status\n\t- last event data\n\t- contract list data\n\t- contract #x data]
deactivate capi

app->app: identifies associated counter

app->capi: <font color=red>**prepare**</font> card transaction:\n\t- reader counter #x
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> commands
activate capi  #pink

capi-[#0000FF]>cardReader: <font color=blue>**Card #6**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: read record (counter #x)
    card- ->cardReader: [counter #1 data]
end

cardReader- -[#0000FF]>capi: [card challenge]
deactivate cardReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status\n\t- environment data\n\t- ratification status\n\t- last event data\n\t- contract list data\n\t- contract #x data\n\t- counter #x data]
deactivate capi

app->app: defines data to update

app->capi: <font color=red>**prepare**</font>:\n\t- decrease counter #x (new value)\n\t- append event record (new event)\n\t- release channel
activate capi  #pink

capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> closing (not ratified)
activate capi  #pink
capi->capi: anticipates the future card responses
note over capi
    If the current value of the counter #x were **unknown**, then the transmission of an additional card APDU
    message would be necessary to operate the decrease counter in a different message than the session closing.
end note

capi-[#00FF00]>samReader: <font color=green>**SAM #2**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen

samReader->sam: digest init (opening data)
sam- ->samReader
samReader->sam: digest update (read environment)
sam- ->samReader
samReader->sam: digest update (last event)
sam- ->samReader
samReader->sam: digest update (read contract list)
sam- ->samReader
samReader->sam: digest update (read contract #x)
sam- ->samReader
samReader->sam: digest update (read counters)
sam- ->samReader
group <font color=red>**anticipated**</font> Card APDU responses
    samReader->sam: digest update (decrease counter)
    sam- ->samReader
    samReader->sam: digest update (append event record)
    sam- ->samReader
end
samReader->sam: digest close
sam- ->samReader: [SAM certificate]

samReader-[#00FF00]->capi: [SAM certificate]
deactivate samReader

capi-[#0000FF]>cardReader: <font color=blue>**Card #7**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: decrease counter (counter #1, value)
    card- ->cardReader: [new counter value]
    cardReader->card: append record (event, data)
    card- ->cardReader
end

cardReader->card: close secure session (SAM certificate, as non ratified)
card- ->cardReader: [card certificate]
cardReader->card: ratification command
card- ->cardReader
cardReader->card: close card channel
card- ->cardReader
deactivate card

cardReader-[#0000FF]->capi: [card certificate]
deactivate cardReader

capi-[#00FF00]>samReader: <font color=green>**SAM #3**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: digest authenticate (card certificate)
sam- ->samReader: [authentication status]

samReader-[#00FF00]->capi: [authentification status]
deactivate samReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status\n\t- environment data\n\t- - -ratification status- -\n\t- last event data (updated)\n\t- contract list data\n\t- contract #x data\n\t- counter #x data (updated)]\nauthentification status
deactivate capi
@enduml

@startuml

skinparam ClassBorderColor #D4AC0D
skinparam stereotypeABorderColor #A9DCDF
skinparam stereotypeIBorderColor #B4A7E5
skinparam stereotypeCBorderColor #ADD1B2
skinparam stereotypeEBorderColor #EB93DF
skinparam shadowing false

skinparam StateBorderColor #D4AC0D
skinparam ActivityBorderColor #D4AC0D

skinparam ClassBackgroundColor<<red>> #FDEDEC
skinparam ClassBorderColor<<red>> #E74C3C
hide <<red>> stereotype
skinparam ClassBackgroundColor<<purple>> #F4ECF7
skinparam ClassBorderColor<<purple>> #8E44AD
hide <<purple>> stereotype
skinparam ClassBackgroundColor<<blue>> #EBF5FB
skinparam ClassBorderColor<<blue>> #3498DB
hide <<blue>> stereotype
skinparam ClassBackgroundColor<<green>> #EAFAF1
skinparam ClassBorderColor<<green>> #2ECC71
hide <<green>> stereotype

skinparam ClassBackgroundColor<<orange>> #FDF2E9
skinparam ClassBorderColor<<orange>> #E67E22
hide <<orange>> stereotype

skinparam ClassBackgroundColor<<grey>> #EAECEE
skinparam ClassBorderColor<<grey>> #2C3E50
hide <<grey>> stereotype

actor "Ticketing Application" as app #gold
participant "Calypso API" as capi #pink
participant "Reader API" as rapi #pink
participant "Calypso Card\nReader" as cardReader #lightBlue
boundary "**Card**" as card #lightBlue
participant "Calypso SAM\nReader" as samReader #lightGreen
boundary "selected\n**SAM**" as sam #lightGreen

activate app #gold
activate sam #lightGreen

== Card selection & identification ==

note over capi
    Only reads data inside the session.
end note

app->capi: <font color=red>**prepare**</font> card selection scenario:\n\t- filter by specific AID\n\t- filter invalidated card status
activate capi  #pink
capi- ->app
deactivate capi

app->rapi: <font color=red>**process**</font> explicit card selection scenario
activate rapi  #pink
rapi-[#0000FF]>cardReader: <font color=blue>**Card #1**</font>\ntransmit selection request\n\t- card selector
activate cardReader #lightBlue

cardReader->card: open card channel
activate card #lightBlue
card- ->cardReader
cardReader->card: select application (aid)
card- ->cardReader: [card FCI]
cardReader->cardReader: checks invalidation status

cardReader- -[#0000FF]>rapi: receive selection response
deactivate cardReader

rapi- ->app: selected active SmartCard image
deactivate rapi

app->capi: **cast** Calypso card
activate capi  #pink
capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status]

deactivate capi

== Card secure transaction ==

app->app: **instantiate** Calypso card transaction:\n\t- Calypso card resource\n\t- Calypso SAM resource

app->capi: <font color=red>**prepare**</font> card transaction:\n\t- read environment file
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> opening (DEBIT access level)
activate capi  #pink

capi-[#00FF00]>samReader: <font color=green>**SAM #1**<font color=red>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: select diversifier (card serial)
sam- ->samReader
samReader->sam: get challenge
sam- ->samReader: [SAM challenge]
samReader-[#00FF00]->capi: [SAM challenge]
deactivate samReader

capi-[#0000FF]>cardReader: <font color=blue>**Card #2**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
note over cardReader
    Optimization: environment file read through the session opening.
end note

    cardReader->card: open secure session (card debit key,\n\tSAM challenge,\n\tSFI environment to read)
    card- ->cardReader: [card challenge & environment data]
end

cardReader- -[#0000FF]>capi: [card challenge]
deactivate cardReader
capi->capi: checks ratification status

capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status\n\t- environment data\n\t- ratification status]
deactivate capi

app->capi: <font color=red>**prepare**</font> card transaction:\n\t- read last event
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> commands
activate capi  #pink

capi-[#0000FF]>cardReader: <font color=blue>**Card #3**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: read record (last event)
    card- ->cardReader: [last event data]
end

cardReader- -[#0000FF]>capi: [last event data]
deactivate cardReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status\n\t- environment data\n\t- ratification status\n\t- last event data]
deactivate capi

app->app: checks transaction recovery status

app->capi: <font color=red>**prepare**</font> card transaction:\n\t- read contract list
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> commands
activate capi  #pink

capi-[#0000FF]>cardReader: <font color=blue>**Card #4**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: read record (contract list)
    card- ->cardReader: [contract list data]
end

cardReader- -[#0000FF]>capi: [contract list data]
deactivate cardReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status\n\t- environment data\n\t- ratification status\n\t- last event data\n\t- contract list data]
deactivate capi

app->app: identifies contract

app->capi: <font color=red>**prepare**</font> card transaction:\n\t- read contract #x
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> commands
activate capi  #pink

capi-[#0000FF]>cardReader: <font color=blue>**Card #5**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: read record (contract #x)
    card- ->cardReader: [contract #x data]
end

cardReader- -[#0000FF]>capi: [contract #x data]
deactivate cardReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status\n\t- environment data\n\t- ratification status\n\t- last event data\n\t- contract list data\n\t- contract #x data]
deactivate capi

app->app: identifies associated counter

app->capi: <font color=red>**prepare**</font> card transaction:\n\t- reader counter #x
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> commands
activate capi  #pink

capi-[#0000FF]>cardReader: <font color=blue>**Card #6**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: read record (counter #x)
    card- ->cardReader: [counter #1 data]
end

cardReader- -[#0000FF]>capi: [card challenge]
deactivate cardReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status\n\t- environment data\n\t- ratification status\n\t- last event data\n\t- contract list data\n\t- contract #x data\n\t- counter #x data]
deactivate capi

app->app: defines data to update

app->capi: <font color=red>**prepare**</font>:\n\t- decrease counter #x (new value)\n\t- append event record (new event)\n\t- release channel
activate capi  #pink

capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> closing (not ratified)
activate capi  #pink
capi->capi: anticipates the future card responses
note over capi
    If the current value of the counter #x were **unknown**, then the transmission of an additional card APDU
    message would be necessary to operate the decrease counter in a different message than the session closing.
end note

capi-[#00FF00]>samReader: <font color=green>**SAM #2**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen

samReader->sam: digest init (opening data)
sam- ->samReader
samReader->sam: digest update (read environment)
sam- ->samReader
samReader->sam: digest update (last event)
sam- ->samReader
samReader->sam: digest update (read contract list)
sam- ->samReader
samReader->sam: digest update (read contract #x)
sam- ->samReader
samReader->sam: digest update (read counters)
sam- ->samReader
group <font color=red>**anticipated**</font> Card APDU responses
    samReader->sam: digest update (decrease counter)
    sam- ->samReader
    samReader->sam: digest update (append event record)
    sam- ->samReader
end
samReader->sam: digest close
sam- ->samReader: [SAM certificate]

samReader-[#00FF00]->capi: [SAM certificate]
deactivate samReader

capi-[#0000FF]>cardReader: <font color=blue>**Card #7**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: decrease counter (counter #1, value)
    card- ->cardReader: [new counter value]
    cardReader->card: append record (event, data)
    card- ->cardReader
end

cardReader->card: close secure session (SAM certificate, as non ratified)
card- ->cardReader: [card certificate]
cardReader->card: ratification command
card- ->cardReader
cardReader->card: close card channel
card- ->cardReader
deactivate card

cardReader-[#0000FF]->capi: [card certificate]
deactivate cardReader

capi-[#00FF00]>samReader: <font color=green>**SAM #3**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: digest authenticate (card certificate)
sam- ->samReader: [authentication status]

samReader-[#00FF00]->capi: [authentification status]
deactivate samReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status\n\t- environment data\n\t- - -ratification status- -\n\t- last event data (updated)\n\t- contract list data\n\t- contract #x data\n\t- counter #x data (updated)]\nauthentification status
deactivate capi
@enduml

PlantUML version 1.2022.4(Sat Apr 09 17:29:17 RET 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: fr
Country: FR
--></g></svg>