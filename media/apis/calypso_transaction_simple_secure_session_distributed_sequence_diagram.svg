<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="4099.2px" preserveAspectRatio="none" style="width:1771px;height:4099px;background:#FFFFFF;" version="1.1" viewBox="0 0 1771 4099" width="1771.2px" zoomAndPan="magnify"><defs/><g><rect fill="#FFD700" height="3881.4914" style="stroke:#181818;stroke-width:1.2;" width="12" x="90.6" y="109.7859"/><rect fill="#FFC0CB" height="16.8" style="stroke:#181818;stroke-width:1.2;" width="12" x="406.2" y="303.1945"/><rect fill="#FFC0CB" height="108.6633" style="stroke:#181818;stroke-width:1.2;" width="12" x="406.2" y="902.3297"/><rect fill="#FFC0CB" height="16.8" style="stroke:#181818;stroke-width:1.2;" width="12" x="406.2" y="1319.8922"/><rect fill="#FFC0CB" height="950.325" style="stroke:#181818;stroke-width:1.2;" width="12" x="406.2" y="1371.8648"/><rect fill="#FFC0CB" height="16.8" style="stroke:#181818;stroke-width:1.2;" width="12" x="406.2" y="2430.8531"/><rect fill="#FFC0CB" height="1497.6516" style="stroke:#181818;stroke-width:1.2;" width="12" x="406.2" y="2482.8258"/><rect fill="#FFC0CB" height="511.9898" style="stroke:#181818;stroke-width:1.2;" width="12" x="715.8" y="355.1672"/><rect fill="#ADD8E6" height="386.5266" style="stroke:#181818;stroke-width:1.2;" width="12" x="955.8" y="445.4578"/><rect fill="#ADD8E6" height="503.5898" style="stroke:#181818;stroke-width:1.2;" width="12" x="955.8" y="1673.1914"/><rect fill="#ADD8E6" height="350.9813" style="stroke:#181818;stroke-width:1.2;" width="12" x="955.8" y="3288.2789"/><rect fill="#ADD8E6" height="3123.457" style="stroke:#181818;stroke-width:1.2;" width="12" x="1279.8" y="480.6305"/><rect fill="#90EE90" height="157.4906" style="stroke:#181818;stroke-width:1.2;" width="12" x="1382.4" y="1443.7828"/><rect fill="#90EE90" height="610.8445" style="stroke:#181818;stroke-width:1.2;" width="12" x="1382.4" y="2605.5164"/><rect fill="#90EE90" height="105.518" style="stroke:#181818;stroke-width:1.2;" width="12" x="1382.4" y="3711.1781"/><rect fill="#90EE90" height="3881.4914" style="stroke:#181818;stroke-width:1.2;" width="12" x="1695.6" y="109.7859"/><rect height="161.4633" style="stroke:#000000;stroke-width:1.7999999999999998;fill:none;" width="440.4" x="886.8" y="636.5484"/><rect height="451.6172" style="stroke:#000000;stroke-width:1.7999999999999998;fill:none;" width="638.4" x="688.8" y="1691.1914"/><rect height="176.6906" style="stroke:#000000;stroke-width:1.7999999999999998;fill:none;" width="435.6" x="1315.2" y="2935.3523"/><rect height="176.6906" style="stroke:#000000;stroke-width:1.7999999999999998;fill:none;" width="440.4" x="886.8" y="3306.2789"/><line style="stroke:#181818;stroke-width:0.6;fill:none;stroke-dasharray:5.0,5.0;" x1="96" x2="96" y1="97.7859" y2="4002.0773"/><line style="stroke:#181818;stroke-width:0.6;fill:none;stroke-dasharray:5.0,5.0;" x1="412.2" x2="412.2" y1="97.7859" y2="4002.0773"/><line style="stroke:#181818;stroke-width:0.6;fill:none;stroke-dasharray:5.0,5.0;" x1="721.8" x2="721.8" y1="97.7859" y2="4002.0773"/><line style="stroke:#181818;stroke-width:0.6;fill:none;stroke-dasharray:5.0,5.0;" x1="961.2" x2="961.2" y1="97.7859" y2="4002.0773"/><line style="stroke:#181818;stroke-width:0.6;fill:none;stroke-dasharray:5.0,5.0;" x1="1285.2" x2="1285.2" y1="97.7859" y2="4002.0773"/><line style="stroke:#181818;stroke-width:0.6;fill:none;stroke-dasharray:5.0,5.0;" x1="1388.4" x2="1388.4" y1="97.7859" y2="4002.0773"/><line style="stroke:#181818;stroke-width:0.6;fill:none;stroke-dasharray:5.0,5.0;" x1="1701.6" x2="1701.6" y1="97.7859" y2="4002.0773"/><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="174" x="6" y="94.2422">Ticketing Application</text><ellipse cx="96.6" cy="16.2" fill="#FFD700" rx="9.6" ry="9.6" style="stroke:#181818;stroke-width:0.6;"/><path d="M96.6,25.8 L96.6,58.2 M81,35.4 L112.2,35.4 M96.6,58.2 L81,76.2 M96.6,58.2 L112.2,76.2 " fill="none" style="stroke:#181818;stroke-width:0.6;"/><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="174" x="6" y="4017.1195">Ticketing Application</text><ellipse cx="96.6" cy="4030.8633" fill="#FFD700" rx="9.6" ry="9.6" style="stroke:#181818;stroke-width:0.6;"/><path d="M96.6,4040.4633 L96.6,4072.8633 M81,4050.0633 L112.2,4050.0633 M96.6,4072.8633 L81,4090.8633 M96.6,4072.8633 L112.2,4090.8633 " fill="none" style="stroke:#181818;stroke-width:0.6;"/><rect fill="#FFC0CB" height="36.5859" rx="3" ry="3" style="stroke:#181818;stroke-width:0.6;" width="112.8" x="355.8" y="60"/><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="96" x="364.2" y="84.6422">Calypso API</text><rect fill="#FFC0CB" height="36.5859" rx="3" ry="3" style="stroke:#181818;stroke-width:0.6;" width="112.8" x="355.8" y="4000.8773"/><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="96" x="364.2" y="4025.5195">Calypso API</text><rect fill="#FFC0CB" height="36.5859" rx="3" ry="3" style="stroke:#181818;stroke-width:0.6;" width="105.6" x="669" y="60"/><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="88.8" x="677.4" y="84.6422">Reader API</text><rect fill="#FFC0CB" height="36.5859" rx="3" ry="3" style="stroke:#181818;stroke-width:0.6;" width="105.6" x="669" y="4000.8773"/><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="88.8" x="677.4" y="4025.5195">Reader API</text><rect fill="#ADD8E6" height="76.1578" rx="3" ry="3" style="stroke:#181818;stroke-width:0.6;" width="126" x="898.8" y="20.4281"/><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="70.8" x="926.4" y="45.0703">(remote)</text><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="109.2" x="907.2" y="64.8563">Calypso Card</text><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="57.6" x="933" y="84.6422">Reader</text><rect fill="#ADD8E6" height="76.1578" rx="3" ry="3" style="stroke:#181818;stroke-width:0.6;" width="126" x="898.8" y="4000.8773"/><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="70.8" x="926.4" y="4025.5195">(remote)</text><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="109.2" x="907.2" y="4045.3055">Calypso Card</text><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="57.6" x="933" y="4065.0914">Reader</text><text fill="#000000" font-family="sans-serif" font-size="16.8" font-weight="bold" lengthAdjust="spacing" textLength="39.6" x="1262.4" y="94.2422">Card</text><path d="M1261.2,44.4 L1261.2,73.2 M1261.2,58.8 L1281.6,58.8 " fill="none" style="stroke:#181818;stroke-width:0.6;"/><ellipse cx="1296" cy="58.8" fill="#ADD8E6" rx="14.4" ry="14.4" style="stroke:#181818;stroke-width:0.6;"/><text fill="#000000" font-family="sans-serif" font-size="16.8" font-weight="bold" lengthAdjust="spacing" textLength="39.6" x="1262.4" y="4017.1195">Card</text><path d="M1261.2,4025.4633 L1261.2,4054.2633 M1261.2,4039.8633 L1281.6,4039.8633 " fill="none" style="stroke:#181818;stroke-width:0.6;"/><ellipse cx="1296" cy="4039.8633" fill="#ADD8E6" rx="14.4" ry="14.4" style="stroke:#181818;stroke-width:0.6;"/><rect fill="#90EE90" height="76.1578" rx="3" ry="3" style="stroke:#181818;stroke-width:0.6;" width="122.4" x="1327.2" y="20.4281"/><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="70.8" x="1353" y="45.0703">(remote)</text><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="105.6" x="1335.6" y="64.8563">Calypso SAM</text><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="57.6" x="1359.6" y="84.6422">Reader</text><rect fill="#90EE90" height="76.1578" rx="3" ry="3" style="stroke:#181818;stroke-width:0.6;" width="122.4" x="1327.2" y="4000.8773"/><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="70.8" x="1353" y="4025.5195">(remote)</text><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="105.6" x="1335.6" y="4045.3055">Calypso SAM</text><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="57.6" x="1359.6" y="4065.0914">Reader</text><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="67.2" x="1664.4" y="74.4563">selected</text><text fill="#000000" font-family="sans-serif" font-size="16.8" font-weight="bold" lengthAdjust="spacing" textLength="37.2" x="1679.4" y="94.2422">SAM</text><path d="M1677,24.6141 L1677,53.4141 M1677,39.0141 L1697.4,39.0141 " fill="none" style="stroke:#181818;stroke-width:0.6;"/><ellipse cx="1711.8" cy="39.0141" fill="#90EE90" rx="14.4" ry="14.4" style="stroke:#181818;stroke-width:0.6;"/><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="67.2" x="1664.4" y="4017.1195">selected</text><text fill="#000000" font-family="sans-serif" font-size="16.8" font-weight="bold" lengthAdjust="spacing" textLength="37.2" x="1679.4" y="4036.9055">SAM</text><path d="M1677,4045.2492 L1677,4074.0492 M1677,4059.6492 L1697.4,4059.6492 " fill="none" style="stroke:#181818;stroke-width:0.6;"/><ellipse cx="1711.8" cy="4059.6492" fill="#90EE90" rx="14.4" ry="14.4" style="stroke:#181818;stroke-width:0.6;"/><rect fill="#FFD700" height="3881.4914" style="stroke:#181818;stroke-width:1.2;" width="12" x="90.6" y="109.7859"/><rect fill="#FFC0CB" height="16.8" style="stroke:#181818;stroke-width:1.2;" width="12" x="406.2" y="303.1945"/><rect fill="#FFC0CB" height="108.6633" style="stroke:#181818;stroke-width:1.2;" width="12" x="406.2" y="902.3297"/><rect fill="#FFC0CB" height="16.8" style="stroke:#181818;stroke-width:1.2;" width="12" x="406.2" y="1319.8922"/><rect fill="#FFC0CB" height="950.325" style="stroke:#181818;stroke-width:1.2;" width="12" x="406.2" y="1371.8648"/><rect fill="#FFC0CB" height="16.8" style="stroke:#181818;stroke-width:1.2;" width="12" x="406.2" y="2430.8531"/><rect fill="#FFC0CB" height="1497.6516" style="stroke:#181818;stroke-width:1.2;" width="12" x="406.2" y="2482.8258"/><rect fill="#FFC0CB" height="511.9898" style="stroke:#181818;stroke-width:1.2;" width="12" x="715.8" y="355.1672"/><rect fill="#ADD8E6" height="386.5266" style="stroke:#181818;stroke-width:1.2;" width="12" x="955.8" y="445.4578"/><rect fill="#ADD8E6" height="503.5898" style="stroke:#181818;stroke-width:1.2;" width="12" x="955.8" y="1673.1914"/><rect fill="#ADD8E6" height="350.9813" style="stroke:#181818;stroke-width:1.2;" width="12" x="955.8" y="3288.2789"/><rect fill="#ADD8E6" height="3123.457" style="stroke:#181818;stroke-width:1.2;" width="12" x="1279.8" y="480.6305"/><rect fill="#90EE90" height="157.4906" style="stroke:#181818;stroke-width:1.2;" width="12" x="1382.4" y="1443.7828"/><rect fill="#90EE90" height="610.8445" style="stroke:#181818;stroke-width:1.2;" width="12" x="1382.4" y="2605.5164"/><rect fill="#90EE90" height="105.518" style="stroke:#181818;stroke-width:1.2;" width="12" x="1382.4" y="3711.1781"/><rect fill="#90EE90" height="3881.4914" style="stroke:#181818;stroke-width:1.2;" width="12" x="1695.6" y="109.7859"/><rect fill="#EEEEEE" height="3.6" style="stroke:#EEEEEE;stroke-width:1.2;" width="1762.8" x="0" y="134.5723"/><line style="stroke:#000000;stroke-width:1.2;" x1="0" x2="1762.8" y1="134.5723" y2="134.5723"/><line style="stroke:#000000;stroke-width:1.2;" x1="0" x2="1762.8" y1="138.1723" y2="138.1723"/><rect fill="#EEEEEE" height="27.9727" style="stroke:#000000;stroke-width:2.4;" width="265.2" x="748.8" y="121.7859"/><text fill="#000000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="243.6" x="756" y="141.668">Card selection &amp; identification</text><path d="M154.8,167.7586 L154.8,197.7586 L668.4,197.7586 L668.4,179.7586 L656.4,167.7586 L154.8,167.7586 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.6;"/><path d="M656.4,167.7586 L656.4,179.7586 L668.4,179.7586 L656.4,167.7586 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.6;"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="488.4" x="162" y="188.8406">Reads the data present in all the cards targeted for the selection.</text><polygon fill="#181818" points="391.8,298.3945,403.8,303.1945,391.8,307.9945,396.6,303.1945" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="102.6" x2="399" y1="303.1945" y2="303.1945"/><text fill="#FF0000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="64.8" x="111" y="224.0133">prepare</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="178.8" x="180.6" y="224.0133">card selection scenario:</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="169.2" x="149.4" y="242.3859">- filter by specific AID</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="226.8" x="149.4" y="260.7586">- filter invalidated card status</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="175.2" x="149.4" y="279.1312">- read environment file</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="142.8" x="149.4" y="297.5039">- read contract list</text><polygon fill="#181818" points="115.8,315.1945,103.8,319.9945,115.8,324.7945,111,319.9945" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="108.6" x2="411" y1="319.9945" y2="319.9945"/><polygon fill="#181818" points="701.4,350.3672,713.4,355.1672,701.4,359.9672,706.2,355.1672" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="102.6" x2="708.6" y1="355.1672" y2="355.1672"/><text fill="#FF0000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="62.4" x="111" y="349.4766">process</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="235.2" x="178.2" y="349.4766">explicit card selection scenario</text><polygon fill="#0000FF" points="941.4,440.6578,953.4,445.4578,941.4,450.2578,946.2,445.4578" style="stroke:#0000FF;stroke-width:1.2;"/><line style="stroke:#0000FF;stroke-width:1.2;" x1="727.8" x2="948.6" y1="445.4578" y2="445.4578"/><text fill="#0000FF" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="64.8" x="736.2" y="384.6492">Card #1</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="198" x="736.2" y="403.0219">transmit selection request</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="111.6" x="774.6" y="421.3945">- card selector</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="85.2" x="774.6" y="439.7672">- APDU list</text><polygon fill="#181818" points="1265.4,475.8305,1277.4,480.6305,1265.4,485.4305,1270.2,480.6305" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="967.8" x2="1272.6" y1="480.6305" y2="480.6305"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="138" x="976.2" y="474.9398">open card channel</text><polygon fill="#181818" points="981,492.6305,969,497.4305,981,502.2305,976.2,497.4305" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="973.8" x2="1278.6" y1="497.4305" y2="497.4305"/><polygon fill="#181818" points="1265.4,527.8031,1277.4,532.6031,1265.4,537.4031,1270.2,532.6031" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="967.8" x2="1272.6" y1="532.6031" y2="532.6031"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="170.4" x="976.2" y="526.9125">select application (aid)</text><polygon fill="#181818" points="981,562.9758,969,567.7758,981,572.5758,976.2,567.7758" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="973.8" x2="1278.6" y1="567.7758" y2="567.7758"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="70.8" x="988.2" y="562.0852">[card FCI]</text><line style="stroke:#181818;stroke-width:1.2;" x1="967.8" x2="1018.2" y1="602.9484" y2="602.9484"/><line style="stroke:#181818;stroke-width:1.2;" x1="1018.2" x2="1018.2" y1="602.9484" y2="618.5484"/><line style="stroke:#181818;stroke-width:1.2;" x1="969" x2="1018.2" y1="618.5484" y2="618.5484"/><polygon fill="#181818" points="981,613.7484,969,618.5484,981,623.3484,976.2,618.5484" style="stroke:#181818;stroke-width:1.2;"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="198" x="976.2" y="597.2578">checks invalidation status</text><path d="M886.8,636.5484 L1311.6,636.5484 L1311.6,645.3211 L1299.6,657.3211 L886.8,657.3211 L886.8,636.5484 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.7999999999999998;"/><rect fill="none" height="161.4633" style="stroke:#000000;stroke-width:1.7999999999999998;" width="440.4" x="886.8" y="636.5484"/><text fill="#000000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="370.8" x="904.8" y="652.8305">Card APDU commands outside secure session</text><polygon fill="#181818" points="1265.4,678.0938,1277.4,682.8938,1265.4,687.6938,1270.2,682.8938" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="967.8" x2="1272.6" y1="682.8938" y2="682.8938"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="194.4" x="976.2" y="677.2031">read record (environment)</text><polygon fill="#181818" points="981,713.2664,969,718.0664,981,722.8664,976.2,718.0664" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="973.8" x2="1278.6" y1="718.0664" y2="718.0664"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="141.6" x="988.2" y="712.3758">[environment data]</text><polygon fill="#181818" points="1265.4,748.4391,1277.4,753.2391,1265.4,758.0391,1270.2,753.2391" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="967.8" x2="1272.6" y1="753.2391" y2="753.2391"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="190.8" x="976.2" y="747.5484">read record (contract list)</text><polygon fill="#181818" points="981,783.6117,969,788.4117,981,793.2117,976.2,788.4117" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="973.8" x2="1278.6" y1="788.4117" y2="788.4117"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="138" x="988.2" y="782.7211">[contract list data]</text><polygon fill="#0000FF" points="741,827.1844,729,831.9844,741,836.7844,736.2,831.9844" style="stroke:#0000FF;stroke-width:1.2;"/><line style="stroke:#0000FF;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="733.8" x2="960.6" y1="831.9844" y2="831.9844"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="199.2" x="748.2" y="826.2937">receive selection response</text><polygon fill="#181818" points="115.8,862.357,103.8,867.157,115.8,871.957,111,867.157" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="108.6" x2="720.6" y1="867.157" y2="867.157"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="244.8" x="123" y="861.4664">selected active SmartCard image</text><polygon fill="#181818" points="391.8,897.5297,403.8,902.3297,391.8,907.1297,396.6,902.3297" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="102.6" x2="399" y1="902.3297" y2="902.3297"/><text fill="#000000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="32.4" x="111" y="896.6391">cast</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="97.2" x="148.2" y="896.6391">Calypso card</text><polygon fill="#181818" points="115.8,1006.193,103.8,1010.993,115.8,1015.793,111,1010.993" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="108.6" x2="411" y1="1010.993" y2="1010.993"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="157.2" x="123" y="931.8117">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="152.4" x="161.4" y="950.1844">- identification data</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="154.8" x="161.4" y="968.557">- invalidation status</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="146.4" x="161.4" y="986.9297">- environment data</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="147.6" x="161.4" y="1005.3023">- contract list data]</text><rect fill="#EEEEEE" height="3.6" style="stroke:#EEEEEE;stroke-width:1.2;" width="1762.8" x="0" y="1045.3793"/><line style="stroke:#000000;stroke-width:1.2;" x1="0" x2="1762.8" y1="1045.3793" y2="1045.3793"/><line style="stroke:#000000;stroke-width:1.2;" x1="0" x2="1762.8" y1="1048.9793" y2="1048.9793"/><rect fill="#EEEEEE" height="27.9727" style="stroke:#000000;stroke-width:2.4;" width="214.8" x="774" y="1032.593"/><text fill="#000000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="193.2" x="781.2" y="1052.475">Card secure transaction</text><line style="stroke:#181818;stroke-width:1.2;" x1="102.6" x2="153" y1="1134.8836" y2="1134.8836"/><line style="stroke:#181818;stroke-width:1.2;" x1="153" x2="153" y1="1134.8836" y2="1150.4836"/><line style="stroke:#181818;stroke-width:1.2;" x1="103.8" x2="153" y1="1150.4836" y2="1150.4836"/><polygon fill="#181818" points="115.8,1145.6836,103.8,1150.4836,115.8,1155.2836,111,1150.4836" style="stroke:#181818;stroke-width:1.2;"/><text fill="#000000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="86.4" x="111" y="1092.4477">instantiate</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="192" x="202.2" y="1092.4477">Calypso card transaction:</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="181.2" x="149.4" y="1110.8203">- Calypso card resource</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="181.2" x="149.4" y="1129.193">- Calypso SAM resource</text><path d="M51.6,1166.0836 L51.6,1196.0836 L772.8,1196.0836 L772.8,1178.0836 L760.8,1166.0836 L51.6,1166.0836 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.6;"/><path d="M760.8,1166.0836 L760.8,1178.0836 L772.8,1178.0836 L760.8,1166.0836 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.6;"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="696" x="58.8" y="1187.1656">Reads again the environment file &amp; the contract list inside the session to authenticate them.</text><polygon fill="#181818" points="391.8,1315.0922,403.8,1319.8922,391.8,1324.6922,396.6,1319.8922" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="102.6" x2="399" y1="1319.8922" y2="1319.8922"/><text fill="#FF0000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="64.8" x="111" y="1222.3383">prepare</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="175.2" x="149.4" y="1240.7109">- read environment file</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="142.8" x="149.4" y="1259.0836">- read contract list</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="138" x="149.4" y="1277.4563">- read contract #x</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="136.8" x="149.4" y="1295.8289">- read contract #y</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="117.6" x="149.4" y="1314.2016">- read counters</text><polygon fill="#181818" points="115.8,1331.8922,103.8,1336.6922,115.8,1341.4922,111,1336.6922" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="108.6" x2="411" y1="1336.6922" y2="1336.6922"/><polygon fill="#181818" points="391.8,1367.0648,403.8,1371.8648,391.8,1376.6648,396.6,1371.8648" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="102.6" x2="399" y1="1371.8648" y2="1371.8648"/><text fill="#FF0000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="62.4" x="111" y="1366.1742">process</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="213.6" x="178.2" y="1366.1742">opening (DEBIT access level)</text><polygon fill="#00FF00" points="1368,1438.9828,1380,1443.7828,1368,1448.5828,1372.8,1443.7828" style="stroke:#00FF00;stroke-width:1.2;"/><line style="stroke:#00FF00;stroke-width:1.2;" x1="418.2" x2="1375.2" y1="1443.7828" y2="1443.7828"/><text fill="#008000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="61.2" x="426.6" y="1401.3469">SAM #1</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="162" x="426.6" y="1419.7195">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="85.2" x="465" y="1438.0922">- APDU list</text><polygon fill="#181818" points="1681.2,1474.1555,1693.2,1478.9555,1681.2,1483.7555,1686,1478.9555" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="1394.4" x2="1688.4" y1="1478.9555" y2="1478.9555"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="217.2" x="1402.8" y="1473.2648">select diversifier (card serial)</text><polygon fill="#181818" points="1407.6,1490.9555,1395.6,1495.7555,1407.6,1500.5555,1402.8,1495.7555" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="1400.4" x2="1694.4" y1="1495.7555" y2="1495.7555"/><polygon fill="#181818" points="1681.2,1526.1281,1693.2,1530.9281,1681.2,1535.7281,1686,1530.9281" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="1394.4" x2="1688.4" y1="1530.9281" y2="1530.9281"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="100.8" x="1402.8" y="1525.2375">get challenge</text><polygon fill="#181818" points="1407.6,1561.3008,1395.6,1566.1008,1407.6,1570.9008,1402.8,1566.1008" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="1400.4" x2="1694.4" y1="1566.1008" y2="1566.1008"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="118.8" x="1414.8" y="1560.4102">[SAM challenge]</text><polygon fill="#00FF00" points="431.4,1596.4734,419.4,1601.2734,431.4,1606.0734,426.6,1601.2734" style="stroke:#00FF00;stroke-width:1.2;"/><line style="stroke:#00FF00;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="424.2" x2="1387.2" y1="1601.2734" y2="1601.2734"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="118.8" x="438.6" y="1595.5828">[SAM challenge]</text><polygon fill="#0000FF" points="941.4,1668.3914,953.4,1673.1914,941.4,1677.9914,946.2,1673.1914" style="stroke:#0000FF;stroke-width:1.2;"/><line style="stroke:#0000FF;stroke-width:1.2;" x1="418.2" x2="948.6" y1="1673.1914" y2="1673.1914"/><text fill="#0000FF" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="64.8" x="426.6" y="1630.7555">Card #2</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="162" x="426.6" y="1649.1281">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="85.2" x="465" y="1667.5008">- APDU list</text><path d="M688.8,1691.1914 L1044,1691.1914 L1044,1699.9641 L1032,1711.9641 L688.8,1711.9641 L688.8,1691.1914 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.7999999999999998;"/><rect fill="none" height="451.6172" style="stroke:#000000;stroke-width:1.7999999999999998;" width="638.4" x="688.8" y="1691.1914"/><text fill="#000000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="301.2" x="706.8" y="1707.4734">Card APDU commands inside session</text><path d="M700.8,1717.9641 L700.8,1747.9641 L1221.6,1747.9641 L1221.6,1729.9641 L1209.6,1717.9641 L700.8,1717.9641 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.6;"/><path d="M1209.6,1717.9641 L1209.6,1729.9641 L1221.6,1729.9641 L1209.6,1717.9641 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.6;"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="495.6" x="708" y="1739.0461">Optimization: environment file read through the session opening.</text><polygon fill="#181818" points="1265.4,1811.8547,1277.4,1816.6547,1265.4,1821.4547,1270.2,1816.6547" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="967.8" x2="1272.6" y1="1816.6547" y2="1816.6547"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="274.8" x="976.2" y="1774.2188">open secure session (card debit key,</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="114" x="1014.6" y="1792.5914">SAM challenge,</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="183.6" x="1014.6" y="1810.9641">SFI environment to read)</text><polygon fill="#181818" points="981,1847.0273,969,1851.8273,981,1856.6273,976.2,1851.8273" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="973.8" x2="1278.6" y1="1851.8273" y2="1851.8273"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="271.2" x="988.2" y="1846.1367">[card challenge &amp; environment data]</text><polygon fill="#181818" points="1265.4,1882.2,1277.4,1887,1265.4,1891.8,1270.2,1887" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="967.8" x2="1272.6" y1="1887" y2="1887"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="190.8" x="976.2" y="1881.3094">read record (contract list)</text><polygon fill="#181818" points="981,1917.3727,969,1922.1727,981,1926.9727,976.2,1922.1727" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="973.8" x2="1278.6" y1="1922.1727" y2="1922.1727"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="138" x="988.2" y="1916.482">[contract list data]</text><polygon fill="#181818" points="1265.4,1952.5453,1277.4,1957.3453,1265.4,1962.1453,1270.2,1957.3453" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="967.8" x2="1272.6" y1="1957.3453" y2="1957.3453"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="186" x="976.2" y="1951.6547">read record (contract #x)</text><polygon fill="#181818" points="981,1987.718,969,1992.518,981,1997.318,976.2,1992.518" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="973.8" x2="1278.6" y1="1992.518" y2="1992.518"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="133.2" x="988.2" y="1986.8273">[contract #x data]</text><polygon fill="#181818" points="1265.4,2022.8906,1277.4,2027.6906,1265.4,2032.4906,1270.2,2027.6906" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="967.8" x2="1272.6" y1="2027.6906" y2="2027.6906"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="184.8" x="976.2" y="2022">read record (contract #y)</text><polygon fill="#181818" points="981,2058.0633,969,2062.8633,981,2067.6633,976.2,2062.8633" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="973.8" x2="1278.6" y1="2062.8633" y2="2062.8633"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="132" x="988.2" y="2057.1727">[contract #y data]</text><polygon fill="#181818" points="1265.4,2093.2359,1277.4,2098.0359,1265.4,2102.8359,1270.2,2098.0359" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="967.8" x2="1272.6" y1="2098.0359" y2="2098.0359"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="165.6" x="976.2" y="2092.3453">read record (counters)</text><polygon fill="#181818" points="981,2128.4086,969,2133.2086,981,2138.0086,976.2,2133.2086" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="973.8" x2="1278.6" y1="2133.2086" y2="2133.2086"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="112.8" x="988.2" y="2127.518">[counters data]</text><polygon fill="#0000FF" points="431.4,2171.9813,419.4,2176.7813,431.4,2181.5812,426.6,2176.7813" style="stroke:#0000FF;stroke-width:1.2;"/><line style="stroke:#0000FF;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="424.2" x2="960.6" y1="2176.7813" y2="2176.7813"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="118.8" x="438.6" y="2171.0906">[card challenge]</text><polygon fill="#181818" points="115.8,2317.3898,103.8,2322.1898,115.8,2326.9898,111,2322.1898" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="108.6" x2="411" y1="2322.1898" y2="2322.1898"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="157.2" x="123" y="2206.2633">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="152.4" x="161.4" y="2224.6359">- identification data</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="217.2" x="161.4" y="2243.0086">- environment data (verified)</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="213.6" x="161.4" y="2261.3813">- contract list data (verified)</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="138" x="161.4" y="2279.7539">- contract #x data</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="136.8" x="161.4" y="2298.1266">- contract #y data</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="122.4" x="161.4" y="2316.4992">- counters data]</text><polygon fill="#181818" points="391.8,2426.0531,403.8,2430.8531,391.8,2435.6531,396.6,2430.8531" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="102.6" x2="399" y1="2430.8531" y2="2430.8531"/><text fill="#FF0000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="64.8" x="111" y="2351.6719">prepare</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="4.8" x="175.8" y="2351.6719">:</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="208.8" x="149.4" y="2370.0445">- update contract list (data)</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="204" x="149.4" y="2388.4172">- update contract #x (data)</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="190.8" x="149.4" y="2406.7898">- update counters (value)</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="130.8" x="149.4" y="2425.1625">- release channel</text><polygon fill="#181818" points="115.8,2442.8531,103.8,2447.6531,115.8,2452.4531,111,2447.6531" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="108.6" x2="411" y1="2447.6531" y2="2447.6531"/><polygon fill="#181818" points="391.8,2478.0258,403.8,2482.8258,391.8,2487.6258,396.6,2482.8258" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="102.6" x2="399" y1="2482.8258" y2="2482.8258"/><text fill="#FF0000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="62.4" x="111" y="2477.1352">process</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="145.2" x="178.2" y="2477.1352">closing (as ratified)</text><line style="stroke:#181818;stroke-width:1.2;" x1="418.2" x2="468.6" y1="2517.9984" y2="2517.9984"/><line style="stroke:#181818;stroke-width:1.2;" x1="468.6" x2="468.6" y1="2517.9984" y2="2533.5984"/><line style="stroke:#181818;stroke-width:1.2;" x1="419.4" x2="468.6" y1="2533.5984" y2="2533.5984"/><polygon fill="#181818" points="431.4,2528.7984,419.4,2533.5984,431.4,2538.3984,426.6,2533.5984" style="stroke:#181818;stroke-width:1.2;"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="280.8" x="426.6" y="2512.3078">anticipates the future card responses</text><polygon fill="#00FF00" points="1368,2600.7164,1380,2605.5164,1368,2610.3164,1372.8,2605.5164" style="stroke:#00FF00;stroke-width:1.2;"/><line style="stroke:#00FF00;stroke-width:1.2;" x1="418.2" x2="1375.2" y1="2605.5164" y2="2605.5164"/><text fill="#008000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="61.2" x="426.6" y="2563.0805">SAM #2</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="162" x="426.6" y="2581.4531">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="85.2" x="465" y="2599.8258">- APDU list</text><polygon fill="#181818" points="1681.2,2635.8891,1693.2,2640.6891,1681.2,2645.4891,1686,2640.6891" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="1394.4" x2="1688.4" y1="2640.6891" y2="2640.6891"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="189.6" x="1402.8" y="2634.9984">digest init (opening data)</text><polygon fill="#181818" points="1407.6,2652.6891,1395.6,2657.4891,1407.6,2662.2891,1402.8,2657.4891" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="1400.4" x2="1694.4" y1="2657.4891" y2="2657.4891"/><polygon fill="#181818" points="1681.2,2687.8617,1693.2,2692.6617,1681.2,2697.4617,1686,2692.6617" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="1394.4" x2="1688.4" y1="2692.6617" y2="2692.6617"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="249.6" x="1402.8" y="2686.9711">digest update (read environment)</text><polygon fill="#181818" points="1407.6,2704.6617,1395.6,2709.4617,1407.6,2714.2617,1402.8,2709.4617" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="1400.4" x2="1694.4" y1="2709.4617" y2="2709.4617"/><polygon fill="#181818" points="1681.2,2739.8344,1693.2,2744.6344,1681.2,2749.4344,1686,2744.6344" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="1394.4" x2="1688.4" y1="2744.6344" y2="2744.6344"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="246" x="1402.8" y="2738.9438">digest update (read contract list)</text><polygon fill="#181818" points="1407.6,2756.6344,1395.6,2761.4344,1407.6,2766.2344,1402.8,2761.4344" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="1400.4" x2="1694.4" y1="2761.4344" y2="2761.4344"/><polygon fill="#181818" points="1681.2,2791.807,1693.2,2796.607,1681.2,2801.407,1686,2796.607" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="1394.4" x2="1688.4" y1="2796.607" y2="2796.607"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="241.2" x="1402.8" y="2790.9164">digest update (read contract #x)</text><polygon fill="#181818" points="1407.6,2808.607,1395.6,2813.407,1407.6,2818.207,1402.8,2813.407" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="1400.4" x2="1694.4" y1="2813.407" y2="2813.407"/><polygon fill="#181818" points="1681.2,2843.7797,1693.2,2848.5797,1681.2,2853.3797,1686,2848.5797" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="1394.4" x2="1688.4" y1="2848.5797" y2="2848.5797"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="240" x="1402.8" y="2842.8891">digest update (read contract #y)</text><polygon fill="#181818" points="1407.6,2860.5797,1395.6,2865.3797,1407.6,2870.1797,1402.8,2865.3797" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="1400.4" x2="1694.4" y1="2865.3797" y2="2865.3797"/><polygon fill="#181818" points="1681.2,2895.7523,1693.2,2900.5523,1681.2,2905.3523,1686,2900.5523" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="1394.4" x2="1688.4" y1="2900.5523" y2="2900.5523"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="220.8" x="1402.8" y="2894.8617">digest update (read counters)</text><polygon fill="#181818" points="1407.6,2912.5523,1395.6,2917.3523,1407.6,2922.1523,1402.8,2917.3523" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="1400.4" x2="1694.4" y1="2917.3523" y2="2917.3523"/><path d="M1315.2,2935.3523 L1641.6,2935.3523 L1641.6,2944.125 L1629.6,2956.125 L1315.2,2956.125 L1315.2,2935.3523 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.7999999999999998;"/><rect fill="none" height="176.6906" style="stroke:#000000;stroke-width:1.7999999999999998;" width="435.6" x="1315.2" y="2935.3523"/><text fill="#FF0000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="91.2" x="1333.2" y="2951.6344">anticipated</text><text fill="#000000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="176.4" x="1429.2" y="2951.6344">Card APDU responses</text><polygon fill="#181818" points="1681.2,2976.8977,1693.2,2981.6977,1681.2,2986.4977,1686,2981.6977" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="1394.4" x2="1688.4" y1="2981.6977" y2="2981.6977"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="265.2" x="1402.8" y="2976.007">digest update (update contract list)</text><polygon fill="#181818" points="1407.6,2993.6977,1395.6,2998.4977,1407.6,3003.2977,1402.8,2998.4977" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="1400.4" x2="1694.4" y1="2998.4977" y2="2998.4977"/><polygon fill="#181818" points="1681.2,3028.8703,1693.2,3033.6703,1681.2,3038.4703,1686,3033.6703" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="1394.4" x2="1688.4" y1="3033.6703" y2="3033.6703"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="260.4" x="1402.8" y="3027.9797">digest update (update contract #x)</text><polygon fill="#181818" points="1407.6,3045.6703,1395.6,3050.4703,1407.6,3055.2703,1402.8,3050.4703" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="1400.4" x2="1694.4" y1="3050.4703" y2="3050.4703"/><polygon fill="#181818" points="1681.2,3080.843,1693.2,3085.643,1681.2,3090.443,1686,3085.643" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="1394.4" x2="1688.4" y1="3085.643" y2="3085.643"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="240" x="1402.8" y="3079.9523">digest update (update counters)</text><polygon fill="#181818" points="1407.6,3097.643,1395.6,3102.443,1407.6,3107.243,1402.8,3102.443" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="1400.4" x2="1694.4" y1="3102.443" y2="3102.443"/><polygon fill="#181818" points="1681.2,3141.2156,1693.2,3146.0156,1681.2,3150.8156,1686,3146.0156" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="1394.4" x2="1688.4" y1="3146.0156" y2="3146.0156"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="91.2" x="1402.8" y="3140.325">digest close</text><polygon fill="#181818" points="1407.6,3176.3883,1395.6,3181.1883,1407.6,3185.9883,1402.8,3181.1883" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="1400.4" x2="1694.4" y1="3181.1883" y2="3181.1883"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="122.4" x="1414.8" y="3175.4977">[SAM certificate]</text><polygon fill="#00FF00" points="431.4,3211.5609,419.4,3216.3609,431.4,3221.1609,426.6,3216.3609" style="stroke:#00FF00;stroke-width:1.2;"/><line style="stroke:#00FF00;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="424.2" x2="1387.2" y1="3216.3609" y2="3216.3609"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="122.4" x="438.6" y="3210.6703">[SAM certificate]</text><polygon fill="#0000FF" points="941.4,3283.4789,953.4,3288.2789,941.4,3293.0789,946.2,3288.2789" style="stroke:#0000FF;stroke-width:1.2;"/><line style="stroke:#0000FF;stroke-width:1.2;" x1="418.2" x2="948.6" y1="3288.2789" y2="3288.2789"/><text fill="#0000FF" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="64.8" x="426.6" y="3245.843">Card #3</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="162" x="426.6" y="3264.2156">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="85.2" x="465" y="3282.5883">- APDU list</text><path d="M886.8,3306.2789 L1242,3306.2789 L1242,3315.0516 L1230,3327.0516 L886.8,3327.0516 L886.8,3306.2789 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.7999999999999998;"/><rect fill="none" height="176.6906" style="stroke:#000000;stroke-width:1.7999999999999998;" width="440.4" x="886.8" y="3306.2789"/><text fill="#000000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="301.2" x="904.8" y="3322.5609">Card APDU commands inside session</text><polygon fill="#181818" points="1265.4,3347.8242,1277.4,3352.6242,1265.4,3357.4242,1270.2,3352.6242" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="967.8" x2="1272.6" y1="3352.6242" y2="3352.6242"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="194.4" x="976.2" y="3346.9336">update contract list (data)</text><polygon fill="#181818" points="981,3364.6242,969,3369.4242,981,3374.2242,976.2,3369.4242" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="973.8" x2="1278.6" y1="3369.4242" y2="3369.4242"/><polygon fill="#181818" points="1265.4,3399.7969,1277.4,3404.5969,1265.4,3409.3969,1270.2,3404.5969" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="967.8" x2="1272.6" y1="3404.5969" y2="3404.5969"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="189.6" x="976.2" y="3398.9063">update contract #x (data)</text><polygon fill="#181818" points="981,3416.5969,969,3421.3969,981,3426.1969,976.2,3421.3969" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="973.8" x2="1278.6" y1="3421.3969" y2="3421.3969"/><polygon fill="#181818" points="1265.4,3451.7695,1277.4,3456.5695,1265.4,3461.3695,1270.2,3456.5695" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="967.8" x2="1272.6" y1="3456.5695" y2="3456.5695"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="169.2" x="976.2" y="3450.8789">update counters (data)</text><polygon fill="#181818" points="981,3468.5695,969,3473.3695,981,3478.1695,976.2,3473.3695" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="973.8" x2="1278.6" y1="3473.3695" y2="3473.3695"/><polygon fill="#181818" points="1265.4,3512.1422,1277.4,3516.9422,1265.4,3521.7422,1270.2,3516.9422" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="967.8" x2="1272.6" y1="3516.9422" y2="3516.9422"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="283.2" x="976.2" y="3511.2516">close secure session (SAM certificate)</text><polygon fill="#181818" points="981,3547.3148,969,3552.1148,981,3556.9148,976.2,3552.1148" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="973.8" x2="1278.6" y1="3552.1148" y2="3552.1148"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="122.4" x="988.2" y="3546.4242">[card certificate]</text><polygon fill="#181818" points="1265.4,3582.4875,1277.4,3587.2875,1265.4,3592.0875,1270.2,3587.2875" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="967.8" x2="1272.6" y1="3587.2875" y2="3587.2875"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="140.4" x="976.2" y="3581.5969">close card channel</text><polygon fill="#181818" points="981,3599.2875,969,3604.0875,981,3608.8875,976.2,3604.0875" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="973.8" x2="1284.6" y1="3604.0875" y2="3604.0875"/><polygon fill="#0000FF" points="431.4,3634.4602,419.4,3639.2602,431.4,3644.0602,426.6,3639.2602" style="stroke:#0000FF;stroke-width:1.2;"/><line style="stroke:#0000FF;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="424.2" x2="960.6" y1="3639.2602" y2="3639.2602"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="122.4" x="438.6" y="3633.5695">[card certificate]</text><polygon fill="#00FF00" points="1368,3706.3781,1380,3711.1781,1368,3715.9781,1372.8,3711.1781" style="stroke:#00FF00;stroke-width:1.2;"/><line style="stroke:#00FF00;stroke-width:1.2;" x1="418.2" x2="1375.2" y1="3711.1781" y2="3711.1781"/><text fill="#008000" font-family="sans-serif" font-size="15.6" font-weight="bold" lengthAdjust="spacing" textLength="61.2" x="426.6" y="3668.7422">SAM #3</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="162" x="426.6" y="3687.1148">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="85.2" x="465" y="3705.4875">- APDU list</text><polygon fill="#181818" points="1681.2,3741.5508,1693.2,3746.3508,1681.2,3751.1508,1686,3746.3508" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;" x1="1394.4" x2="1688.4" y1="3746.3508" y2="3746.3508"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="272.4" x="1402.8" y="3740.6602">digest authenticate (card certificate)</text><polygon fill="#181818" points="1407.6,3776.7234,1395.6,3781.5234,1407.6,3786.3234,1402.8,3781.5234" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="1400.4" x2="1694.4" y1="3781.5234" y2="3781.5234"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="170.4" x="1414.8" y="3775.8328">[authentication status]</text><polygon fill="#00FF00" points="431.4,3811.8961,419.4,3816.6961,431.4,3821.4961,426.6,3816.6961" style="stroke:#00FF00;stroke-width:1.2;"/><line style="stroke:#00FF00;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="424.2" x2="1387.2" y1="3816.6961" y2="3816.6961"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="181.2" x="438.6" y="3811.0055">[authentification status]</text><polygon fill="#181818" points="115.8,3975.6773,103.8,3980.4773,115.8,3985.2773,111,3980.4773" style="stroke:#181818;stroke-width:1.2;"/><line style="stroke:#181818;stroke-width:1.2;stroke-dasharray:2.0,2.0;" x1="108.6" x2="411" y1="3980.4773" y2="3980.4773"/><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="157.2" x="123" y="3846.1781">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="152.4" x="161.4" y="3864.5508">- identification data</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="146.4" x="161.4" y="3882.9234">- environment data</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="218.4" x="161.4" y="3901.2961">- contract list data (updated)</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="213.6" x="161.4" y="3919.6688">- contract #x data (updated)</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="136.8" x="161.4" y="3938.0414">- contract #y data</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="222" x="161.4" y="3956.4141">- counters data (#x updated)]</text><text fill="#000000" font-family="sans-serif" font-size="15.6" lengthAdjust="spacing" textLength="171.6" x="123" y="3974.7867">authentification status</text><!--MD5=[077f02ce22107e8ba5f05783820227eb]
@startuml

'skinparam ClassBorderColor #F1C40F
skinparam ClassBorderColor #D4AC0D
skinparam stereotypeABorderColor #A9DCDF
skinparam stereotypeIBorderColor #B4A7E5
skinparam stereotypeCBorderColor #ADD1B2
skinparam stereotypeEBorderColor #EB93DF
skinparam shadowing false

skinparam StateBorderColor #D4AC0D
skinparam ActivityBorderColor #D4AC0D

' Red
skinparam ClassBackgroundColor<<red>> #FDEDEC
skinparam ClassBorderColor<<red>> #E74C3C
hide <<red>> stereotype
' Purple
skinparam ClassBackgroundColor<<purple>> #F4ECF7
skinparam ClassBorderColor<<purple>> #8E44AD
hide <<purple>> stereotype
' blue
skinparam ClassBackgroundColor<<blue>> #EBF5FB
skinparam ClassBorderColor<<blue>> #3498DB
hide <<blue>> stereotype
' Green
skinparam ClassBackgroundColor<<green>> #EAFAF1
skinparam ClassBorderColor<<green>> #2ECC71
hide <<green>> stereotype

' Orange
skinparam ClassBackgroundColor<<orange>> #FDF2E9
skinparam ClassBorderColor<<orange>> #E67E22
hide <<orange>> stereotype

' Grey
skinparam ClassBackgroundColor<<grey>> #EAECEE
skinparam ClassBorderColor<<grey>> #2C3E50
hide <<grey>> stereotype

actor "Ticketing Application" as app #gold
participant "Calypso API" as capi #pink
participant "Reader API" as rapi #pink
participant "(remote)\nCalypso Card\nReader" as cardReader #lightBlue
boundary "**Card**" as card #lightBlue
participant "(remote)\nCalypso SAM\nReader" as samReader #lightGreen
boundary "selected\n**SAM**" as sam #lightGreen

activate app #gold
activate sam #lightGreen

== Card selection & identification ==

note over capi
    Reads the data present in all the cards targeted for the selection.
end note

app->capi: <font color=red>**prepare**</font> card selection scenario:\n\t- filter by specific AID\n\t- filter invalidated card status\n\t- read environment file\n\t- read contract list
activate capi  #pink
capi- ->app
deactivate capi

app->rapi: <font color=red>**process**</font> explicit card selection scenario
activate rapi  #pink
rapi-[#0000FF]>cardReader: <font color=blue>**Card #1**</font>\ntransmit selection request\n\t- card selector\n\t- APDU list
activate cardReader #lightBlue

cardReader->card: open card channel
activate card #lightBlue
card- ->cardReader
cardReader->card: select application (aid)
card- ->cardReader: [card FCI]
cardReader->cardReader: checks invalidation status

group Card APDU commands outside secure session
    cardReader->card: read record (environment)
    card- ->cardReader: [environment data]
    cardReader->card: read record (contract list)
    card- ->cardReader: [contract list data]
end

cardReader- -[#0000FF]>rapi: receive selection response
deactivate cardReader

rapi- ->app: selected active SmartCard image
deactivate rapi

app->capi: **cast** Calypso card
activate capi  #pink
capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status\n\t- environment data\n\t- contract list data]

deactivate capi

== Card secure transaction ==

app->app: **instantiate** Calypso card transaction:\n\t- Calypso card resource\n\t- Calypso SAM resource

note over capi
    Reads again the environment file & the contract list inside the session to authenticate them.
end note

app->capi: <font color=red>**prepare**</font>\n\t- read environment file\n\t- read contract list\n\t- read contract #x\n\t- read contract #y\n\t- read counters
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> opening (DEBIT access level)
activate capi  #pink

capi-[#00FF00]>samReader: <font color=green>**SAM #1**<font color=red>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: select diversifier (card serial)
sam- ->samReader
samReader->sam: get challenge
sam- ->samReader: [SAM challenge]
samReader-[#00FF00]->capi: [SAM challenge]
deactivate samReader

capi-[#0000FF]>cardReader: <font color=blue>**Card #2**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
note over cardReader
    Optimization: environment file read through the session opening.
end note

    cardReader->card: open secure session (card debit key,\n\tSAM challenge,\n\tSFI environment to read)
    card- ->cardReader: [card challenge & environment data]
    cardReader->card: read record (contract list)
    card- ->cardReader: [contract list data]
    cardReader->card: read record (contract #x)
    card- ->cardReader: [contract #x data]
    cardReader->card: read record (contract #y)
    card- ->cardReader: [contract #y data]
    cardReader->card: read record (counters)
    card- ->cardReader: [counters data]
end

cardReader- -[#0000FF]>capi: [card challenge]
deactivate cardReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- environment data (verified)\n\t- contract list data (verified)\n\t- contract #x data\n\t- contract #y data\n\t- counters data]
deactivate capi

app->capi: <font color=red>**prepare**</font>:\n\t- update contract list (data)\n\t- update contract #x (data)\n\t- update counters (value)\n\t- release channel
activate capi  #pink

capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> closing (as ratified)
activate capi  #pink
capi->capi: anticipates the future card responses

capi-[#00FF00]>samReader: <font color=green>**SAM #2**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen

samReader->sam: digest init (opening data)
sam- ->samReader
samReader->sam: digest update (read environment)
sam- ->samReader
samReader->sam: digest update (read contract list)
sam- ->samReader
samReader->sam: digest update (read contract #x)
sam- ->samReader
samReader->sam: digest update (read contract #y)
sam- ->samReader
samReader->sam: digest update (read counters)
sam- ->samReader
group <font color=red>**anticipated**</font> Card APDU responses
    samReader->sam: digest update (update contract list)
    sam- ->samReader
    samReader->sam: digest update (update contract #x)
    sam- ->samReader
    samReader->sam: digest update (update counters)
    sam- ->samReader
end
samReader->sam: digest close
sam- ->samReader: [SAM certificate]

samReader-[#00FF00]->capi: [SAM certificate]
deactivate samReader

capi-[#0000FF]>cardReader: <font color=blue>**Card #3**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: update contract list (data)
    card- ->cardReader
    cardReader->card: update contract #x (data)
    card- ->cardReader
    cardReader->card: update counters (data)
    card- ->cardReader
end

cardReader->card: close secure session (SAM certificate)
card- ->cardReader: [card certificate]
cardReader->card: close card channel
card- ->cardReader
deactivate card

cardReader-[#0000FF]->capi: [card certificate]
deactivate cardReader

capi-[#00FF00]>samReader: <font color=green>**SAM #3**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: digest authenticate (card certificate)
sam- ->samReader: [authentication status]

samReader-[#00FF00]->capi: [authentification status]
deactivate samReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- environment data\n\t- contract list data (updated)\n\t- contract #x data (updated)\n\t- contract #y data\n\t- counters data (#x updated)]\nauthentification status
deactivate capi
@enduml

@startuml

skinparam ClassBorderColor #D4AC0D
skinparam stereotypeABorderColor #A9DCDF
skinparam stereotypeIBorderColor #B4A7E5
skinparam stereotypeCBorderColor #ADD1B2
skinparam stereotypeEBorderColor #EB93DF
skinparam shadowing false

skinparam StateBorderColor #D4AC0D
skinparam ActivityBorderColor #D4AC0D

skinparam ClassBackgroundColor<<red>> #FDEDEC
skinparam ClassBorderColor<<red>> #E74C3C
hide <<red>> stereotype
skinparam ClassBackgroundColor<<purple>> #F4ECF7
skinparam ClassBorderColor<<purple>> #8E44AD
hide <<purple>> stereotype
skinparam ClassBackgroundColor<<blue>> #EBF5FB
skinparam ClassBorderColor<<blue>> #3498DB
hide <<blue>> stereotype
skinparam ClassBackgroundColor<<green>> #EAFAF1
skinparam ClassBorderColor<<green>> #2ECC71
hide <<green>> stereotype

skinparam ClassBackgroundColor<<orange>> #FDF2E9
skinparam ClassBorderColor<<orange>> #E67E22
hide <<orange>> stereotype

skinparam ClassBackgroundColor<<grey>> #EAECEE
skinparam ClassBorderColor<<grey>> #2C3E50
hide <<grey>> stereotype

actor "Ticketing Application" as app #gold
participant "Calypso API" as capi #pink
participant "Reader API" as rapi #pink
participant "(remote)\nCalypso Card\nReader" as cardReader #lightBlue
boundary "**Card**" as card #lightBlue
participant "(remote)\nCalypso SAM\nReader" as samReader #lightGreen
boundary "selected\n**SAM**" as sam #lightGreen

activate app #gold
activate sam #lightGreen

== Card selection & identification ==

note over capi
    Reads the data present in all the cards targeted for the selection.
end note

app->capi: <font color=red>**prepare**</font> card selection scenario:\n\t- filter by specific AID\n\t- filter invalidated card status\n\t- read environment file\n\t- read contract list
activate capi  #pink
capi- ->app
deactivate capi

app->rapi: <font color=red>**process**</font> explicit card selection scenario
activate rapi  #pink
rapi-[#0000FF]>cardReader: <font color=blue>**Card #1**</font>\ntransmit selection request\n\t- card selector\n\t- APDU list
activate cardReader #lightBlue

cardReader->card: open card channel
activate card #lightBlue
card- ->cardReader
cardReader->card: select application (aid)
card- ->cardReader: [card FCI]
cardReader->cardReader: checks invalidation status

group Card APDU commands outside secure session
    cardReader->card: read record (environment)
    card- ->cardReader: [environment data]
    cardReader->card: read record (contract list)
    card- ->cardReader: [contract list data]
end

cardReader- -[#0000FF]>rapi: receive selection response
deactivate cardReader

rapi- ->app: selected active SmartCard image
deactivate rapi

app->capi: **cast** Calypso card
activate capi  #pink
capi- ->app: [Calypso card image:\n\t- identification data\n\t- invalidation status\n\t- environment data\n\t- contract list data]

deactivate capi

== Card secure transaction ==

app->app: **instantiate** Calypso card transaction:\n\t- Calypso card resource\n\t- Calypso SAM resource

note over capi
    Reads again the environment file & the contract list inside the session to authenticate them.
end note

app->capi: <font color=red>**prepare**</font>\n\t- read environment file\n\t- read contract list\n\t- read contract #x\n\t- read contract #y\n\t- read counters
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> opening (DEBIT access level)
activate capi  #pink

capi-[#00FF00]>samReader: <font color=green>**SAM #1**<font color=red>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: select diversifier (card serial)
sam- ->samReader
samReader->sam: get challenge
sam- ->samReader: [SAM challenge]
samReader-[#00FF00]->capi: [SAM challenge]
deactivate samReader

capi-[#0000FF]>cardReader: <font color=blue>**Card #2**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
note over cardReader
    Optimization: environment file read through the session opening.
end note

    cardReader->card: open secure session (card debit key,\n\tSAM challenge,\n\tSFI environment to read)
    card- ->cardReader: [card challenge & environment data]
    cardReader->card: read record (contract list)
    card- ->cardReader: [contract list data]
    cardReader->card: read record (contract #x)
    card- ->cardReader: [contract #x data]
    cardReader->card: read record (contract #y)
    card- ->cardReader: [contract #y data]
    cardReader->card: read record (counters)
    card- ->cardReader: [counters data]
end

cardReader- -[#0000FF]>capi: [card challenge]
deactivate cardReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- environment data (verified)\n\t- contract list data (verified)\n\t- contract #x data\n\t- contract #y data\n\t- counters data]
deactivate capi

app->capi: <font color=red>**prepare**</font>:\n\t- update contract list (data)\n\t- update contract #x (data)\n\t- update counters (value)\n\t- release channel
activate capi  #pink

capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> closing (as ratified)
activate capi  #pink
capi->capi: anticipates the future card responses

capi-[#00FF00]>samReader: <font color=green>**SAM #2**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen

samReader->sam: digest init (opening data)
sam- ->samReader
samReader->sam: digest update (read environment)
sam- ->samReader
samReader->sam: digest update (read contract list)
sam- ->samReader
samReader->sam: digest update (read contract #x)
sam- ->samReader
samReader->sam: digest update (read contract #y)
sam- ->samReader
samReader->sam: digest update (read counters)
sam- ->samReader
group <font color=red>**anticipated**</font> Card APDU responses
    samReader->sam: digest update (update contract list)
    sam- ->samReader
    samReader->sam: digest update (update contract #x)
    sam- ->samReader
    samReader->sam: digest update (update counters)
    sam- ->samReader
end
samReader->sam: digest close
sam- ->samReader: [SAM certificate]

samReader-[#00FF00]->capi: [SAM certificate]
deactivate samReader

capi-[#0000FF]>cardReader: <font color=blue>**Card #3**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: update contract list (data)
    card- ->cardReader
    cardReader->card: update contract #x (data)
    card- ->cardReader
    cardReader->card: update counters (data)
    card- ->cardReader
end

cardReader->card: close secure session (SAM certificate)
card- ->cardReader: [card certificate]
cardReader->card: close card channel
card- ->cardReader
deactivate card

cardReader-[#0000FF]->capi: [card certificate]
deactivate cardReader

capi-[#00FF00]>samReader: <font color=green>**SAM #3**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: digest authenticate (card certificate)
sam- ->samReader: [authentication status]

samReader-[#00FF00]->capi: [authentification status]
deactivate samReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- environment data\n\t- contract list data (updated)\n\t- contract #x data (updated)\n\t- contract #y data\n\t- counters data (#x updated)]\nauthentification status
deactivate capi
@enduml

PlantUML version 1.2022.4(Sat Apr 09 17:29:17 RET 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: fr
Country: FR
--></g></svg>