<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="3083px" preserveAspectRatio="none" style="width:1378px;height:3083px;background:#FFFFFF;" version="1.1" viewBox="0 0 1378 3083" width="1378px" zoomAndPan="magnify"><defs/><g><rect fill="#FFD700" height="2902.4707" style="stroke:#181818;stroke-width:1.0;" width="10" x="75.5" y="91.4883"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="377.5" y="231.6621"/><rect fill="#FFC0CB" height="624.0742" style="stroke:#181818;stroke-width:1.0;" width="10" x="377.5" y="274.9727"/><rect fill="#FFC0CB" height="899.248" style="stroke:#181818;stroke-width:1.0;" width="10" x="377.5" y="928.3574"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="377.5" y="1902.8477"/><rect fill="#FFC0CB" height="1003.4902" style="stroke:#181818;stroke-width:1.0;" width="10" x="377.5" y="1981.4688"/><rect fill="#ADD8E6" height="267.1055" style="stroke:#181818;stroke-width:1.0;" width="10" x="635.5" y="526.0781"/><rect fill="#ADD8E6" height="119.2422" style="stroke:#181818;stroke-width:1.0;" width="10" x="635.5" y="988.2891"/><rect fill="#ADD8E6" height="119.2422" style="stroke:#181818;stroke-width:1.0;" width="10" x="635.5" y="1617.8105"/><rect fill="#ADD8E6" height="307.7949" style="stroke:#181818;stroke-width:1.0;" width="10" x="635.5" y="2392.8164"/><rect fill="#ADD8E6" height="2579.8125" style="stroke:#181818;stroke-width:1.0;" width="10" x="905.5" y="91.4883"/><rect fill="#90EE90" height="131.2422" style="stroke:#181818;stroke-width:1.0;" width="10" x="997.5" y="334.9043"/><rect fill="#90EE90" height="390.416" style="stroke:#181818;stroke-width:1.0;" width="10" x="997.5" y="1167.4629"/><rect fill="#90EE90" height="249.1738" style="stroke:#181818;stroke-width:1.0;" width="10" x="997.5" y="2083.7109"/><rect fill="#90EE90" height="87.9316" style="stroke:#181818;stroke-width:1.0;" width="10" x="997.5" y="2760.543"/><rect fill="#90EE90" height="2902.4707" style="stroke:#181818;stroke-width:1.0;" width="10" x="1326.5" y="91.4883"/><rect height="223.7949" style="stroke:#000000;stroke-width:1.5;fill:none;" width="373.5" x="578" y="541.0781"/><rect height="75.9316" style="stroke:#000000;stroke-width:1.5;fill:none;" width="373.5" x="578" y="1003.2891"/><rect height="75.9316" style="stroke:#000000;stroke-width:1.5;fill:none;" width="373.5" x="578" y="1632.8105"/><rect height="103.9316" style="stroke:#000000;stroke-width:1.5;fill:none;" width="431" x="941.5" y="2142.0215"/><rect height="119.2422" style="stroke:#000000;stroke-width:1.5;fill:none;" width="373.5" x="578" y="2407.8164"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="80" x2="80" y1="81.4883" y2="3002.959"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="382.5" x2="382.5" y1="81.4883" y2="3002.959"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="640" x2="640" y1="81.4883" y2="3002.959"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="910.5" x2="910.5" y1="81.4883" y2="3002.959"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="1002.5" x2="1002.5" y1="81.4883" y2="3002.959"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="1331.5" x2="1331.5" y1="81.4883" y2="3002.959"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="145" x="5" y="78.5352">Ticketing Application</text><ellipse cx="80.5" cy="13.5" fill="#FFD700" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M80.5,21.5 L80.5,48.5 M67.5,29.5 L93.5,29.5 M80.5,48.5 L67.5,63.5 M80.5,48.5 L93.5,63.5 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="145" x="5" y="3015.4941">Ticketing Application</text><ellipse cx="80.5" cy="3026.9473" fill="#FFD700" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M80.5,3034.9473 L80.5,3061.9473 M67.5,3042.9473 L93.5,3042.9473 M80.5,3061.9473 L67.5,3076.9473 M80.5,3061.9473 L93.5,3076.9473 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#FFC0CB" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="94" x="335.5" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="80" x="342.5" y="70.5352">Calypso API</text><rect fill="#FFC0CB" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="94" x="335.5" y="3001.959"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="80" x="342.5" y="3022.4941">Calypso API</text><rect fill="#ADD8E6" height="46.9766" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="105" x="588" y="33.5117"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="595" y="54.0469">Calypso Card</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48" x="616.5" y="70.5352">Reader</text><rect fill="#ADD8E6" height="46.9766" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="105" x="588" y="3001.959"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="595" y="3022.4941">Calypso Card</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48" x="616.5" y="3038.9824">Reader</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="879.5" y="62.0469">selected</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="33" x="891" y="78.5352">Card</text><path d="M890,20.5117 L890,44.5117 M890,32.5117 L907,32.5117 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><ellipse cx="919" cy="32.5117" fill="#ADD8E6" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="879.5" y="3015.4941">selected</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="33" x="891" y="3031.9824">Card</text><path d="M890,3038.9355 L890,3062.9355 M890,3050.9355 L907,3050.9355 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><ellipse cx="919" cy="3050.9355" fill="#ADD8E6" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#90EE90" height="46.9766" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="102" x="951.5" y="33.5117"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="88" x="958.5" y="54.0469">Calypso SAM</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48" x="978.5" y="70.5352">Reader</text><rect fill="#90EE90" height="46.9766" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="102" x="951.5" y="3001.959"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="88" x="958.5" y="3022.4941">Calypso SAM</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48" x="978.5" y="3038.9824">Reader</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="1300.5" y="62.0469">selected</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="31" x="1313" y="78.5352">SAM</text><path d="M1311,20.5117 L1311,44.5117 M1311,32.5117 L1328,32.5117 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><ellipse cx="1340" cy="32.5117" fill="#90EE90" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="1300.5" y="3015.4941">selected</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="31" x="1313" y="3031.9824">SAM</text><path d="M1311,3038.9355 L1311,3062.9355 M1311,3050.9355 L1328,3050.9355 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><ellipse cx="1340" cy="3050.9355" fill="#90EE90" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#FFD700" height="2902.4707" style="stroke:#181818;stroke-width:1.0;" width="10" x="75.5" y="91.4883"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="377.5" y="231.6621"/><rect fill="#FFC0CB" height="624.0742" style="stroke:#181818;stroke-width:1.0;" width="10" x="377.5" y="274.9727"/><rect fill="#FFC0CB" height="899.248" style="stroke:#181818;stroke-width:1.0;" width="10" x="377.5" y="928.3574"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="377.5" y="1902.8477"/><rect fill="#FFC0CB" height="1003.4902" style="stroke:#181818;stroke-width:1.0;" width="10" x="377.5" y="1981.4688"/><rect fill="#ADD8E6" height="267.1055" style="stroke:#181818;stroke-width:1.0;" width="10" x="635.5" y="526.0781"/><rect fill="#ADD8E6" height="119.2422" style="stroke:#181818;stroke-width:1.0;" width="10" x="635.5" y="988.2891"/><rect fill="#ADD8E6" height="119.2422" style="stroke:#181818;stroke-width:1.0;" width="10" x="635.5" y="1617.8105"/><rect fill="#ADD8E6" height="307.7949" style="stroke:#181818;stroke-width:1.0;" width="10" x="635.5" y="2392.8164"/><rect fill="#ADD8E6" height="2579.8125" style="stroke:#181818;stroke-width:1.0;" width="10" x="905.5" y="91.4883"/><rect fill="#90EE90" height="131.2422" style="stroke:#181818;stroke-width:1.0;" width="10" x="997.5" y="334.9043"/><rect fill="#90EE90" height="390.416" style="stroke:#181818;stroke-width:1.0;" width="10" x="997.5" y="1167.4629"/><rect fill="#90EE90" height="249.1738" style="stroke:#181818;stroke-width:1.0;" width="10" x="997.5" y="2083.7109"/><rect fill="#90EE90" height="87.9316" style="stroke:#181818;stroke-width:1.0;" width="10" x="997.5" y="2760.543"/><rect fill="#90EE90" height="2902.4707" style="stroke:#181818;stroke-width:1.0;" width="10" x="1326.5" y="91.4883"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="127.5" y1="143.4199" y2="143.4199"/><line style="stroke:#181818;stroke-width:1.0;" x1="127.5" x2="127.5" y1="143.4199" y2="156.4199"/><line style="stroke:#181818;stroke-width:1.0;" x1="86.5" x2="127.5" y1="156.4199" y2="156.4199"/><polygon fill="#181818" points="96.5,152.4199,86.5,156.4199,96.5,160.4199,92.5,156.4199" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="72" x="92.5" y="108.0566">instantiate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="168.5" y="108.0566">Calypso card transaction:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="124.5" y="123.3672">- Calypso card resource</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="124.5" y="138.6777">- Calypso SAM resource</text><polygon fill="#181818" points="365.5,227.6621,375.5,231.6621,365.5,235.6621,369.5,231.6621" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="371.5" y1="231.6621" y2="231.6621"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="92.5" y="180.9883">prepare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="106" x="150.5" y="180.9883">card transaction:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="146" x="124.5" y="196.2988">- read environment file</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="124.5" y="211.6094">- read contract #1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="123" x="124.5" y="226.9199">- reader counter #1</text><polygon fill="#181818" points="96.5,241.6621,86.5,245.6621,96.5,249.6621,92.5,245.6621" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="381.5" y1="245.6621" y2="245.6621"/><polygon fill="#181818" points="365.5,270.9727,375.5,274.9727,365.5,278.9727,369.5,274.9727" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="371.5" y1="274.9727" y2="274.9727"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="92.5" y="270.2305">process</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="178" x="148.5" y="270.2305">opening (DEBIT access level)</text><polygon fill="#00FF00" points="985.5,330.9043,995.5,334.9043,985.5,338.9043,989.5,334.9043" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;" x1="387.5" x2="991.5" y1="334.9043" y2="334.9043"/><text fill="#008000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="51" x="394.5" y="299.541">SAM #1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="394.5" y="314.8516">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="426.5" y="330.1621">- APDU list</text><polygon fill="#181818" points="1314.5,360.2148,1324.5,364.2148,1314.5,368.2148,1318.5,364.2148" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1007.5" x2="1320.5" y1="364.2148" y2="364.2148"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="181" x="1014.5" y="359.4727">select diversifier (card serial)</text><polygon fill="#181818" points="1018.5,374.2148,1008.5,378.2148,1018.5,382.2148,1014.5,378.2148" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1012.5" x2="1325.5" y1="378.2148" y2="378.2148"/><polygon fill="#181818" points="1314.5,403.5254,1324.5,407.5254,1314.5,411.5254,1318.5,407.5254" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1007.5" x2="1320.5" y1="407.5254" y2="407.5254"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="84" x="1014.5" y="402.7832">get challenge</text><polygon fill="#181818" points="1018.5,432.8359,1008.5,436.8359,1018.5,440.8359,1014.5,436.8359" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1012.5" x2="1325.5" y1="436.8359" y2="436.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="99" x="1024.5" y="432.0938">[SAM challenge]</text><polygon fill="#00FF00" points="398.5,462.1465,388.5,466.1465,398.5,470.1465,394.5,466.1465" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="392.5" x2="1001.5" y1="466.1465" y2="466.1465"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="99" x="404.5" y="461.4043">[SAM challenge]</text><polygon fill="#0000FF" points="623.5,522.0781,633.5,526.0781,623.5,530.0781,627.5,526.0781" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;" x1="387.5" x2="629.5" y1="526.0781" y2="526.0781"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="394.5" y="490.7148">Card #2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="394.5" y="506.0254">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="426.5" y="521.3359">- APDU list</text><path d="M578,541.0781 L874,541.0781 L874,548.3887 L864,558.3887 L578,558.3887 L578,541.0781 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="223.7949" style="stroke:#000000;stroke-width:1.5;" width="373.5" x="578" y="541.0781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="251" x="593" y="554.6465">Card APDU commands inside session</text><polygon fill="#181818" points="893.5,606.3203,903.5,610.3203,893.5,614.3203,897.5,610.3203" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="645.5" x2="899.5" y1="610.3203" y2="610.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="229" x="652.5" y="574.957">open secure session (card debit key,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="95" x="684.5" y="590.2676">SAM challenge,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="153" x="684.5" y="605.5781">SFI environment to read)</text><polygon fill="#181818" points="656.5,635.6309,646.5,639.6309,656.5,643.6309,652.5,639.6309" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="650.5" x2="904.5" y1="639.6309" y2="639.6309"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="226" x="662.5" y="634.8887">[card challenge &amp; environment data]</text><polygon fill="#181818" points="893.5,664.9414,903.5,668.9414,893.5,672.9414,897.5,668.9414" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="645.5" x2="899.5" y1="668.9414" y2="668.9414"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="155" x="652.5" y="664.1992">read record (contract #1)</text><polygon fill="#181818" points="656.5,694.252,646.5,698.252,656.5,702.252,652.5,698.252" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="650.5" x2="904.5" y1="698.252" y2="698.252"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="111" x="662.5" y="693.5098">[contract #1 data]</text><polygon fill="#181818" points="893.5,723.5625,903.5,727.5625,893.5,731.5625,897.5,727.5625" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="645.5" x2="899.5" y1="727.5625" y2="727.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="652.5" y="722.8203">read record (counter #1)</text><polygon fill="#181818" points="656.5,752.873,646.5,756.873,656.5,760.873,652.5,756.873" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="650.5" x2="904.5" y1="756.873" y2="756.873"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="107" x="662.5" y="752.1309">[counter #1 data]</text><polygon fill="#0000FF" points="398.5,789.1836,388.5,793.1836,398.5,797.1836,394.5,793.1836" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="392.5" x2="639.5" y1="793.1836" y2="793.1836"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="99" x="404.5" y="788.4414">[card challenge]</text><polygon fill="#181818" points="96.5,895.0469,86.5,899.0469,96.5,903.0469,92.5,899.0469" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="381.5" y1="899.0469" y2="899.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="102.5" y="817.752">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127" x="134.5" y="833.0625">- identification data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="185" x="134.5" y="848.373">- environment data (updated)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="119" x="134.5" y="863.6836">- contract list data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="134.5" y="878.9941">- contract #1 data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="134.5" y="894.3047">- counter #1 data]</text><polygon fill="#181818" points="365.5,924.3574,375.5,928.3574,365.5,932.3574,369.5,928.3574" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="371.5" y1="928.3574" y2="928.3574"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="92.5" y="923.6152">process</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="166" x="148.5" y="923.6152">Verify PIN (plain PIN value)</text><polygon fill="#0000FF" points="623.5,984.2891,633.5,988.2891,623.5,992.2891,627.5,988.2891" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;" x1="387.5" x2="629.5" y1="988.2891" y2="988.2891"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="394.5" y="952.9258">Card #3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="394.5" y="968.2363">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="426.5" y="983.5469">- APDU list</text><path d="M578,1003.2891 L874,1003.2891 L874,1010.5996 L864,1020.5996 L578,1020.5996 L578,1003.2891 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="75.9316" style="stroke:#000000;stroke-width:1.5;" width="373.5" x="578" y="1003.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="251" x="593" y="1016.8574">Card APDU commands inside session</text><polygon fill="#181818" points="893.5,1037.9102,903.5,1041.9102,893.5,1045.9102,897.5,1041.9102" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="645.5" x2="899.5" y1="1041.9102" y2="1041.9102"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="87" x="652.5" y="1037.168">Get Challenge</text><polygon fill="#181818" points="656.5,1067.2207,646.5,1071.2207,656.5,1075.2207,652.5,1071.2207" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="650.5" x2="904.5" y1="1071.2207" y2="1071.2207"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="126" x="662.5" y="1066.4785">[PIN Card challenge]</text><polygon fill="#0000FF" points="398.5,1103.5313,388.5,1107.5313,398.5,1111.5313,394.5,1107.5313" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="392.5" x2="639.5" y1="1107.5313" y2="1107.5313"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="101" x="404.5" y="1102.7891">[Card challenge]</text><polygon fill="#00FF00" points="985.5,1163.4629,995.5,1167.4629,985.5,1171.4629,989.5,1167.4629" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;" x1="387.5" x2="991.5" y1="1167.4629" y2="1167.4629"/><text fill="#008000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="51" x="394.5" y="1132.0996">SAM #2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="394.5" y="1147.4102">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="426.5" y="1162.7207">- APDU list</text><path d="M736,1180.4629 L736,1205.4629 L1268,1205.4629 L1268,1190.4629 L1258,1180.4629 L736,1180.4629 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1258,1180.4629 L1258,1190.4629 L1268,1190.4629 L1258,1180.4629 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="511" x="742" y="1198.0313">When ciphered PIN verification requested, processes all pending SAM commands.</text><polygon fill="#181818" points="1314.5,1228.084,1324.5,1232.084,1314.5,1236.084,1318.5,1232.084" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1007.5" x2="1320.5" y1="1232.084" y2="1232.084"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1014.5" y="1227.3418">digest init (opening data)</text><polygon fill="#181818" points="1018.5,1242.084,1008.5,1246.084,1018.5,1250.084,1014.5,1246.084" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1012.5" x2="1325.5" y1="1246.084" y2="1246.084"/><polygon fill="#181818" points="1314.5,1271.3945,1324.5,1275.3945,1314.5,1279.3945,1318.5,1275.3945" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1007.5" x2="1320.5" y1="1275.3945" y2="1275.3945"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="208" x="1014.5" y="1270.6523">digest update (read environment)</text><polygon fill="#181818" points="1018.5,1285.3945,1008.5,1289.3945,1018.5,1293.3945,1014.5,1289.3945" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1012.5" x2="1325.5" y1="1289.3945" y2="1289.3945"/><polygon fill="#181818" points="1314.5,1314.7051,1324.5,1318.7051,1314.5,1322.7051,1318.5,1318.7051" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1007.5" x2="1320.5" y1="1318.7051" y2="1318.7051"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="181" x="1014.5" y="1313.9629">digest update (read contract)</text><polygon fill="#181818" points="1018.5,1328.7051,1008.5,1332.7051,1018.5,1336.7051,1014.5,1332.7051" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1012.5" x2="1325.5" y1="1332.7051" y2="1332.7051"/><polygon fill="#181818" points="1314.5,1358.0156,1324.5,1362.0156,1314.5,1366.0156,1318.5,1362.0156" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1007.5" x2="1320.5" y1="1362.0156" y2="1362.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="177" x="1014.5" y="1357.2734">digest update (read counter)</text><polygon fill="#181818" points="1018.5,1372.0156,1008.5,1376.0156,1018.5,1380.0156,1014.5,1376.0156" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1012.5" x2="1325.5" y1="1376.0156" y2="1376.0156"/><path d="M721,1389.0156 L721,1414.0156 L1283,1414.0156 L1283,1399.0156 L1273,1389.0156 L721,1389.0156 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1273,1389.0156 L1273,1399.0156 L1283,1399.0156 L1273,1389.0156 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="541" x="727" y="1406.584">Diversification for the PIN ciphering is necessarily the same as for the secure session.</text><polygon fill="#181818" points="1314.5,1436.6367,1324.5,1440.6367,1314.5,1444.6367,1318.5,1440.6367" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1007.5" x2="1320.5" y1="1440.6367" y2="1440.6367"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="210" x="1014.5" y="1435.8945">Give Random (PIN card challenge)</text><polygon fill="#181818" points="1018.5,1465.9473,1008.5,1469.9473,1018.5,1473.9473,1014.5,1469.9473" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1012.5" x2="1325.5" y1="1469.9473" y2="1469.9473"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="22" x="1024.5" y="1465.2051">ack</text><polygon fill="#181818" points="1314.5,1495.2578,1324.5,1499.2578,1314.5,1503.2578,1318.5,1499.2578" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1007.5" x2="1320.5" y1="1499.2578" y2="1499.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="295" x="1014.5" y="1494.5156">Card Cipher PIN (plain PIN, debit key reference)</text><polygon fill="#181818" points="1018.5,1524.5684,1008.5,1528.5684,1018.5,1532.5684,1014.5,1528.5684" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1012.5" x2="1325.5" y1="1528.5684" y2="1528.5684"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="87" x="1024.5" y="1523.8262">[ciphered PIN]</text><polygon fill="#00FF00" points="398.5,1553.8789,388.5,1557.8789,398.5,1561.8789,394.5,1557.8789" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="392.5" x2="1001.5" y1="1557.8789" y2="1557.8789"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="87" x="404.5" y="1553.1367">[ciphered PIN]</text><polygon fill="#0000FF" points="623.5,1613.8105,633.5,1617.8105,623.5,1621.8105,627.5,1617.8105" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;" x1="387.5" x2="629.5" y1="1617.8105" y2="1617.8105"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="394.5" y="1582.4473">Card #4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="394.5" y="1597.7578">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="426.5" y="1613.0684">- APDU list</text><path d="M578,1632.8105 L874,1632.8105 L874,1640.1211 L864,1650.1211 L578,1650.1211 L578,1632.8105 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="75.9316" style="stroke:#000000;stroke-width:1.5;" width="373.5" x="578" y="1632.8105"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="251" x="593" y="1646.3789">Card APDU commands inside session</text><polygon fill="#181818" points="893.5,1667.4316,903.5,1671.4316,893.5,1675.4316,897.5,1671.4316" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="645.5" x2="899.5" y1="1671.4316" y2="1671.4316"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="652.5" y="1666.6895">Verify PIN (ciphered PIN)</text><polygon fill="#181818" points="656.5,1696.7422,646.5,1700.7422,656.5,1704.7422,652.5,1700.7422" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="650.5" x2="904.5" y1="1700.7422" y2="1700.7422"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="72" x="662.5" y="1696">[PIN status]</text><polygon fill="#0000FF" points="398.5,1733.0527,388.5,1737.0527,398.5,1741.0527,394.5,1737.0527" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="392.5" x2="639.5" y1="1737.0527" y2="1737.0527"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="72" x="404.5" y="1732.3105">[PIN status]</text><polygon fill="#181818" points="96.5,1823.6055,86.5,1827.6055,96.5,1831.6055,92.5,1827.6055" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="381.5" y1="1827.6055" y2="1827.6055"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="102.5" y="1761.6211">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="236" x="134.5" y="1776.9316">- identification data with PIN support</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="179" x="134.5" y="1792.2422">- key #1 reference (updated)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="116" x="134.5" y="1807.5527">- key #2 reference</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="134.5" y="1822.8633">- key #3 reference]</text><polygon fill="#181818" points="365.5,1898.8477,375.5,1902.8477,365.5,1906.8477,369.5,1902.8477" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="371.5" y1="1902.8477" y2="1902.8477"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="92.5" y="1852.1738">prepare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="146.5" y="1852.1738">:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="184" x="124.5" y="1867.4844">- decrease counter #1 (value)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="179" x="124.5" y="1882.7949">- append event record (data)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="109" x="124.5" y="1898.1055">- release channel</text><polygon fill="#181818" points="96.5,1912.8477,86.5,1916.8477,96.5,1920.8477,92.5,1916.8477" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="381.5" y1="1916.8477" y2="1916.8477"/><path d="M136,1929.8477 L136,1954.8477 L628,1954.8477 L628,1939.8477 L618,1929.8477 L136,1929.8477 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M618,1929.8477 L618,1939.8477 L628,1939.8477 L618,1929.8477 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="471" x="142" y="1947.416">At the session closure, any data secure processing should be unnecessary.</text><polygon fill="#181818" points="365.5,1977.4688,375.5,1981.4688,365.5,1985.4688,369.5,1981.4688" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="371.5" y1="1981.4688" y2="1981.4688"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="92.5" y="1976.7266">process</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="128" x="148.5" y="1976.7266">closing (not ratified)</text><line style="stroke:#181818;stroke-width:1.0;" x1="387.5" x2="429.5" y1="2010.7793" y2="2010.7793"/><line style="stroke:#181818;stroke-width:1.0;" x1="429.5" x2="429.5" y1="2010.7793" y2="2023.7793"/><line style="stroke:#181818;stroke-width:1.0;" x1="388.5" x2="429.5" y1="2023.7793" y2="2023.7793"/><polygon fill="#181818" points="398.5,2019.7793,388.5,2023.7793,398.5,2027.7793,394.5,2023.7793" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="234" x="394.5" y="2006.0371">anticipates the future card responses</text><polygon fill="#00FF00" points="985.5,2079.7109,995.5,2083.7109,985.5,2087.7109,989.5,2083.7109" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;" x1="387.5" x2="991.5" y1="2083.7109" y2="2083.7109"/><text fill="#008000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="51" x="394.5" y="2048.3477">SAM #3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="394.5" y="2063.6582">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="426.5" y="2078.9688">- APDU list</text><polygon fill="#181818" points="1314.5,2109.0215,1324.5,2113.0215,1314.5,2117.0215,1318.5,2113.0215" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1007.5" x2="1320.5" y1="2113.0215" y2="2113.0215"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1014.5" y="2108.2793">digest update (verify PIN)</text><polygon fill="#181818" points="1018.5,2123.0215,1008.5,2127.0215,1018.5,2131.0215,1014.5,2127.0215" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1012.5" x2="1325.5" y1="2127.0215" y2="2127.0215"/><path d="M941.5,2142.0215 L1213.5,2142.0215 L1213.5,2149.332 L1203.5,2159.332 L941.5,2159.332 L941.5,2142.0215 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="103.9316" style="stroke:#000000;stroke-width:1.5;" width="431" x="941.5" y="2142.0215"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="76" x="956.5" y="2155.5898">anticipated</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="147" x="1036.5" y="2155.5898">Card APDU responses</text><polygon fill="#181818" points="1314.5,2176.6426,1324.5,2180.6426,1314.5,2184.6426,1318.5,2180.6426" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1007.5" x2="1320.5" y1="2180.6426" y2="2180.6426"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="205" x="1014.5" y="2175.9004">digest update (decrease counter)</text><polygon fill="#181818" points="1018.5,2190.6426,1008.5,2194.6426,1018.5,2198.6426,1014.5,2194.6426" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1012.5" x2="1325.5" y1="2194.6426" y2="2194.6426"/><polygon fill="#181818" points="1314.5,2219.9531,1324.5,2223.9531,1314.5,2227.9531,1318.5,2223.9531" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1007.5" x2="1320.5" y1="2223.9531" y2="2223.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="226" x="1014.5" y="2219.2109">digest update (append event record)</text><polygon fill="#181818" points="1018.5,2233.9531,1008.5,2237.9531,1018.5,2241.9531,1014.5,2237.9531" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1012.5" x2="1325.5" y1="2237.9531" y2="2237.9531"/><polygon fill="#181818" points="1314.5,2270.2637,1324.5,2274.2637,1314.5,2278.2637,1318.5,2274.2637" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1007.5" x2="1320.5" y1="2274.2637" y2="2274.2637"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="76" x="1014.5" y="2269.5215">digest close</text><polygon fill="#181818" points="1018.5,2299.5742,1008.5,2303.5742,1018.5,2307.5742,1014.5,2303.5742" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1012.5" x2="1325.5" y1="2303.5742" y2="2303.5742"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="1024.5" y="2298.832">[SAM certificate]</text><polygon fill="#00FF00" points="398.5,2328.8848,388.5,2332.8848,398.5,2336.8848,394.5,2332.8848" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="392.5" x2="1001.5" y1="2332.8848" y2="2332.8848"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="404.5" y="2328.1426">[SAM certificate]</text><polygon fill="#0000FF" points="623.5,2388.8164,633.5,2392.8164,623.5,2396.8164,627.5,2392.8164" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;" x1="387.5" x2="629.5" y1="2392.8164" y2="2392.8164"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="394.5" y="2357.4531">Card #5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="394.5" y="2372.7637">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="426.5" y="2388.0742">- APDU list</text><path d="M578,2407.8164 L874,2407.8164 L874,2415.127 L864,2425.127 L578,2425.127 L578,2407.8164 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="119.2422" style="stroke:#000000;stroke-width:1.5;" width="373.5" x="578" y="2407.8164"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="251" x="593" y="2421.3848">Card APDU commands inside session</text><polygon fill="#181818" points="893.5,2442.4375,903.5,2446.4375,893.5,2450.4375,897.5,2446.4375" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="645.5" x2="899.5" y1="2446.4375" y2="2446.4375"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="168" x="652.5" y="2441.6953">update record (event, data)</text><polygon fill="#181818" points="656.5,2456.4375,646.5,2460.4375,656.5,2464.4375,652.5,2460.4375" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="650.5" x2="904.5" y1="2460.4375" y2="2460.4375"/><polygon fill="#181818" points="893.5,2485.748,903.5,2489.748,893.5,2493.748,897.5,2489.748" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="645.5" x2="899.5" y1="2489.748" y2="2489.748"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="228" x="652.5" y="2485.0059">decrease counter (counter #1, value)</text><polygon fill="#181818" points="656.5,2515.0586,646.5,2519.0586,656.5,2523.0586,652.5,2519.0586" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="650.5" x2="904.5" y1="2519.0586" y2="2519.0586"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="122" x="662.5" y="2514.3164">[new counter value]</text><polygon fill="#181818" points="893.5,2551.3691,903.5,2555.3691,893.5,2559.3691,897.5,2555.3691" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="645.5" x2="899.5" y1="2555.3691" y2="2555.3691"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="236" x="652.5" y="2550.627">close secure session (SAM certificate)</text><polygon fill="#181818" points="656.5,2580.6797,646.5,2584.6797,656.5,2588.6797,652.5,2584.6797" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="650.5" x2="904.5" y1="2584.6797" y2="2584.6797"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="662.5" y="2579.9375">[card certificate]</text><polygon fill="#181818" points="893.5,2609.9902,903.5,2613.9902,893.5,2617.9902,897.5,2613.9902" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="645.5" x2="899.5" y1="2613.9902" y2="2613.9902"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="652.5" y="2609.248">ratification command</text><polygon fill="#181818" points="656.5,2623.9902,646.5,2627.9902,656.5,2631.9902,652.5,2627.9902" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="650.5" x2="904.5" y1="2627.9902" y2="2627.9902"/><polygon fill="#181818" points="893.5,2653.3008,903.5,2657.3008,893.5,2661.3008,897.5,2657.3008" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="645.5" x2="899.5" y1="2657.3008" y2="2657.3008"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="652.5" y="2652.5586">close card channel</text><polygon fill="#181818" points="656.5,2667.3008,646.5,2671.3008,656.5,2675.3008,652.5,2671.3008" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="650.5" x2="909.5" y1="2671.3008" y2="2671.3008"/><polygon fill="#0000FF" points="398.5,2696.6113,388.5,2700.6113,398.5,2704.6113,394.5,2700.6113" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="392.5" x2="639.5" y1="2700.6113" y2="2700.6113"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="404.5" y="2695.8691">[card certificate]</text><polygon fill="#00FF00" points="985.5,2756.543,995.5,2760.543,985.5,2764.543,989.5,2760.543" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;" x1="387.5" x2="991.5" y1="2760.543" y2="2760.543"/><text fill="#008000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="51" x="394.5" y="2725.1797">SAM #4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="394.5" y="2740.4902">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="426.5" y="2755.8008">- APDU list</text><polygon fill="#181818" points="1314.5,2785.8535,1324.5,2789.8535,1314.5,2793.8535,1318.5,2789.8535" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1007.5" x2="1320.5" y1="2789.8535" y2="2789.8535"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="227" x="1014.5" y="2785.1113">digest authenticate (card certificate)</text><polygon fill="#181818" points="1018.5,2815.1641,1008.5,2819.1641,1018.5,2823.1641,1014.5,2819.1641" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1012.5" x2="1325.5" y1="2819.1641" y2="2819.1641"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="142" x="1024.5" y="2814.4219">[authentication status]</text><polygon fill="#00FF00" points="398.5,2844.4746,388.5,2848.4746,398.5,2852.4746,394.5,2848.4746" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="392.5" x2="1001.5" y1="2848.4746" y2="2848.4746"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="404.5" y="2843.7324">[authentification status]</text><polygon fill="#181818" points="96.5,2980.959,86.5,2984.959,96.5,2988.959,92.5,2984.959" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="381.5" y1="2984.959" y2="2984.959"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="102.5" y="2873.043">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127" x="134.5" y="2888.3535">- identification data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="122" x="134.5" y="2903.6641">- environment data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="119" x="134.5" y="2918.9746">- contract list data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="134.5" y="2934.2852">- contract #1 data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="174" x="134.5" y="2949.5957">- counter #1 data (updated)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="133" x="134.5" y="2964.9063">- event #1 (updated)]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="143" x="102.5" y="2980.2168">authentification status</text><!--MD5=[59a55c776c199c07f3c40a62aaafa262]
@startuml

'skinparam ClassBorderColor #F1C40F
skinparam ClassBorderColor #D4AC0D
skinparam stereotypeABorderColor #A9DCDF
skinparam stereotypeIBorderColor #B4A7E5
skinparam stereotypeCBorderColor #ADD1B2
skinparam stereotypeEBorderColor #EB93DF
skinparam shadowing false

skinparam StateBorderColor #D4AC0D
skinparam ActivityBorderColor #D4AC0D

' Red
skinparam ClassBackgroundColor<<red>> #FDEDEC
skinparam ClassBorderColor<<red>> #E74C3C
hide <<red>> stereotype
' Purple
skinparam ClassBackgroundColor<<purple>> #F4ECF7
skinparam ClassBorderColor<<purple>> #8E44AD
hide <<purple>> stereotype
' blue
skinparam ClassBackgroundColor<<blue>> #EBF5FB
skinparam ClassBorderColor<<blue>> #3498DB
hide <<blue>> stereotype
' Green
skinparam ClassBackgroundColor<<green>> #EAFAF1
skinparam ClassBorderColor<<green>> #2ECC71
hide <<green>> stereotype

' Orange
skinparam ClassBackgroundColor<<orange>> #FDF2E9
skinparam ClassBorderColor<<orange>> #E67E22
hide <<orange>> stereotype

' Grey
skinparam ClassBackgroundColor<<grey>> #EAECEE
skinparam ClassBorderColor<<grey>> #2C3E50
hide <<grey>> stereotype

actor "Ticketing Application" as app #gold
participant "Calypso API" as capi #pink
participant "Calypso Card\nReader" as cardReader #lightBlue
boundary "selected\n**Card**" as card #lightBlue
participant "Calypso SAM\nReader" as samReader #lightGreen
boundary "selected\n**SAM**" as sam #lightGreen

activate app #gold
activate card #lightBlue
activate sam #lightGreen

app->app: **instantiate** Calypso card transaction:\n\t- Calypso card resource\n\t- Calypso SAM resource


app->capi: <font color=red>**prepare**</font> card transaction:\n\t- read environment file\n\t- read contract #1\n\t- reader counter #1
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> opening (DEBIT access level)
activate capi  #pink

capi-[#00FF00]>samReader: <font color=green>**SAM #1**<font color=red>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen

samReader->sam: select diversifier (card serial)
sam- ->samReader
samReader->sam: get challenge
sam- ->samReader: [SAM challenge]
samReader-[#00FF00]->capi: [SAM challenge]
deactivate samReader

capi-[#0000FF]>cardReader: <font color=blue>**Card #2**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: open secure session (card debit key,\n\tSAM challenge,\n\tSFI environment to read)
    card- ->cardReader: [card challenge & environment data]
    cardReader->card: read record (contract #1)
    card- ->cardReader: [contract #1 data]
    cardReader->card: read record (counter #1)
    card- ->cardReader: [counter #1 data]
end

cardReader- -[#0000FF]>capi: [card challenge]
deactivate cardReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- environment data (updated)\n\t- contract list data\n\t- contract #1 data\n\t- counter #1 data]
deactivate capi






app->capi: <font color=red>**process**</font> Verify PIN (plain PIN value)
activate capi  #pink

capi-[#0000FF]>cardReader: <font color=blue>**Card #3**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: Get Challenge
    card- ->cardReader: [PIN Card challenge]
end

cardReader- -[#0000FF]>capi: [Card challenge]
deactivate cardReader

capi-[#00FF00]>samReader: <font color=green>**SAM #2**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen


note over samReader
    When ciphered PIN verification requested, processes all pending SAM commands.
end note

samReader->sam: digest init (opening data)
sam- ->samReader
samReader->sam: digest update (read environment)
sam- ->samReader
samReader->sam: digest update (read contract)
sam- ->samReader
samReader->sam: digest update (read counter)
sam- ->samReader

note over samReader
    Diversification for the PIN ciphering is necessarily the same as for the secure session.
end note

samReader->sam: Give Random (PIN card challenge)
sam- ->samReader: ack
samReader->sam: Card Cipher PIN (plain PIN, debit key reference)
sam- ->samReader: [ciphered PIN]

samReader-[#00FF00]->capi: [ciphered PIN]
deactivate samReader

capi-[#0000FF]>cardReader: <font color=blue>**Card #4**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: Verify PIN (ciphered PIN)
    card- ->cardReader: [PIN status]
end

cardReader-[#0000FF]->capi: [PIN status]
deactivate cardReader

capi- ->app: [Calypso card image:\n\t- identification data with PIN support\n\t- key #1 reference (updated)\n\t- key #2 reference\n\t- key #3 reference]
deactivate capi


app->capi: <font color=red>**prepare**</font>:\n\t- decrease counter #1 (value)\n\t- append event record (data)\n\t- release channel
activate capi  #pink
capi- ->app
deactivate capi

note over capi
    At the session closure, any data secure processing should be unnecessary.
end note

app->capi: <font color=red>**process**</font> closing (not ratified)
activate capi  #pink
capi->capi: anticipates the future card responses

capi-[#00FF00]>samReader: <font color=green>**SAM #3**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen

samReader->sam: digest update (verify PIN)
sam- ->samReader

group <font color=red>**anticipated**</font> Card APDU responses
    samReader->sam: digest update (decrease counter)
    sam- ->samReader
    samReader->sam: digest update (append event record)
    sam- ->samReader
end
samReader->sam: digest close
sam- ->samReader: [SAM certificate]

samReader-[#00FF00]->capi: [SAM certificate]
deactivate samReader

capi-[#0000FF]>cardReader: <font color=blue>**Card #5**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: update record (event, data)
    card- ->cardReader
    cardReader->card: decrease counter (counter #1, value)
    card- ->cardReader: [new counter value]
end

cardReader->card: close secure session (SAM certificate)
card- ->cardReader: [card certificate]
cardReader->card: ratification command
card- ->cardReader
cardReader->card: close card channel
card- ->cardReader
deactivate card

cardReader-[#0000FF]->capi: [card certificate]
deactivate cardReader

capi-[#00FF00]>samReader: <font color=green>**SAM #4**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: digest authenticate (card certificate)
sam- ->samReader: [authentication status]

samReader-[#00FF00]->capi: [authentification status]
deactivate samReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- environment data\n\t- contract list data\n\t- contract #1 data\n\t- counter #1 data (updated)\n\t- event #1 (updated)]\nauthentification status
deactivate capi
@enduml

@startuml

skinparam ClassBorderColor #D4AC0D
skinparam stereotypeABorderColor #A9DCDF
skinparam stereotypeIBorderColor #B4A7E5
skinparam stereotypeCBorderColor #ADD1B2
skinparam stereotypeEBorderColor #EB93DF
skinparam shadowing false

skinparam StateBorderColor #D4AC0D
skinparam ActivityBorderColor #D4AC0D

skinparam ClassBackgroundColor<<red>> #FDEDEC
skinparam ClassBorderColor<<red>> #E74C3C
hide <<red>> stereotype
skinparam ClassBackgroundColor<<purple>> #F4ECF7
skinparam ClassBorderColor<<purple>> #8E44AD
hide <<purple>> stereotype
skinparam ClassBackgroundColor<<blue>> #EBF5FB
skinparam ClassBorderColor<<blue>> #3498DB
hide <<blue>> stereotype
skinparam ClassBackgroundColor<<green>> #EAFAF1
skinparam ClassBorderColor<<green>> #2ECC71
hide <<green>> stereotype

skinparam ClassBackgroundColor<<orange>> #FDF2E9
skinparam ClassBorderColor<<orange>> #E67E22
hide <<orange>> stereotype

skinparam ClassBackgroundColor<<grey>> #EAECEE
skinparam ClassBorderColor<<grey>> #2C3E50
hide <<grey>> stereotype

actor "Ticketing Application" as app #gold
participant "Calypso API" as capi #pink
participant "Calypso Card\nReader" as cardReader #lightBlue
boundary "selected\n**Card**" as card #lightBlue
participant "Calypso SAM\nReader" as samReader #lightGreen
boundary "selected\n**SAM**" as sam #lightGreen

activate app #gold
activate card #lightBlue
activate sam #lightGreen

app->app: **instantiate** Calypso card transaction:\n\t- Calypso card resource\n\t- Calypso SAM resource


app->capi: <font color=red>**prepare**</font> card transaction:\n\t- read environment file\n\t- read contract #1\n\t- reader counter #1
activate capi  #pink
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> opening (DEBIT access level)
activate capi  #pink

capi-[#00FF00]>samReader: <font color=green>**SAM #1**<font color=red>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen

samReader->sam: select diversifier (card serial)
sam- ->samReader
samReader->sam: get challenge
sam- ->samReader: [SAM challenge]
samReader-[#00FF00]->capi: [SAM challenge]
deactivate samReader

capi-[#0000FF]>cardReader: <font color=blue>**Card #2**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: open secure session (card debit key,\n\tSAM challenge,\n\tSFI environment to read)
    card- ->cardReader: [card challenge & environment data]
    cardReader->card: read record (contract #1)
    card- ->cardReader: [contract #1 data]
    cardReader->card: read record (counter #1)
    card- ->cardReader: [counter #1 data]
end

cardReader- -[#0000FF]>capi: [card challenge]
deactivate cardReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- environment data (updated)\n\t- contract list data\n\t- contract #1 data\n\t- counter #1 data]
deactivate capi






app->capi: <font color=red>**process**</font> Verify PIN (plain PIN value)
activate capi  #pink

capi-[#0000FF]>cardReader: <font color=blue>**Card #3**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: Get Challenge
    card- ->cardReader: [PIN Card challenge]
end

cardReader- -[#0000FF]>capi: [Card challenge]
deactivate cardReader

capi-[#00FF00]>samReader: <font color=green>**SAM #2**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen


note over samReader
    When ciphered PIN verification requested, processes all pending SAM commands.
end note

samReader->sam: digest init (opening data)
sam- ->samReader
samReader->sam: digest update (read environment)
sam- ->samReader
samReader->sam: digest update (read contract)
sam- ->samReader
samReader->sam: digest update (read counter)
sam- ->samReader

note over samReader
    Diversification for the PIN ciphering is necessarily the same as for the secure session.
end note

samReader->sam: Give Random (PIN card challenge)
sam- ->samReader: ack
samReader->sam: Card Cipher PIN (plain PIN, debit key reference)
sam- ->samReader: [ciphered PIN]

samReader-[#00FF00]->capi: [ciphered PIN]
deactivate samReader

capi-[#0000FF]>cardReader: <font color=blue>**Card #4**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: Verify PIN (ciphered PIN)
    card- ->cardReader: [PIN status]
end

cardReader-[#0000FF]->capi: [PIN status]
deactivate cardReader

capi- ->app: [Calypso card image:\n\t- identification data with PIN support\n\t- key #1 reference (updated)\n\t- key #2 reference\n\t- key #3 reference]
deactivate capi


app->capi: <font color=red>**prepare**</font>:\n\t- decrease counter #1 (value)\n\t- append event record (data)\n\t- release channel
activate capi  #pink
capi- ->app
deactivate capi

note over capi
    At the session closure, any data secure processing should be unnecessary.
end note

app->capi: <font color=red>**process**</font> closing (not ratified)
activate capi  #pink
capi->capi: anticipates the future card responses

capi-[#00FF00]>samReader: <font color=green>**SAM #3**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen

samReader->sam: digest update (verify PIN)
sam- ->samReader

group <font color=red>**anticipated**</font> Card APDU responses
    samReader->sam: digest update (decrease counter)
    sam- ->samReader
    samReader->sam: digest update (append event record)
    sam- ->samReader
end
samReader->sam: digest close
sam- ->samReader: [SAM certificate]

samReader-[#00FF00]->capi: [SAM certificate]
deactivate samReader

capi-[#0000FF]>cardReader: <font color=blue>**Card #5**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: update record (event, data)
    card- ->cardReader
    cardReader->card: decrease counter (counter #1, value)
    card- ->cardReader: [new counter value]
end

cardReader->card: close secure session (SAM certificate)
card- ->cardReader: [card certificate]
cardReader->card: ratification command
card- ->cardReader
cardReader->card: close card channel
card- ->cardReader
deactivate card

cardReader-[#0000FF]->capi: [card certificate]
deactivate cardReader

capi-[#00FF00]>samReader: <font color=green>**SAM #4**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: digest authenticate (card certificate)
sam- ->samReader: [authentication status]

samReader-[#00FF00]->capi: [authentification status]
deactivate samReader

capi- ->app: [Calypso card image:\n\t- identification data\n\t- environment data\n\t- contract list data\n\t- contract #1 data\n\t- counter #1 data (updated)\n\t- event #1 (updated)]\nauthentification status
deactivate capi
@enduml

PlantUML version 1.2022.4(Sat Apr 09 17:29:17 RET 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: fr
Country: FR
--></g></svg>