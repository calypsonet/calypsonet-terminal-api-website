<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="2218px" preserveAspectRatio="none" style="width:1493px;height:2218px;background:#FFFFFF;" version="1.1" viewBox="0 0 1493 2218" width="1493px" zoomAndPan="magnify"><defs/><g><rect fill="#FFD700" height="2036.5332" style="stroke:#181818;stroke-width:1.0;" width="10" x="75.5" y="91.4883"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="371.5" y="237.3516"/><rect fill="#FFC0CB" height="90.5527" style="stroke:#181818;stroke-width:1.0;" width="10" x="371.5" y="705.3203"/><rect fill="#FFC0CB" height="49.3105" style="stroke:#181818;stroke-width:1.0;" width="10" x="371.5" y="992.0469"/><rect fill="#FFC0CB" height="238.416" style="stroke:#181818;stroke-width:1.0;" width="10" x="371.5" y="1070.668"/><rect fill="#FFC0CB" height="49.3105" style="stroke:#181818;stroke-width:1.0;" width="10" x="371.5" y="1369.0156"/><rect fill="#FFC0CB" height="671.3848" style="stroke:#181818;stroke-width:1.0;" width="10" x="371.5" y="1447.6367"/><rect fill="#FFC0CB" height="395.3477" style="stroke:#181818;stroke-width:1.0;" width="10" x="472.5" y="280.6621"/><rect fill="#ADD8E6" height="290.7949" style="stroke:#181818;stroke-width:1.0;" width="10" x="672.5" y="355.9043"/><rect fill="#ADD8E6" height="87.9316" style="stroke:#181818;stroke-width:1.0;" width="10" x="672.5" y="1130.5996"/><rect fill="#ADD8E6" height="166.5527" style="stroke:#181818;stroke-width:1.0;" width="10" x="672.5" y="1698.7422"/><rect fill="#ADD8E6" height="1450.7695" style="stroke:#181818;stroke-width:1.0;" width="10" x="1016.5" y="385.2148"/><rect fill="#90EE90" height="131.2422" style="stroke:#181818;stroke-width:1.0;" width="10" x="1102" y="1507.5684"/><rect fill="#90EE90" height="87.9316" style="stroke:#181818;stroke-width:1.0;" width="10" x="1102" y="1925.2266"/><rect fill="#90EE90" height="2036.5332" style="stroke:#181818;stroke-width:1.0;" width="10" x="1445" y="91.4883"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="80" x2="80" y1="81.4883" y2="2137.0215"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="376.5" x2="376.5" y1="81.4883" y2="2137.0215"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="477.5" x2="477.5" y1="81.4883" y2="2137.0215"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="677" x2="677" y1="81.4883" y2="2137.0215"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1021" x2="1021" y1="81.4883" y2="2137.0215"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1107" x2="1107" y1="81.4883" y2="2137.0215"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1450" x2="1450" y1="81.4883" y2="2137.0215"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="145" x="5" y="78.5352">Ticketing Application</text><ellipse cx="80.5" cy="13.5" fill="#FFD700" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M80.5,21.5 L80.5,48.5 M67.5,29.5 L93.5,29.5 M80.5,48.5 L67.5,63.5 M80.5,48.5 L93.5,63.5 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="145" x="5" y="2149.5566">Ticketing Application</text><ellipse cx="80.5" cy="2161.0098" fill="#FFD700" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M80.5,2169.0098 L80.5,2196.0098 M67.5,2177.0098 L93.5,2177.0098 M80.5,2196.0098 L67.5,2211.0098 M80.5,2196.0098 L93.5,2211.0098 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#FFC0CB" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="94" x="329.5" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="80" x="336.5" y="70.5352">Calypso API</text><rect fill="#FFC0CB" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="94" x="329.5" y="2136.0215"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="80" x="336.5" y="2156.5566">Calypso API</text><rect fill="#FFC0CB" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="88" x="433.5" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="74" x="440.5" y="70.5352">Reader API</text><rect fill="#FFC0CB" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="88" x="433.5" y="2136.0215"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="74" x="440.5" y="2156.5566">Reader API</text><rect fill="#ADD8E6" height="46.9766" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="105" x="625" y="33.5117"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="632" y="54.0469">Calypso Card</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48" x="653.5" y="70.5352">Reader</text><rect fill="#ADD8E6" height="46.9766" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="105" x="625" y="2136.0215"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="632" y="2156.5566">Calypso Card</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48" x="653.5" y="2173.0449">Reader</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="33" x="1002" y="78.5352">Card</text><path d="M1001,37 L1001,61 M1001,49 L1018,49 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><ellipse cx="1030" cy="49" fill="#ADD8E6" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="33" x="1002" y="2149.5566">Card</text><path d="M1001,2156.5098 L1001,2180.5098 M1001,2168.5098 L1018,2168.5098 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><ellipse cx="1030" cy="2168.5098" fill="#ADD8E6" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#90EE90" height="46.9766" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="102" x="1056" y="33.5117"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="88" x="1063" y="54.0469">Calypso SAM</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48" x="1083" y="70.5352">Reader</text><rect fill="#90EE90" height="46.9766" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="102" x="1056" y="2136.0215"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="88" x="1063" y="2156.5566">Calypso SAM</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48" x="1083" y="2173.0449">Reader</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="1419" y="62.0469">selected</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="31" x="1431.5" y="78.5352">SAM</text><path d="M1429.5,20.5117 L1429.5,44.5117 M1429.5,32.5117 L1446.5,32.5117 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><ellipse cx="1458.5" cy="32.5117" fill="#90EE90" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="1419" y="2149.5566">selected</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="31" x="1431.5" y="2166.0449">SAM</text><path d="M1429.5,2172.998 L1429.5,2196.998 M1429.5,2184.998 L1446.5,2184.998 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><ellipse cx="1458.5" cy="2184.998" fill="#90EE90" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#FFD700" height="2036.5332" style="stroke:#181818;stroke-width:1.0;" width="10" x="75.5" y="91.4883"/><rect fill="#FFC0CB" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="371.5" y="237.3516"/><rect fill="#FFC0CB" height="90.5527" style="stroke:#181818;stroke-width:1.0;" width="10" x="371.5" y="705.3203"/><rect fill="#FFC0CB" height="49.3105" style="stroke:#181818;stroke-width:1.0;" width="10" x="371.5" y="992.0469"/><rect fill="#FFC0CB" height="238.416" style="stroke:#181818;stroke-width:1.0;" width="10" x="371.5" y="1070.668"/><rect fill="#FFC0CB" height="49.3105" style="stroke:#181818;stroke-width:1.0;" width="10" x="371.5" y="1369.0156"/><rect fill="#FFC0CB" height="671.3848" style="stroke:#181818;stroke-width:1.0;" width="10" x="371.5" y="1447.6367"/><rect fill="#FFC0CB" height="395.3477" style="stroke:#181818;stroke-width:1.0;" width="10" x="472.5" y="280.6621"/><rect fill="#ADD8E6" height="290.7949" style="stroke:#181818;stroke-width:1.0;" width="10" x="672.5" y="355.9043"/><rect fill="#ADD8E6" height="87.9316" style="stroke:#181818;stroke-width:1.0;" width="10" x="672.5" y="1130.5996"/><rect fill="#ADD8E6" height="166.5527" style="stroke:#181818;stroke-width:1.0;" width="10" x="672.5" y="1698.7422"/><rect fill="#ADD8E6" height="1450.7695" style="stroke:#181818;stroke-width:1.0;" width="10" x="1016.5" y="385.2148"/><rect fill="#90EE90" height="131.2422" style="stroke:#181818;stroke-width:1.0;" width="10" x="1102" y="1507.5684"/><rect fill="#90EE90" height="87.9316" style="stroke:#181818;stroke-width:1.0;" width="10" x="1102" y="1925.2266"/><rect fill="#90EE90" height="2036.5332" style="stroke:#181818;stroke-width:1.0;" width="10" x="1445" y="91.4883"/><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1486" x="0" y="112.1436"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1486" y1="112.1436" y2="112.1436"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1486" y1="115.1436" y2="115.1436"/><rect fill="#EEEEEE" height="23.3105" style="stroke:#000000;stroke-width:2.0;" width="221" x="632.5" y="101.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="203" x="638.5" y="118.0566">Card selection &amp; identification</text><path d="M133,139.7988 L133,164.7988 L620,164.7988 L620,149.7988 L610,139.7988 L133,139.7988 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M610,139.7988 L610,149.7988 L620,149.7988 L610,139.7988 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="466" x="139" y="157.3672">Reads the environment data present in all the cards targeted for selection.</text><polygon fill="#181818" points="359.5,233.3516,369.5,237.3516,359.5,241.3516,363.5,237.3516" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="365.5" y1="237.3516" y2="237.3516"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="92.5" y="186.6777">prepare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="149" x="150.5" y="186.6777">card selection scenario:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="141" x="124.5" y="201.9883">- filter by specific AID</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="136" x="124.5" y="217.2988">- read SV Load record</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="147" x="124.5" y="232.6094">- read SV Debit records</text><polygon fill="#181818" points="96.5,247.3516,86.5,251.3516,96.5,255.3516,92.5,251.3516" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="375.5" y1="251.3516" y2="251.3516"/><polygon fill="#181818" points="460.5,276.6621,470.5,280.6621,460.5,284.6621,464.5,280.6621" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="466.5" y1="280.6621" y2="280.6621"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="92.5" y="275.9199">process</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="196" x="148.5" y="275.9199">explicit card selection scenario</text><polygon fill="#0000FF" points="660.5,351.9043,670.5,355.9043,660.5,359.9043,664.5,355.9043" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;" x1="482.5" x2="666.5" y1="355.9043" y2="355.9043"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="489.5" y="305.2305">Card #1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="165" x="489.5" y="320.541">transmit selection request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="93" x="521.5" y="335.8516">- card selector</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="521.5" y="351.1621">- APDU list</text><polygon fill="#181818" points="1004.5,381.2148,1014.5,385.2148,1004.5,389.2148,1008.5,385.2148" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="682.5" x2="1010.5" y1="385.2148" y2="385.2148"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="689.5" y="380.4727">open card channel</text><polygon fill="#181818" points="693.5,395.2148,683.5,399.2148,693.5,403.2148,689.5,399.2148" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="687.5" x2="1015.5" y1="399.2148" y2="399.2148"/><polygon fill="#181818" points="1004.5,424.5254,1014.5,428.5254,1004.5,432.5254,1008.5,428.5254" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="682.5" x2="1010.5" y1="428.5254" y2="428.5254"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="142" x="689.5" y="423.7832">select application (aid)</text><polygon fill="#181818" points="693.5,453.8359,683.5,457.8359,693.5,461.8359,689.5,457.8359" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="687.5" x2="1015.5" y1="457.8359" y2="457.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="59" x="699.5" y="453.0938">[card FCI]</text><line style="stroke:#181818;stroke-width:1.0;" x1="682.5" x2="724.5" y1="487.1465" y2="487.1465"/><line style="stroke:#181818;stroke-width:1.0;" x1="724.5" x2="724.5" y1="487.1465" y2="500.1465"/><line style="stroke:#181818;stroke-width:1.0;" x1="683.5" x2="724.5" y1="500.1465" y2="500.1465"/><polygon fill="#181818" points="693.5,496.1465,683.5,500.1465,693.5,504.1465,689.5,500.1465" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="165" x="689.5" y="482.4043">checks invalidation status</text><polygon fill="#181818" points="1004.5,525.457,1014.5,529.457,1004.5,533.457,1008.5,529.457" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="682.5" x2="1010.5" y1="529.457" y2="529.457"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="176" x="689.5" y="524.7148">read record (SV Load record)</text><polygon fill="#181818" points="693.5,554.7676,683.5,558.7676,693.5,562.7676,689.5,558.7676" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="687.5" x2="1015.5" y1="558.7676" y2="558.7676"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="101" x="699.5" y="554.0254">[SV Load record]</text><polygon fill="#181818" points="1004.5,584.0781,1014.5,588.0781,1004.5,592.0781,1008.5,588.0781" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="682.5" x2="1010.5" y1="588.0781" y2="588.0781"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="187" x="689.5" y="583.3359">read record (SV Debit records)</text><polygon fill="#181818" points="693.5,613.3887,683.5,617.3887,693.5,621.3887,689.5,617.3887" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="687.5" x2="1015.5" y1="617.3887" y2="617.3887"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="108" x="699.5" y="612.6465">[SV Load records]</text><polygon fill="#0000FF" points="493.5,642.6992,483.5,646.6992,493.5,650.6992,489.5,646.6992" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="487.5" x2="676.5" y1="646.6992" y2="646.6992"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="166" x="499.5" y="641.957">receive selection response</text><polygon fill="#181818" points="96.5,672.0098,86.5,676.0098,96.5,680.0098,92.5,676.0098" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="476.5" y1="676.0098" y2="676.0098"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="204" x="102.5" y="671.2676">selected active SmartCard image</text><polygon fill="#181818" points="359.5,701.3203,369.5,705.3203,359.5,709.3203,363.5,705.3203" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="365.5" y1="705.3203" y2="705.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="27" x="92.5" y="700.5781">cast</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="81" x="123.5" y="700.5781">Calypso card</text><polygon fill="#181818" points="96.5,791.873,86.5,795.873,96.5,799.873,92.5,795.873" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="375.5" y1="795.873" y2="795.873"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="102.5" y="729.8887">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="230" x="134.5" y="745.1992">- identification data with SV support</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="92" x="134.5" y="760.5098">- SV Load data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="96" x="134.5" y="775.8203">- SV Debit data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="83" x="134.5" y="791.1309">- SV balance]</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1486" x="0" y="824.5283"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1486" y1="824.5283" y2="824.5283"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1486" y1="827.5283" y2="827.5283"/><rect fill="#EEEEEE" height="23.3105" style="stroke:#000000;stroke-width:2.0;" width="179" x="653.5" y="813.873"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="161" x="659.5" y="830.4414">Card secure transaction</text><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="127.5" y1="899.1152" y2="899.1152"/><line style="stroke:#181818;stroke-width:1.0;" x1="127.5" x2="127.5" y1="899.1152" y2="912.1152"/><line style="stroke:#181818;stroke-width:1.0;" x1="86.5" x2="127.5" y1="912.1152" y2="912.1152"/><polygon fill="#181818" points="96.5,908.1152,86.5,912.1152,96.5,916.1152,92.5,912.1152" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="72" x="92.5" y="863.752">instantiate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="168.5" y="863.752">Calypso card transaction:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="124.5" y="879.0625">- Calypso card resource</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="124.5" y="894.373">- Calypso SAM resource</text><path d="M118,925.1152 L118,950.1152 L635,950.1152 L635,935.1152 L625,925.1152 L118,925.1152 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M625,925.1152 L625,935.1152 L635,935.1152 L625,925.1152 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="496" x="124" y="942.6836">Reads again the Stored Value Load record to initiate a Stored Value transaction.</text><polygon fill="#181818" points="359.5,988.0469,369.5,992.0469,359.5,996.0469,363.5,992.0469" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="365.5" y1="992.0469" y2="992.0469"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="92.5" y="971.9941">prepare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="106" x="150.5" y="971.9941">card transaction:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="108" x="124.5" y="987.3047">- SV Get for Load</text><path d="M125,1005.0469 L125,1030.0469 L627,1030.0469 L627,1015.0469 L617,1005.0469 L125,1005.0469 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M617,1005.0469 L617,1015.0469 L627,1015.0469 L617,1005.0469 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="175" x="131" y="1022.6152">SV Get for Debit prepared in</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="24" x="310" y="1022.6152">last</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="274" x="338" y="1022.6152">position of a card command set to process.</text><polygon fill="#181818" points="96.5,1037.3574,86.5,1041.3574,96.5,1045.3574,92.5,1041.3574" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="375.5" y1="1041.3574" y2="1041.3574"/><polygon fill="#181818" points="359.5,1066.668,369.5,1070.668,359.5,1074.668,363.5,1070.668" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="365.5" y1="1070.668" y2="1070.668"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="92.5" y="1065.9258">process</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="69" x="148.5" y="1065.9258">commands</text><polygon fill="#0000FF" points="660.5,1126.5996,670.5,1130.5996,660.5,1134.5996,664.5,1130.5996" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;" x1="381.5" x2="666.5" y1="1130.5996" y2="1130.5996"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="388.5" y="1095.2363">Card #2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="388.5" y="1110.5469">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="420.5" y="1125.8574">- APDU list</text><polygon fill="#181818" points="1004.5,1155.9102,1014.5,1159.9102,1004.5,1163.9102,1008.5,1159.9102" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="682.5" x2="1010.5" y1="1159.9102" y2="1159.9102"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="104" x="689.5" y="1155.168">SV Get (for Load)</text><polygon fill="#181818" points="693.5,1185.2207,683.5,1189.2207,693.5,1193.2207,689.5,1189.2207" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="687.5" x2="1015.5" y1="1189.2207" y2="1189.2207"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="221" x="699.5" y="1184.4785">[SV Load record, SV Card challenge]</text><polygon fill="#0000FF" points="392.5,1214.5313,382.5,1218.5313,392.5,1222.5313,388.5,1218.5313" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="386.5" x2="676.5" y1="1218.5313" y2="1218.5313"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="398.5" y="1213.7891">[SV Card challenge]</text><polygon fill="#181818" points="96.5,1305.084,86.5,1309.084,96.5,1313.084,92.5,1309.084" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="375.5" y1="1309.084" y2="1309.084"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="102.5" y="1243.0996">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="230" x="134.5" y="1258.4102">- identification data with SV support</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="155" x="134.5" y="1273.7207">- SV Load data (updated)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="96" x="134.5" y="1289.0313">- SV Debit data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="146" x="134.5" y="1304.3418">- SV balance (updated)]</text><polygon fill="#181818" points="359.5,1365.0156,369.5,1369.0156,359.5,1373.0156,363.5,1369.0156" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="365.5" y1="1369.0156" y2="1369.0156"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="92.5" y="1333.6523">prepare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="106" x="150.5" y="1333.6523">card transaction:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="174" x="124.5" y="1348.9629">- SV Load (specific amount)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="109" x="124.5" y="1364.2734">- release channel</text><path d="M147,1382.0156 L147,1407.0156 L605,1407.0156 L605,1392.0156 L595,1382.0156 L147,1382.0156 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M595,1382.0156 L595,1392.0156 L605,1392.0156 L595,1382.0156 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="128" x="153" y="1399.584">SV Debit prepared in</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="27" x="285" y="1399.584">first</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="274" x="316" y="1399.584">position of a card command set to process.</text><polygon fill="#181818" points="96.5,1414.3262,86.5,1418.3262,96.5,1422.3262,92.5,1418.3262" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="375.5" y1="1418.3262" y2="1418.3262"/><polygon fill="#181818" points="359.5,1443.6367,369.5,1447.6367,359.5,1451.6367,363.5,1447.6367" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="365.5" y1="1447.6367" y2="1447.6367"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="92.5" y="1442.8945">process</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="69" x="148.5" y="1442.8945">commands</text><polygon fill="#00FF00" points="1090,1503.5684,1100,1507.5684,1090,1511.5684,1094,1507.5684" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;" x1="381.5" x2="1096" y1="1507.5684" y2="1507.5684"/><text fill="#008000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="51" x="388.5" y="1472.2051">SAM #1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="388.5" y="1487.5156">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="420.5" y="1502.8262">- APDU list</text><polygon fill="#181818" points="1433,1532.8789,1443,1536.8789,1433,1540.8789,1437,1536.8789" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1112" x2="1439" y1="1536.8789" y2="1536.8789"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="181" x="1119" y="1532.1367">select diversifier (card serial)</text><polygon fill="#181818" points="1123,1546.8789,1113,1550.8789,1123,1554.8789,1119,1550.8789" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1117" x2="1444" y1="1550.8789" y2="1550.8789"/><polygon fill="#181818" points="1433,1576.1895,1443,1580.1895,1433,1584.1895,1437,1580.1895" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1112" x2="1439" y1="1580.1895" y2="1580.1895"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="309" x="1119" y="1575.4473">SV prepare Load (SV card challenge, load amount)</text><polygon fill="#181818" points="1123,1605.5,1113,1609.5,1123,1613.5,1119,1609.5" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1117" x2="1444" y1="1609.5" y2="1609.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="239" x="1129" y="1604.7578">[SV SAM challenge, SV SAM certificate]</text><polygon fill="#00FF00" points="392.5,1634.8105,382.5,1638.8105,392.5,1642.8105,388.5,1638.8105" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="386.5" x2="1106" y1="1638.8105" y2="1638.8105"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="398.5" y="1634.0684">[SAM challenge, SAM certificate]</text><polygon fill="#0000FF" points="660.5,1694.7422,670.5,1698.7422,660.5,1702.7422,664.5,1698.7422" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;" x1="381.5" x2="666.5" y1="1698.7422" y2="1698.7422"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="54" x="388.5" y="1663.3789">Card #3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="388.5" y="1678.6895">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="420.5" y="1694">- APDU list</text><path d="M403,1711.7422 L403,1736.7422 L952,1736.7422 L952,1721.7422 L942,1711.7422 L403,1711.7422 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M942,1711.7422 L942,1721.7422 L952,1721.7422 L942,1711.7422 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="103" x="409" y="1729.3105">SV Debit follows</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="59" x="516" y="1729.3105">directely</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="358" x="579" y="1729.3105">a previously transmitted SV Get for Debit card command.</text><polygon fill="#181818" points="1004.5,1759.3633,1014.5,1763.3633,1004.5,1767.3633,1008.5,1763.3633" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="682.5" x2="1010.5" y1="1763.3633" y2="1763.3633"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="310" x="689.5" y="1758.6211">SV Load (amount, SAM challenge, SAM certificate)</text><polygon fill="#181818" points="693.5,1788.6738,683.5,1792.6738,693.5,1796.6738,689.5,1792.6738" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="687.5" x2="1015.5" y1="1792.6738" y2="1792.6738"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="208" x="699.5" y="1787.9316">[new balance, SV Card certificate]</text><polygon fill="#181818" points="1004.5,1817.9844,1014.5,1821.9844,1004.5,1825.9844,1008.5,1821.9844" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="682.5" x2="1010.5" y1="1821.9844" y2="1821.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="689.5" y="1817.2422">close card channel</text><polygon fill="#181818" points="693.5,1831.9844,683.5,1835.9844,693.5,1839.9844,689.5,1835.9844" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="687.5" x2="1020.5" y1="1835.9844" y2="1835.9844"/><polygon fill="#0000FF" points="392.5,1861.2949,382.5,1865.2949,392.5,1869.2949,388.5,1865.2949" style="stroke:#0000FF;stroke-width:1.0;"/><line style="stroke:#0000FF;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="386.5" x2="676.5" y1="1865.2949" y2="1865.2949"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="398.5" y="1860.5527">[card certificate]</text><polygon fill="#00FF00" points="1090,1921.2266,1100,1925.2266,1090,1929.2266,1094,1925.2266" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;" x1="381.5" x2="1096" y1="1925.2266" y2="1925.2266"/><text fill="#008000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="51" x="388.5" y="1889.8633">SAM #2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="388.5" y="1905.1738">transmit card request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="420.5" y="1920.4844">- APDU list</text><polygon fill="#181818" points="1433,1950.5371,1443,1954.5371,1433,1958.5371,1437,1954.5371" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1112" x2="1439" y1="1954.5371" y2="1954.5371"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="164" x="1119" y="1949.7949">SV Check (card certificate)</text><polygon fill="#181818" points="1123,1979.8477,1113,1983.8477,1123,1987.8477,1119,1983.8477" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1117" x2="1444" y1="1983.8477" y2="1983.8477"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="142" x="1129" y="1979.1055">[authentication status]</text><polygon fill="#00FF00" points="392.5,2009.1582,382.5,2013.1582,392.5,2017.1582,388.5,2013.1582" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="386.5" x2="1106" y1="2013.1582" y2="2013.1582"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="398.5" y="2008.416">[authentification status]</text><polygon fill="#181818" points="96.5,2115.0215,86.5,2119.0215,96.5,2123.0215,92.5,2119.0215" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="375.5" y1="2119.0215" y2="2119.0215"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="102.5" y="2037.7266">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="230" x="134.5" y="2053.0371">- identification data with SV support</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="155" x="134.5" y="2068.3477">- SV Load data (updated)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="96" x="134.5" y="2083.6582">- SV Debit data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="146" x="134.5" y="2098.9688">- SV balance (updated)]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="143" x="102.5" y="2114.2793">authentification status</text><!--MD5=[93ac0dda0ec3ee6e451544fa247cfed4]
@startuml

'skinparam ClassBorderColor #F1C40F
skinparam ClassBorderColor #D4AC0D
skinparam stereotypeABorderColor #A9DCDF
skinparam stereotypeIBorderColor #B4A7E5
skinparam stereotypeCBorderColor #ADD1B2
skinparam stereotypeEBorderColor #EB93DF
skinparam shadowing false

skinparam StateBorderColor #D4AC0D
skinparam ActivityBorderColor #D4AC0D

' Red
skinparam ClassBackgroundColor<<red>> #FDEDEC
skinparam ClassBorderColor<<red>> #E74C3C
hide <<red>> stereotype
' Purple
skinparam ClassBackgroundColor<<purple>> #F4ECF7
skinparam ClassBorderColor<<purple>> #8E44AD
hide <<purple>> stereotype
' blue
skinparam ClassBackgroundColor<<blue>> #EBF5FB
skinparam ClassBorderColor<<blue>> #3498DB
hide <<blue>> stereotype
' Green
skinparam ClassBackgroundColor<<green>> #EAFAF1
skinparam ClassBorderColor<<green>> #2ECC71
hide <<green>> stereotype

' Orange
skinparam ClassBackgroundColor<<orange>> #FDF2E9
skinparam ClassBorderColor<<orange>> #E67E22
hide <<orange>> stereotype

' Grey
skinparam ClassBackgroundColor<<grey>> #EAECEE
skinparam ClassBorderColor<<grey>> #2C3E50
hide <<grey>> stereotype

actor "Ticketing Application" as app #gold
participant "Calypso API" as capi #pink
participant "Reader API" as rapi #pink
participant "Calypso Card\nReader" as cardReader #lightBlue
boundary "**Card**" as card #lightBlue
participant "Calypso SAM\nReader" as samReader #lightGreen
boundary "selected\n**SAM**" as sam #lightGreen

activate app #gold
activate sam #lightGreen

== Card selection & identification ==

note over capi
    Reads the environment data present in all the cards targeted for selection.
end note

app->capi: <font color=red>**prepare**</font> card selection scenario:\n\t- filter by specific AID\n\t- read SV Load record\n\t- read SV Debit records
activate capi  #pink
capi- ->app
deactivate capi

app->rapi: <font color=red>**process**</font> explicit card selection scenario
activate rapi  #pink
rapi-[#0000FF]>cardReader: <font color=blue>**Card #1**</font>\ntransmit selection request\n\t- card selector\n\t- APDU list
activate cardReader #lightBlue

cardReader->card: open card channel
activate card #lightBlue
card- ->cardReader
cardReader->card: select application (aid)
card- ->cardReader: [card FCI]
cardReader->cardReader: checks invalidation status

'group Card APDU commands outside secure session
    cardReader->card: read record (SV Load record)
    card- ->cardReader: [SV Load record]
    cardReader->card: read record (SV Debit records)
    card- ->cardReader: [SV Load records]
'end

cardReader- -[#0000FF]>rapi: receive selection response
deactivate cardReader

rapi- ->app: selected active SmartCard image
deactivate rapi

app->capi: **cast** Calypso card
activate capi  #pink
capi- ->app: [Calypso card image:\n\t- identification data with SV support\n\t- SV Load data\n\t- SV Debit data\n\t- SV balance]

deactivate capi

== Card secure transaction ==

app->app: **instantiate** Calypso card transaction:\n\t- Calypso card resource\n\t- Calypso SAM resource

note over capi
    Reads again the Stored Value Load record to initiate a Stored Value transaction.
end note

app->capi: <font color=red>**prepare**</font> card transaction:\n\t- SV Get for Load
activate capi  #pink
note over capi
    SV Get for Debit prepared in **last** position of a card command set to process.
end note
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> commands
activate capi  #pink

capi-[#0000FF]>cardReader: <font color=blue>**Card #2**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

'group Card APDU commands inside session
    cardReader->card: SV Get (for Load)
    card- ->cardReader: [SV Load record, SV Card challenge]
'end

cardReader- -[#0000FF]>capi: [SV Card challenge]
deactivate cardReader

capi- ->app: [Calypso card image:\n\t- identification data with SV support\n\t- SV Load data (updated)\n\t- SV Debit data\n\t- SV balance (updated)]
deactivate capi

app->capi: <font color=red>**prepare**</font> card transaction:\n\t- SV Load (specific amount)\n\t- release channel
activate capi  #pink
note over capi
    SV Debit prepared in **first** position of a card command set to process.
end note
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> commands
activate capi  #pink

capi-[#00FF00]>samReader: <font color=green>**SAM #1**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen

samReader->sam: select diversifier (card serial)
sam- ->samReader
samReader->sam: SV prepare Load (SV card challenge, load amount)
sam- ->samReader: [SV SAM challenge, SV SAM certificate]

samReader-[#00FF00]->capi: [SAM challenge, SAM certificate]
deactivate samReader

capi-[#0000FF]>cardReader: <font color=blue>**Card #3**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

'group Card APDU commands inside session
note over cardReader
    SV Debit follows **directely** a previously transmitted SV Get for Debit card command.
end note
    cardReader->card: SV Load (amount, SAM challenge, SAM certificate)
    card- ->cardReader: [new balance, SV Card certificate]
'end

cardReader->card: close card channel
card- ->cardReader
deactivate card

cardReader-[#0000FF]->capi: [card certificate]
deactivate cardReader

capi-[#00FF00]>samReader: <font color=green>**SAM #2**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: SV Check (card certificate)
sam- ->samReader: [authentication status]

samReader-[#00FF00]->capi: [authentification status]
deactivate samReader

capi- ->app: [Calypso card image:\n\t- identification data with SV support\n\t- SV Load data (updated)\n\t- SV Debit data\n\t- SV balance (updated)]\nauthentification status
deactivate capi
@enduml

@startuml

skinparam ClassBorderColor #D4AC0D
skinparam stereotypeABorderColor #A9DCDF
skinparam stereotypeIBorderColor #B4A7E5
skinparam stereotypeCBorderColor #ADD1B2
skinparam stereotypeEBorderColor #EB93DF
skinparam shadowing false

skinparam StateBorderColor #D4AC0D
skinparam ActivityBorderColor #D4AC0D

skinparam ClassBackgroundColor<<red>> #FDEDEC
skinparam ClassBorderColor<<red>> #E74C3C
hide <<red>> stereotype
skinparam ClassBackgroundColor<<purple>> #F4ECF7
skinparam ClassBorderColor<<purple>> #8E44AD
hide <<purple>> stereotype
skinparam ClassBackgroundColor<<blue>> #EBF5FB
skinparam ClassBorderColor<<blue>> #3498DB
hide <<blue>> stereotype
skinparam ClassBackgroundColor<<green>> #EAFAF1
skinparam ClassBorderColor<<green>> #2ECC71
hide <<green>> stereotype

skinparam ClassBackgroundColor<<orange>> #FDF2E9
skinparam ClassBorderColor<<orange>> #E67E22
hide <<orange>> stereotype

skinparam ClassBackgroundColor<<grey>> #EAECEE
skinparam ClassBorderColor<<grey>> #2C3E50
hide <<grey>> stereotype

actor "Ticketing Application" as app #gold
participant "Calypso API" as capi #pink
participant "Reader API" as rapi #pink
participant "Calypso Card\nReader" as cardReader #lightBlue
boundary "**Card**" as card #lightBlue
participant "Calypso SAM\nReader" as samReader #lightGreen
boundary "selected\n**SAM**" as sam #lightGreen

activate app #gold
activate sam #lightGreen

== Card selection & identification ==

note over capi
    Reads the environment data present in all the cards targeted for selection.
end note

app->capi: <font color=red>**prepare**</font> card selection scenario:\n\t- filter by specific AID\n\t- read SV Load record\n\t- read SV Debit records
activate capi  #pink
capi- ->app
deactivate capi

app->rapi: <font color=red>**process**</font> explicit card selection scenario
activate rapi  #pink
rapi-[#0000FF]>cardReader: <font color=blue>**Card #1**</font>\ntransmit selection request\n\t- card selector\n\t- APDU list
activate cardReader #lightBlue

cardReader->card: open card channel
activate card #lightBlue
card- ->cardReader
cardReader->card: select application (aid)
card- ->cardReader: [card FCI]
cardReader->cardReader: checks invalidation status

    cardReader->card: read record (SV Load record)
    card- ->cardReader: [SV Load record]
    cardReader->card: read record (SV Debit records)
    card- ->cardReader: [SV Load records]

cardReader- -[#0000FF]>rapi: receive selection response
deactivate cardReader

rapi- ->app: selected active SmartCard image
deactivate rapi

app->capi: **cast** Calypso card
activate capi  #pink
capi- ->app: [Calypso card image:\n\t- identification data with SV support\n\t- SV Load data\n\t- SV Debit data\n\t- SV balance]

deactivate capi

== Card secure transaction ==

app->app: **instantiate** Calypso card transaction:\n\t- Calypso card resource\n\t- Calypso SAM resource

note over capi
    Reads again the Stored Value Load record to initiate a Stored Value transaction.
end note

app->capi: <font color=red>**prepare**</font> card transaction:\n\t- SV Get for Load
activate capi  #pink
note over capi
    SV Get for Debit prepared in **last** position of a card command set to process.
end note
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> commands
activate capi  #pink

capi-[#0000FF]>cardReader: <font color=blue>**Card #2**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

    cardReader->card: SV Get (for Load)
    card- ->cardReader: [SV Load record, SV Card challenge]

cardReader- -[#0000FF]>capi: [SV Card challenge]
deactivate cardReader

capi- ->app: [Calypso card image:\n\t- identification data with SV support\n\t- SV Load data (updated)\n\t- SV Debit data\n\t- SV balance (updated)]
deactivate capi

app->capi: <font color=red>**prepare**</font> card transaction:\n\t- SV Load (specific amount)\n\t- release channel
activate capi  #pink
note over capi
    SV Debit prepared in **first** position of a card command set to process.
end note
capi- ->app
deactivate capi

app->capi: <font color=red>**process**</font> commands
activate capi  #pink

capi-[#00FF00]>samReader: <font color=green>**SAM #1**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen

samReader->sam: select diversifier (card serial)
sam- ->samReader
samReader->sam: SV prepare Load (SV card challenge, load amount)
sam- ->samReader: [SV SAM challenge, SV SAM certificate]

samReader-[#00FF00]->capi: [SAM challenge, SAM certificate]
deactivate samReader

capi-[#0000FF]>cardReader: <font color=blue>**Card #3**</font>\ntransmit card request\n\t- APDU list
activate cardReader #lightBlue

note over cardReader
    SV Debit follows **directely** a previously transmitted SV Get for Debit card command.
end note
    cardReader->card: SV Load (amount, SAM challenge, SAM certificate)
    card- ->cardReader: [new balance, SV Card certificate]

cardReader->card: close card channel
card- ->cardReader
deactivate card

cardReader-[#0000FF]->capi: [card certificate]
deactivate cardReader

capi-[#00FF00]>samReader: <font color=green>**SAM #2**</font>\ntransmit card request\n\t- APDU list
activate samReader #lightGreen
samReader->sam: SV Check (card certificate)
sam- ->samReader: [authentication status]

samReader-[#00FF00]->capi: [authentification status]
deactivate samReader

capi- ->app: [Calypso card image:\n\t- identification data with SV support\n\t- SV Load data (updated)\n\t- SV Debit data\n\t- SV balance (updated)]\nauthentification status
deactivate capi
@enduml

PlantUML version 1.2022.4(Sat Apr 09 17:29:17 RET 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: fr
Country: FR
--></g></svg>